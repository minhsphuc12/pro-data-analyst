# Search procedures for W_POL_DTL_F — db=DWH_ADMIN


## By --table W_POL_DTL_F
Found 30 object(s).

Found **30** matching objects (full source).

### `BACHPX.PROC_DATA_POL` (PROCEDURE) — 2 lines reference search term

```
PROCEDURE        PROC_DATA_POL(P_DATE NUMBER)
IS

BEGIN

EXECUTE IMMEDIATE 'TRUNCATE TABLE bachpx.W_DATA_POL';
INSERT /*+ append parallel(6) */ INTO bachpx.W_DATA_POL

WITH cal AS (
SELECT  *
FROM F88DWH.W_CALENDAR_D wcd
WHERE  DATE_WID <= P_DATE
	AND DATE_WID >TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD')  - 10, 'YYYYMMDD')
),
SOURCE_POL AS (
SELECT 174 AS SOURCE_ID FROM dual  --'Recall KHQL'
UNION ALL
SELECT 2 AS SOURCE_ID FROM dual  --'Marketing PGD'
UNION ALL
SELECT 214 AS SOURCE_ID FROM dual   --'TLS E2E'
UNION ALL
SELECT 1 AS SOURCE_ID FROM dual)   -- 'Digital HO'
,
data_pol AS (
SELECT   /*+ parallel (F88DWH.W_POL_DTL_F,6) */
		op.INT_POL_PAWN_ID AS POL_ID,
		wpdf.STATUS_NM AS STATUS_STR,
		wpdf.GROUP_ID AS SHOP_CODE,
		wpdf.SOURCE_LEVEL_1_NAME AS KENH,
		wpdf.SOURCE_LEVEL_2_NAME AS NHOM_NGUON,
		wpdf.SOURCE_LEVEL_3_NAME AS NGUON_PHU,
		wpdf.CAMPAIGN_NM AS CAMPAIGN,
		worfd.ONLINE_REASON_FAIL_WID AS REASON_WID,
		worfd.TYPE_NM AS ACTION_NM,
		worfd.CANCELED_REASON_NM AS REASON_NM,
		op.CREATED_DT ,
		wpdf.DATE_WID AS CREATED_TIME_POL,
		COALESCE(wpdf.TRANS_TO_SHOP_DT, wpdf.FORM_CREATED_DT ) AS TO_SHOP_DT,
		op.ROW_DESC,
		wpdf.FIRST_CALL_DT,
		wpdf.LAST_CALL_DT
FROM F88DWH.W_POL_DTL_F wpdf
JOIN SOURCE_POL sp
	ON wpdf.SOURCE_LEVEL_1_ID = sp.SOURCE_ID
LEFT JOIN BACHPX.W_ONLINE_PROCESS_TMP op
	ON  wpdf.POL_WID = op.INT_POL_PAWN_ID
LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
	ON op.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
WHERE EXISTS ( SELECT 1
FROM cal
WHERE
	  wpdf.YEAR_NUM = cal.YEAR_NUM
	AND wpdf.MONTH_NUM = cal.MONTH_NUM
	AND wpdf.DATE_WID = cal.DATE_WID
)
)
,
to_shop_adj AS (
SELECT /*+ parallel (data_pol,6) */
		POL_ID,
		MAX(CREATED_DT) AS TO_SHOP_ADJ
FROM data_pol
WHERE 1 = 1
	AND REASON_WID IN( 818, 884, 848)
GROUP BY POL_ID
)
,
call_first_adj AS (
SELECT   /*+ parallel (data_pol,6) */
		a.POL_ID,
		MIN(a.CREATED_DT) AS FIRST_CALL_ADJ
FROM data_pol a
LEFT JOIN to_shop_adj b
	ON a.POL_ID = b.POL_ID
WHERE 1 = 1
	AND a.CREATED_DT > b.TO_SHOP_ADJ
	AND a.REASON_WID NOT IN (887, 831, 854, 381, 402, 720, 421, 627, 884, 634, 655, 963, 685,8, 818, 848, 1121, 731, 1063, 1041,1021, 961)
	AND a.REASON_WID IS NOT NULL
GROUP BY a.POL_ID
)
,
data_all AS (
SELECT  dp.POL_ID,
		STATUS_STR,
		SHOP_CODE,
		KENH,
		NHOM_NGUON,
		NGUON_PHU,
		CAMPAIGN,
		REASON_WID,
		ACTION_NM,
		REASON_NM,
		CREATED_DT ,
		CREATED_TIME_POL,
		TO_SHOP_DT,
		ROW_DESC,
		TO_NUMBER(TO_CHAR(FIRST_CALL_DT, 'YYYYMMDDHH24MISS')) FIRST_CALL,
		TO_NUMBER(TO_CHAR(LAST_CALL_DT, 'YYYYMMDDHH24MISS')) LAST_CALL,
		tsa.TO_SHOP_ADJ,
		cfa.FIRST_CALL_ADJ
FROM data_pol dp
LEFT JOIN to_shop_adj tsa
	ON dp.POL_ID = tsa.POL_ID
LEFT JOIN call_first_adj cfa
	ON dp.POL_ID = cfa.POL_ID
)
,
lst_cmt AS (
SELECT  POL_ID,
		TO_DATE(CREATED_DT,'YYYYMMDDHH24MISS') AS CREATED_DT
FROM data_all mdp
WHERE ROW_DESC = 1
	AND STATUS_STR = 'Đang chăm sóc'
	)
,
prior_lst_cmt AS (
SELECT  POL_ID,
		TO_DATE(CREATED_DT,'YYYYMMDDHH24MISS') AS CREATED_DT
FROM data_all mdp
WHERE ROW_DESC = 2
	AND STATUS_STR = 'Đang chăm sóc'
	)
,
cham_don_3d_stt AS ( ------------------
SELECT  a.POL_ID,
		a.CREATED_DT AS LAST_CALL,
		b.CREATED_DT AS PRIOR_LAST_CALL,
		(a.CREATED_DT - b.CREATED_DT) AS TIME_,
		CASE WHEN a.CREATED_DT - b.CREATED_DT BETWEEN 0 AND 3 THEN 'Đạt SLA'
		ELSE 'Không đạt SLA' END AS CHAM_3D_STT
FROM lst_cmt a
JOIN prior_lst_cmt b
ON a.POL_ID = b.POL_ID
	)
,
sla_time AS (
SELECT
		a.POL_ID,
		CASE
			WHEN TO_SHOP_DT IS NULL THEN NULL
			WHEN TO_CHAR(TO_SHOP_DT, 'HH24MISS') < 80000 THEN CONCAT(TO_CHAR(TO_SHOP_DT, 'YYYYMMDD'), '080000')
			WHEN TO_CHAR(TO_SHOP_DT, 'HH24MISS') >= 80000 AND TO_CHAR(TO_SHOP_DT, 'HH24MISS') <= 190000 THEN TO_CHAR(TO_SHOP_DT, 'YYYYMMDDHH24MISS')
			ELSE CONCAT(TO_CHAR(TO_SHOP_DT + 1, 'YYYYMMDD'), '080000')
		END
		AS SLA_TO_SHOP,
		CASE
			WHEN TO_SHOP_ADJ IS NULL THEN NULL
			WHEN SUBSTR(TO_SHOP_ADJ, 9,6) <  80000 THEN CONCAT(TO_CHAR(TO_DATE(SUBSTR(TO_SHOP_ADJ,1,8), 'YYYYMMDD'), 'YYYYMMDD'), '080000')
			WHEN SUBSTR(TO_SHOP_ADJ, 9,6) >= 80000 AND  SUBSTR(TO_SHOP_ADJ, 9,6) <= 190000 THEN TO_CHAR(TO_SHOP_ADJ)
			ELSE CONCAT(TO_CHAR(TO_DATE(SUBSTR(TO_SHOP_ADJ,1,8), 'YYYYMMDD') + 1, 'YYYYMMDD'), '080000')
		END
		AS SLA_TO_SHOP_ADJ
FROM data_all a
WHERE a.ROW_DESC = 1
)
,
tiep_can_don AS (
SELECT
		a.POL_ID,
		a.SLA_TO_SHOP,
		a.SLA_TO_SHOP_ADJ
FROM sla_time a
)
,
final_ AS (
SELECT a.*,
		b.SLA_TO_SHOP,
		b.SLA_TO_SHOP_ADJ,
		TO_DATE(a.FIRST_CALL, 'YYYYMMDDHH24MISS') - TO_DATE(b.SLA_TO_SHOP, 'YYYYMMDDHH24MISS') AS TIME_TIEP_CAN,
        TO_DATE(a.FIRST_CALL_ADJ, 'YYYYMMDDHH24MISS') - TO_DATE(b.SLA_TO_SHOP_ADJ, 'YYYYMMDDHH24MISS') AS TIME_TIEP_CAN_ADJ,
		c.TIME_ AS TIME_CHAM_DON,
		c.CHAM_3D_STT AS CHAM_DON_3D_STT
FROM data_all a
LEFT JOIN tiep_can_don b
	ON a.POL_ID = b.POL_ID
LEFT JOIN cham_don_3d_stt c
	ON a.POL_ID = c.POL_ID
)
SELECT * FROM FINAL_;

DBMS_OUTPUT.PUT_LINE ('----> DONE INSERT DATA_POL '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));
COMMIT;
END ;
```

### `DEVDWH.PKG_BALANCE_MOVEMENT` (PACKAGE BODY) — 1 lines reference search term

```
PACKAGE BODY        PKG_BALANCE_MOVEMENT
AS
-- Package body

/*
* -- Author: DEVDWH
* -- Created: 2023-09-22
* -- Purpose: Phục vụ BDM theo dõi hợp đồng theo flow kinh doanh
*/


PROCEDURE NEW_CUSTOMER_SOURCE (CB_DATE NUMBER) IS
BEGIN
DELETE FROM DEVDWH.W_RPT_NEW_CUSTOMER_SOURCE WHERE SUBSTR(DISBURSE_DATE_WID,1,6) = SUBSTR(CB_DATE,1,6);
INSERT INTO DEVDWH.W_RPT_NEW_CUSTOMER_SOURCE
	WITH D AS (
	 	SELECT
			LDT.LOAN_WID ,
			LDT.LOAN_CODE ,
			LDT.DISBURSE_DATE_WID ,
			CASE
				WHEN POL.SOURCE_LEVEL_1_NAME IN ('Digital HO','TLS E2E') THEN 'Digital HO'
				WHEN POL.SOURCE_LEVEL_1_NAME = 'Marketing PGD' OR POL.LOAN_CODE IS NULL THEN 'Marketing PGD'
				WHEN POL.SOURCE_LEVEL_1_NAME = 'Recall KHQL' THEN POL.SOURCE_LEVEL_1_NAME
				ELSE 'Khác'
			END KENH,
			POL.SOURCE_LEVEL_2_NAME NHOM_NGUON ,
			C.CUSTOMER_CODE ,
			LDT.CTR_TYPE ,
			ROW_NUMBER() OVER (PARTITION BY C.CUSTOMER_CODE ORDER BY DISBURSE_DATE_WID) RN
		FROM
			F88DWH.W_LOAN_DTL_F LDT
			LEFT JOIN F88DWH.W_POL_DTL_F POL ON LDT.LOAN_CODE = POL.LOAN_CODE AND POL.STATUS_NM = 'Nhận cầm cố'
			LEFT JOIN F88DWH.VW_W_CUSTOMER_D C ON LDT.CUSTOMER_WID = C.CUSTOMER_WID
		WHERE
			LDT.CTR_TYPE = 'Mới'
			AND SUBSTR(DISBURSE_DATE_WID,1,6) = SUBSTR(CB_DATE,1,6)
			--AND c.CUSTOMER_CODE = '2293216853'--LDT.LOAN_CODE = '20811615320'
	)

	SELECT
		LOAN_WID ,
		LOAN_CODE ,
		DISBURSE_DATE_WID ,
		KENH ,
		NHOM_NGUON ,
		CUSTOMER_CODE
	FROM
		D
	WHERE
		RN = 1

;

DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT NEW_CUSTOMER_SOURCE:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));
COMMIT;
END ;



PROCEDURE BALANCE_MOVEMENT (CB_DATE NUMBER) IS
BEGIN
DELETE FROM DEVDWH.W_RPT_BALANCE_MOVEMENT WHERE REPORT_MONTH  =  SUBSTR(CB_DATE,1,6) ;
INSERT INTO DEVDWH.W_RPT_BALANCE_MOVEMENT
    (YEAR_NUM
    , REPORT_MONTH
    , LOAN_CODE
    , PRINCIPAL_OB
    , PRINCIPAL_CB
    , DISBURSE_AMT
    , PRINCIPAL_PAID
    , BUCKET_OB
    , BUCKET_CB
    , BUCKET_MVT
    , BUCKET_MVT_STEP
    , OVD_OB
    , OVD_CB
    , ASSET_TP_NM
    , PACKAGE_NM
    , PRODUCT_NM
    , GIA_THAM_DINH
    , SO_TIEN_VAY_TOI_DA
    , GIAI_NGAN
    , BAO_HIEM
    , KY_HAN_VAY
    , DV_KY_HAN_VAY
    , CHI_PHI_VAY
    , NGAY_GIAI_NGAN
    , NGAY_DONG_HĐ
    , THOI_GIAN_VAY_THUC_TE
    , LTV
    , CHANNEL_CODE
    , FUND_NAME
    , CUSTOMER_CODE
    , CUSTOMER_AGE
    , GENDER_NM
    , JOB_NM
    , CUSTOMER_INCOME
    , CTR_TYPE
    , OLD_LOAN_CODE
    , KENH, NHOM_NGUON
    , CREATED_USER
    , POSITION_CREATED_USER
    , SUPPORT_USER
    , POSITION_SUPPORT_USER
    , RANK
    , SHOP_NM
    , QLKV
    , QLV
    , PHAN_VUNG
    , PROVINCE
    , DV_HC
    , DIA_HINH
    , QUY_MO_DS
    , DIEM_MAT_BANG
    , PHAN_HANG_MAT_BANG
    , SHOP_OPENING_DATE, SHOP_AGE, REPORT_DATE
    )

	WITH CAL AS
	(
		SELECT
			DATE_WID ,
			DATE_TM ,
			YEAR_NUM ,
			MONTH_NUM ,
			LAST_DOM_FLAG ,
			CASE
				WHEN DATE_TM = TRUNC(TO_DATE(CB_DATE,'YYYYMMDD'),'MM')-1 THEN 'MONTH_PRE'
				ELSE 'MONTH'
			END MONTH_TYPE ,
			CASE
				WHEN DATE_WID = CB_DATE THEN 'CLOSING_DATE'
				WHEN DATE_TM = TRUNC(TO_DATE(CB_DATE,'YYYYMMDD'),'MM')-1 THEN 'OPENING_DATE'
			END DATE_TYPE
		FROM
			F88DWH.W_CALENDAR_D
		WHERE
				DATE_TM >= TRUNC(TO_DATE(CB_DATE,'YYYYMMDD'),'MM')-1
			AND DATE_WID <= CB_DATE
	)

	, D AS
	(
	SELECT
		LDT.* ,
		NVL(LDA_OB.PRINCIPAL_REMAIN,0) AS PRINCIPAL_OB ,
		NVL(LDA_CB.PRINCIPAL_REMAIN,0) AS PRINCIPAL_CB ,
		CASE
			WHEN CAL_GN.MONTH_TYPE = 'MONTH' THEN LDT.DISBURSE_AMT
		END DISBURSE_AMT_IN_MONTH ,
		CASE
			WHEN CAL_GN.MONTH_TYPE = 'MONTH' THEN 'GIẢI NGÂN MỚI'
			WHEN LDA_OB.OVERDUE_DAYS <= 0 THEN 'B0'
			WHEN LDA_OB.OVERDUE_DAYS <= 10 THEN 'B1A'
			WHEN LDA_OB.OVERDUE_DAYS <= 30 THEN 'B1B'
			WHEN LDA_OB.OVERDUE_DAYS <= 60 THEN 'B2'
			WHEN LDA_OB.OVERDUE_DAYS <= 90 THEN 'B3'
			WHEN LDA_OB.OVERDUE_DAYS > 90 THEN 'B3+'
		END BUCKET_OB ,
		CASE
			WHEN LDA_CB.OVERDUE_DAYS <= 0 THEN 'B0'
			WHEN LDA_CB.OVERDUE_DAYS <= 10 THEN 'B1A'
			WHEN LDA_CB.OVERDUE_DAYS <= 30 THEN 'B1B'
			WHEN LDA_CB.OVERDUE_DAYS <= 60 THEN 'B2'
			WHEN LDA_CB.OVERDUE_DAYS <= 90 THEN 'B3'
			WHEN LDA_CB.OVERDUE_DAYS > 90 THEN 'B3+'
			WHEN CAL_R.MONTH_TYPE = 'MONTH' THEN 'TẤT TOÁN HĐ'
		END BUCKET_CB ,
		LDA_OB.OVERDUE_DAYS AS OVD_OB ,
		LDA_CB.OVERDUE_DAYS AS OVD_CB ,
		CASE
	--		WHEN CAL_GN.MONTH_TYPE = 'MONTH' THEN 0 --'GIẢI NGÂN MỚI'
			WHEN LDA_OB.OVERDUE_DAYS <= 0 THEN 1 --'B0'
			WHEN LDA_OB.OVERDUE_DAYS <= 10 THEN 2 --'B1A'
			WHEN LDA_OB.OVERDUE_DAYS <= 30 THEN 2 --'B1B'
			WHEN LDA_OB.OVERDUE_DAYS <= 60 THEN 3 --'B2'
			WHEN LDA_OB.OVERDUE_DAYS <= 90 THEN 4 --'B3'
			WHEN LDA_OB.OVERDUE_DAYS > 90 THEN 5 --'B3+'
		END BUCKET_OB_N ,
		CASE
			WHEN LDA_CB.OVERDUE_DAYS <= 0 THEN 1 --'B0'
			WHEN LDA_CB.OVERDUE_DAYS <= 10 THEN 2 --'B1A'
			WHEN LDA_CB.OVERDUE_DAYS <= 30 THEN 2 --'B1B'
			WHEN LDA_CB.OVERDUE_DAYS <= 60 THEN 3 --'B2'
			WHEN LDA_CB.OVERDUE_DAYS <= 90 THEN 4 --'B3'
			WHEN LDA_CB.OVERDUE_DAYS > 90 THEN 5 --'B3+'
	--		WHEN CAL_R.MONTH_TYPE = 'MONTH' THEN 0 --'TẤT TOÁN HĐ'
		END BUCKET_CB_N ,
		CASE
			WHEN NVL(LDA_CB.PRINCIPAL_REMAIN,0) - NVL(LDA_OB.PRINCIPAL_REMAIN,0) > 0 THEN 'TĂNG'
			WHEN NVL(LDA_CB.PRINCIPAL_REMAIN,0) - NVL(LDA_OB.PRINCIPAL_REMAIN,0) < 0 THEN 'GIẢM'
			WHEN NVL(LDA_CB.PRINCIPAL_REMAIN,0) - NVL(LDA_OB.PRINCIPAL_REMAIN,0) = 0 THEN 'KHÔNG ĐỔI'
		END BALANCE_MOVEMENT ,
		CASE
			WHEN NVL(LDA_CB.SHOP_WID,LDA_OB.SHOP_WID) IS NULL THEN LDT.SHOP_WID
			ELSE NVL(LDA_CB.SHOP_WID,LDA_OB.SHOP_WID)
		END OLD_SHOP_WID

	FROM
		F88DWH.W_LOAN_DTL_F LDT
		LEFT JOIN (
					SELECT
						LOAN_WID ,
						OVERDUE_DAYS ,
						PRINCIPAL_REMAIN ,
						SHOP_WID
					FROM
						F88DWH.W_LOAN_DAILY_F LDA ,
						CAL
					WHERE
						CAL.DATE_TYPE = 'CLOSING_DATE'
						AND LDA.YEAR_NUM = CAL.YEAR_NUM
						AND LDA.MONTH_NUM = CAL.MONTH_NUM
						AND LDA.DATE_WID = CAL.DATE_WID
					) LDA_CB ON LDT.LOAN_WID = LDA_CB.LOAN_WID

		LEFT JOIN (
					SELECT
						LOAN_WID ,
						OVERDUE_DAYS ,
						PRINCIPAL_REMAIN ,
						SCHEDULE_NEXT_DATE ,
						SHOP_WID
					FROM
						F88DWH.W_LOAN_DAILY_F LDA ,
						CAL
					WHERE
						CAL.DATE_TYPE = 'OPENING_DATE'
						AND LDA.YEAR_NUM = CAL.YEAR_NUM
						AND LDA.MONTH_NUM = CAL.MONTH_NUM
						AND LDA.DATE_WID = CAL.DATE_WID
					) LDA_OB ON LDT.LOAN_WID = LDA_OB.LOAN_WID
		LEFT JOIN CAL CAL_GN ON LDT.DISBURSE_DATE_WID = CAL_GN.DATE_WID AND CAL_GN.MONTH_TYPE = 'MONTH'
		LEFT JOIN CAL CAL_R ON LDT.CLOSED_DATE_WID = CAL_R.DATE_WID AND CAL_R.MONTH_TYPE = 'MONTH'
	WHERE
		(CAL_GN.MONTH_TYPE = 'MONTH'
		OR CAL_R.MONTH_TYPE = 'MONTH'
		OR LDA_CB.PRINCIPAL_REMAIN > 0
		OR LDA_OB.PRINCIPAL_REMAIN > 0)
	)

	,LT AS --GIAO DỊCH TRẢ GỐC TRÊN LOAN_TRANS
	(
		SELECT
			LOAN_WID ,
			SUM(PRINCIPAL_AMT) PRINCIPAL_PAID
		FROM
			F88DWH.W_LOAN_TRANS_DTL_F LT
			JOIN CAL ON LT.TRANS_DATE_WID = CAL.DATE_WID AND CAL.MONTH_TYPE = 'MONTH'
		WHERE LT.ACTION_CODE IN ('DONG_HD','DONG_HDNX','DONG_HD_CD','DONG_HD_CDNX','DONG_HD_CD_CIMB','DONG_HD_CIMB_F88','DONG_HD_CIMB_F88_WO','DONG_HD_DH','TRA_CPV','TRA_CPV_CIMB','TRA_CPV_CIMB_F88','TRA_CPV_CIMB_F88_WO','TRA_CPV_HDNX')
		GROUP BY LOAN_WID
	)

	SELECT
         SUBSTR(CB_DATE,1,4) YEAR_NUM
        ,SUBSTR(CB_DATE,1,6) REPORT_MONTH
		, D.LOAN_CODE
		, D.PRINCIPAL_OB
		, D.PRINCIPAL_CB
		, D.DISBURSE_AMT
		, LT.PRINCIPAL_PAID
		, D.BUCKET_OB
		, D.BUCKET_CB
		, CASE
			WHEN BUCKET_OB_N > BUCKET_CB_N THEN 'ROLL BACK'
			WHEN BUCKET_OB_N < BUCKET_CB_N THEN 'ROLL FORWARD'
			WHEN BUCKET_OB = 'GIẢI NGÂN MỚI' AND BUCKET_CB = 'TẤT TOÁN HĐ' THEN 'MỞ - ĐÓNG TRONG THÁNG'
			WHEN BUCKET_OB = 'GIẢI NGÂN MỚI' AND BUCKET_CB IN ('B1A','B1B') THEN 'ROLL FORWARD'
			WHEN BUCKET_OB = 'GIẢI NGÂN MỚI' THEN 'GIẢI NGÂN MỚI'
			WHEN BUCKET_CB = 'TẤT TOÁN HĐ' THEN 'TẤT TOÁN HĐ'
			WHEN BUCKET_OB_N = BUCKET_CB_N THEN 'NO CHANGE'
		  END BUCKET_MVT
		, BUCKET_CB_N - BUCKET_OB_N BUCKET_MVT_STEP
		, D.OVD_OB
		, D.OVD_CB
		, ATP.ASSET_TP_NM
		, D.LOAN_PKG_NM PACKAGE_NM
		, PRO.PRODUCT_NM
		, D.COLLATERAL_AMT GIA_THAM_DINH
		, D.MAX_LENDABLE_AMT SO_TIEN_VAY_TOI_DA
		, D.DISBURSE_AMT - D.INSURANCE_AMT GIAI_NGAN
		, D.INSURANCE_AMT BAO_HIEM
		, D.TERM_FREQUENCY KY_HAN_VAY
		, D.TERM_FREQUENCY_UNIT DV_KY_HAN_VAY
		, D.INTEREST_RATE CHI_PHI_VAY
		, TO_DATE(D.DISBURSE_DATE_WID,'YYYYMMDD') NGAY_GIAI_NGAN
		, TO_DATE(D.CLOSED_DATE_WID,'YYYYMMDD') NGAY_DONG_HĐ
		, CASE
				WHEN D.CLOSED_DATE_WID IS NULL THEN NULL
				WHEN D.CLOSED_DATE_WID IS NOT NULL THEN ROUND((TO_DATE(D.CLOSED_DATE_WID,'YYYYMMDD') - TO_DATE(D.DISBURSE_DATE_WID,'YYYYMMDD')+1)/30,2)
		  END THOI_GIAN_VAY_THUC_TE
		, CASE
			WHEN D.COLLATERAL_AMT IS NULL OR D.COLLATERAL_AMT = 0 THEN NULL
			WHEN D.COLLATERAL_AMT > 0 THEN ROUND((D.DISBURSE_AMT - D.INSURANCE_AMT) / D.COLLATERAL_AMT,2)
		  END LTV
		--
		, D.CHANNEL_CODE
		, D.FUND_NAME
		, C.CUSTOMER_CODE
		, EXTRACT(YEAR FROM SYSDATE ) - C.BIRTH_DAY CUSTOMER_AGE
		, C.GENDER_NM
		, JOB.JOB_NM
		, G.GRP_NM CUSTOMER_INCOME
		, CASE
				WHEN D.CTR_TYPE = 'Mới' THEN 'Mới'
				WHEN D.DISBURSE_DATE_WID < 20220101 THEN D.CTR_TYPE
				ELSE KHQL.CTR_TYPE
		  END CTR_TYPE
		, LDT1.LOAN_CODE  OLD_LOAN_CODE
		, CS.KENH
		, CS.NHOM_NGUON
		, EC.EMPLOYEE_CODE CREATED_USER
		, EC.POSITION_NM POSITION_CREATED_USER
		, ES.EMPLOYEE_CODE SUPPORT_USER
		, ES.POSITION_NM POSITION_SUPPORT_USER
		, LS.RANK
		--
		, S.SHOP_NM
		, A.QLKV
		, A.TPK QLV
		, A.TRADE_LEAD PHAN_VUNG
		, A.PROVINCE
		, A.DV_HC
		, A.DIA_HINH
		, A.QUY_MO_DS
		, A.DIEM_MAT_BANG
		, A.PHAN_HANG_MAT_BANG
		, A.FAIL_14_6  SHOP_OPENING_DATE
		, FLOOR(MONTHS_BETWEEN( TO_DATE(CB_DATE,'yyyymmdd'),A.FAIL_14_6)) SHOP_AGE
		, CB_DATE REPORT_DATE
	FROM
		D
		LEFT JOIN LT ON D.LOAN_WID = LT.LOAN_WID
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D C ON D.CUSTOMER_WID = C.CUSTOMER_WID
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D CUS ON C.CUSTOMER_CODE = CUS.CUSTOMER_CODE  AND CUS.CRN_ROW_IND = 1
		LEFT JOIN F88DWH.W_JOB_D JOB ON CUS.JOB = JOB.JOB_CODE AND to_date(CB_DATE,'yyyymmdd') BETWEEN job.VALID_FM_DT AND job.VALID_TO_DT +1
		LEFT JOIN F88DWH.GRP G ON CUS.CUSTOMER_INCOME  = G.GRP_CODE AND G.GRP_TP = 'AVERAGE_INCOME'
		LEFT JOIN F88DWH.W_LOAN_SCORE_F LS ON D.LOAN_WID = LS.LOAN_WID
		--
		LEFT JOIN F88DWH.W_ASSET_TP_D ATP ON D.ASSET_TYPE_WID = ATP.ASSET_TP_WID
--		LEFT JOIN F88DWH.W_PACKAGE_D PAK ON D.PACKAGE_WID = PAK.PACKAGE_WID
		LEFT JOIN F88DWH.W_PRODUCT_D PRO ON D.PRODUCT_WID = PRO.PRODUCT_WID
		LEFT JOIN DEVDWH.W_RPT_NEW_CUSTOMER_SOURCE CS ON C.CUSTOMER_CODE = CS.CUSTOMER_CODE
--		LEFT JOIN BACHPX.CTR_TYPE_KHQL_TMP KHQL ON D.LOAN_WID = KHQL.LOAN_WID_NEW
		LEFT JOIN F88DWH.W_CTR_TYPE_KHQL KHQL ON D.LOAN_WID = KHQL.LOAN_WID_NEW
		LEFT JOIN F88DWH.W_LOAN_DTL_F LDT1 ON KHQL.LOAN_WID = LDT1.LOAN_WID
		--
		LEFT JOIN F88DWH.W_SHOP_D S ON D.OLD_SHOP_WID = S.SHOP_WID
		LEFT JOIN F88DWH.W_AREA_MANAGER_D A ON S.SHOP_CODE = A.SHOP_ID
		--
		LEFT JOIN F88DWH.VW_W_EMPLOYEE_D EC ON D.CREATED_USER_WID = EC.EMPLOYEE_WID
		LEFT JOIN F88DWH.vW_W_EMPLOYEE_D ES ON D.SUPPORTER_WID = ES.EMPLOYEE_WID
;

DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT BALANCE_MOVEMENT '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));
COMMIT;
END ;


PROCEDURE MAIN (CB_DATE NUMBER) IS
BEGIN
	NEW_CUSTOMER_SOURCE (CB_DATE) ;
	BALANCE_MOVEMENT (CB_DATE) ;
END ;


END PKG_BALANCE_MOVEMENT;
```

### `DEVDWH.PKG_CUSTOMER_DEMO` (PACKAGE BODY) — 2 lines reference search term

```
PACKAGE BODY        PKG_CUSTOMER_DEMO
AS

PROCEDURE PROC_RPT_CUS_DEMO (P_DATE NUMBER)
IS
BEGIN
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_TOI_MONTHLY';
COMMIT;

INSERT INTO F88DWH.W_RPT_TOI_MONTHLY
(YEAR_MONTH ,SHOP_WID, SHOP_CODE ,SHOP_NM , CUSTOMER_CODE, LOAN_CODE , REVENUE_TO_F88, PENALTY_FEE,OVERDUE_PENALTY ,RECOVERY,WO )
SELECT YEAR_MONTH , SHOP_WID, SHOP_CODE, SHOP_NM,customer_code,loan_code
        , sum(CASE WHEN TO_BUY_DEBT = 'BUY_DEPT' THEN 0 ELSE nvl(INTEREST,0) END)
        	+ sum(nvl(APPRAISAL_FEE,0)) + sum(nvl(ADMIN_FEE,0)) + sum(nvl(FEE_CONSIGNMENT,0))
        	+ sum(nvl(INTEREST_OVER_BUY_DEPT,0)) + sum(nvl(EXTEND_FEE,0)) + + sum(nvl(LOAN_MANAGEMENT_FEE,0)) REVENUE_TO_F88
        , sum(nvl(BETIMES_PENALTY,0)) + sum(nvl(OVERDUE_PENALTY,0)) PENALTY_FEE
        ,sum(CASE WHEN Trans_Type = 'NORMAL'  THEN nvl(OVERDUE_PENALTY,0) END ) OVERDUE_PENALTY
        ,sum(CASE WHEN RECOVERY = 'RECOVERY' AND  AMOUNT >0 THEN AMOUNT END ) RECOVERY
        ,sum(CASE WHEN WO = 'WO' THEN AMOUNT END ) RECOVERY
FROM (
    SELECT substr(P_DATE,1,6) YEAR_MONTH
    ,cus.customer_code,lda.loan_code
    , s.SHOP_WID, s.SHOP_CODE, s.SHOP_NM
        , txn.TRANSACTION_TYPE_ENUM, txn.CODE_MASTER_DATA
        ,   case
                when (txn.CODE_MASTER_DATA like '%NX%'
                or txn.CODE_MASTER_DATA like '%WO%' or (txn.TRANSACTION_TYPE_ENUM is null and txn.CODE_MASTER_DATA not in ('212', '213', '227', '228') and nvl(txn.is_bad_debt,0) = 1))
            and txn.CODE_MASTER_DATA not in ('BAN_THANH_LY_HDNX_CIMB_F88') then 'RECOVERY'
            else 'NORMAL'
            end Trans_Type
        ,   case
                when txn.CODE_MASTER_DATA in ('TRA_CPV_CIMB', 'DONG_HD_CD_CIMB', 'DONG_HD_CIMB') then 'CIMB'
            else 'F88'
            end TO_FUND
        , CASE
            WHEN txn.CODE_MASTER_DATA = '228' OR txn.CODE_MASTER_DATA IN ('BAN_THANH_LY_HDNX_CIMB_F88', 'DONG_HD_CIMB_F88', 'TRA_CPV_CIMB_F88') THEN 'BUY_DEPT'
            ELSE 'NORMAL'
        END AS TO_BUY_DEBT
        , CASE
            WHEN txn.TRANSACTION_TYPE_ENUM = 'RECOVERY_LIQUIDATION' THEN 'LIQUID_CLEAR'
            ELSE 'NORMAL'
        END AS IS_LIQUID_CLEAR
      ,CASE WHEN  txn.TRANSACTION_TYPE_ENUM  = 'LOAN_TRANSFER_TO_BAD_DEBT' THEN 'WO' END WO
        ,CASE WHEN txn.CODE_MASTER_DATA IN (
						'133', '134','BAN_THANH_LY',
						'BAN_THANH_LY_HDNX','DONG_HDNX',
						'TRA_CPV_HDNX','TRA_HANG_THANH_LY_HDNX',
						'136', '140', '135',
						'BAN_THANH_LY_HDNX_CIMB_F88','BAN_THANH_LY_HDNX_CIMB_SMN',
						'DONG_HD_CIMB_F88_WO', 'TRA_CPV_F88_WO',
						'TRA_CPV_CIMB_F88_WO', 'DONG_HD_CD', 'DONG_HD_CDNX',
						'TRA_CPV', 'DONG_HD_CD_CIMB', 'TRA_CPV_CIMB_F88', 'DONG_HD_CIMB_F88', 'TRA_CPV_CIMB',
						'213','228','210','227','212','211') AND txn.DPD>90 then 'RECOVERY' END RECOVERY
        , txn.INTEREST
        , txn.APPRAISAL_FEE, txn.ADMIN_FEE, txn.FEE_CONSIGNMENT, txn.BETIMES_PENALTY, txn.OVERDUE_PENALTY, txn.INTEREST_OVER_BUY_DEPT, txn.EXTEND_FEE, txn.LOAN_MANAGEMENT_FEE,txn.AMOUNT
    FROM F88DWH.W_DOCUMENT_TRANSACTION txn
    INNER JOIN F88DWH.W_LOAN_DTL_F lda ON lda.LOAN_CODE = txn.CODE_NO
    LEFT JOIN F88DWH.VW_W_CUSTOMER_D cus ON lda.customer_wid = cus.customer_wid
    INNER JOIN F88DWH.W_SHOP_D s ON s.SHOP_WID = lda.SHOP_WID ----AND s.CRN_ROW_IND = 1 AND s.SHOP_TYPE = 'F88'
    WHERE  YEAR_NUM = substr(P_DATE,1,4)
			AND month_num = substr(P_DATE,5,2)
			AND DATE_WID <= P_DATE
    AND  (txn.TRANSACTION_TYPE_ENUM in ('REPAYMENT', 'RECOVERY_LIQUIDATION', 'REVERT_LIQUIDATION','LOAN_TRANSFER_TO_BAD_DEBT')
        OR txn.CODE_MASTER_DATA IN ('133', '134', '136', '140', '212', '213', '228','BAN_THANH_LY',
						'BAN_THANH_LY_HDNX',
						'DONG_HDNX',
						'TRA_CPV_HDNX',
						'TRA_HANG_THANH_LY_HDNX', '135','210','227','211',
						'BAN_THANH_LY_HDNX_CIMB_F88',
						'BAN_THANH_LY_HDNX_CIMB_SMN',
						'DONG_HD_CIMB_F88_WO', 'TRA_CPV_F88_WO',
						'TRA_CPV_CIMB_F88_WO', 'DONG_HD_CD', 'DONG_HD_CDNX',
						'TRA_CPV', 'DONG_HD_CD_CIMB', 'TRA_CPV_CIMB_F88', 'DONG_HD_CIMB_F88', 'TRA_CPV_CIMB'))
    ) T
WHERE t.TO_FUND = 'F88'
GROUP BY YEAR_MONTH, SHOP_WID, SHOP_CODE, SHOP_NM,customer_code,loan_code;

COMMIT;

EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_LOAN_PREBAL_MONTHLY' ;
INSERT INTO  F88DWH.W_RPT_LOAN_PREBAL_MONTHLY
(YEAR_MONTH , CUSTOMER_CODE , PRETIME , ONTIME , OTHER)
WITH b AS (
SELECT
LOAN_WID,
CASE
WHEN NVL(OVERDUE_DAYS, 0) <= 0 THEN 'B0'
ELSE 'B1+'
END AS BUCKET,
PRINCIPAL_REMAIN
FROM
F88DWH.W_LOAN_DAILY_F A
WHERE 1=1
AND year_num = to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyy'))
AND month_num = to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'mm'))
AND DATE_WID = to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd'))
),
c AS (
SELECT
LOAN_WID,
CASE
WHEN NVL(OVERDUE_DAYS, 0) <= 0 THEN 'B0'
ELSE 'B1+'
END AS BUCKET,
PRINCIPAL_REMAIN
FROM
F88DWH.W_LOAN_DAILY_F
WHERE 1=1
AND YEAR_NUM = substr(P_DATE,1,4)
AND month_num = substr(P_DATE,5,2)
AND DATE_WID = P_DATE
)
   ,dat2 as(
    SELECT cus.CUSTOMER_CODE,
    CASE WHEN a.CLOSED_DATE_WID < to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Pretime' WHEN a.CLOSED_DATE_WID = to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Ontime' ELSE 'Other' END status,
   SUM(NVL(B.PRINCIPAL_REMAIN, A.DISBURSE_AMT)) tat_toan
FROM
    F88DWH.W_LOAN_DTL_F A
LEFT JOIN B ON A.LOAN_WID = B.LOAN_WID
LEFT JOIN C ON A.LOAN_WID = C.LOAN_WID
LEFT JOIN F88DWH.VW_W_CUSTOMER_D cus ON a.customer_wid = cus.customer_wid
WHERE 1=1
AND A.CHANNEL_CODE = 'KDML'
AND substr(a.CLOSED_DATE_WID,1,6) = substr(P_DATE,1,6)
AND a.CLOSED_DATE_WID <=P_DATE
AND a.is_bad_debt <> 1 --Nguyennt: dùng trường is_bad_debt <> 1
AND (CASE
WHEN a.CLOSED_DATE_WID IS NOT NULL AND a.CLOSED_DATE_WID = P_DATE AND a.DISBURSE_DATE_WID = P_DATE THEN 'TATTOAN'
WHEN A.CLOSED_DATE_WID IS NOT NULL AND A.CLOSED_DATE_WID <= P_DATE AND A.CLOSED_DATE_WID > to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd')) AND B.BUCKET = 'B0' AND NVL(C.PRINCIPAL_REMAIN,0) = 0 THEN 'TATTOAN'
WHEN A.CLOSED_DATE_WID IS NOT NULL AND A.CLOSED_DATE_WID <= P_DATE AND A.CLOSED_DATE_WID > to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd')) AND A.DISBURSE_DATE_WID > to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd')) AND A.DISBURSE_DATE_WID<= P_DATE AND NVL(C.PRINCIPAL_REMAIN,0) = 0 THEN 'TATTOAN'
END) IS NOT NULL
GROUP BY cus.CUSTOMER_CODE, --a.LOAN_CODE,
    CASE WHEN a.CLOSED_DATE_WID < to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Pretime' WHEN a.CLOSED_DATE_WID = to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Ontime' ELSE 'Other' END
    )
    SELECT substr(P_DATE,1,6) YEAR_MONTH ,CUSTOMER_CODE,Pretime,Ontime,Other
    FROM dat2 A
    pivot (sum(TAT_TOAN) FOR STATUS IN ('Pretime' as Pretime,'Ontime' AS Ontime,'Other' AS Other))A;




EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_LOAN_CUS_MONTHLY' ;
INSERT INTO  F88DWH.W_RPT_LOAN_CUS_MONTHLY
 (	YEAR_MONTH , CUSTOMER_CODE , SHOP_WID , SHOP_CODE , CTR_TYPE , FUND_NAME , HAVE_W0 , LOAI_TS , GOI_VAY, DISBURSE_AMT , COLLATERAL_AMT ,
	MAX_LENDABLE_AMT , DPD_NOW , INSURANCE_AMT , IS_BAD_DEBT , IS_BAD_DEBT_2Y , MAX_DPD_2Y , SCORE ,
	RANK , AVG_BAL , EOP_BAL , FIRST_DISBURSE , LAST_DISBURSE , LAST_CLOSEDATE , NEW_BAL , PAIDOFF_BAL , NO_CONTRACT , NO_CONTRACT_MTD , 		TOTAL_REPAY_PRINCIPAL ,TOTAL_INTEREST_FEE , LIFE_TIME , TERM_FREQUENCY,LOAN_PURPOSE_NAME,NUMBER_OF_CHILD,MARITAL_ID 	,LOAI_KHACH_HANG,LOAI_HINH_CU_TRU,LTV)
WITH  max_2y AS (
	SELECT loan_wid,max(MAX_DPD) DPD_MAX,max(nvl(IS_BAD_DEBT,0)) IS_BAD_DEBT
FROM F88DWH.W_LOAN_DPD_PRINCIPAL_MONTHLY_F
WHERE THANG BETWEEN to_char(ADD_MONTHS(to_date(P_DATE,'YYYYMMDD'),-24),'YYYYMMDD') and to_char(ADD_MONTHS(to_date(P_DATE,'YYYYMMDD'),-12) ,'YYYYMMDD')
GROUP BY loan_wid)
,monthly_loan AS --Nguyennt: tách riêng bảng monthly, daily
(SELECT a.LOAN_WID
		,max(a.is_bad_debt )  is_bad_debt --max()
		,max(a.OVERDUE_DAYS ) OVERDUE_DAYS --max()
		,sum(a.PRINCIPAL_REMAIN)/count(DISTINCT a.date_wid) AVG_BAL
FROM F88DWH.W_LOAN_DAILY_F a
WHERE YEAR_NUM = substr(P_DATE,1,4) AND month_num = substr(P_DATE,5,2)
GROUP BY a.LOAN_WID )
,rank_ AS
(SELECT DISTINCT nvl(c.customer_code,a.customer_code) customer_code
,a.internal_score
,b.SCORE
,b."RANK"
,CASE WHEN a.internal_score IS NULL AND b.SCORE IS NULL AND b."RANK" IS NULL THEN ''
	  WHEN  b."RANK" IS NOT  NULL THEN  b."RANK"
	   WHEN  a.internal_score <=350 AND a.is_bad_debt = 1 THEN 'E'
	   WHEN  a.internal_score <=350 AND a.is_bad_debt = 0 THEN 'D'
	   WHEN  a.internal_score <=450 THEN 'C'
	   WHEN  a.internal_score <=550  THEN 'B'
	   WHEN  a.internal_score >550  THEN 'A'
	   END RANK_M
FROM F88DWH.W_LOAN_DTL_F a
JOIN F88DWH.W_FIRST_LOAN_CONTRACT_F f ON a.loan_wid = f.loan_wid
LEFT JOIN F88DWH.W_LOAN_SCORE_F b ON a.LOAN_WID =b.LOAN_WID
LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON a.CUSTOMER_WID =c.CUSTOMER_WID
WHERE a.ctr_type = 'Mới')
,dat2 as(
	SELECT substr(P_DATE,1,6) Year_month,cus.CUSTOMER_CODE,c.LOAN_CODE
		,c.DISBURSE_AMT
		,c.COLLATERAL_AMT
		,c.INSURANCE_AMT
		,max(TO_DATE(c.CLOSED_DATE_WID, 'rrrr/mm/dd') - TO_DATE(c.DISBURSE_DATE_WID, 'rrrr/mm/dd')) LIFE_TIME
		,max(CASE WHEN c.WRITEOFF_DATE_WID IS NOT null AND  c.WRITEOFF_DATE_WID <= P_DATE THEN 1 ELSE 0 END) HAVE_W0
		,c.MAX_LENDABLE_AMT
		,y.IS_BAD_DEBT IS_BAD_DEBT_2Y
		,y.DPD_MAX MAX_DPD_2Y
		,a.is_bad_debt --max()
		,a.OVERDUE_DAYS --max()
		,a.AVG_BAL
		,sum(a1.PRINCIPAL_REMAIN) EOP_BAL ---sum() du No hien tai
		,sum(DISTINCT CASE WHEN substr(c.DISBURSE_DATE_WID ,1,6)= substr(P_DATE,1,6) THEN c.DISBURSE_AMT END) NEW_BAL---sum()
		,sum(DISTINCT CASE WHEN substr(c.CLOSED_DATE_WID,1,6)= substr(P_DATE,1,6) THEN c.DISBURSE_AMT END) PAIDOFF_BAL ---sum()
		,min(c.DISBURSE_DATE_WID) FIRST_DISBURSE
		,max(c.DISBURSE_DATE_WID) LAST_DISBURSE
		,max(CASE WHEN c.CLOSED_DATE_WID <= P_DATE THEN c.CLOSED_DATE_WID END ) LAST_CLOSEDATE
		,sum(nvl(a1.TOTAL_REPAY_INTEREST,0)) TOTAL_REPAY_PRINCIPAL--goc qua han
		,sum(nvl(a1.TOTAL_REPAY_INTEREST,0) +nvl(a1.TOTAL_REPAY_FEE,0) +nvl(a1.TOTAL_REPAY_PENALTY,0)  )  TOTAL_INTEREST_FEE
		,sum(nvl(a1.TOTAL_WAIVED,0)) TOTAL_WAIVED
	FROM F88DWH.W_LOAN_DTL_F  c
	LEFT JOIN monthly_loan  a ON a.LOAN_WID =c.LOAN_WID
	left join F88DWH.W_LOAN_DAILY_F a1 on a1.LOAN_WID =c.LOAN_WID AND a1.YEAR_NUM = substr(P_DATE,1,4) AND a1.month_num = substr(P_DATE,5,2) and a1.date_wid = P_DATE
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D cus ON c.CUSTOMER_WID = cus.customer_wid
	LEFT JOIN max_2y y ON y.LOAN_WID = c.LOAN_WID
	WHERE c.DISBURSE_AMT IS NOT NULL
			AND c.DISBURSE_DATE_WID <= P_DATE
	and (c.CLOSED_DATE_WID IS NULL OR c.CLOSED_DATE_WID  <= P_DATE )
	GROUP BY  cus.CUSTOMER_CODE ,c.DISBURSE_AMT ,c.LOAN_CODE
		,c.COLLATERAL_AMT
		,c.INSURANCE_AMT
		,c.MAX_LENDABLE_AMT
		,y.IS_BAD_DEBT ,y.DPD_MAX
		,a.is_bad_debt --max()
		,a.OVERDUE_DAYS --max()
		,a.AVG_BAL
)
,dat4 AS(
	SELECT CUSTOMER_CODE,LOAN_PKG_NM,FUND_NAME,ASSET_TP_NM,CTR_TYPE,TERM_FREQUENCY,shop_wid
		,SHOP_CODE,LOAN_PURPOSE_NAME,NUMBER_OF_CHILD,MARITAL_ID,LOAI_KHACH_HANG,LOAI_HINH_CU_TRU
	FROM (
	SELECT lc.CUSTOMER_CODE ,a.LOAN_CODE
			,a.DISBURSE_DATE_WID
			,a.DISBURSE_AMT
			,a.LOAN_PKG_NM
			,nvl(a.FUND_NAME, 'F88 fund') FUND_NAME
			,watd.ASSET_TP_NM,CTR_TYPE
			,a.shop_wid
			,a.SHOP_CODE
			,CASE WHEN TERM_FREQUENCY_UNIT = 'Months' THEN TERM_FREQUENCY ELSE TERM_FREQUENCY/30.25 END  TERM_FREQUENCY
			,b.LOAN_PURPOSE_NAME
			,b.NUMBER_OF_CHILD
			,b.MARITAL_ID
			,nvl(b.LOAI_KHACH_HANG,CASE WHEN a.LOAN_TYPE LIKE '%Individual%' THEN 'Cá nhân' ELSE 'Tổ chức' END ) LOAI_KHACH_HANG
			,b.LOAI_HINH_CU_TRU
			,ROW_NUMBER () OVER( PARTITION BY lc.CUSTOMER_CODE ORDER BY a.DISBURSE_DATE_WID desc) ST
	FROM F88DWH.W_LOAN_DTL_F  a
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D  lc ON a.customer_wid = lc.customer_wid
	LEFT JOIN F88DWH.W_ASSET_TP_D watd
	        ON a.ASSET_TYPE_WID = watd.ASSET_TP_WID
	LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F  b ON a.LOAN_WID= b.LOAN_WID
	WHERE a.DISBURSE_DATE_WID <= P_DATE
	AND (a.CLOSED_DATE_WID IS NULL OR a.CLOSED_DATE_WID  <= P_DATE )
	) A
	WHERE ST=1)
,th AS (
	SELECT
	YEAR_MONTH
	,a.CUSTOMER_CODE
	,c.NUMBER_OF_CHILD
	,c.MARITAL_ID
	,c.shop_wid
	,c.shop_code
	,c.CTR_TYPE
	,c.FUND_NAME
	,c.ASSET_TP_NM LOAI_TS
	,c.LOAN_PKG_NM GOI_VAY
	,c.LOAN_PURPOSE_NAME
	,max(HAVE_W0) HAVE_W0
	,sum(CASE WHEN a.LAST_CLOSEDATE IS NULL THEN nvl(DISBURSE_AMT,0) END ) DISBURSE_AMT
	,max(nvl(a.COLLATERAL_AMT,0)) COLLATERAL_AMT--chỉnh lại lấy hạn mức tối đa
	,max(nvl(a.MAX_LENDABLE_AMT,0)) MAX_LENDABLE_AMT
	,max(a.OVERDUE_DAYS ) OVERDUE_DAYS
	,sum(nvl(a.INSURANCE_AMT,0)) INSURANCE_AMT
	,mAX(nvl(a.IS_BAD_DEBT,0)) IS_BAD_DEBT
	,max(a.IS_BAD_DEBT_2Y) IS_BAD_DEBT_2Y
	,max(a.MAX_DPD_2Y) MAX_DPD_2Y
	,d.SCORE
	,d.RANK_M
	,avg(nvl(a.AVG_BAL,0)) AVG_BAL
	,sum(nvl(a.EOP_BAL,0)) EOP_BAL
	,min(a.FIRST_DISBURSE) FIRST_DISBURSE
	,max(a.LAST_DISBURSE) LAST_DISBURSE
	,max(a.LAST_CLOSEDATE ) LAST_CLOSEDATE
	,sum(nvl(a.NEW_BAL,0)) NEW_BAL
	,sum(nvl(a.PAIDOFF_BAL,0)) PAIDOFF_BAL
	,count(a.loan_code) NO_CONTRACT --Nguyennt: 1 loan_code ứng chỉ 1 loan_wid
	,count( CASE WHEN a.LAST_CLOSEDATE IS NULL AND nvl(a.eop_bal,0) >0 THEN a.loan_code end) NO_CONTRACT_MTD --Nguyennt: 1 loan_code ứng chỉ 1 loan_wid
	,sum(nvl(a.TOTAL_REPAY_PRINCIPAL,0) )  TOTAL_REPAY_PRINCIPAL
	,sum(nvl(a.TOTAL_INTEREST_FEE,0)) TOTAL_INTEREST_FEE
	,sum(nvl(a.LIFE_TIME,0))/30.25 LIFE_TIME
	,c.TERM_FREQUENCY
	,c.LOAI_KHACH_HANG
	,c.LOAI_HINH_CU_TRU
FROM dat2 a
LEFT JOIN dat4 c ON a.CUSTOMER_CODE = c.CUSTOMER_CODE
LEFT JOIN rank_ d ON a.CUSTOMER_CODE = d.CUSTOMER_CODE
GROUP BY YEAR_MONTH,a.CUSTOMER_CODE,c.shop_wid,c.shop_code
		,c.FUND_NAME,c.TERM_FREQUENCY
		,c.ASSET_TP_NM
		,c.LOAN_PKG_NM
		,c.CTR_TYPE,c.LOAN_PURPOSE_NAME,c.NUMBER_OF_CHILD,c.MARITAL_ID,c.LOAI_KHACH_HANG
		,c.LOAI_HINH_CU_TRU,d.SCORE,d.RANK_M
)
SELECT YEAR_MONTH
	,CUSTOMER_CODE
	,SHOP_WID
	,SHOP_CODE
	,CTR_TYPE
	,FUND_NAME
	,max(HAVE_W0) HAVE_W0
	,LISTAGG(LOAI_TS, ',') WITHIN GROUP(ORDER BY LOAI_TS ) AS  LOAI_TS
	,GOI_VAY
	,sum( nvl(DISBURSE_AMT,0) ) DISBURSE_AMT
	,max(nvl(COLLATERAL_AMT,0)) COLLATERAL_AMT--chỉnh lại lấy hạn mức tối đa
	,max(MAX_LENDABLE_AMT  ) MAX_LENDABLE_AMT
	,max(OVERDUE_DAYS ) DPD_NOW
	,sum(nvl(INSURANCE_AMT,0)) INSURANCE_AMT
	,mAX(nvl(IS_BAD_DEBT,0)) IS_BAD_DEBT
	,max(IS_BAD_DEBT_2Y) IS_BAD_DEBT_2Y
	,max(MAX_DPD_2Y) MAX_DPD_2Y
	,SCORE
	,RANK_M RANK
	,avg(nvl(AVG_BAL,0)) AVG_BAL
	,sum(nvl(EOP_BAL,0)) EOP_BAL
	,min(FIRST_DISBURSE) FIRST_DISBURSE
	,max(LAST_DISBURSE) LAST_DISBURSE
	,max(LAST_CLOSEDATE ) LAST_CLOSEDATE
	,sum(nvl(NEW_BAL,0)) NEW_BAL
	,sum(nvl(PAIDOFF_BAL,0)) PAIDOFF_BAL
	,sum(nvl(NO_CONTRACT,0)) NO_CONTRACT
	,sum(nvl(NO_CONTRACT_MTD,0)) NO_CONTRACT_MTD
	,sum(nvl(TOTAL_REPAY_PRINCIPAL,0)) TOTAL_REPAY_PRINCIPAL
	,sum(nvl(TOTAL_INTEREST_FEE,0)) TOTAL_INTEREST_FEE
	,LIFE_TIME
	,TERM_FREQUENCY
	,LOAN_PURPOSE_NAME
	,NUMBER_OF_CHILD
	,MARITAL_ID
	,LOAI_KHACH_HANG
	,LOAI_HINH_CU_TRU
	,CASE WHEN sum(nvl(COLLATERAL_AMT,0)) = 0 THEN 0 ELSE sum( nvl(DISBURSE_AMT,0) - nvl(INSURANCE_AMT,0))/sum(nvl(COLLATERAL_AMT,0)) END LTV
FROM TH
WHERE customer_code IS NOT NULL
GROUP BY YEAR_MONTH,CUSTOMER_CODE,SHOP_WID,SHOP_CODE,SCORE,RANK_M
,CTR_TYPE,FUND_NAME,TERM_FREQUENCY,GOI_VAY,LIFE_TIME,LOAN_PURPOSE_NAME,NUMBER_OF_CHILD,MARITAL_ID,LOAI_KHACH_HANG,LOAI_HINH_CU_TRU
;
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_BANCA_F'  ;
INSERT INTO F88DWH.W_RPT_BANCA_F
(YEAR_MONTH , CUSTOMER_CODE , CREATE_DATE , FINISH_SHOP_WID  , APE_PREMIUM, NO_BANCA)
WITH dat2 AS(
	SELECT substr(P_DATE,1,6) YEAR_MONTH,nvl(b1.CUSTOMER_CODE,b2.CUSTOMER_CODE) CUSTOMER_CODE
		,min(to_char(b.CREATED_DT,'YYYYMMDD')) CREATE_DATE --Nguyennt: quét bảng W_INS_CONTRACT_F
		,b.FINISH_SHOP_WID
		,sum(b.CONTRACT_AMT) APE_PREMIUM --Nguyennt: CONTRACT_AMT
		,count(DISTINCT b.CONTRACT_NO) NO_BANCA
	FROM F88DWH.W_INS_CONTRACT_F b
	LEFT JOIN f88dwh.VW_W_CUSTOMER_D  b1  ON b.CUSTOMER_WID = b1.CUSTOMER_WID
	LEFT JOIN F88DWH.VW_W_INS_CUSTOMER_D b2 ON b.CUSTOMER_WID = b2.CUSTOMER_WID
	WHERE b.STATE  IN (1,4)
		AND to_char(b.CREATED_DT,'YYYYMMDD') <= substr(P_DATE,1,6)
	GROUP BY nvl(b1.CUSTOMER_CODE,b2.CUSTOMER_CODE),b.FINISH_SHOP_WID)
,shop AS (
	SELECT a.CUSTOMER_CODE,a.FINISH_SHOP_WID,ROW_NUMBER () OVER( PARTITION BY a.CUSTOMER_CODE ORDER BY a.APE_PREMIUM asc) ST
	FROM dat2 a
	JOIN (SELECT CUSTOMER_CODE,max(CREATE_DATE) CREATE_DATE FROM dat2 GROUP BY CUSTOMER_CODE ) b ON a.CUSTOMER_CODE = b.CUSTOMER_CODE AND a.CREATE_DATE = b.CREATE_DATE
)
	SELECT a.YEAR_MONTH,a.CUSTOMER_CODE
		,min(a.CREATE_DATE) CREATE_DATE
		,b.FINISH_SHOP_WID
	---	,sum(a.FEE) FEE
		,sum(a.APE_PREMIUM) APE_PREMIUM
	----	,sum(a.OPTION_FEE) OPTION_FEE
		,sum(a.NO_BANCA) NO_BANCA
	FROM dat2 a
	LEFT JOIN shop b ON a.CUSTOMER_CODE = b.CUSTOMER_CODE and b.ST = 1
	GROUP BY a.YEAR_MONTH,a.CUSTOMER_CODE,b.FINISH_SHOP_WID;


EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_CUS_DEMO' ;
COMMIT;



INSERT INTO F88DWH.W_RPT_CUS_DEMO
(YEAR_MONTH ,CUSTOMER_WID , CUSTOMER_CODE , BIRTH_DAY , GENDER_CODE , CRN_ROW_IND , PROVINCE , JOB_TP , JOB , INDUSTRY_CODE,
CUSTOMER_INCOME , CUSTOMER_TYPE, CUSTOMER_SOURCE  , IS_F88,MONTHLY_INCOME ,B_SCORE,SHOP_NM_POL,REGION_SHOP_POL  )
WITH pol AS (SELECT f.CUSTOMER_CODE
		,a.GROUP_NM
		,d.REGION
		,d.PROVINCE
	FROM F88DWH.W_POL_DTL_F A
	LEFT JOIN F88DWH.W_LOAN_DTL_F b ON a.LOAN_WID =b.LOAN_WID
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D f ON b.CUSTOMER_WID  =f.CUSTOMER_WID
	LEFT JOIN f88dwh.W_AREA_MANAGER_D d ON trim(d.SHOP_ID)  = a.GROUP_ID
	WHERE A.YEAR_NUM = substr(P_DATE,1,4) AND  A.MONTH_NUM = substr(P_DATE,5,2) AND  A.DISBURSE_DT = P_DATE
	AND a.STATUS_NM <> 'Hủy đăng ký')
, hrm AS (
	SELECT DISTINCT a.EMPLOYEE_CODE,b.EMAIL,b.PHONE,a.EMAIL_PERSONAL,a.ID_NO,a.EMPLOYEE_NAME,POSITION_NAME,b.DATEOFBIRTH,a.TRANGTHAI
	FROM  F88DWH.VW_W_HRM_EMPLOYEE_INFOR_D  a
	LEFT JOIN F88DWH.VW_W_EMPLOYEE_D b on b.EMPLOYEE_CODE = a.EMPLOYEE_CODE
	and to_date(P_DATE,'YYYYMMDD') >= b.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < b.VALID_TO_DT
	 WHERE lower(EMPLOYEE_NAME) NOT LIKE '%test%'
	 AND to_date(P_DATE,'YYYYMMDD') >= a.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < a.VALID_TO_DT
),
cus AS (
SELECT a.CUSTOMER_CODE ,a.CUSTOMER_NM,nvl(c.phone_num,a.phone_num) PHONE_NUM,BIRTH_DAY,ID_NUM,EMAIL
FROM  F88DWH.VW_W_CUSTOMER_D a
LEFT JOIN F88DWH.VW_W_CUSTOMER_PHONE_F c ON a.CUSTOMER_CODE = c.CUSTOMER_CODE AND c.IS_PRIMARY = 1
WHERE  to_date(P_DATE,'YYYYMMDD') >= a.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < a.VALID_TO_DT ),
hrm2 AS (
		SELECT   a.*
		,ROW_NUMBER () OVER( PARTITION BY a.CUSTOMER_CODE ORDER BY a.RULE_MAP asc) ST
		FROM (
		(SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 1' RULE_MAP
		FROM cus a
		JOIN hrm b ON a.ID_NUM = b.ID_NO AND a.BIRTH_DAY =b.DATEOFBIRTH AND a.PHONE_NUM =b.PHONE AND b.EMPLOYEE_NAME = a.CUSTOMER_NM
		)
		UNION ALL
		(SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 2' RULE_MAP
		FROM cus a
		 JOIN hrm b1 ON a.ID_NUM = b1.ID_NO AND a.BIRTH_DAY =b1.DATEOFBIRTH AND a.PHONE_NUM =b1.PHONE
		 )
		 UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 3' RULE_MAP
		FROM cus a
		 JOIN hrm b2 ON a.ID_NUM = b2.ID_NO AND a.PHONE_NUM =b2.PHONE
		)
		 UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 4' RULE_MAP
		FROM cus a
		JOIN hrm b3 ON a.ID_NUM = b3.ID_NO AND a.BIRTH_DAY =b3.DATEOFBIRTH
		)
		UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 5' RULE_MAP
		FROM F88DWH.VW_W_CUSTOMER_D a
		 JOIN hrm b4 ON a.ID_NUM = b4.ID_NO
		 WHERE a.ID_NUM IS NOT null)
		 UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 6' RULE_MAP
		FROM F88DWH.VW_W_CUSTOMER_D a
		 JOIN hrm b5 ON a.PHONE_NUM =b5.PHONE AND a.EMAIL = b5.EMAIL_PERSONAL
		)
 		UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 7' RULE_MAP
		FROM F88DWH.VW_W_CUSTOMER_D a
		 JOIN hrm b5 ON a.PHONE_NUM =b5.PHONE ----AND a.EMAIL = b5.EMAIL_PERSONAL
		)
		 )A)
SELECT substr(P_DATE,1,6) YEAR_MONTH
			,b.CUSTOMER_WID
			,b.CUSTOMER_CODE
			,b.BIRTH_DAY
			,b.GENDER_CODE
			,b.CRN_ROW_IND
			,c.PROVINCE_NAME PROVINCE
			,b.JOB_TP	--16
			,b.JOB	--13
			,b.INDUSTRY_CODE
			,b.CUSTOMER_INCOME
			,b.CUSTOMER_TYPE
			,b.CUSTOMER_SOURCE
			,CASE WHEN h.customer_code IS NULL THEN 0 ELSE 1 END IS_F88
			,b.MONTHLY_INCOME
			,f."RANK" B_SCORE
			,p.GROUP_NM SHOP_NM_POL
			,p.REGION REGION_SHOP_POL
FROM  F88DWH.VW_W_CUSTOMER_D b
LEFT JOIN F88DWH.VW_W_customer_place_D c ON b.customer_code = c.customer_code AND  to_date(P_DATE,'YYYYMMDD') >= c.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < c.VALID_TO_DT AND c.place_type = 3
LEFT JOIN hrm2 h ON b.CUSTOMER_CODE = h.CUSTOMER_CODE and h.ST = 1
LEFT JOIN F88DWH.W_B_SCORE_F f ON b.CUSTOMER_CODE = to_char(f.CUSTOMER_CODE)
LEFT JOIN pol p ON b.CUSTOMER_CODE = p.CUSTOMER_CODE
WHERE to_date(P_DATE,'YYYYMMDD') >= b.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < b.VALID_TO_DT
AND b.SOURCE = 'CIF'
;


EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_TBL_CUS_SUMMARY';

COMMIT;
insert into F88DWH.W_TBL_CUS_SUMMARY
(YEAR_MONTH , CUSTOMER_WID , CUSTOMER_CODE , GENDER_CODE , PROVINCE , JOB_TP , JOB,INDUSTRY_CODE , CUSTOMER_INCOME , CUSTOMER_TYPE , CUSTOMER_SOURCE , NUMBER_OF_CHILD ,
	IS_F88 , MARITAL_ID , AGE , SHOP_WID , SHOP_CODE , DISBURSE_AMT , COLLATERAL_AMT , MAX_LENDABLE_AMT , DPD_NOW , IS_BAD_DEBT ,
	IS_BAD_DEBT_2Y , MAX_DPD_2Y , SCORE , A_SCORE, BSCORE , AVG_BAL , EOP_BAL , FIRST_DISBURSE , LAST_DISBURSE , LAST_CLOSEDATE , NEW_BAL , PAIDOFF_BAL , NO_CONTRACT , NO_CONTRACT_MTD ,
	TOTAL_REPAY_PRINCIPAL , TOTAL_INTEREST_FEE , LIFE_TIME , TERM_FREQUENCY , PRETIME , ONTIME, INSURANCE_AMT , TOI , PENALTY_FEE , FIRST_BANCA ,
	FINISH_SHOP_WID  , APE_PREMIUM  , NO_BANCA , CUS_TYPE , CTR_TYPE , SO_TIEN_DA_TRA , FUND_NAME , LOAI_TS , GOI_VAY , VAS_USING , VAS_AMT , HAVE_W0,LOAN_PURPOSE_NAME,MONTHLY_INCOME,OVERDUE_PENALTY,RECOVERY,WO_BALANCE,SHOP_NM_POL,REGION_SHOP_POL,NGUON_KH,CUSTOMER_SUBSOURCE,CUSTOMER_SUBSOURCE_PARTNER,CUSTOMER_SUBSOURCE_CAMPAIGN,LOAI_KHACH_HANG,LOAI_HINH_CU_TRU,LTV)
WITH toi_ AS
(SELECT YEAR_MONTH,CUSTOMER_CODE,sum(nvl(REVENUE_TO_F88,0)) TOI
		,sum(nvl(PENALTY_FEE,0))  PENALTY_FEE
		,sum(nvl(OVERDUE_PENALTY,0)) OVERDUE_PENALTY
		,sum(nvl(RECOVERY,0)) RECOVERY
		,sum(nvl(WO,0)) WO_BALANCE
FROM F88DWH.W_RPT_TOI_MONTHLY
GROUP BY YEAR_MONTH,CUSTOMER_CODE ),
vas AS (SELECT CUSTOMER_CODE,sum(MONEYTOTAL) VAS_AMT
	FROM F88DWH.W_RPT_VAS_CUS
	WHERE substr(TRANSACTIONDATE,1,6) = substr(P_DATE,1,6)
	GROUP BY CUSTOMER_CODE),
dat AS (
	SELECT a.LOAN_WID ,a.CUSTOMER_WID
		,nvl(b.CUSTOMER_CODE ,a.customer_code) customer_code
		,a.DISBURSE_DATE_WID FIRST_DT
	FROM F88DWH.W_LOAN_DTL_F a
	JOIN F88DWH.W_FIRST_LOAN_CONTRACT_F f ON a.loan_wid = f.loan_wid
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D b ON a.CUSTOMER_WID = b.CUSTOMER_WID
	WHERE a.ctr_type = 'Mới' )
,pol	 AS (
	SELECT f.CUSTOMER_CODE
		,a.SOURCE_LEVEL_1_NAME CUSTOMER_SOURCE
		,a.SOURCE_LEVEL_2_NAME CUSTOMER_SUBSOURCE
		,a.SOURCE_LEVEL_3_NAME CUSTOMER_SUBSOURCE_PARTNER---  ,,
```

### `DEVDWH.PKG_KPI_KEY_DRIVER_BY_SHOP` (PACKAGE BODY) — 10 lines reference search term

```
PACKAGE BODY        PKG_KPI_KEY_DRIVER_BY_SHOP
AS

/*
* -- Author: NganNT8
* -- Created: 2024-01-18
* -- Purpose: Phục vụ BDM theo dõi các chỉ số kinh doanh
*/

PROCEDURE SALE_LEAD (P_DATE NUMBER)
IS
BEGIN

/*
 * asignee: hanhdtm
 */

-- 2.2. Insert new data
dbms_output.put_line('----> START TIME:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

EXECUTE IMMEDIATE 'TRUNCATE TABLE DEVDWH.W_RPT_ONLINE_TMP';

COMMIT;

INSERT /*+ append parallel(6) */ INTO DEVDWH.W_RPT_ONLINE_TMP
SELECT
        YEAR_NUM,
        MONTH_NUM,
        date1 REPORT_DT,
        SHOP_CODE,
        CALLER_CODE,
        SALER_CODE,
        CHANNEL_CODE,
        FORM_ASSET,
        ASSET,
        CAMPAIGN,
        NHOM_NGUON,
        NGUON_PHU,
        PHAN_LOAI_NGUON_PHU,
        URL,
        ctr_type,
        SUM(Form_TT) Form_TT,
        SUM(Form_TLS) Form_TLS,
        SUM(Lead_PGD) Lead_PGD,
        SUM(Sale) Sale,
        SUM(Giai_ngan) Giai_ngan,
        SUM(Lead_TLS) Lead_TLS,
        SUM(Sale_TLS) Sale_TLS,
        SUM(Giai_ngan_TLS) Giai_ngan_TLS,
        CHANNEL_STR,
        sum(F_cancel_in_month) F_cancel_in_month,
        sum(S_in_month) S_in_month,
        ASSET_TYPE_NAME ,
        sum(F_cancel) F_cancel
FROM (
--3. sum Lead PGD
        (   SELECT
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) YEAR_NUM,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) MONTH_NUM,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                0 AS Form_TT,
                0 AS Form_TLS,
                SUM(CASE WHEN PO.FIRST_SHOP_TRANS_DT  IS NOT NULL THEN 1 ELSE 0 END) AS Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
    FROM F88DWH.W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TRIM(m.SHOP_ID)= TO_CHAR(po.group_id)
        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
  WHERE 1=1
       AND TRUNC(PO.FIRST_SHOP_TRANS_DT) > ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1
  GROUP BY
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) ,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) ,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ),
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM ,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
                po.SOURCE_LEVEL_1_NAME,
                po.FORM_ASSET_TP_NM)
UNION  ALL
-- 4. sum sale TT và Giải ngân TT
        (
        SELECT
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                0 AS Form_TT,
                0 AS Form_TLS,
                0 AS Lead_PGD,
                COUNT(po.LOAN_CODE)  AS Sale,
                SUM(po.DISBURSE_AMT) AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND trunc(po.FORM_CREATED_DT) = TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  THEN 1 ELSE 0 END ) S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TRIM(m.SHOP_ID)= TO_CHAR(po.group_id)
        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
                AND TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  > ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1
                AND po.STATUS_NM ='Nhận cầm cố'
        GROUP BY
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM ,
                po.LOAN_ASSET_TP_NM,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
                po.SOURCE_LEVEL_1_NAME,
                po.FORM_ASSET_TP_NM
       )
    UNION  ALL
--6. HDMM nhập thẳng trên LOS không qua PAWN_ONLINE_WID
        (
SELECT
        to_number(substr(a.DISBURSE_DATE_WID, 1, 4)) year_num,
        to_number(substr(a.DISBURSE_DATE_WID, 5, 2)) month_num,
        to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') date1,
        CASE WHEN REGEXP_LIKE(sh.SHOP_CODE, '^[[:digit:]]+$') THEN to_number(sh.SHOP_CODE) ELSE NULL END shop_code ,
        NULL caller_name,
        NULL caller_code,
        a.CHANNEL_CODE ,
        c.ASSET_TP_NM form_asset,
        c.ASSET_TP_NM asset,
        r.RESOURCES_NM campaign,
        CASE
                WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END NHOM_NGUON,
        'LOS' nguon_phu,
        NULL phan_loai_nguon_phu,
        NULL url,
        a.CTR_TYPE,
        count(a.LOAN_WID) form_tt,
        0 form_tls,
        count(a.LOAN_WID) lead_pgd,
        count(a.LOAN_WID) sale,
        sum(a.DISBURSE_AMT) giai_ngan,
        0 Lead_TLS,
        0 Sale_TLS,
        0 Giai_ngan_TLS,
        'Marketing PGD' SOURCE,
        0 F_cancel_in_month,
        0 S_in_month,
        c.ASSET_TP_NM ASSET_TYPE_NAME,
        0 F_cancel
FROM
    F88DWH.W_LOAN_DTL_F a
LEFT JOIN F88DWH.W_POL_DTL_F b ON a.LOAN_WID =b.LOAN_WID
LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID =a.ASSET_TYPE_WID
LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =A.LOAN_WID
LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
LEFT JOIN F88DWH.W_SHOP_D sh ON sh.SHOP_WID = a.SHOP_WID
WHERE 1 = 1
    AND b.LOAN_CODE  IS NULL
    AND to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') > ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1
GROUP BY
        to_number(substr(a.DISBURSE_DATE_WID, 1, 4)),
        to_number(substr(a.DISBURSE_DATE_WID, 5, 2)),
        to_date(a.DISBURSE_DATE_WID, 'yyyymmdd'),
        sh.SHOP_CODE ,
        a.CHANNEL_CODE ,
        c.ASSET_TP_NM,
        r.RESOURCES_NM,
        a.CTR_TYPE,
        CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END
        )
)
GROUP BY
        YEAR_NUM,
        MONTH_NUM,
        date1,
        shop_code,
        CALLER_CODE,
        SALER_CODE,
        Channel_code,
        FORM_ASSET,
        ASSET,
        CAMPAIGN,
        NHOM_NGUON,
        NGUON_PHU,
        PHAN_LOAI_NGUON_PHU,
        URL,
        ctr_type,
        CHANNEL_STR,
        ASSET_TYPE_NAME ;

COMMIT;

dbms_output.put_line('----> DONE INSERT SUCCESS SALE_LEAD AT: '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

END;



---

PROCEDURE DUNO (P_DATE NUMBER)
IS
BEGIN
DELETE /*+ append parallel(6) */ FROM DEVDWH.W_KPI_KEY_DRIVER_BY_SHOP_F WHERE YEAR_NUM = SUBSTR(P_DATE, 1,4) AND MONTH_NUM = SUBSTR(P_DATE,5,2) AND DATE_WID = P_DATE AND KPI IN ('%RFW B0-B1 monthly 2W','%RFW B0-B1 monthly 4W','%RFW B0-B1 monthly total','%Rút gốc 2W','%Rút gốc 4W','DNQH','KH active 4W','KH active 2W','KH lũy kế 4W', 'Same Month Closed','KH lũy kế 2W','DNQH',
																																													'Dư nợ B1A','Dư nợ B1B','Dư nợ B2','Dư nợ B3','Dư nợ B3+','Dư nợ BQ','Dư nợ BQ DPD0','Dư nợ DPD 1-90','Dư nợ DPD0','Dư nợ DPD0 KHM 2W','Dư nợ DPD0 KHM 4W','Dư nợ DPD0 KHQL 2W','Dư nợ DPD0 KHQL 4W','Dư nợ DPD0 đầu kỳ','Dư nợ WO',
/*
 * asignee: ngannt8
 */																																													'Giải ngân','Giải ngân KHM','Giải ngân KHM 2W','Giải ngân KHM 4W','Giải ngân KHQL','HĐMM 2W','HĐMM 4W','Lãi phí thực thu','Roll Back','Roll Back monthly 2W','Roll Back monthly 4W','Roll Forward','Roll Forward monthly 2W','Roll Forward monthly 4W',
																																													'Rút gốc','Rút gốc 2W','Rút gốc 4W','Tăng Net', 'Giải ngân KHM (KPI)','Giải ngân KHQL (KPI)'
);
COMMIT;
INSERT /*+ append parallel(8) */ INTO DEVDWH.W_KPI_KEY_DRIVER_BY_SHOP_F(YEAR_NUM, MONTH_NUM, DATE_WID, SHOP_WID , SHOP_CODE ,SHOP_NM, KPI_CODE, KPI, VALUE_, tu_so, mau_so,KPI_TYPE)

WITH smc AS (SELECT
	a.SHOP_WID ,
	b.SHOP_CODE ,
	b.SHOP_NM ,
	sum(a.DISBURSE_AMT)/1e6 samemonth_closed
FROM F88DWH.W_LOAN_DTL_F a
LEFT JOIN F88DWH.W_SHOP_D b ON b.SHOP_WID = a.SHOP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
WHERE 1=1
AND DISBURSE_DATE_WID >= to_char(trunc(to_date(P_DATE,'yyyymmdd'),'mm'),'yyyymmdd')
AND DISBURSE_DATE_WID <= P_DATE
AND (CASE WHEN a.DISBURSE_DATE_WID >=20240515 AND a.CHANNEL_CODE ='E2E' THEN 'KDML' ELSE a.CHANNEL_CODE END) ='KDML'
AND substr(a.DISBURSE_DATE_WID,1,6)=substr(nvl(a.CLOSED_DATE_WID,0),1,6)
GROUP BY
	a.SHOP_WID ,
	b.SHOP_CODE ,
	b.SHOP_NM),
WO AS (
SELECT
	a.SHOP_WID,
	b.SHOP_CODE,
	b.SHOP_NM,
	CASE WHEN c.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN c.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END SP,
	sum(CASE WHEN a.DATE_WID = P_DATE AND a.IS_BAD_DEBT=1 AND a.STATUS !=603 THEN a.PRINCIPAL_REMAIN ELSE 0 END)/1e6 WO
FROM F88DWH.W_LOAN_DAILY_F a
LEFT JOIN F88DWH.W_SHOP_D b ON b.SHOP_WID = a.SHOP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
LEFT JOIN F88DWH.W_LOAN_DTL_F d ON d.LOAN_WID = a.LOAN_WID
WHERE 1=1
AND YEAR_NUM = substr(P_DATE,1,4)
AND MONTH_NUM = substr(P_DATE,5,2)
AND DATE_WID = P_DATE
GROUP BY
	a.SHOP_WID,
	b.SHOP_CODE,
	b.SHOP_NM ,
	CASE WHEN c.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN c.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END
),
EOP AS (
SELECT
	A.SHOP_WID,
	C.SHOP_CODE,
	C.SHOP_NM,
	CASE WHEN b.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN b.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END SP,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND a.PS_BAD_DEBT = 0 THEN DPD0_AMT ELSE 0 END)/1e6 EOP,
	(sum(CASE WHEN a.PS_BAD_DEBT = 0 AND PS_STATUS = 300 THEN DPD0_AMT ELSE 0 END)/1e6) EOP_ACC,
	to_number(substr(P_DATE,7,2)) DAY_NUM,
	(sum(CASE WHEN a.PS_BAD_DEBT = 0 AND PS_STATUS = 300 THEN DPD0_AMT ELSE 0 END)/1e6)/to_number(substr(P_DATE,7,2)) AVG_EOP,
	sum(CASE WHEN a.DATE_WID = P_DATE AND LM_STATUS != 603 THEN MTD_RF01_AMT ELSE 0 END)/1e6 RF01,
	(sum(CASE WHEN a.PS_BAD_DEBT = 0 AND PS_STATUS = 300 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6) DUNO_ACC,
	(sum(CASE WHEN a.PS_BAD_DEBT = 0 AND PS_STATUS = 300 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6)/to_number(substr(P_DATE,7,2)) AVG_DUNO,
	sum(CASE WHEN PS_STATUS != 603 AND IS_CLOSED_SAMEDAY=0 THEN DAILY_TT_AMT ELSE 0 END)/1e6+ sum(CASE WHEN PS_STATUS != 603 AND IS_CLOSED_SAMEDAY=0 THEN DAILY_TG_AMT ELSE 0 END)/1e6 RG,
	sum(CASE WHEN PS_STATUS != 603 THEN DAILY_TT_AMT ELSE 0 END)/1e6+ sum(CASE WHEN PS_STATUS != 603 THEN DAILY_TG_AMT ELSE 0 END)/1e6 RG_,
	sum(CASE WHEN a.DATE_WID = P_DATE THEN a.MTD_GN_AMT ELSE 0 END)/1e6 GN,
	sum(CASE WHEN a.DATE_WID = P_DATE AND a.IS_CLOSED_SAMEDAY = 0 AND a.CTR_TYPE NOT IN ('Tái tục') THEN a.MTD_GN_NUM ELSE 0 END) HDMM,
	sum(CASE WHEN a.DATE_WID = P_DATE AND a.CTR_TYPE = 'Mới' THEN a.MTD_GN_AMT ELSE 0 END)/1e6 GN_KHM,
	sum(CASE WHEN a.DATE_WID = P_DATE AND a.CTR_TYPE NOT IN ('Mới') THEN a.MTD_GN_AMT ELSE 0 END)/1e6 GN_KHQL,
	sum(CASE WHEN a.DATE_WID = P_DATE AND a.CTR_TYPE = 'Mới' AND a.IS_CLOSED_SAMEDAY =0 THEN a.MTD_GN_AMT ELSE 0 END)/1e6 GN_KHM_NET,
	sum(CASE WHEN a.DATE_WID = P_DATE AND a.CTR_TYPE NOT IN ('Mới', 'Tái tục') AND a.IS_CLOSED_SAMEDAY =0 THEN a.MTD_GN_AMT ELSE 0 END)/1e6 GN_KHQL_NET,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND a.PS_BAD_DEBT = 0 AND a.CTR_TYPE = 'Mới' THEN DPD0_AMT ELSE 0 END)/1e6 EOP_KHM,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND a.PS_BAD_DEBT = 0 AND a.CTR_TYPE NOT IN ('Mới') THEN DPD0_AMT ELSE 0 END)/1e6 EOP_KHQL,
	sum(CASE WHEN PS_STATUS = 300 THEN DAILY_RF_AMT ELSE 0 END)/1e6 RF,
	sum(CASE WHEN PS_STATUS = 300 THEN DAILY_RB_AMT ELSE 0 END)/1e6 RB,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 THEN MTD_RF_AMT ELSE 0 END)/1e6 RF_MTD,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 THEN MTD_RB_AMT ELSE 0 END)/1e6 RB_MTD,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND PS_BAD_DEBT = 0 AND a.GROUP_DEBT BETWEEN 1 AND 6 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 DN1_90,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND PS_BAD_DEBT = 0 AND a.GROUP_DEBT >1 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 DNQH_NOTWO,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND PS_BAD_DEBT = 0 AND a.GROUP_DEBT BETWEEN 1 AND 3 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 DNB1A,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND PS_BAD_DEBT = 0 AND a.GROUP_DEBT = 4 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 DNB1B,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND PS_BAD_DEBT = 0 AND a.GROUP_DEBT = 5 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 DNB2,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND PS_BAD_DEBT = 0 AND a.GROUP_DEBT = 6 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 DNB3,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_STATUS = 300 AND PS_BAD_DEBT = 0 AND a.GROUP_DEBT > 6 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 DNB3_,
	sum(CASE WHEN a.DATE_WID = P_DATE AND PS_BAD_DEBT = 1 THEN PRINCIPAL_REMAIN ELSE 0 END)/1e6 WO
FROM
	DEVDWH.W_RPT_LOAN_TRAFFIC_F a
LEFT JOIN F88DWH.W_ASSET_TP_D b ON b.ASSET_TP_WID = a.ASSET_TYPE_WID
LEFT JOIN F88DWH.W_SHOP_D c ON c.SHOP_WID = a.SHOP_WID
WHERE
	1 = 1
	AND YEAR_NUM = to_number(substr(P_DATE, 1, 4))
	AND MONTH_NUM = to_number(substr(P_DATE, 5, 2))
	AND DATE_WID <= P_DATE
	AND CHANNEL_CODE_FLAG ='KDML'
GROUP BY
	A.SHOP_WID,
	C.SHOP_CODE,
	C.SHOP_NM,
	CASE WHEN b.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN b.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END
	),
EOP_BF AS ( -- tính mẫu cho chỉ số RFB0B1 theo logic QLTS + QTRR (ko loại bad debt, lấy total toàn cty)
SELECT
	A.SHOP_WID,
	C.SHOP_CODE,
	C.SHOP_NM,
	CASE WHEN b.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN b.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END  SP,
	sum(CASE WHEN PS_STATUS != 603 THEN DPD0_AMT ELSE 0 END)/1e6 EOP_BF,
	sum(CASE WHEN PS_STATUS = 300 AND a.PS_BAD_DEBT = 0 THEN DPD0_AMT ELSE 0 END)/1e6 EOP_MO
FROM
	DEVDWH.W_RPT_LOAN_TRAFFIC_F a
LEFT JOIN F88DWH.W_ASSET_TP_D b ON b.ASSET_TP_WID = a.ASSET_TYPE_WID
LEFT JOIN F88DWH.W_SHOP_D c ON c.SHOP_WID = a.SHOP_WID
WHERE
	1 = 1
	AND YEAR_NUM = TO_NUMBER(TO_CHAR(TRUNC(TO_DATE(P_DATE,'YYYYMMDD'),'MM')-1,'YYYY'))
	AND MONTH_NUM = TO_NUMBER(TO_CHAR(TRUNC(TO_DATE(P_DATE,'YYYYMMDD'),'MM')-1,'MM'))
	AND DATE_WID = TO_NUMBER(TO_CHAR(TRUNC(TO_DATE(P_DATE,'YYYYMMDD'),'MM')-1,'YYYYMMDD'))
	AND CHANNEL_CODE_FLAG ='KDML'
GROUP BY
	A.SHOP_WID,
	C.SHOP_CODE,
	C.SHOP_NM,
	CASE WHEN b.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN b.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END
),
RF01 AS (
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, SUM(TU_SO)/NULLIF(SUM(MAU_SO),0) VALUE_, SUM(TU_SO) TU_SO, SUM(MAU_SO) MAU_SO
FROM (
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, RF01 TU_SO, 0 MAU_SO FROM EOP
UNION
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, 0 TU_SO, EOP_BF MAU_SO FROM EOP_BF
)
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM, SP
),
RG AS (
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, SUM(TU_SO)/NULLIF(SUM(MAU_SO),0) VALUE_, SUM(TU_SO) TU_SO, SUM(MAU_SO) MAU_SO
FROM (
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, RG TU_SO, 0 MAU_SO FROM EOP
UNION
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, 0 TU_SO, EOP_BF MAU_SO FROM EOP_BF
)
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM, SP
),
NET AS (
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, EOP, 0 EOP_MO FROM EOP
UNION ALL
SELECT SHOP_WID, SHOP_CODE, SHOP_NM, SP, 0 EOP, EOP_MO FROM EOP_BF
),
cuml AS (
SELECT
	a.SHOP_WID ,
	c.SHOP_CODE ,
	c.SHOP_NM ,
	CASE WHEN e.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN e.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END SP,
	count(DISTINCT b.CUSTOMER_CODE) cus_cuml
FROM F88DWH.W_LOAN_DTL_F a
LEFT JOIN F88DWH.VW_W_CUSTOMER_D b ON b.CUSTOMER_WID = a.CUSTOMER_WID
LEFT JOIN F88DWH.W_SHOP_D c ON c.SHOP_WID = a.SHOP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D e ON e.ASSET_TP_WID = a.ASSET_TYPE_WID
WHERE 1=1
AND a.DISBURSE_DATE_WID <= P_DATE
AND (CASE WHEN a.DISBURSE_DATE_WID >=20240515 AND a.CHANNEL_CODE ='E2E' THEN 'KDML' ELSE a.CHANNEL_CODE END) ='KDML'
GROUP BY
	a.SHOP_WID ,
	c.SHOP_CODE ,
	c.SHOP_NM,
	CASE WHEN e.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN e.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END
	),
active AS (
SELECT
	a.SHOP_WID ,
	d.SHOP_CODE ,
	d.SHOP_NM ,
	CASE WHEN e.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN e.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END SP,
	count(DISTINCT b.CUSTOMER_CODE) cus_num
FROM F88DWH.W_LOAN_DAILY_F a
LEFT JOIN F88DWH.W_LOAN_DTL_F b ON b.LOAN_WID = a.LOAN_WID
LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON c.CUSTOMER_WID = a.CUSTOMER_WID
LEFT JOIN F88DWH.W_SHOP_D d ON d.SHOP_WID = a.SHOP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D e ON e.ASSET_TP_WID = b.ASSET_TYPE_WID
WHERE 1=1
AND a.YEAR_NUM = substr(P_DATE,1,4)
AND a.MONTH_NUM = substr(P_DATE,5,2)
AND a.DATE_WID = P_DATE
AND a.STATUS = '300'
AND a.IS_BAD_DEBT = 0
AND (CASE WHEN b.DISBURSE_DATE_WID >=20240515 AND b.CHANNEL_CODE ='E2E' THEN 'KDML' ELSE b.CHANNEL_CODE END) = 'KDML'
GROUP BY
	a.SHOP_WID ,
	d.SHOP_CODE ,
	d.SHOP_NM ,
	CASE WHEN e.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN e.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END
	)
SELECT * FROM (
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.1' AS KPI_CODE, 'Dư nợ DPD0' KPI, SUM(EOP) VALUE_, NULL TU_SO, NULL MAU_SO, 'KPI' KPI_TYPE FROM EOP
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.1.1' AS KPI_CODE, 'Dư nợ DPD0 KHM 2W' KPI, SUM(EOP_KHM) VALUE_, NULL TU_SO, NULL MAU_SO, 'KPI' KPI_TYPE FROM EOP WHERE SP = 'DKXM'
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.1.2' AS KPI_CODE, 'Dư nợ DPD0 KHM 4W' KPI, SUM(EOP_KHM) VALUE_, NULL TU_SO, NULL MAU_SO, 'KPI' KPI_TYPE FROM EOP WHERE SP = 'DKOT'
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.1.3' AS KPI_CODE, 'Dư nợ DPD0 KHQL 2W' KPI, SUM(EOP_KHQL) VALUE_, NULL TU_SO, NULL MAU_SO, 'KPI' KPI_TYPE FROM EOP WHERE SP = 'DKXM'
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.1.4' AS KPI_CODE, 'Dư nợ DPD0 KHQL 4W' KPI, SUM(EOP_KHQL) VALUE_, NULL TU_SO, NULL MAU_SO, 'KPI' KPI_TYPE FROM EOP WHERE SP = 'DKOT'
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.2' AS KPI_CODE, 'Dư nợ BQ DPD0' KPI, SUM(AVG_EOP) VALUE_, SUM(EOP_ACC) TU_SO, TO_NUMBER(SUBSTR(P_DATE,7,2)) MAU_SO, 'KPI' KPI_TYPE FROM EOP
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '9.1' AS KPI_CODE, '%RFW B0-B1 monthly 2W' KPI, VALUE_, TU_SO, MAU_SO, 'Key-driver' KPI_TYPE FROM RF01 WHERE SP = 'DKXM'
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '9.2' AS KPI_CODE, '%RFW B0-B1 monthly 4W' KPI, VALUE_, TU_SO, MAU_SO, 'Key-driver' KPI_TYPE FROM RF01 WHERE SP = 'DKOT'
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '9.3' AS KPI_CODE, '%RFW B0-B1 monthly total' KPI, sum(TU_SO)/NULLIF(sum(MAU_SO),0) VALUE_, SUM(TU_SO) TU_SO, SUM(MAU_SO) MAU_SO, 'Key-driver' KPI_TYPE FROM RF01
WHERE SP IN ('DKXM','DKOT')
GROUP BY SHOP_WID, SHOP_CODE, SHOP_NM
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.5.1' AS KPI_CODE, 'Roll Forward monthly 2W' KPI, RF_MTD VALUE_, NULL TU_SO, NULL MAU_SO, 'Key-driver' KPI_TYPE FROM EOP WHERE SP = 'DKXM'
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.5.2' AS KPI_CODE, 'Roll Forward monthly 4W' KPI, RF_MTD VALUE_, NULL TU_SO, NULL MAU_SO, 'Key-driver' KPI_TYPE FROM EOP WHERE SP = 'DKOT'
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.6.1' AS KPI_CODE, 'Roll Back monthly 2W' KPI, RB_MTD VALUE_, NULL TU_SO, NULL MAU_SO, 'Key-driver' KPI_TYPE FROM EOP WHERE SP = 'DKXM'
UNION ALL
SELECT SUBSTR(P_DATE, 1, 4) YEAR_NUM, SUBSTR(P_DATE,5,2) MONTH_NUM, P_DATE DATE_WID, SHOP_WID, SHOP_CODE, SHOP_NM, '10.1.6.2' AS KPI_CODE, 'Roll Back monthly 4W' KPI, RB_MTD VALUE_, NULL TU_SO, NULL MAU_SO, 'Key-driver' KPI_TYPE FROM EOP WHERE SP = 'DKOT'
--UNION ALL
```

### `DEVDWH.PROC_CRM_SURVEY_INFO` (PROCEDURE) — 6 lines reference search term

```
PROCEDURE        PROC_CRM_SURVEY_INFO (P_DATE NUMBER)
/*
  -- Author  : TRANH2
  -- Updated : 26/04/2024
  -- Purpose : Khao sat ZNS
*/
IS
BEGIN

	EXECUTE IMMEDIATE 'TRUNCATE TABLE DEVDWH.W_TNKH_SURVEY_TMP';

	INSERT INTO DEVDWH.W_TNKH_SURVEY_TMP (CREATED_DT, TRANS_DT, CUSTOMER_CODE, CUSTOMER_NM, LOAN_CODE, LOAN_WID, TEMPLATE_CODE)
	--TEMPLATE_POL_ZNS_01
	WITH Pre_onl AS --KH đã vay nguồn onl trước
	(
	SELECT A.CUSTOMER_CODE
	FROM F88DWH.W_LOAN_DTL_F A
	LEFT JOIN F88DWH.W_POL_DTL_F C ON A.LOAN_WID = C.LOAN_WID
	WHERE 1=1
	AND (C.SOURCE_LEVEL_1_NAME = 'Digital HO' OR SOURCE_LEVEL_2_NAME = 'Digital Mạng Lưới')
	AND A.DISBURSE_DATE_WID < P_DATE
	)
	,Pre_off AS
	(
	-- los - walkin   (tự đến PGD)
	SELECT
	DTL.CUSTOMER_CODE
	FROM F88DWH.W_LOAN_DTL_F DTL
	LEFT JOIN F88DWH.W_POL_DTL_F b ON b.LOAN_WID  = dtl.LOAN_WID
	LEFT JOIN (SELECT DISTINCT loan_wid, CUSTOMER_RESOURCES_WID FROM  F88DWH.VW_W_LOAN_CUSTOMER_F) LC ON LC.LOAN_WID =DTL.LOAN_WID
	LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
	WHERE 1=1
	AND DTL.DISBURSE_DATE_WID < P_DATE
	AND b.LOAN_CODE IS NULL
	AND dtl.CHANNEL_CODE = 'KDML'
	AND (UPPER(R.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(R.RESOURCES_NM) LIKE '%TRADE%')
	UNION ALL
	-- pol offline (quét mã)
	SELECT l.CUSTOMER_CODE
	FROM F88DWH.W_POL_DTL_F d
	INNER JOIN F88DWH.W_LOAN_DTL_F l  ON d.LOAN_WID = l.LOAN_WID
	WHERE SOURCE_LEVEL_1_ID =2
	AND SOURCE_LEVEL_2_ID =9
	AND l.DISBURSE_DATE_WID < P_DATE
	)
	,--TEMPLATE_POL_ZNS_05
	tt_th AS
	(SELECT LDT.LOAN_WID, LDT.CUSTOMER_CODE, LDT.CUSTOMER_WID, LDT.LOAN_CODE,TO_DATE(LDT.CLOSED_DATE_WID , 'yyyymmdd') trans_dt  --tất toán trước hạn
	FROM F88DWH.W_LOAN_DTL_F LDT
	WHERE 1=1
	AND NVL(LDT.CLOSED_DATE_WID,0) != DISBURSE_DATE_WID
	AND TO_DATE(LDT.CLOSED_DATE_WID , 'yyyymmdd') <= TO_DATE
	AND LDT.CLOSED_DATE_WID = P_DATE
	)
	, dpd AS
	(SELECT LOAN_CODE, OVERDUE_DAYS_ADJUST
	FROM F88DWH.W_LOAN_DAILY_F LD
	WHERE 1=1
	AND YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE,1,4))
	AND MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE,5,2))
	AND DATE_WID = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'yyyymmdd') - 1, 'yyyymmdd'))
	)
	SELECT
		SYSDATE CREATED_DT,
		TRANS_DT,
		tt_th.CUSTOMER_CODE,
		c.CUSTOMER_NM ,
		tt_th.LOAN_CODE, tt_th.LOAN_WID,
		'TEMPLATE_POL_ZNS_05' TEMPLATE_CODE
	FROM tt_th
	LEFT JOIN dpd ON tt_th.LOAN_CODE = dpd.LOAN_CODE
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON tt_th.CUSTOMER_WID = c.CUSTOMER_WID
	WHERE NVL(dpd.OVERDUE_DAYS_ADJUST,0) <=0
	UNION ALL
	SELECT
		SYSDATE CREATED_DT,
		A.CREATED_DT TRANS_DT,
	    A.CUSTOMER_CODE,
	    c.CUSTOMER_NM,
	    A.LOAN_CODE , A.LOAN_WID ,
	    'TEMPLATE_POL_ZNS_01' TEMPLATE_CODE
	FROM F88DWH.W_LOAN_DTL_F A
	LEFT JOIN F88DWH.W_SHOP_D B ON A.SHOP_WID = B.SHOP_WID
	LEFT JOIN F88DWH.W_POL_DTL_F C ON A.LOAN_WID = C.LOAN_WID
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON A.CUSTOMER_WID = c.CUSTOMER_WID
	WHERE 1 = 1
	AND DISBURSE_DATE_WID = P_DATE
	AND NVL(CLOSED_DATE_WID,0) != DISBURSE_DATE_WID
	AND LOWER(B.SHOP_NM) NOT LIKE '%test%'
	AND (C.SOURCE_LEVEL_1_NAME = 'Digital HO' OR C.SOURCE_LEVEL_2_NAME = 'Digital Mạng Lưới')
	AND A.CHANNEL_CODE = 'KDML'
	AND C.STATUS_NM = 'Nhận cầm cố'
	AND A.CUSTOMER_CODE NOT IN (SELECT * FROM Pre_onl)
	UNION ALL
	--TEMPLATE_POL_ZNS_02
	(SELECT
		SYSDATE CREATED_DT,
		DTL.CREATED_DT TRANS_DT ,
	    DTL.CUSTOMER_CODE,
	    c.CUSTOMER_NM,
	    DTL.LOAN_CODE , dtl.LOAN_WID ,
	    'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE
	FROM F88DWH.W_LOAN_DTL_F DTL
	LEFT JOIN F88DWH.W_POL_DTL_F b ON b.LOAN_WID  = dtl.LOAN_WID
	LEFT JOIN (SELECT DISTINCT loan_wid, CUSTOMER_RESOURCES_WID FROM  F88DWH.VW_W_LOAN_CUSTOMER_F) LC ON LC.LOAN_WID =DTL.LOAN_WID
	LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON DTL.CUSTOMER_WID = c.CUSTOMER_WID
	WHERE 1=1
	AND DISBURSE_DATE_WID = P_DATE
	AND b.LOAN_CODE IS NULL
	AND dtl.CHANNEL_CODE = 'KDML'
	AND (UPPER(R.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(R.RESOURCES_NM) LIKE '%TRADE%')
	AND DTL.CUSTOMER_CODE NOT IN (SELECT * FROM Pre_off)
	UNION
	SELECT
		SYSDATE CREATED_DT,
		l.CREATED_DT TRANS_DT ,
	    l.CUSTOMER_CODE ,
	    c.CUSTOMER_NM,
	    l.LOAN_CODE , l.LOAN_WID,
	    'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE
	FROM F88DWH.W_POL_DTL_F d
	INNER JOIN F88DWH.W_LOAN_DTL_F l  ON d.LOAN_WID = l.LOAN_WID
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON l.CUSTOMER_WID = c.CUSTOMER_WID
	WHERE SOURCE_LEVEL_1_ID =2
	AND SOURCE_LEVEL_2_ID =9
	AND DISBURSE_DATE_WID = P_DATE
	AND l.CUSTOMER_CODE NOT IN (SELECT * FROM Pre_off)
	)
	UNION ALL
	--TEMPLATE_POL_ZNS_03
	SELECT
		SYSDATE CREATE_DT,
		LT.CREATED_DT TRANS_DT,
		c.CUSTOMER_CODE,
		c.CUSTOMER_NM,
	    lt.LOAN_CODE,lt.LOAN_WID ,
	    'TEMPLATE_POL_ZNS_03' TEMPLATE_CODE
	FROM F88DWH.W_LOAN_TRANS_DTL_F LT
	LEFT JOIN F88DWH.W_LOAN_SCH_DTL_F LS ON LT.LOAN_WID = LS.LOAN_WID  AND trim(TO_CHAR(LT.CREATED_DT,'yyyymm')) = trim(TO_CHAR(LS.TO_DATE,'yyyymm'))
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON lt.CUSTOMER_WID = c.CUSTOMER_WID
	WHERE 1=1
	AND ACTION_CODE = 'TRA_CPV'
	AND TO_CHAR(LT.CREATED_DT, 'yyyymmdd') = P_DATE
	AND LT.CREATED_DT < LS.TO_DATE -- trả CPV trước ngày đến hạn trong tháng
	UNION ALL
	--TEMPLATE_POL_ZNS_04
	SELECT
		SYSDATE CREATE_DT,
		LT.CREATED_DT TRANS_DT,
		c.CUSTOMER_CODE,
		c.CUSTOMER_NM,
	    lt.LOAN_CODE, lt.LOAN_WID,
	    'TEMPLATE_POL_ZNS_04' TEMPLATE_CODE
	FROM F88DWH.W_LOAN_TRANS_DTL_F LT
	LEFT JOIN F88DWH.W_LOAN_SCH_DTL_F LS ON LT.LOAN_WID = LS.LOAN_WID  AND trim(TO_CHAR(LT.CREATED_DT,'yyyymm')) = trim(TO_CHAR(LS.TO_DATE,'yyyymm'))
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON lt.CUSTOMER_WID = c.CUSTOMER_WID
	WHERE 1=1
	AND ACTION_CODE = 'TRA_CPV'
	AND TO_CHAR(LT.CREATED_DT, 'yyyymmdd') = P_DATE
	AND LT.CREATED_DT > LS.TO_DATE -- trả CPV sau ngày đến hạn trong tháng
	UNION ALL
	--TEMPLATE_POL_ZNS_06
	SELECT
		SYSDATE CREATED_DT,
		A.CREATED_DT TRANS_DT,
		A.CUSTOMER_CODE,
		c.CUSTOMER_NM  ,
		A.LOAN_CODE, A.LOAN_WID,
		'TEMPLATE_POL_ZNS_06' TEMPLATE_CODE
	FROM F88DWH.W_LOAN_DTL_F A
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON A.CUSTOMER_WID = c.CUSTOMER_WID
	WHERE 1=1
	AND CTR_TYPE = 'Quay lại'
	AND DISBURSE_DATE_WID = P_DATE
	;

	DELETE FROM  DEVDWH.W_CRM_SURVEY_INFO WHERE TO_NUMBER(TO_CHAR(CREATED_DT, 'yyyymmdd')) = P_DATE;

	INSERT INTO DEVDWH.W_CRM_SURVEY_INFO (CREATED_DT,TRANS_DT,CUSTOMER_CODE, CUSTOMER_NM, LOAN_CODE, TEMPLATE_CODE, PHONE)
	WITH cus AS
	(
	SELECT LC.LOAN_WID, LC.LOAN_CODE, LC.CUSTOMER_CODE, LC.INTEGRATION_ID
	,ROW_NUMBER() OVER(PARTITION BY LC.LOAN_WID, LC.LOAN_CODE, LC.CUSTOMER_CODE ORDER BY LC.CREATED_DT desc ) rnk
	FROM F88DWH.VW_W_LOAN_CUSTOMER_F LC
	INNER JOIN DEVDWH.W_TNKH_SURVEY_TMP survey ON survey.LOAN_WID = LC.LOAN_WID
	)
	SELECT
	survey.CREATED_DT,
	survey.TRANS_DT,
	survey.CUSTOMER_CODE,
	survey.CUSTOMER_NM,
	survey.LOAN_CODE,
	survey.TEMPLATE_CODE
	, CP.PHONE
	FROM DEVDWH.W_TNKH_SURVEY_TMP survey
	LEFT JOIN cus ON survey.LOAN_WID = cus.LOAN_WID
	LEFT JOIN F88dwh.W_LOAN_CUSTOMER_PHONE_F CP ON CP.LOAN_CUSTOMER_ID = cus.INTEGRATION_ID
	WHERE 1=1
	AND CP.IS_PRIMARY = 1
	AND CP.STATUS =1
	AND CP.TYPE = 1
	AND rnk =1 ;
	dbms_output.put_line('----> DONE INSERT SUCCESS W_CRM_SURVEY_INFO AT:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

	COMMIT;

END PROC_CRM_SURVEY_INFO;
```

### `DUONGHA.PROC_LOAN_COLLECTION_RISK` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE         proc_loan_collection_risk (P_DATE NUMBER)
IS

/*
  -- Author  : DUONGHA
  -- Created : 01/08/2025
  -- Purpose : check data collection
*/

BEGIN

DELETE FROM  DUONGHA.W_RISK_LOAN_COLLECTION WHERE YYMM =SUBSTR(P_DATE,1,6) OR YYMM_DISBUR =SUBSTR(P_DATE,1,6);

INSERT INTO  DUONGHA.W_RISK_LOAN_COLLECTION
(
LOAN_WID,
LOAN_CODE,
HDCC,
CUSTOMER_CODE,
YYMM_DISBUR,
CREATEDDATE,
DISBURSE_DATE,
CLOSED_DATE,
MTH,
YYMM,
WO_YYMM,
WO_AMT,
IS_BAD_DEBT,
DISBURSE_AMT,
COLLATERAL_AMT,
BAOHIEM,
MAX_LENDABLE_AMT,
LTV,
BAL_SOM,
BAL_EOM,
DPD_EOM,
DPD_SOM,
DPD_EOM_GRP,
DPD_SOM_GRP,
ASSET_TYPE,
TEN_TS,
NGAY_DKX,
LOAN_STATUS,
FUND_NAME,
CHANNEL_CODE,
TENOR_HD,
SCHEDULE_NUM,
SCH_DT,
TO_DATE,
PAID_DATE,
LOAN_PKG_NM,
PAYMENT_METHOD,
CTR_TYPE,
SHOP_WID,
SHOP_NM,
PROVINCE,
AREA,
A_SCORE,
INTERNAL_SCORE,
BSCORE_MONTHLY,
BSCORE_GN,
CUSTOMERSCORE,
FLAG_DENHAN_B0,
COLLECTION_STATUS,
GIOI_TINH,
CUSTOMER_AGE,
LOAI_HINH_CU_TRU,
DISTANCE,
RESIDENCE_TIME,
TINHTRANG_NOIO,
JOB_NM,
NGPEHUTHUOC,
MARITAL_STATUS,
INCOME,
CUSTOMER_INCOME,
INCOME_FINAL,
INCOME_GRP,
POL_CHANNEL_CODE,
SOURCE_LEVEL_1_NAME,
SOURCE_LEVEL_2_NAME,
SOURCE_LEVEL_3_NAME,
SOURCE_LEVEL_4_NAME,
TONG_NGHIAVU,
NGHIAVU_GOC,
NGHIAVU_LAI_PHAT,
TONG_PAID,
GOC_PAID,
LAI_PHI_PAID,
TONG_WAIVED,
LIQUIDATION_DATE_WID,
STATUS_SOM
)
WITH d AS
(
	    	select
	    		CAL.YEAR_NUM,
	    		CAL.MONTH_NUM,
	    		cal.date_tm,
	    		d.status loan_status,
			    Substr(TO_NUMBER(TO_CHAR(DATE_TM +1,'YYYYMMDD')),1,6) as YYMM,
	    		--SUBSTR(CAL.DATE_WID,1,6) YYMM ,
			   	EXTRACT( YEAR FROM DATE_TM +1) YEAR_NUM_N ,
				EXTRACT( MONTH FROM DATE_TM +1) MONTH_NUM_N,
				CAL.DATE_TM - D.OVERDUE_DAYS SCH_DT,
				to_number(to_char(d.dpd_from_date,'yyyymm')) dpd_from_date,
				LOAN_WID,
				LOAN_CODE,
			    OVERDUE_DAYS DPD_SOM,
			    IS_BAD_DEBT,
			    term_frequency ,
			    LEAD(OVERDUE_DAYS) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) DPD_EOM,
			    principal_remain BAL_SOM,
			    LEAD(principal_remain) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) BAL_EOM,
			    D.STATUS STATUS_SOM
		    FROM
		    	F88DWH.W_LOAN_DAILY_F d
		    	,  f88dwh.W_CALENDAR_D cal
		    	, F88DWH.W_ASSET_TP_D ATP
		    where
		    	CAL.LAST_DOM_FLAG = 1
		     	and CAL.YEAR_NUM = d.YEAR_NUM
		      	AND CAL.MONTH_NUM = d.MONTH_NUM
		      	AND CAL.DATE_WID = d.DATE_WID
		      	--
				AND ATP.ASSET_TP_WID = D.ASSET_TYPE_WID
				AND ATP.CATEGORY_CODE  IN ('15','17','02')
				AND
				(
				(cal.year_num = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE ,'YYYYMMDD'),-1),'YYYY'))
				AND cal.date_wid = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE,'YYYYMMDD'),-1),'YYYYMMDD')))
				OR
				(cal.year_num = TO_NUMBER(SUBSTR(P_DATE,1,4))
				AND cal.date_wid = P_DATE
				)
				)
--				AND CAL.YEAR_NUM >= 2022
--				AND cal.date_wid >= 20220531
				AND d.reversed_date IS NULL
)
, bscore AS
(
SELECT * FROM (
		SELECT
		b.*,
		ROW_NUMBER() OVER (PARTITION BY CUSTOMER_CODE, DATE_WID ORDER BY DATE_CREATED) rn
		FROM F88DWH.W_B_SCORE_MONTHLY_F b
		WHERE 1=1
		AND
		(date_wid = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE ,'YYYYMMDD'),-1)+1,'YYYYMMDD'))
		OR
		date_wid = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE ,'YYYYMMDD'),-2)+1,'YYYYMMDD'))
		)
		) WHERE rn =1
)
SELECT *
--yymm, sum(bal_som)
--YYMM_Disbur, sum(disburse_amt)
FROM
(
SELECT
l.loan_wid,
		L.LOAN_CODE,
		l.contract_code HDCC,
		l.customer_code,
		substr(l.disburse_date_wid,1,6) as YYMM_Disbur,
		mt.CREATEDDATE,
		to_date(l.disburse_date_wid,'yyyy-mm_dd') disburse_date,
		to_date(l.closed_date_wid,'yyyy-mm_dd') closed_date,
	    MONTHS_BETWEEN(to_date(l.closed_date_wid,'yyyy-mm_dd'),to_date(l.disburse_date_wid,'yyyy-mm_dd')) mth, --thangtattoan
		NVL(d.YYMM, SUBSTR(l.disburse_date_wid,1,6)) YYMM,
		SUBSTR(l.WRITEOFF_DATE_WID,1,6) WO_YYMM,
		CASE WHEN YYMM = SUBSTR(l.WRITEOFF_DATE_WID,1,6) THEN BAL_SOM ELSE 0 END WO_AMT,
		d.is_bad_debt,
		l.disburse_amt,
		l.COLLATERAL_AMT,
		L.INSURANCE_AMT baohiem,
		l.MAX_LENDABLE_AMT,
		round((L.DISBURSE_AMT - L.INSURANCE_AMT) / L.COLLATERAL_AMT,3) LTV,
		D.BAL_SOM,
		D.BAL_EOM,
		DPD_EOM,
		DPD_SOM,
		case when DPD_EOM < 1 then 0
			 when DPD_EOM < 31 then 1
			 when DPD_EOM < 61 then 2
			 when DPD_EOM < 91 then 3
			 when DPD_EOM IS null then null
			 else 4 end dpd_EOM_grp ,
		case
			when DPD_SOM < 1 then 0
			 when DPD_SOM < 31 then 1
			 when DPD_SOM < 61 then 2
			 when DPD_SOM < 91 then 3
			 when DPD_SOM IS null then null
			 else 4 --B4+
			 end  DPD_SOM_GRP,
		a.ASSET_TP_NM  asset_type,
		UPPER(ass.LOAN_ASSET_NM) TEN_TS,
		ass.REGISTRATION_DT NGAY_DKX,
		d.loan_status,
		l.fund_name,
		l.channel_code,
		l.term_frequency tenor_hd,
		ls.schedule_num,
		to_number(to_char(SCH_DT,'yyyymmdd')) sch_dt,
		ls.to_date,
		CASE WHEN LS.COMPLETED_PAID_DATE <= sch_dt THEN sch_dt
		WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') THEN LS.COMPLETED_PAID_DATE
		END PAID_DATE,
		l.LOAN_PKG_NM,
	 	---
	 	CASE WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100000 THEN 'GocHangKy'
	 		WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100001 THEN 'GocGocKy' ELSE 'other' end PAYMENT_METHOD,
		CASE WHEN l.ctr_type = 'Mới' THEN l.ctr_type
				else COALESCE(ql.CTR_TYPE, l.ctr_type) END ctr_type ,
			l.shop_wid , SHOP.shop_nm , manager.province, manager.Trade_lead as Area,
		 	CASE WHEN l.ctr_type = 'Mới' THEN  sco.RANK  ELSE NULL END  a_score,
		 	sco.SCORE_INTERNAL AS INTERNAL_SCORE,
		 	b.RANK bscore_monthly,
		 	CASE
		 		WHEN mt.CUSTOMERSCORE >600 THEN '1. Tốt'
		 		WHEN mt.CUSTOMERSCORE >500 THEN '2. Khá'
		 		WHEN mt.CUSTOMERSCORE >399 THEN '3. Trung Bình'
		 		WHEN mt.CUSTOMERSCORE <400 THEN '4. Xấu'
		 		ELSE '5. Khác'
		 	END Bscore_gn,
		 	customerscore,
			----
		CASE WHEN d.dpd_from_date = d.yymm THEN 1 ELSE 0 END FLAG_DENHAN_B0,
		CASE
			 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS < 0 THEN 'TẤT TOÁN HĐ TRƯỚC HẠN'
		     WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 AND D.SCH_DT > TO_DATE(P_DATE ,'YYYYMMDD') THEN 'CHƯA CẦN THU'
		     WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 THEN 'THU ĐÚNG HẠN'
			 WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') AND LS.OVERDUE_DAYS > 0 THEN 'THU QUÁ HẠN'
			 WHEN D.SCH_DT > TO_DATE(P_DATE ,'YYYYMMDD') THEN 'CHƯA CẦN THU'
			 WHEN LS.LOAN_WID IS NULL THEN NULL
			 ELSE 'CHƯA THU ĐƯỢC'
		END COLLECTION_STATUS,
		CUS.GENDER_NM GIOI_TINH,
		substr(L.DISBURSE_DATE_WID,1,4) - CUS.BIRTH_DAY  CUSTOMER_AGE,
		lc.LOAI_HINH_CU_TRU ,
		lc.DISTANCE ,
		lc.RESIDENCE_TIME,
		house.HOUSE_STATUS_NM TINHTRANG_NOIO ,
		lc.JOB_NM,
		lc.NUMBER_OF_CHILD NgPehuThuoc,
		g.GRP_NM Marital_status,
		LC.MONTHLY_INCOME_VALUE INCOME,
		customer_income,
		INCOME_FINAL,
		CASE when cus.customer_income = '01' then '1.<5tr'
			when cus.customer_income = '02' then '2.5->8tr'
			when cus.customer_income = '03' then '3.8->10tr'
			when cus.customer_income = '04' THEN '4.10->15tr'
			when cus.customer_income = '05' THEN '5.15->25tr'
			when cus.customer_income = '06' then '6.25->45tr'
			when cus.customer_income = '07' then '7.>45tr'
			ELSE cus.customer_income END INCOME_GRP,
		pol.channel_code POL_CHANNEL_CODE,
		POL.SOURCE_LEVEL_1_NAME ,
		POL.SOURCE_LEVEL_2_NAME ,
		POL.SOURCE_LEVEL_3_NAME ,
		POL.SOURCE_LEVEL_4_NAME ,
       PRINCIPAL_AMT + ROUND(INTEREST_AMT *1.1,0) + NVL(PENALTY_AMT,0)+ NVL(FEE_CHARGES_AMOUNT,0) TONG_NGHIAVU,
		PRINCIPAL_AMT NGHIAVU_GOC,
		ROUND(INTEREST_AMT *1.1,0)  + NVL(PENALTY_AMT,0)+ NVL(FEE_CHARGES_AMOUNT,0) NGHIAVU_LAI_PHAT,
		nvl(principal_paid_amt,0) + nvl(interest_paid_amt,0) + nvl(PENALTY_CHARGES_PAID_AMT ,0) + nvl(FEE_CHARGES_PAID_AMT,0) TONG_PAID,
		nvl(principal_paid_amt,0)  GOC_PAID,
		nvl(interest_paid_amt,0) + nvl(PENALTY_CHARGES_PAID_AMT,0) + nvl(FEE_CHARGES_PAID_AMT,0)  LAI_Phi_PAID,
		nvl(INTEREST_WAIVED_DERIVED,0) + nvl(FEE_CHARGES_WAIVED_DERIVED,0) + nvl(PENALTY_CHARGES_WAIVED_DERIVED,0) TONG_waived,
		L.LIQUIDATION_DATE_WID,
		D.STATUS_SOM
FROM F88DWH.W_LOAN_DTL_F l
	LEFT JOIN F88DWH.W_POL_DTL_F POL ON POL.LOAN_WID = L.LOAN_WID AND pol.STATUS_NM= 'Nhận cầm cố' and pol.year_num>=2023
	LEFT JOIN f88dwh.W_CTR_TYPE_KHQL ql ON ql.LOAN_WID_NEW = l.loan_wid
	left join d on d.loan_wid = l.loan_wid
	LEFT JOIN F88DWH.W_LOAN_SCH_DTL_F LS ON d.LOAN_WID = LS.LOAN_WID
											AND D.SCH_DT = LS.TO_DATE
	LEFT JOIN f88dwh.VW_W_LOAN_MASTER_F mt ON mt.loan_wid = l.loan_wid
	LEFT JOIN f88dwh.W_CTR_TYPE_KHQL ql ON ql.LOAN_WID_NEW = l.loan_wid
	left join F88DWH.VW_W_CUSTOMER_D cus on cus.customer_wid = l.customer_wid AND cus."SOURCE" = 'CIF'
	LEFT JOIN
	(
	SELECT b.*,
	ROW_NUMBER() OVER(PARTITION BY LOAN_WID ORDER BY SOURCE DESC, INTEGRATION_ID DESC ) rn
	FROM  F88DWH.VW_W_LOAN_CUSTOMER_F b
	) lc ON l.LOAN_WID = lc.LOAN_WID AND RN=1
--	LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F lc ON lc.LOAN_WID = L.LOAN_WID
	LEFT JOIN F88DWH.W_HOUSE_STATUS_D house ON house.HOUSE_STATUS_WID = lc.HOUSE_STATUS_WID
	LEFT JOIN F88DWH.GRP g ON G.GRP_ID = lc.MARITAL_ID
	LEFT JOIN f88dwh.W_ASSET_TP_D a ON a.ASSET_TP_WID = l.ASSET_TYPE_WID
	LEFT JOIN F88DWH.W_LOAN_ASSET_F ass ON ass.LOAN_WID = l.LOAN_WID
	left join f88dwh.w_shop_d shop on shop.shop_wid = l.shop_wid
	left join f88dwh.w_area_manager_d manager on shop.shop_code = trim(manager.shop_id)
	left join f88dwh.w_loan_score_f sco on sco.loan_wid = l.loan_wid
	LEFT JOIN bscore b ON  d.YYMM = SUBSTR(b.date_wid,1,6) AND b.customer_code = l.customer_code --AND SUBSTR(l.DISBURSE_DATE_WID,1,6) = SUBSTR(b.date_wid,1,6)
	WHERE
		a.CATEGORY_CODE in ('15','17','02')
		and l.disburse_date_wid > 20220531
		AND l.CREATED_USER NOT LIKE '%test%'
		AND NVL(L.COLLATERAL_AMT,0) > 0
		AND l.disburse_date_wid <= P_DATE
--		AND l.loan_code ='30166382631'
		)
		WHERE  yymm = SUBSTR(P_DATE,1,6) OR  YYMM_Disbur = SUBSTR(P_DATE,1,6)
--	GROUP BY YYMM
--	HAVING COUNT(1)>1
-- khi chạy job delete các bản ghi where p_date = p_date
;
DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT W_RISK_LOAN_COLLECTION'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));
COMMIT;


END ;
```

### `DUONGHA.PROC_RPT_ONLINE_DAILY` (PROCEDURE) — 6 lines reference search term

```
PROCEDURE         PROC_RPT_ONLINE_DAILY
AS
BEGIN

/*
Procedure to generate data for Online datamart
Daily procedure re-generate the data for the current month and the previous month

update by: duongha
update dt: 2025102x
ticket: #F88_M9CB10YS
*/

-- 1.2. Delete old data
DELETE FROM DUONGHA.W_RPT_ONLINE
WHERE REPORT_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1;

-- 2.2. Insert new data
INSERT INTO DUONGHA.W_RPT_ONLINE
(YEAR_NUM, MONTH_NUM, REPORT_DT, SHOP_CODE, CALLER_CODE, SALER_CODE, CHANNEL_CODE, FORM_ASSET, ASSET, CAMPAIGN, NHOM_NGUON, NGUON_PHU, PHAN_LOAI_NGUON_PHU, URL, CTR_TYPE, FLAG_SAMEDAY, FORM_TT, FORM_TLS, LEAD_PGD, SALE, GIAI_NGAN, LEAD_TLS, SALE_TLS, GIAI_NGAN_TLS, CHANNEL_STR, F_CANCEL_IN_MONTH, S_IN_MONTH, ASSET_TYPE_NAME, F_CANCEL)
SELECT
        YEAR_NUM,
        MONTH_NUM,
        date1 REPORT_DT,
        SHOP_CODE,
        CALLER_CODE,
        SALER_CODE,
        CHANNEL_CODE,
        FORM_ASSET,
        ASSET,
        CAMPAIGN,
        NHOM_NGUON,
        NGUON_PHU,
        PHAN_LOAI_NGUON_PHU,
        URL,
        ctr_type,
        FLAG_SAMEDAY,
        SUM(Form_TT) Form_TT,
        SUM(Form_TLS) Form_TLS,
        SUM(Lead_PGD) Lead_PGD,
        SUM(Sale) Sale,
        SUM(Giai_ngan) Giai_ngan,
        SUM(Lead_TLS) Lead_TLS,
        SUM(Sale_TLS) Sale_TLS,
        SUM(Giai_ngan_TLS) Giai_ngan_TLS,
        CHANNEL_STR,
        sum(F_cancel_in_month) F_cancel_in_month,
        sum(S_in_month) S_in_month,
        ASSET_TYPE_NAME ,
        sum(F_cancel) F_cancel
--1.sum Form TT
FROM (
        (
        SELECT
                po.YEAR_NUM,
                po.MONTH_NUM,
                TRUNC(po.FORM_CREATED_DT) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                SUM(CASE WHEN FORM_CREATED_DT IS NOT NULL THEN 1 ELSE 0 END) AS Form_TT,
                0 AS Form_TLS,
                0 AS Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                sum(CASE WHEN lower(po.STATUS_NM)='hủy đăng ký' THEN 1 ELSE 0 END) F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TRUNC(FORM_CREATED_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND FORM_CREATED_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
                AND po.SOURCE_LEVEL_2_NAME <>'LOS'
        GROUP BY
                po.YEAR_NUM,
                po.MONTH_NUM,
                TRUNC(po.FORM_CREATED_DT),
                po.group_id,
                WED.EMPLOYEE_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM,
                CAMPAIGN_NM,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END,
                po.SOURCE_LEVEL_1_NAME
       )
--2. sum Lead PGD
UNION ALL
        (   SELECT
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) YEAR_NUM,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) MONTH_NUM,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                SUM(CASE WHEN PO.FIRST_SHOP_TRANS_DT  IS NOT NULL THEN 1 ELSE 0 END) AS Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
    FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
  WHERE 1=1
--       AND TRUNC(PO.FIRST_SHOP_TRANS_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
		AND PO.FIRST_SHOP_TRANS_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
       AND po.SOURCE_LEVEL_2_NAME <>'LOS'
  GROUP BY
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) ,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) ,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ),
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE  WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM ,
                po.LOAN_ASSET_TP_NM ,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
               CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END,
                po.SOURCE_LEVEL_1_NAME   )
-- 3. sum sale TT và Giải ngân TT
UNION  ALL
        (
        SELECT
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                0 AS Lead_PGD,
                COUNT(po.LOAN_CODE)  AS Sale,
                SUM(po.DISBURSE_AMT) AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND to_char(po.FORM_CREATED_DT,'yyyymm') = substr(PO.DISBURSE_DT,1,6)  THEN 1 ELSE 0 END ) S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND PO.DISBURSE_DT > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
                AND po.STATUS_NM ='Nhận cầm cố'
                AND po.SOURCE_LEVEL_2_NAME <>'LOS'
        GROUP BY
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM ,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END  ,
                po.SOURCE_LEVEL_1_NAME
       )
--4. HDMM nhập thẳng trên LOS không qua PAWN_ONLINE_WID
UNION  ALL
        (SELECT
        to_number(substr(a.MIFOS_DISBURSE_DATE_WID, 1, 4)) year_num,
        to_number(substr(a.MIFOS_DISBURSE_DATE_WID, 5, 2)) month_num,
        to_date(a.MIFOS_DISBURSE_DATE_WID, 'yyyymmdd') date1,
        CASE WHEN REGEXP_LIKE(sh.SHOP_CODE, '^[[:digit:]]+$') THEN to_number(sh.SHOP_CODE) ELSE NULL END shop_code ,
        NULL caller_name,
        NULL caller_code,
        a.MIFOS_CHANNEL_CODE ,
        c.ASSET_TP_NM  AS FORM_ASSET,
        c.ASSET_TP_NM ASSET,
        r.RESOURCES_NM campaign,
        CASE
                WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END NHOM_NGUON,
        'LOS' nguon_phu,
        NULL phan_loai_nguon_phu,
        NULL url,
        a.MIFOS_CTR_TYPE,
        CASE WHEN NVL(A.MIFOS_CLOSED_DATE_WID,0) != A.MIFOS_DISBURSE_DATE_WID THEN 1 ELSE 0 END FLAG_SAMEDAY,
        count(a.PAWN_WID) form_tt,
        0 form_tls,
        count(a.PAWN_WID) lead_pgd,
        count(a.PAWN_WID) sale,
        sum(a.MIFOS_DISBURSE_AMT) giai_ngan,
        0 Lead_TLS,
        0 Sale_TLS,
        0 Giai_ngan_TLS,
        'Marketing PGD' SOURCE,
        0 F_cancel_in_month,
        0 S_in_month,
        c.ASSET_TP_NM  ASSET_TYPE_NAME,
        0 F_cancel
FROM
    F88DWH.W_PAWN_F a
LEFT JOIN F88DWH.VW_W_POL_DTL_F b ON a.PAWN_WID =b.PAWN_WID
LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F LC ON LC.PAWN_WID =A.PAWN_WID
LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
LEFT JOIN F88DWH.W_SHOP_D sh ON sh.SHOP_WID = a.MIFOS_SHOP_WID
WHERE
    1 = 1
    AND a.MIFOS_DISBURSE_DATE_WID IS NOT NULL
    AND b.LOAN_CODE  IS NULL
--    AND to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
    AND a.MIFOS_DISBURSE_DATE_WID > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
GROUP BY
        to_number(substr(a.MIFOS_DISBURSE_DATE_WID, 1, 4)),
        to_number(substr(a.MIFOS_DISBURSE_DATE_WID, 5, 2)),
        to_date(a.MIFOS_DISBURSE_DATE_WID, 'yyyymmdd'),
        sh.SHOP_CODE ,
        a.MIFOS_CHANNEL_CODE ,
        b.FORM_ASSET_TP_NM  ,
        b.LOAN_ASSET_TP_NM,
        r.RESOURCES_NM,
        a.MIFOS_CTR_TYPE,
        CASE WHEN NVL(A.MIFOS_CLOSED_DATE_WID,0) != A.MIFOS_DISBURSE_DATE_WID THEN 1 ELSE 0 END ,
        CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END,
        c.ASSET_TP_NM
        )
---4.* HỢP ĐỒNG TỪ GOLIVE NHÓM NGUỒN LOS NHẬP LÊN POL TỪ 19/04/2024
UNION  ALL
        (
        SELECT
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                po.GROUP_id shop_code,
                NULL CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                r.RESOURCES_NM  CAMPAIGN,
                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                        ELSE 'Trade MKT' END NHOM_NGUON,
                'LOS' nguon_phu,
                NULL PHAN_LOAI_NGUON_PHU,
                NULL url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                count(po.LOAN_WID) form_tt,
                        0 form_tls,
                        count(po.LOAN_WID) lead_pgd,
                        count(po.LOAN_WID) sale,
                SUM(po.DISBURSE_AMT) AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                'Marketing PGD'  CHANNEL_STR,
                0 F_cancel_in_month,
                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND to_char(po.FORM_CREATED_DT,'yyyymm') = substr(PO.DISBURSE_DT,1,6)  THEN 1 ELSE 0 END ) S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =PO.LOAN_WID
                LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND PO.DISBURSE_DT > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
                AND po.STATUS_NM ='Nhận cầm cố'
                AND po.SOURCE_LEVEL_2_NAME ='LOS'
        GROUP BY
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                po.GROUP_id ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM ,
                RESOURCES_NM ,
                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                        ELSE 'Trade MKT' END,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END
       )
 -- 5.Traffic NKTB nhập thẳng trên LOS
UNION ALL
(
SELECT
        TO_NUMBER(SUBSTR(LLF.DATE_WID,1,4)) YEAR_NUM,
        TO_NUMBER(SUBSTR(LLF.DATE_WID,5,2)) MONTH_NUM,
        TO_DATE(LLF.DATE_WID,'YYYYMMDD') DATE1,
        TO_NUMBER(LLF.SHOP_CODE) SHOP_CODE,
        NULL CALLER_NAME,
        NULL CALLER_CODE,
        'KDML' CHANNEL_CODE,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END FORM_ASSET,
        NULL ASSET,
        WRD.RESOURCES_NM CAMPAIGN,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'Digital Mạng Lưới'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'Trade MKT'
    END NHOM_NGUON,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'WALKIN ONLINE'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'WALKIN OFFLINE'
    END NGUON_PHU,
    NULL PHAN_LOAI_NGUON_PHU,
    NULL URL,
    NULL CTR_TYPE,
    NULL FLAG_SAMEDAY,
    COUNT(1) FORM_TT,
    0 FORM_TLS,
    COUNT(1) LEAD_PGD,
    0 SALE,
    0 GIAI_NGAN,
    0 LEAD_TLS,
    0 SALE_TLS,
    0 GIAI_NGAN_TLS,
    'Marketing PGD' SOURCE,
    0 F_CANCEL_IN_MONTH,
    0 S_IN_MONTH,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END ASSET_TYPE_NAME,
        0 F_CANCEL
FROM F88DWH.VW_W_LOAN_LOG_FAILURE_F LLF
LEFT JOIN (SELECT * FROM F88DWH.W_RESOURCES_D WHERE status = 1 )  wrd on LLF.ORG_CUSTOMER = wrd.RESOURCES_CODE
WHERE 1=1
--AND TO_DATE(LLF.DATE_WID, 'yyyymmdd') > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
AND LLF.DATE_WID > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
GROUP BY
        TO_NUMBER(SUBSTR(LLF.DATE_WID,1,4)),
        TO_NUMBER(SUBSTR(LLF.DATE_WID,5,2)),
        TO_DATE(LLF.DATE_WID,'YYYYMMDD'),
        TO_NUMBER(LLF.SHOP_CODE),
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END,
        WRD.RESOURCES_NM,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'Digital Mạng Lưới'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'Trade MKT'
    END,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'WALKIN ONLINE'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'WALKIN OFFLINE'
    END,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END
        )
UNION ALL --đơn hủy theo tháng hủy đơn
(
        SELECT
                EXTRACT (YEAR FROM CANCEL_DT) YEAR_NUM,
                EXTRACT (MONTH FROM CANCEL_DT) MONTH_NUM,
                TRUNC(CANCEL_DT) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                0 Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                count(po.POL_WID) F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TRUNC(CANCEL_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND CANCEL_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
```

### `DUONGHA.RRTD_F11_LAA` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE         RRTD_F11_LAA (P_DATE NUMBER)
IS

BEGIN
DELETE FROM DUONGHA.RRTD_FI11_LAST_ACTION_ADJ WHERE YEAR_NUM = SUBSTR(P_DATE,1,4) AND MONTH_NUM = SUBSTR(P_DATE,5,2);
INSERT INTO DUONGHA.RRTD_FI11_LAST_ACTION_ADJ
(
YEAR_NUM,
MONTH_NUM,
MA_HĐ,
NGAY_GN,
DISBURSE_AMT,
LAST_ACTION,
LAST_ACTION_ADJ,
LAST_ACTION_CODE_ADJUST,
DESCRIPTION,
DETAIL,
BOM_BUCKET,
CUSTOMER_NM,
PROVINCE_NM,
DISTRICT_NM,
WARD_NM,
KENH,
NHOM_NGUON,
NGUON_PHU,
PHAN_LOAI_NGUON_PHU,
SAN_PHAM,
FUND,
PKG_GROUP,
KHU_VUC,
MIEN,
AGE,
GENDER,
LOAI_HINH_NHA_O,
LOAI_HINH_CU_TRU,
ASCORE,
BSCORE,
CREATED_USER_WID,
UPDATED_USER_WID
)
WITH QLTS AS
(
SELECT *
FROM
(
SELECT
YEAR_NUM,
MONTH_NUM,
ACT.LOAN_WID,
ACT.CUSTOMER_WID,
ACT.BOM_BUCKET,
GRP.GRP_NM,
CASE
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'trốn|bỏ|chuyển|trốn|ở|dọn|don|đổi|trả|trọ|chuyen|bo|chốn|rời|dời|chon|khỏi|địa phương|truy dấu|bt|tung tích|mướn|bể|về quê|về|quê|tro|đổ|vỡ|truy vết|vết|lh|ll|đi|dia phuog|dp|move|nơi khác|bx|bs|b su|trôn|chọn|ko còn|không còn','i') THEN 'Bỏ trốn'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'địa chỉ sai|sai|tìm|tim|chính xác|thông tin|biết|địa chỉ|ảo|ao|mượn|thẩm định|định vị|check|vị trí|hẻm|số nhà|ngõ|địa|hỏi|thăm|ko có ai|ko thấy|dckrr|không phải nhà|ko tiềm thấy nhà|ko tìm thấy nhà|k quen|không quen|không biết','i') THEN 'Địa chỉ sai'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'bán nhà|bán|giải tỏa|nhượng|sang nhượng|sang|giải toả|ban nha|giai|toa|bn|bn nha|ban nhà|BN','i') THEN 'Bán nhà'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'nghỉ làm|nghỉ việc|nghỉ|nghi|việc|viec|nghĩ|cty|làm|vp|đình chỉ|lm chỗ khác','i') THEN 'Nghỉ làm'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'tù|tu|trại|giam|bị bắt','i') THEN 'Đi tù'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'chết|chet|tử vong|đã mất','i') THEN 'Chết'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'hứa hẹn|hứa|hẹn|nhắn','i') THEN 'KH hẹn TT'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'hợp tác|hop tac|từ chối|tu choi|lươn lẹo|ko thanh toán|không hộp tát|chây ì|chây lì|chày cối|k hợp tác|không giải quyết|cố thủ|ko liên quan|mất khả năng|không đóng|k đóng|không muốn đóng','i') THEN 'Không hợp tác'
	WHEN GRP.GRP_CODE = 'FI11' AND REGEXP_LIKE(DETAIL,'chung cư|cc|quay lại|quay lai|đóng cửa|khóa cửa|không gặp|chưa gặp|thông báo|thư báo|tb|chưa liên hệ được KH|ko có nhà|k gặp|chưa liên hệ') THEN 'Chưa liên hệ được KH'
	WHEN GRP.GRP_CODE <> 'FI11' THEN NULL
	ELSE 'Khác'
END GROUP_,
GRP2.LAST_ACTION_CODE_ADJUST,
GRP2.DESCRIPTION,
ACT.DETAIL,
CREATED_USER_WID,
UPDATED_USER_WID,
ROW_NUMBER()OVER(PARTITION BY MONTH_NUM,LOAN_WID ORDER BY CREATED_DT DESC) RN
FROM F88DWH.W_ACTIVITY_ENTITY_F ACT
LEFT JOIN F88DWH.GRP ON ACT.ACTIVITY_WID = GRP.GRP_ID AND GRP.GRP_TP = 'ACTION_CODE_V1'
LEFT JOIN DUONGHA.QLTS_GRP_CODE GRP2 ON ACT.ACTIVITY_WID = GRP2.GRP_ID
WHERE 1=1
AND YEAR_NUM = SUBSTR(P_DATE,1,4)
AND MONTH_NUM = SUBSTR(P_DATE,5,2)
)
WHERE RN=1
)
SELECT
YEAR_NUM,
MONTH_NUM,
MA_HĐ,
NGAY_GN,
DISBURSE_AMT,
LAST_ACTION,
LAST_ACTION_ADJ,
LAST_ACTION_CODE_ADJUST,
DESCRIPTION,
DETAIL,
BOM_BUCKET,
CUSTOMER_NM,
PROVINCE_NM,
DISTRICT_NM,
WARD_NM,
NULL KENH,
NULL NHOM_NGUON,
NULL NGUON_PHU,
NULL PHAN_LOAI_NGUON_PHU,
SAN_PHAM,
FUND,
PKG_GROUP,
KHU_VUC,
MIEN,
AGE,
GENDER,
LOAI_HINH_NHA_O,
LOAI_HINH_CU_TRU,
ASCORE,
BSCORE,
CREATED_USER_WID,
UPDATED_USER_WID
FROM
(
SELECT
QLTS.YEAR_NUM,
QLTS.MONTH_NUM,
DTL.LOAN_CODE MA_HĐ,
DTL.DISBURSE_DATE_WID NGAY_GN,
DTL.DISBURSE_AMT,
QLTS.GRP_NM LAST_ACTION,
QLTS.GROUP_ LAST_ACTION_ADJ,
QLTS.LAST_ACTION_CODE_ADJUST,
QLTS.DESCRIPTION,
QLTS.DETAIL,
QLTS.BOM_BUCKET,
CUS.CUSTOMER_NM,
CUS.PROVINCE_NM,
CUS.DISTRICT_NM,
CUS.WARD_NM,
NULL KENH,
NULL NHOM_NGUON,
NULL NGUON_PHU,
NULL PHAN_LOAI_NGUON_PHU,
DTL.LOAN_PKG_NM SAN_PHAM,
CASE
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%LAODONG%' THEN 'LDTD'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%CONGNHAN%' THEN 'CongNhan'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%VP%' THEN 'VP'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%TAIXE%' THEN 'TXCN'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%TIEUTHUONG%' THEN 'TieuThuong'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%PHUNU%' THEN 'PHUNU'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%E2E%' THEN 'E2E'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%App%' THEN 'App'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%24%' THEN '24T'
	WHEN upper(DTL.LOAN_PKG_NM) LIKE '%LUONG%' THEN 'TinChap_CNVP'
	WHEN DTL.PACKAGE_WID IN (1010,1306,1100,1540) THEN 'AppVay'
	WHEN DTL.PACKAGE_WID IN (1360, 1281, 1280 , 1420, 1480,1308,1180) THEN 'Partner'
	ELSE 'OTHER'
END PKG_GROUP,
DTL.FUND_NAME FUND,
AR.TRADE_LEAD KHU_VUC,
AR.REGION MIEN,
SUBSTR(P_DATE,1,4) - CUS.BIRTH_YEAR AGE,
CUS.GENDER_NM GENDER,
HOUSE.HOUSE_STATUS_NM LOAI_HINH_NHA_O,
CUS.LOAI_HINH_CU_TRU,
DTL.INTERNAL_SCORE ASCORE,
BS.BSCORE,
QLTS.CREATED_USER_WID,
QLTS.UPDATED_USER_WID,
ROW_NUMBER() OVER(PARTITION BY QLTS.LOAN_WID ORDER BY CUS.DATE_WID DESC) RN
FROM QLTS
LEFT JOIN F88DWH.W_LOAN_DTL_F DTL ON QLTS.LOAN_WID = DTL.LOAN_WID
LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F CUS ON QLTS.LOAN_WID = CUS.LOAN_WID
LEFT JOIN F88DWH.VW_W_CUSTOMER_D CUSD ON QLTS.CUSTOMER_WID = CUSD.CUSTOMER_WID AND CUSD.CRN_ROW_IND = 1
LEFT JOIN F88DWH.W_B_SCORE_F BS ON CUSD.CUSTOMER_CODE = BS.CUSTOMER_CODE
LEFT JOIN F88DWH.W_HOUSE_STATUS_D HOUSE ON cus.HOUSE_STATUS_WID = house.HOUSE_STATUS_WID
LEFT JOIN F88DWH.W_SHOP_D SH ON DTL.SHOP_WID = SH.SHOP_WID AND SH.CRN_ROW_IND = 1
LEFT JOIN F88DWH.W_AREA_MANAGER_D AR ON SH.SHOP_CODE = AR.SHOP_ID
--INNER JOIN F88DWH.W_POL_DTL_F POL ON QLTS.LOAN_WID = POL.LOAN_WID AND POL.STATUS_NM='Nhận cầm cố'
)
WHERE RN =1
;
DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT RRTD_FI11'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));
COMMIT;


END ;
```

### `F88DWH.PKG_BALANCE_MOVEMENT` (PACKAGE BODY) — 1 lines reference search term

```
PACKAGE BODY        PKG_BALANCE_MOVEMENT
AS
-- Package body

/*
* -- Author: F88DWH
* -- Created: 2023-09-22
* -- Purpose: Phục vụ BDM theo dõi hợp đồng theo flow kinh doanh
*/


PROCEDURE NEW_CUSTOMER_SOURCE (CB_DATE NUMBER) IS
BEGIN
DELETE FROM F88DWH.W_RPT_NEW_CUSTOMER_SOURCE WHERE SUBSTR(DISBURSE_DATE_WID,1,6) = SUBSTR(CB_DATE,1,6);
INSERT INTO F88DWH.W_RPT_NEW_CUSTOMER_SOURCE
	WITH D AS (
	 	SELECT
			LDT.LOAN_WID ,
			LDT.LOAN_CODE ,
			LDT.DISBURSE_DATE_WID ,
			CASE
				WHEN POL.SOURCE_LEVEL_1_NAME IN ('Digital HO','TLS E2E') THEN 'Digital HO'
				WHEN POL.SOURCE_LEVEL_1_NAME = 'Marketing PGD' OR POL.LOAN_CODE IS NULL THEN 'Marketing PGD'
				WHEN POL.SOURCE_LEVEL_1_NAME = 'Recall KHQL' THEN POL.SOURCE_LEVEL_1_NAME
				ELSE 'Khác'
			END KENH,
			POL.SOURCE_LEVEL_2_NAME NHOM_NGUON ,
			C.CUSTOMER_CODE ,
			LDT.CTR_TYPE ,
			ROW_NUMBER() OVER (PARTITION BY C.CUSTOMER_CODE ORDER BY DISBURSE_DATE_WID) RN
		FROM
			F88DWH.W_LOAN_DTL_F LDT
			LEFT JOIN F88DWH.W_POL_DTL_F POL ON LDT.LOAN_CODE = POL.LOAN_CODE AND POL.STATUS_NM = 'Nhận cầm cố'
			LEFT JOIN F88DWH.VW_W_CUSTOMER_D C ON LDT.CUSTOMER_WID = C.CUSTOMER_WID
		WHERE
			LDT.CTR_TYPE = 'Mới'
			AND SUBSTR(DISBURSE_DATE_WID,1,6) = SUBSTR(CB_DATE,1,6)
			--AND c.CUSTOMER_CODE = '2293216853'--LDT.LOAN_CODE = '20811615320'
	)

	SELECT
		LOAN_WID ,
		LOAN_CODE ,
		DISBURSE_DATE_WID ,
		KENH ,
		NHOM_NGUON ,
		CUSTOMER_CODE
	FROM
		D
	WHERE
		RN = 1

;

DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT NEW_CUSTOMER_SOURCE:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));
COMMIT;
END ;



PROCEDURE BALANCE_MOVEMENT (CB_DATE NUMBER) IS
BEGIN
DELETE FROM F88DWH.W_RPT_BALANCE_MOVEMENT WHERE REPORT_MONTH  =  SUBSTR(CB_DATE,1,6) ;
INSERT INTO F88DWH.W_RPT_BALANCE_MOVEMENT
    (YEAR_NUM
    , REPORT_MONTH
    , LOAN_CODE
    , PRINCIPAL_OB
    , PRINCIPAL_CB
    , DISBURSE_AMT
    , PRINCIPAL_PAID
    , BUCKET_OB
    , BUCKET_CB
    , BUCKET_MVT
    , BUCKET_MVT_STEP
    , OVD_OB
    , OVD_CB
    , ASSET_TP_NM
    , PACKAGE_NM
    , PRODUCT_NM
    , GIA_THAM_DINH
    , SO_TIEN_VAY_TOI_DA
    , GIAI_NGAN
    , BAO_HIEM
    , KY_HAN_VAY
    , DV_KY_HAN_VAY
    , CHI_PHI_VAY
    , NGAY_GIAI_NGAN
    , NGAY_DONG_HĐ
    , THOI_GIAN_VAY_THUC_TE
    , LTV
    , CHANNEL_CODE
    , FUND_NAME
    , CUSTOMER_CODE
    , CUSTOMER_AGE
    , GENDER_NM
    , JOB_NM
    , CUSTOMER_INCOME
    , CTR_TYPE
    , OLD_LOAN_CODE
    , KENH, NHOM_NGUON
    , CREATED_USER
    , POSITION_CREATED_USER
    , SUPPORT_USER
    , POSITION_SUPPORT_USER
    , RANK
    , SHOP_NM
    , QLKV
    , QLV
    , PHAN_VUNG
    , PROVINCE
    , DV_HC
    , DIA_HINH
    , QUY_MO_DS
    , DIEM_MAT_BANG
    , PHAN_HANG_MAT_BANG
    , SHOP_OPENING_DATE, SHOP_AGE, REPORT_DATE
    )

	WITH CAL AS
	(
		SELECT
			DATE_WID ,
			DATE_TM ,
			YEAR_NUM ,
			MONTH_NUM ,
			LAST_DOM_FLAG ,
			CASE
				WHEN DATE_TM = TRUNC(TO_DATE(CB_DATE,'YYYYMMDD'),'MM')-1 THEN 'MONTH_PRE'
				ELSE 'MONTH'
			END MONTH_TYPE ,
			CASE
				WHEN DATE_WID = CB_DATE THEN 'CLOSING_DATE'
				WHEN DATE_TM = TRUNC(TO_DATE(CB_DATE,'YYYYMMDD'),'MM')-1 THEN 'OPENING_DATE'
			END DATE_TYPE
		FROM
			F88DWH.W_CALENDAR_D
		WHERE
				DATE_TM >= TRUNC(TO_DATE(CB_DATE,'YYYYMMDD'),'MM')-1
			AND DATE_WID <= CB_DATE
	)

	, D AS
	(
	SELECT
		LDT.* ,
		NVL(LDA_OB.PRINCIPAL_REMAIN,0) AS PRINCIPAL_OB ,
		NVL(LDA_CB.PRINCIPAL_REMAIN,0) AS PRINCIPAL_CB ,
		CASE
			WHEN CAL_GN.MONTH_TYPE = 'MONTH' THEN LDT.DISBURSE_AMT
		END DISBURSE_AMT_IN_MONTH ,
		CASE
			WHEN CAL_GN.MONTH_TYPE = 'MONTH' THEN 'GIẢI NGÂN MỚI'
			WHEN LDA_OB.OVERDUE_DAYS <= 0 THEN 'B0'
			WHEN LDA_OB.OVERDUE_DAYS <= 10 THEN 'B1A'
			WHEN LDA_OB.OVERDUE_DAYS <= 30 THEN 'B1B'
			WHEN LDA_OB.OVERDUE_DAYS <= 60 THEN 'B2'
			WHEN LDA_OB.OVERDUE_DAYS <= 90 THEN 'B3'
			WHEN LDA_OB.OVERDUE_DAYS > 90 THEN 'B3+'
		END BUCKET_OB ,
		CASE
			WHEN LDA_CB.OVERDUE_DAYS <= 0 THEN 'B0'
			WHEN LDA_CB.OVERDUE_DAYS <= 10 THEN 'B1A'
			WHEN LDA_CB.OVERDUE_DAYS <= 30 THEN 'B1B'
			WHEN LDA_CB.OVERDUE_DAYS <= 60 THEN 'B2'
			WHEN LDA_CB.OVERDUE_DAYS <= 90 THEN 'B3'
			WHEN LDA_CB.OVERDUE_DAYS > 90 THEN 'B3+'
			WHEN CAL_R.MONTH_TYPE = 'MONTH' THEN 'TẤT TOÁN HĐ'
		END BUCKET_CB ,
		LDA_OB.OVERDUE_DAYS AS OVD_OB ,
		LDA_CB.OVERDUE_DAYS AS OVD_CB ,
		CASE
	--		WHEN CAL_GN.MONTH_TYPE = 'MONTH' THEN 0 --'GIẢI NGÂN MỚI'
			WHEN LDA_OB.OVERDUE_DAYS <= 0 THEN 1 --'B0'
			WHEN LDA_OB.OVERDUE_DAYS <= 10 THEN 2 --'B1A'
			WHEN LDA_OB.OVERDUE_DAYS <= 30 THEN 2 --'B1B'
			WHEN LDA_OB.OVERDUE_DAYS <= 60 THEN 3 --'B2'
			WHEN LDA_OB.OVERDUE_DAYS <= 90 THEN 4 --'B3'
			WHEN LDA_OB.OVERDUE_DAYS > 90 THEN 5 --'B3+'
		END BUCKET_OB_N ,
		CASE
			WHEN LDA_CB.OVERDUE_DAYS <= 0 THEN 1 --'B0'
			WHEN LDA_CB.OVERDUE_DAYS <= 10 THEN 2 --'B1A'
			WHEN LDA_CB.OVERDUE_DAYS <= 30 THEN 2 --'B1B'
			WHEN LDA_CB.OVERDUE_DAYS <= 60 THEN 3 --'B2'
			WHEN LDA_CB.OVERDUE_DAYS <= 90 THEN 4 --'B3'
			WHEN LDA_CB.OVERDUE_DAYS > 90 THEN 5 --'B3+'
	--		WHEN CAL_R.MONTH_TYPE = 'MONTH' THEN 0 --'TẤT TOÁN HĐ'
		END BUCKET_CB_N ,
		CASE
			WHEN NVL(LDA_CB.PRINCIPAL_REMAIN,0) - NVL(LDA_OB.PRINCIPAL_REMAIN,0) > 0 THEN 'TĂNG'
			WHEN NVL(LDA_CB.PRINCIPAL_REMAIN,0) - NVL(LDA_OB.PRINCIPAL_REMAIN,0) < 0 THEN 'GIẢM'
			WHEN NVL(LDA_CB.PRINCIPAL_REMAIN,0) - NVL(LDA_OB.PRINCIPAL_REMAIN,0) = 0 THEN 'KHÔNG ĐỔI'
		END BALANCE_MOVEMENT ,
		CASE
			WHEN NVL(LDA_CB.SHOP_WID,LDA_OB.SHOP_WID) IS NULL THEN LDT.SHOP_WID
			ELSE NVL(LDA_CB.SHOP_WID,LDA_OB.SHOP_WID)
		END OLD_SHOP_WID

	FROM
		F88DWH.W_LOAN_DTL_F LDT
		LEFT JOIN (
					SELECT
						LOAN_WID ,
						OVERDUE_DAYS ,
						PRINCIPAL_REMAIN ,
						SHOP_WID
					FROM
						F88DWH.W_LOAN_DAILY_F LDA ,
						CAL
					WHERE
						CAL.DATE_TYPE = 'CLOSING_DATE'
						AND LDA.YEAR_NUM = CAL.YEAR_NUM
						AND LDA.MONTH_NUM = CAL.MONTH_NUM
						AND LDA.DATE_WID = CAL.DATE_WID
					) LDA_CB ON LDT.LOAN_WID = LDA_CB.LOAN_WID

		LEFT JOIN (
					SELECT
						LOAN_WID ,
						OVERDUE_DAYS ,
						PRINCIPAL_REMAIN ,
						SCHEDULE_NEXT_DATE ,
						SHOP_WID
					FROM
						F88DWH.W_LOAN_DAILY_F LDA ,
						CAL
					WHERE
						CAL.DATE_TYPE = 'OPENING_DATE'
						AND LDA.YEAR_NUM = CAL.YEAR_NUM
						AND LDA.MONTH_NUM = CAL.MONTH_NUM
						AND LDA.DATE_WID = CAL.DATE_WID
					) LDA_OB ON LDT.LOAN_WID = LDA_OB.LOAN_WID
		LEFT JOIN CAL CAL_GN ON LDT.DISBURSE_DATE_WID = CAL_GN.DATE_WID AND CAL_GN.MONTH_TYPE = 'MONTH'
		LEFT JOIN CAL CAL_R ON LDT.CLOSED_DATE_WID = CAL_R.DATE_WID AND CAL_R.MONTH_TYPE = 'MONTH'
	WHERE
		(CAL_GN.MONTH_TYPE = 'MONTH'
		OR CAL_R.MONTH_TYPE = 'MONTH'
		OR LDA_CB.PRINCIPAL_REMAIN > 0
		OR LDA_OB.PRINCIPAL_REMAIN > 0)
	)

	,LT AS --GIAO DỊCH TRẢ GỐC TRÊN LOAN_TRANS
	(
		SELECT
			LOAN_WID ,
			SUM(PRINCIPAL_AMT) PRINCIPAL_PAID
		FROM
			F88DWH.W_LOAN_TRANS_DTL_F LT
			JOIN CAL ON LT.TRANS_DATE_WID = CAL.DATE_WID AND CAL.MONTH_TYPE = 'MONTH'
		WHERE LT.ACTION_CODE IN ('DONG_HD','DONG_HDNX','DONG_HD_CD','DONG_HD_CDNX','DONG_HD_CD_CIMB','DONG_HD_CIMB_F88','DONG_HD_CIMB_F88_WO','DONG_HD_DH','TRA_CPV','TRA_CPV_CIMB','TRA_CPV_CIMB_F88','TRA_CPV_CIMB_F88_WO','TRA_CPV_HDNX')
		GROUP BY LOAN_WID
	)

	SELECT
         SUBSTR(CB_DATE,1,4) YEAR_NUM
        ,SUBSTR(CB_DATE,1,6) REPORT_MONTH
		, D.LOAN_CODE
		, D.PRINCIPAL_OB
		, D.PRINCIPAL_CB
		, D.DISBURSE_AMT
		, LT.PRINCIPAL_PAID
		, D.BUCKET_OB
		, D.BUCKET_CB
		, CASE
			WHEN BUCKET_OB_N > BUCKET_CB_N THEN 'ROLL BACK'
			WHEN BUCKET_OB_N < BUCKET_CB_N THEN 'ROLL FORWARD'
			WHEN BUCKET_OB = 'GIẢI NGÂN MỚI' AND BUCKET_CB = 'TẤT TOÁN HĐ' THEN 'MỞ - ĐÓNG TRONG THÁNG'
			WHEN BUCKET_OB = 'GIẢI NGÂN MỚI' AND BUCKET_CB IN ('B1A','B1B') THEN 'ROLL FORWARD'
			WHEN BUCKET_OB = 'GIẢI NGÂN MỚI' THEN 'GIẢI NGÂN MỚI'
			WHEN BUCKET_CB = 'TẤT TOÁN HĐ' THEN 'TẤT TOÁN HĐ'
			WHEN BUCKET_OB_N = BUCKET_CB_N THEN 'NO CHANGE'
		  END BUCKET_MVT
		, BUCKET_CB_N - BUCKET_OB_N BUCKET_MVT_STEP
		, D.OVD_OB
		, D.OVD_CB
		, ATP.ASSET_TP_NM
		, D.LOAN_PKG_NM PACKAGE_NM
		, PRO.PRODUCT_NM
		, D.COLLATERAL_AMT GIA_THAM_DINH
		, D.MAX_LENDABLE_AMT SO_TIEN_VAY_TOI_DA
		, D.DISBURSE_AMT - D.INSURANCE_AMT GIAI_NGAN
		, D.INSURANCE_AMT BAO_HIEM
		, D.TERM_FREQUENCY KY_HAN_VAY
		, D.TERM_FREQUENCY_UNIT DV_KY_HAN_VAY
		, D.INTEREST_RATE CHI_PHI_VAY
		, TO_DATE(D.DISBURSE_DATE_WID,'YYYYMMDD') NGAY_GIAI_NGAN
		, TO_DATE(D.CLOSED_DATE_WID,'YYYYMMDD') NGAY_DONG_HĐ
		, CASE
				WHEN D.CLOSED_DATE_WID IS NULL THEN NULL
				WHEN D.CLOSED_DATE_WID IS NOT NULL THEN ROUND((TO_DATE(D.CLOSED_DATE_WID,'YYYYMMDD') - TO_DATE(D.DISBURSE_DATE_WID,'YYYYMMDD')+1)/30,2)
		  END THOI_GIAN_VAY_THUC_TE
		, CASE
			WHEN D.COLLATERAL_AMT IS NULL OR D.COLLATERAL_AMT = 0 THEN NULL
			WHEN D.COLLATERAL_AMT > 0 THEN ROUND((D.DISBURSE_AMT - D.INSURANCE_AMT) / D.COLLATERAL_AMT,2)
		  END LTV
		--
		, D.CHANNEL_CODE
		, D.FUND_NAME
		, C.CUSTOMER_CODE
		, EXTRACT(YEAR FROM SYSDATE ) - C.BIRTH_DAY CUSTOMER_AGE
		, C.GENDER_NM
		, JOB.JOB_NM
		, G.GRP_NM CUSTOMER_INCOME
		, CASE
				WHEN D.CTR_TYPE = 'Mới' THEN 'Mới'
				WHEN D.DISBURSE_DATE_WID < 20220101 THEN D.CTR_TYPE
				ELSE KHQL.CTR_TYPE
		  END CTR_TYPE
		, LDT1.LOAN_CODE  OLD_LOAN_CODE
		, CS.KENH
		, CS.NHOM_NGUON
		, EC.EMPLOYEE_CODE CREATED_USER
		, EC.POSITION_NM POSITION_CREATED_USER
		, ES.EMPLOYEE_CODE SUPPORT_USER
		, ES.POSITION_NM POSITION_SUPPORT_USER
		, LS.RANK
		--
		, S.SHOP_NM
		, A.QLKV
		, A.TPK QLV
		, A.TRADE_LEAD PHAN_VUNG
		, A.PROVINCE
		, A.DV_HC
		, A.DIA_HINH
		, A.QUY_MO_DS
		, A.DIEM_MAT_BANG
		, A.PHAN_HANG_MAT_BANG
		, A.FAIL_14_6  SHOP_OPENING_DATE
		, FLOOR(MONTHS_BETWEEN( TO_DATE(CB_DATE,'yyyymmdd'),A.FAIL_14_6)) SHOP_AGE
		, CB_DATE REPORT_DATE
	FROM
		D
		LEFT JOIN LT ON D.LOAN_WID = LT.LOAN_WID
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D C ON D.CUSTOMER_WID = C.CUSTOMER_WID
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D CUS ON C.CUSTOMER_CODE = CUS.CUSTOMER_CODE  AND CUS.CRN_ROW_IND = 1
		LEFT JOIN F88DWH.W_JOB_D JOB ON CUS.JOB = JOB.JOB_CODE AND to_date(CB_DATE,'yyyymmdd') BETWEEN job.VALID_FM_DT AND job.VALID_TO_DT +1
		LEFT JOIN F88DWH.GRP G ON CUS.CUSTOMER_INCOME  = G.GRP_CODE AND G.GRP_TP = 'AVERAGE_INCOME'
		LEFT JOIN F88DWH.W_LOAN_SCORE_F LS ON D.LOAN_WID = LS.LOAN_WID
		--
		LEFT JOIN F88DWH.W_ASSET_TP_D ATP ON D.ASSET_TYPE_WID = ATP.ASSET_TP_WID
--		LEFT JOIN F88DWH.W_PACKAGE_D PAK ON D.PACKAGE_WID = PAK.PACKAGE_WID
		LEFT JOIN F88DWH.W_PRODUCT_D PRO ON D.PRODUCT_WID = PRO.PRODUCT_WID
		LEFT JOIN F88DWH.W_RPT_NEW_CUSTOMER_SOURCE CS ON C.CUSTOMER_CODE = CS.CUSTOMER_CODE
--		LEFT JOIN BACHPX.CTR_TYPE_KHQL_TMP KHQL ON D.LOAN_WID = KHQL.LOAN_WID_NEW
		LEFT JOIN F88DWH.W_CTR_TYPE_KHQL KHQL ON D.LOAN_WID = KHQL.LOAN_WID_NEW
		LEFT JOIN F88DWH.W_LOAN_DTL_F LDT1 ON KHQL.LOAN_WID = LDT1.LOAN_WID
		--
		LEFT JOIN F88DWH.W_SHOP_D S ON D.OLD_SHOP_WID = S.SHOP_WID
		LEFT JOIN F88DWH.W_AREA_MANAGER_D A ON S.SHOP_CODE = A.SHOP_ID
		--
		LEFT JOIN F88DWH.VW_W_EMPLOYEE_D EC ON D.CREATED_USER_WID = EC.EMPLOYEE_WID
		LEFT JOIN F88DWH.vW_W_EMPLOYEE_D ES ON D.SUPPORTER_WID = ES.EMPLOYEE_WID
;

DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT BALANCE_MOVEMENT '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));
COMMIT;
END ;


PROCEDURE MAIN (CB_DATE NUMBER) IS
BEGIN
	NEW_CUSTOMER_SOURCE (CB_DATE) ;
	BALANCE_MOVEMENT (CB_DATE) ;
END ;


END PKG_BALANCE_MOVEMENT;
```

### `F88DWH.PKG_CUSTOMER_DEMO` (PACKAGE BODY) — 3 lines reference search term

```
PACKAGE BODY        PKG_CUSTOMER_DEMO
AS

PROCEDURE PROC_RPT_CUS_DEMO (P_DATE NUMBER)
IS
BEGIN
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_TOI_MONTHLY';
COMMIT;

INSERT INTO F88DWH.W_RPT_TOI_MONTHLY
(YEAR_MONTH ,SHOP_WID, SHOP_CODE ,SHOP_NM , CUSTOMER_CODE, LOAN_CODE , REVENUE_TO_F88, PENALTY_FEE,OVERDUE_PENALTY ,RECOVERY,WO )
SELECT YEAR_MONTH , SHOP_WID, SHOP_CODE, SHOP_NM,customer_code,loan_code
        , sum(CASE WHEN TO_BUY_DEBT = 'BUY_DEPT' THEN 0 ELSE nvl(INTEREST,0) END)
        	+ sum(nvl(APPRAISAL_FEE,0)) + sum(nvl(ADMIN_FEE,0)) + sum(nvl(FEE_CONSIGNMENT,0))
        	+ sum(nvl(INTEREST_OVER_BUY_DEPT,0)) + sum(nvl(EXTEND_FEE,0)) + + sum(nvl(LOAN_MANAGEMENT_FEE,0)) REVENUE_TO_F88
        , sum(nvl(BETIMES_PENALTY,0)) + sum(nvl(OVERDUE_PENALTY,0)) PENALTY_FEE
        ,sum(CASE WHEN Trans_Type = 'NORMAL'  THEN nvl(OVERDUE_PENALTY,0) END ) OVERDUE_PENALTY
        ,sum(CASE WHEN RECOVERY = 'RECOVERY' AND  AMOUNT >0 THEN AMOUNT END ) RECOVERY
        ,sum(CASE WHEN WO = 'WO' THEN AMOUNT END ) RECOVERY
FROM (
    SELECT substr(P_DATE,1,6) YEAR_MONTH
    ,cus.customer_code,lda.loan_code
    , s.SHOP_WID, s.SHOP_CODE, s.SHOP_NM
        , txn.TRANSACTION_TYPE_ENUM, txn.CODE_MASTER_DATA
        ,   case
                when (txn.CODE_MASTER_DATA like '%NX%'
                or txn.CODE_MASTER_DATA like '%WO%' or (txn.TRANSACTION_TYPE_ENUM is null and txn.CODE_MASTER_DATA not in ('212', '213', '227', '228') and nvl(txn.is_bad_debt,0) = 1))
            and txn.CODE_MASTER_DATA not in ('BAN_THANH_LY_HDNX_CIMB_F88') then 'RECOVERY'
            else 'NORMAL'
            end Trans_Type
        ,   case
                when txn.CODE_MASTER_DATA in ('TRA_CPV_CIMB', 'DONG_HD_CD_CIMB', 'DONG_HD_CIMB') then 'CIMB'
            else 'F88'
            end TO_FUND
        , CASE
            WHEN txn.CODE_MASTER_DATA = '228' OR txn.CODE_MASTER_DATA IN ('BAN_THANH_LY_HDNX_CIMB_F88', 'DONG_HD_CIMB_F88', 'TRA_CPV_CIMB_F88') THEN 'BUY_DEPT'
            ELSE 'NORMAL'
        END AS TO_BUY_DEBT
        , CASE
            WHEN txn.TRANSACTION_TYPE_ENUM = 'RECOVERY_LIQUIDATION' THEN 'LIQUID_CLEAR'
            ELSE 'NORMAL'
        END AS IS_LIQUID_CLEAR
      ,CASE WHEN  txn.TRANSACTION_TYPE_ENUM  = 'LOAN_TRANSFER_TO_BAD_DEBT' THEN 'WO' END WO
        ,CASE WHEN txn.CODE_MASTER_DATA IN (
						'133', '134','BAN_THANH_LY',
						'BAN_THANH_LY_HDNX','DONG_HDNX',
						'TRA_CPV_HDNX','TRA_HANG_THANH_LY_HDNX',
						'136', '140', '135',
						'BAN_THANH_LY_HDNX_CIMB_F88','BAN_THANH_LY_HDNX_CIMB_SMN',
						'DONG_HD_CIMB_F88_WO', 'TRA_CPV_F88_WO',
						'TRA_CPV_CIMB_F88_WO', 'DONG_HD_CD', 'DONG_HD_CDNX',
						'TRA_CPV', 'DONG_HD_CD_CIMB', 'TRA_CPV_CIMB_F88', 'DONG_HD_CIMB_F88', 'TRA_CPV_CIMB',
						'213','228','210','227','212','211') AND txn.DPD>90 then 'RECOVERY' END RECOVERY
        , txn.INTEREST
        , txn.APPRAISAL_FEE, txn.ADMIN_FEE, txn.FEE_CONSIGNMENT, txn.BETIMES_PENALTY, txn.OVERDUE_PENALTY, txn.INTEREST_OVER_BUY_DEPT, txn.EXTEND_FEE, txn.LOAN_MANAGEMENT_FEE,txn.AMOUNT
    FROM F88DWH.W_DOCUMENT_TRANSACTION txn
    INNER JOIN F88DWH.W_LOAN_DTL_F lda ON lda.LOAN_CODE = txn.CODE_NO
    LEFT JOIN F88DWH.VW_W_CUSTOMER_D cus ON lda.customer_wid = cus.customer_wid
    INNER JOIN F88DWH.W_SHOP_D s ON s.SHOP_WID = lda.SHOP_WID ----AND s.CRN_ROW_IND = 1 AND s.SHOP_TYPE = 'F88'
    WHERE  YEAR_NUM = substr(P_DATE,1,4)
			AND month_num = substr(P_DATE,5,2)
			AND DATE_WID <= P_DATE
    AND  (txn.TRANSACTION_TYPE_ENUM in ('REPAYMENT', 'RECOVERY_LIQUIDATION', 'REVERT_LIQUIDATION','LOAN_TRANSFER_TO_BAD_DEBT')
        OR txn.CODE_MASTER_DATA IN ('133', '134', '136', '140', '212', '213', '228','BAN_THANH_LY',
						'BAN_THANH_LY_HDNX',
						'DONG_HDNX',
						'TRA_CPV_HDNX',
						'TRA_HANG_THANH_LY_HDNX', '135','210','227','211',
						'BAN_THANH_LY_HDNX_CIMB_F88',
						'BAN_THANH_LY_HDNX_CIMB_SMN',
						'DONG_HD_CIMB_F88_WO', 'TRA_CPV_F88_WO',
						'TRA_CPV_CIMB_F88_WO', 'DONG_HD_CD', 'DONG_HD_CDNX',
						'TRA_CPV', 'DONG_HD_CD_CIMB', 'TRA_CPV_CIMB_F88', 'DONG_HD_CIMB_F88', 'TRA_CPV_CIMB'))
    ) T
WHERE t.TO_FUND = 'F88'
GROUP BY YEAR_MONTH, SHOP_WID, SHOP_CODE, SHOP_NM,customer_code,loan_code;

COMMIT;

EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_LOAN_PREBAL_MONTHLY' ;
INSERT INTO  F88DWH.W_RPT_LOAN_PREBAL_MONTHLY
(YEAR_MONTH , CUSTOMER_CODE , PRETIME , ONTIME , OTHER)
WITH b AS (
SELECT
LOAN_WID,
CASE
WHEN NVL(OVERDUE_DAYS, 0) <= 0 THEN 'B0'
ELSE 'B1+'
END AS BUCKET,
PRINCIPAL_REMAIN
FROM
F88DWH.W_LOAN_DAILY_F A
WHERE 1=1
AND year_num = to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyy'))
AND month_num = to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'mm'))
AND DATE_WID = to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd'))
),
c AS (
SELECT
LOAN_WID,
CASE
WHEN NVL(OVERDUE_DAYS, 0) <= 0 THEN 'B0'
ELSE 'B1+'
END AS BUCKET,
PRINCIPAL_REMAIN
FROM
F88DWH.W_LOAN_DAILY_F
WHERE 1=1
AND YEAR_NUM = substr(P_DATE,1,4)
AND month_num = substr(P_DATE,5,2)
AND DATE_WID = P_DATE
)
   ,dat2 as(
    SELECT cus.CUSTOMER_CODE,
    CASE WHEN a.CLOSED_DATE_WID < to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Pretime' WHEN a.CLOSED_DATE_WID = to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Ontime' ELSE 'Other' END status,
   SUM(NVL(B.PRINCIPAL_REMAIN, A.DISBURSE_AMT)) tat_toan
FROM
    F88DWH.W_LOAN_DTL_F A
LEFT JOIN B ON A.LOAN_WID = B.LOAN_WID
LEFT JOIN C ON A.LOAN_WID = C.LOAN_WID
LEFT JOIN F88DWH.VW_W_CUSTOMER_D cus ON a.customer_wid = cus.customer_wid
WHERE 1=1
AND A.CHANNEL_CODE = 'KDML'
AND substr(a.CLOSED_DATE_WID,1,6) = substr(P_DATE,1,6)
AND a.CLOSED_DATE_WID <=P_DATE
AND a.is_bad_debt <> 1 --Nguyennt: dùng trường is_bad_debt <> 1
AND (CASE
WHEN a.CLOSED_DATE_WID IS NOT NULL AND a.CLOSED_DATE_WID = P_DATE AND a.DISBURSE_DATE_WID = P_DATE THEN 'TATTOAN'
WHEN A.CLOSED_DATE_WID IS NOT NULL AND A.CLOSED_DATE_WID <= P_DATE AND A.CLOSED_DATE_WID > to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd')) AND B.BUCKET = 'B0' AND NVL(C.PRINCIPAL_REMAIN,0) = 0 THEN 'TATTOAN'
WHEN A.CLOSED_DATE_WID IS NOT NULL AND A.CLOSED_DATE_WID <= P_DATE AND A.CLOSED_DATE_WID > to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd')) AND A.DISBURSE_DATE_WID > to_number(to_char(TRUNC(to_date(P_DATE,'yyyymmdd'),'MM')-1,'yyyymmdd')) AND A.DISBURSE_DATE_WID<= P_DATE AND NVL(C.PRINCIPAL_REMAIN,0) = 0 THEN 'TATTOAN'
END) IS NOT NULL
GROUP BY cus.CUSTOMER_CODE, --a.LOAN_CODE,
    CASE WHEN a.CLOSED_DATE_WID < to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Pretime' WHEN a.CLOSED_DATE_WID = to_number(to_char(a.TO_DATE,'yyyymmdd')) THEN 'Ontime' ELSE 'Other' END
    )
    SELECT substr(P_DATE,1,6) YEAR_MONTH ,CUSTOMER_CODE,Pretime,Ontime,Other
    FROM dat2 A
    pivot (sum(TAT_TOAN) FOR STATUS IN ('Pretime' as Pretime,'Ontime' AS Ontime,'Other' AS Other))A;




EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_LOAN_CUS_MONTHLY' ;
INSERT INTO  F88DWH.W_RPT_LOAN_CUS_MONTHLY
 (	YEAR_MONTH , CUSTOMER_CODE , SHOP_WID , SHOP_CODE , CTR_TYPE , FUND_NAME , HAVE_W0 , LOAI_TS , GOI_VAY, DISBURSE_AMT , COLLATERAL_AMT ,
	MAX_LENDABLE_AMT , DPD_NOW , INSURANCE_AMT , IS_BAD_DEBT , IS_BAD_DEBT_2Y , MAX_DPD_2Y , SCORE ,
	RANK , AVG_BAL , EOP_BAL , FIRST_DISBURSE , LAST_DISBURSE , LAST_CLOSEDATE , NEW_BAL , PAIDOFF_BAL , NO_CONTRACT , NO_CONTRACT_MTD , 		TOTAL_REPAY_PRINCIPAL ,TOTAL_INTEREST_FEE , LIFE_TIME , TERM_FREQUENCY,LOAN_PURPOSE_NAME,NUMBER_OF_CHILD,MARITAL_ID 	,LOAI_KHACH_HANG,LOAI_HINH_CU_TRU,LTV)
WITH  max_2y AS (
	SELECT loan_wid,max(MAX_DPD) DPD_MAX,max(nvl(IS_BAD_DEBT,0)) IS_BAD_DEBT
FROM F88DWH.W_LOAN_DPD_PRINCIPAL_MONTHLY_F
WHERE THANG BETWEEN to_char(ADD_MONTHS(to_date(P_DATE,'YYYYMMDD'),-24),'YYYYMMDD') and to_char(ADD_MONTHS(to_date(P_DATE,'YYYYMMDD'),-12) ,'YYYYMMDD')
GROUP BY loan_wid)
,monthly_loan AS --Nguyennt: tách riêng bảng monthly, daily
(SELECT a.LOAN_WID
		,max(a.is_bad_debt )  is_bad_debt --max()
		,max(a.OVERDUE_DAYS ) OVERDUE_DAYS --max()
		,sum(a.PRINCIPAL_REMAIN)/count(DISTINCT a.date_wid) AVG_BAL
FROM F88DWH.W_LOAN_DAILY_F a
WHERE YEAR_NUM = substr(P_DATE,1,4) AND month_num = substr(P_DATE,5,2)
GROUP BY a.LOAN_WID )
,rank_ AS
(SELECT DISTINCT nvl(c.customer_code,a.customer_code) customer_code
,a.internal_score
,b.SCORE
,b."RANK"
,CASE WHEN a.internal_score IS NULL AND b.SCORE IS NULL AND b."RANK" IS NULL THEN ''
	  WHEN  b."RANK" IS NOT  NULL THEN  b."RANK"
	   WHEN  a.internal_score <=350 AND a.is_bad_debt = 1 THEN 'E'
	   WHEN  a.internal_score <=350 AND a.is_bad_debt = 0 THEN 'D'
	   WHEN  a.internal_score <=450 THEN 'C'
	   WHEN  a.internal_score <=550  THEN 'B'
	   WHEN  a.internal_score >550  THEN 'A'
	   END RANK_M
FROM F88DWH.W_LOAN_DTL_F a
JOIN F88DWH.W_FIRST_LOAN_CONTRACT_F f ON a.loan_wid = f.loan_wid
LEFT JOIN F88DWH.W_LOAN_SCORE_F b ON a.LOAN_WID =b.LOAN_WID
LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON a.CUSTOMER_WID =c.CUSTOMER_WID
WHERE a.ctr_type = 'Mới')
,dat2 as(
	SELECT substr(P_DATE,1,6) Year_month,cus.CUSTOMER_CODE,c.LOAN_CODE
		,c.DISBURSE_AMT
		,c.COLLATERAL_AMT
		,c.INSURANCE_AMT
		,max(TO_DATE(c.CLOSED_DATE_WID, 'rrrr/mm/dd') - TO_DATE(c.DISBURSE_DATE_WID, 'rrrr/mm/dd')) LIFE_TIME
		,max(CASE WHEN c.WRITEOFF_DATE_WID IS NOT null AND  c.WRITEOFF_DATE_WID <= P_DATE THEN 1 ELSE 0 END) HAVE_W0
		,c.MAX_LENDABLE_AMT
		,y.IS_BAD_DEBT IS_BAD_DEBT_2Y
		,y.DPD_MAX MAX_DPD_2Y
		,a.is_bad_debt --max()
		,a.OVERDUE_DAYS --max()
		,a.AVG_BAL
		,sum(a1.PRINCIPAL_REMAIN) EOP_BAL ---sum() du No hien tai
		,sum(DISTINCT CASE WHEN substr(c.DISBURSE_DATE_WID ,1,6)= substr(P_DATE,1,6) THEN c.DISBURSE_AMT END) NEW_BAL---sum()
		,sum(DISTINCT CASE WHEN substr(c.CLOSED_DATE_WID,1,6)= substr(P_DATE,1,6) THEN c.DISBURSE_AMT END) PAIDOFF_BAL ---sum()
		,min(c.DISBURSE_DATE_WID) FIRST_DISBURSE
		,max(c.DISBURSE_DATE_WID) LAST_DISBURSE
		,max(CASE WHEN c.CLOSED_DATE_WID <= P_DATE THEN c.CLOSED_DATE_WID END ) LAST_CLOSEDATE
		,sum(nvl(a1.TOTAL_REPAY_INTEREST,0)) TOTAL_REPAY_PRINCIPAL--goc qua han
		,sum(nvl(a1.TOTAL_REPAY_INTEREST,0) +nvl(a1.TOTAL_REPAY_FEE,0) +nvl(a1.TOTAL_REPAY_PENALTY,0)  )  TOTAL_INTEREST_FEE
		,sum(nvl(a1.TOTAL_WAIVED,0)) TOTAL_WAIVED
	FROM F88DWH.W_LOAN_DTL_F  c
	LEFT JOIN monthly_loan  a ON a.LOAN_WID =c.LOAN_WID
	left join F88DWH.W_LOAN_DAILY_F a1 on a1.LOAN_WID =c.LOAN_WID AND a1.YEAR_NUM = substr(P_DATE,1,4) AND a1.month_num = substr(P_DATE,5,2) and a1.date_wid = P_DATE
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D cus ON c.CUSTOMER_WID = cus.customer_wid
	LEFT JOIN max_2y y ON y.LOAN_WID = c.LOAN_WID
	WHERE c.DISBURSE_AMT IS NOT NULL
			AND c.DISBURSE_DATE_WID <= P_DATE
	and (c.CLOSED_DATE_WID IS NULL OR c.CLOSED_DATE_WID  <= P_DATE )
	GROUP BY  cus.CUSTOMER_CODE ,c.DISBURSE_AMT ,c.LOAN_CODE
		,c.COLLATERAL_AMT
		,c.INSURANCE_AMT
		,c.MAX_LENDABLE_AMT
		,y.IS_BAD_DEBT ,y.DPD_MAX
		,a.is_bad_debt --max()
		,a.OVERDUE_DAYS --max()
		,a.AVG_BAL
)
,dat4 AS(
	SELECT CUSTOMER_CODE,LOAN_PKG_NM,FUND_NAME,ASSET_TP_NM,CTR_TYPE,TERM_FREQUENCY,shop_wid
		,SHOP_CODE,LOAN_PURPOSE_NAME,NUMBER_OF_CHILD,MARITAL_ID,LOAI_KHACH_HANG,LOAI_HINH_CU_TRU
	FROM (
	SELECT lc.CUSTOMER_CODE ,a.LOAN_CODE
			,a.DISBURSE_DATE_WID
			,a.DISBURSE_AMT
			,a.LOAN_PKG_NM
			,nvl(a.FUND_NAME, 'F88 fund') FUND_NAME
			,watd.ASSET_TP_NM,CTR_TYPE
			,a.shop_wid
			,a.SHOP_CODE
			,CASE WHEN TERM_FREQUENCY_UNIT = 'Months' THEN TERM_FREQUENCY ELSE TERM_FREQUENCY/30.25 END  TERM_FREQUENCY
			,b.LOAN_PURPOSE_NAME
			,b.NUMBER_OF_CHILD
			,b.MARITAL_ID
			,nvl(b.LOAI_KHACH_HANG,CASE WHEN a.LOAN_TYPE LIKE '%Individual%' THEN 'Cá nhân' ELSE 'Tổ chức' END ) LOAI_KHACH_HANG
			,b.LOAI_HINH_CU_TRU
			,ROW_NUMBER () OVER( PARTITION BY lc.CUSTOMER_CODE ORDER BY a.DISBURSE_DATE_WID desc) ST
	FROM F88DWH.W_LOAN_DTL_F  a
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D  lc ON a.customer_wid = lc.customer_wid
	LEFT JOIN F88DWH.W_ASSET_TP_D watd
	        ON a.ASSET_TYPE_WID = watd.ASSET_TP_WID
	LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F  b ON a.LOAN_WID= b.LOAN_WID
	WHERE a.DISBURSE_DATE_WID <= P_DATE
	AND (a.CLOSED_DATE_WID IS NULL OR a.CLOSED_DATE_WID  <= P_DATE )
	) A
	WHERE ST=1)
,th AS (
	SELECT
	YEAR_MONTH
	,a.CUSTOMER_CODE
	,c.NUMBER_OF_CHILD
	,c.MARITAL_ID
	,c.shop_wid
	,c.shop_code
	,c.CTR_TYPE
	,c.FUND_NAME
	,c.ASSET_TP_NM LOAI_TS
	,c.LOAN_PKG_NM GOI_VAY
	,c.LOAN_PURPOSE_NAME
	,max(HAVE_W0) HAVE_W0
	,sum(CASE WHEN a.LAST_CLOSEDATE IS NULL THEN nvl(DISBURSE_AMT,0) END ) DISBURSE_AMT
	,max(nvl(a.COLLATERAL_AMT,0)) COLLATERAL_AMT--chỉnh lại lấy hạn mức tối đa
	,max(nvl(a.MAX_LENDABLE_AMT,0)) MAX_LENDABLE_AMT
	,max(a.OVERDUE_DAYS ) OVERDUE_DAYS
	,sum(nvl(a.INSURANCE_AMT,0)) INSURANCE_AMT
	,mAX(nvl(a.IS_BAD_DEBT,0)) IS_BAD_DEBT
	,max(a.IS_BAD_DEBT_2Y) IS_BAD_DEBT_2Y
	,max(a.MAX_DPD_2Y) MAX_DPD_2Y
	,d.SCORE
	,d.RANK_M
	,avg(nvl(a.AVG_BAL,0)) AVG_BAL
	,sum(nvl(a.EOP_BAL,0)) EOP_BAL
	,min(a.FIRST_DISBURSE) FIRST_DISBURSE
	,max(a.LAST_DISBURSE) LAST_DISBURSE
	,max(a.LAST_CLOSEDATE ) LAST_CLOSEDATE
	,sum(nvl(a.NEW_BAL,0)) NEW_BAL
	,sum(nvl(a.PAIDOFF_BAL,0)) PAIDOFF_BAL
	,count(a.loan_code) NO_CONTRACT --Nguyennt: 1 loan_code ứng chỉ 1 loan_wid
	,count( CASE WHEN a.LAST_CLOSEDATE IS NULL AND nvl(a.eop_bal,0) >0 THEN a.loan_code end) NO_CONTRACT_MTD --Nguyennt: 1 loan_code ứng chỉ 1 loan_wid
	,sum(nvl(a.TOTAL_REPAY_PRINCIPAL,0) )  TOTAL_REPAY_PRINCIPAL
	,sum(nvl(a.TOTAL_INTEREST_FEE,0)) TOTAL_INTEREST_FEE
	,sum(nvl(a.LIFE_TIME,0))/30.25 LIFE_TIME
	,c.TERM_FREQUENCY
	,c.LOAI_KHACH_HANG
	,c.LOAI_HINH_CU_TRU
FROM dat2 a
LEFT JOIN dat4 c ON a.CUSTOMER_CODE = c.CUSTOMER_CODE
LEFT JOIN rank_ d ON a.CUSTOMER_CODE = d.CUSTOMER_CODE
GROUP BY YEAR_MONTH,a.CUSTOMER_CODE,c.shop_wid,c.shop_code
		,c.FUND_NAME,c.TERM_FREQUENCY
		,c.ASSET_TP_NM
		,c.LOAN_PKG_NM
		,c.CTR_TYPE,c.LOAN_PURPOSE_NAME,c.NUMBER_OF_CHILD,c.MARITAL_ID,c.LOAI_KHACH_HANG
		,c.LOAI_HINH_CU_TRU,d.SCORE,d.RANK_M
)
SELECT YEAR_MONTH
	,CUSTOMER_CODE
	,SHOP_WID
	,SHOP_CODE
	,CTR_TYPE
	,FUND_NAME
	,max(HAVE_W0) HAVE_W0
	,LISTAGG(LOAI_TS, ',') WITHIN GROUP(ORDER BY LOAI_TS ) AS  LOAI_TS
	,GOI_VAY
	,sum( nvl(DISBURSE_AMT,0) ) DISBURSE_AMT
	,max(nvl(COLLATERAL_AMT,0)) COLLATERAL_AMT--chỉnh lại lấy hạn mức tối đa
	,max(MAX_LENDABLE_AMT  ) MAX_LENDABLE_AMT
	,max(OVERDUE_DAYS ) DPD_NOW
	,sum(nvl(INSURANCE_AMT,0)) INSURANCE_AMT
	,mAX(nvl(IS_BAD_DEBT,0)) IS_BAD_DEBT
	,max(IS_BAD_DEBT_2Y) IS_BAD_DEBT_2Y
	,max(MAX_DPD_2Y) MAX_DPD_2Y
	,SCORE
	,RANK_M RANK
	,avg(nvl(AVG_BAL,0)) AVG_BAL
	,sum(nvl(EOP_BAL,0)) EOP_BAL
	,min(FIRST_DISBURSE) FIRST_DISBURSE
	,max(LAST_DISBURSE) LAST_DISBURSE
	,max(LAST_CLOSEDATE ) LAST_CLOSEDATE
	,sum(nvl(NEW_BAL,0)) NEW_BAL
	,sum(nvl(PAIDOFF_BAL,0)) PAIDOFF_BAL
	,sum(nvl(NO_CONTRACT,0)) NO_CONTRACT
	,sum(nvl(NO_CONTRACT_MTD,0)) NO_CONTRACT_MTD
	,sum(nvl(TOTAL_REPAY_PRINCIPAL,0)) TOTAL_REPAY_PRINCIPAL
	,sum(nvl(TOTAL_INTEREST_FEE,0)) TOTAL_INTEREST_FEE
	,LIFE_TIME
	,TERM_FREQUENCY
	,LOAN_PURPOSE_NAME
	,NUMBER_OF_CHILD
	,MARITAL_ID
	,LOAI_KHACH_HANG
	,LOAI_HINH_CU_TRU
	,CASE WHEN sum(nvl(COLLATERAL_AMT,0)) = 0 THEN 0 ELSE sum( nvl(DISBURSE_AMT,0) - nvl(INSURANCE_AMT,0))/sum(nvl(COLLATERAL_AMT,0)) END LTV
FROM TH
WHERE customer_code IS NOT NULL
GROUP BY YEAR_MONTH,CUSTOMER_CODE,SHOP_WID,SHOP_CODE,SCORE,RANK_M
,CTR_TYPE,FUND_NAME,TERM_FREQUENCY,GOI_VAY,LIFE_TIME,LOAN_PURPOSE_NAME,NUMBER_OF_CHILD,MARITAL_ID,LOAI_KHACH_HANG,LOAI_HINH_CU_TRU
;
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_BANCA_F'  ;
INSERT INTO F88DWH.W_RPT_BANCA_F
(YEAR_MONTH , CUSTOMER_CODE , CREATE_DATE , FINISH_SHOP_WID  , APE_PREMIUM, NO_BANCA)
WITH dat2 AS(
	SELECT substr(P_DATE,1,6) YEAR_MONTH,nvl(b1.CUSTOMER_CODE,b2.CUSTOMER_CODE) CUSTOMER_CODE
		,min(to_char(b.CREATED_DT,'YYYYMMDD')) CREATE_DATE --Nguyennt: quét bảng W_INS_CONTRACT_F
		,b.FINISH_SHOP_WID
		,sum(b.CONTRACT_AMT) APE_PREMIUM --Nguyennt: CONTRACT_AMT
		,count(DISTINCT b.CONTRACT_NO) NO_BANCA
	FROM F88DWH.W_INS_CONTRACT_F b
	LEFT JOIN f88dwh.VW_W_CUSTOMER_D  b1  ON b.CUSTOMER_WID = b1.CUSTOMER_WID
	LEFT JOIN F88DWH.VW_W_INS_CUSTOMER_D b2 ON b.CUSTOMER_WID = b2.CUSTOMER_WID
	WHERE b.STATE  IN (1,4)
		AND to_char(b.CREATED_DT,'YYYYMMDD') <= substr(P_DATE,1,6)
	GROUP BY nvl(b1.CUSTOMER_CODE,b2.CUSTOMER_CODE),b.FINISH_SHOP_WID)
,shop AS (
	SELECT a.CUSTOMER_CODE,a.FINISH_SHOP_WID,ROW_NUMBER () OVER( PARTITION BY a.CUSTOMER_CODE ORDER BY a.APE_PREMIUM asc) ST
	FROM dat2 a
	JOIN (SELECT CUSTOMER_CODE,max(CREATE_DATE) CREATE_DATE FROM dat2 GROUP BY CUSTOMER_CODE ) b ON a.CUSTOMER_CODE = b.CUSTOMER_CODE AND a.CREATE_DATE = b.CREATE_DATE
)
	SELECT a.YEAR_MONTH,a.CUSTOMER_CODE
		,min(a.CREATE_DATE) CREATE_DATE
		,b.FINISH_SHOP_WID
	---	,sum(a.FEE) FEE
		,sum(a.APE_PREMIUM) APE_PREMIUM
	----	,sum(a.OPTION_FEE) OPTION_FEE
		,sum(a.NO_BANCA) NO_BANCA
	FROM dat2 a
	LEFT JOIN shop b ON a.CUSTOMER_CODE = b.CUSTOMER_CODE and b.ST = 1
	GROUP BY a.YEAR_MONTH,a.CUSTOMER_CODE,b.FINISH_SHOP_WID;

EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_CUS_DEMO';
COMMIT;

INSERT INTO F88DWH.W_RPT_CUS_DEMO
(YEAR_MONTH ,CUSTOMER_WID , CUSTOMER_CODE , BIRTH_DAY , GENDER_CODE , CRN_ROW_IND , PROVINCE , JOB_TP , JOB , INDUSTRY_CODE,
CUSTOMER_INCOME , CUSTOMER_TYPE, CUSTOMER_SOURCE  , IS_F88,MONTHLY_INCOME,B_SCORE,SHOP_NM_POL,REGION_SHOP_POL  )
WITH pol AS (SELECT f.CUSTOMER_CODE
,a.GROUP_NM
,d.REGION
,d.PROVINCE
FROM F88DWH.W_POL_DTL_F A
LEFT JOIN F88DWH.W_LOAN_DTL_F b ON a.LOAN_WID =b.LOAN_WID
LEFT JOIN F88DWH.VW_W_CUSTOMER_D f ON b.CUSTOMER_WID  =f.CUSTOMER_WID
LEFT JOIN f88dwh.W_AREA_MANAGER_D d ON trim(d.SHOP_ID)  = a.GROUP_ID
WHERE A.YEAR_NUM = substr(P_DATE,1,4) AND  A.MONTH_NUM = substr(P_DATE,5,2) AND  A.DISBURSE_DT = P_DATE
AND a.STATUS_NM <> 'Hủy đăng ký')
,hrm AS (
	SELECT DISTINCT a.EMPLOYEE_CODE,b.EMAIL,b.PHONE,a.EMAIL_PERSONAL,a.ID_NO,a.EMPLOYEE_NAME,POSITION_NAME,b.DATEOFBIRTH,a.TRANGTHAI
	FROM  F88DWH.VW_W_HRM_EMPLOYEE_INFOR_D  a
	LEFT JOIN F88DWH.VW_W_EMPLOYEE_D b on b.EMPLOYEE_CODE = a.EMPLOYEE_CODE
	and to_date(P_DATE,'YYYYMMDD') >= b.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < b.VALID_TO_DT
	 WHERE lower(EMPLOYEE_NAME) NOT LIKE '%test%'
--	 AND to_date(P_DATE,'YYYYMMDD') >= a.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < a.VALID_TO_DT
),
cus AS (
SELECT a.CUSTOMER_CODE ,a.CUSTOMER_NM,nvl(c.phone_num,a.phone_num) PHONE_NUM,BIRTH_DAY,ID_NUM,EMAIL
FROM  F88DWH.VW_W_CUSTOMER_D a
LEFT JOIN F88DWH.VW_W_CUSTOMER_PHONE_F c ON a.CUSTOMER_CODE = c.CUSTOMER_CODE AND c.IS_PRIMARY = 1
WHERE  to_date(P_DATE,'YYYYMMDD') >= a.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < a.VALID_TO_DT ),
hrm2 AS (
		SELECT   a.*
		,ROW_NUMBER () OVER( PARTITION BY a.CUSTOMER_CODE ORDER BY a.RULE_MAP asc) ST
		FROM (
		(SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 1' RULE_MAP
		FROM cus a
		JOIN hrm b ON a.ID_NUM = b.ID_NO AND a.BIRTH_DAY =b.DATEOFBIRTH AND a.PHONE_NUM =b.PHONE AND b.EMPLOYEE_NAME = a.CUSTOMER_NM
		)
		UNION ALL
		(SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 2' RULE_MAP
		FROM cus a
		 JOIN hrm b1 ON a.ID_NUM = b1.ID_NO AND a.BIRTH_DAY =b1.DATEOFBIRTH AND a.PHONE_NUM =b1.PHONE
		 )
		 UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 3' RULE_MAP
		FROM cus a
		 JOIN hrm b2 ON a.ID_NUM = b2.ID_NO AND a.PHONE_NUM =b2.PHONE
		)
		 UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 4' RULE_MAP
		FROM cus a
		JOIN hrm b3 ON a.ID_NUM = b3.ID_NO AND a.BIRTH_DAY =b3.DATEOFBIRTH
		)
		UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 5' RULE_MAP
		FROM F88DWH.VW_W_CUSTOMER_D a
		 JOIN hrm b4 ON a.ID_NUM = b4.ID_NO
		 WHERE a.ID_NUM IS NOT null)
		 UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 6' RULE_MAP
		FROM F88DWH.VW_W_CUSTOMER_D a
		 JOIN hrm b5 ON a.PHONE_NUM =b5.PHONE AND a.EMAIL = b5.EMAIL_PERSONAL
		)
 		UNION ALL
		 (SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 7' RULE_MAP
		FROM F88DWH.VW_W_CUSTOMER_D a
		 JOIN hrm b5 ON a.PHONE_NUM =b5.PHONE ----AND a.EMAIL = b5.EMAIL_PERSONAL
		)
		 )A)
SELECT substr(P_DATE,1,6) YEAR_MONTH
			,b.CUSTOMER_WID
			,b.CUSTOMER_CODE
			,b.BIRTH_DAY
			,b.GENDER_CODE
			,b.CRN_ROW_IND
			,c.PROVINCE_NAME PROVINCE
			,b.JOB_TP	--16
			,b.JOB	--13
			,b.INDUSTRY_CODE
			,b.CUSTOMER_INCOME
			,b.CUSTOMER_TYPE
			,b.CUSTOMER_SOURCE
			,CASE WHEN h.customer_code IS NULL THEN 0 ELSE 1 END IS_F88
			,b.MONTHLY_INCOME
			,f."RANK" B_SCORE
			,p.GROUP_NM SHOP_NM_POL
			,p.REGION REGION_SHOP_POL
FROM  F88DWH.VW_W_CUSTOMER_D b
LEFT JOIN hrm2 h ON b.CUSTOMER_CODE = h.CUSTOMER_CODE and h.ST = 1
LEFT JOIN F88DWH.W_B_SCORE_F f ON b.CUSTOMER_CODE = to_char(f.CUSTOMER_CODE)
LEFT JOIN F88DWH.VW_W_customer_place_D c ON b.customer_code = c.customer_code AND  to_date(P_DATE,'YYYYMMDD') >= c.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < c.VALID_TO_DT AND c.place_type = 3
LEFT JOIN pol p ON b.CUSTOMER_CODE = p.CUSTOMER_CODE
WHERE to_date(P_DATE,'YYYYMMDD') >= b.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < b.VALID_TO_DT
AND b.SOURCE = 'CIF';
--EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_CUS_DEMO' ;
--COMMIT;
--
--
--
--INSERT INTO F88DWH.W_RPT_CUS_DEMO
--(YEAR_MONTH ,CUSTOMER_WID , CUSTOMER_CODE , BIRTH_DAY , GENDER_CODE , CRN_ROW_IND , PROVINCE , JOB_TP , JOB , INDUSTRY_CODE,
--CUSTOMER_INCOME , CUSTOMER_TYPE, CUSTOMER_SOURCE  , IS_F88,MONTHLY_INCOME ,B_SCORE,SHOP_NM_POL,REGION_SHOP_POL  )
--WITH pol AS (SELECT f.CUSTOMER_CODE
--		,a.GROUP_NM
--		,d.REGION
--		,d.PROVINCE
--	FROM F88DWH.W_POL_DTL_F A
--	LEFT JOIN F88DWH.W_LOAN_DTL_F b ON a.LOAN_WID =b.LOAN_WID
--	LEFT JOIN F88DWH.VW_W_CUSTOMER_D f ON b.CUSTOMER_WID  =f.CUSTOMER_WID
--	LEFT JOIN f88dwh.W_AREA_MANAGER_D d ON trim(d.SHOP_ID)  = a.GROUP_ID
--	WHERE A.YEAR_NUM = substr(P_DATE,1,4) AND  A.MONTH_NUM = substr(P_DATE,5,2) AND  A.DISBURSE_DT = P_DATE
--	AND a.STATUS_NM <> 'Hủy đăng ký')
--, hrm AS (
--	SELECT DISTINCT a.EMPLOYEE_CODE,b.EMAIL,b.PHONE,a.EMAIL_PERSONAL,a.ID_NO,a.EMPLOYEE_NAME,POSITION_NAME,b.DATEOFBIRTH,a.TRANGTHAI
--	FROM  F88DWH.VW_W_HRM_EMPLOYEE_INFOR_D  a
--	LEFT JOIN F88DWH.VW_W_EMPLOYEE_D b on b.EMPLOYEE_CODE = a.EMPLOYEE_CODE
--	and to_date(P_DATE,'YYYYMMDD') >= b.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < b.VALID_TO_DT
--	 WHERE lower(EMPLOYEE_NAME) NOT LIKE '%test%'
--	 AND to_date(P_DATE,'YYYYMMDD') >= a.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < a.VALID_TO_DT
--),
--cus AS (
--SELECT a.CUSTOMER_CODE ,a.CUSTOMER_NM,nvl(c.phone_num,a.phone_num) PHONE_NUM,BIRTH_DAY,ID_NUM,EMAIL
--FROM  F88DWH.VW_W_CUSTOMER_D a
--LEFT JOIN F88DWH.VW_W_CUSTOMER_PHONE_F c ON a.CUSTOMER_CODE = c.CUSTOMER_CODE AND c.IS_PRIMARY = 1
--WHERE  to_date(P_DATE,'YYYYMMDD') >= a.VALID_FM_DT and to_date(P_DATE,'YYYYMMDD') < a.VALID_TO_DT ),
--hrm2 AS (
--		SELECT   a.*
--		,ROW_NUMBER () OVER( PARTITION BY a.CUSTOMER_CODE ORDER BY a.RULE_MAP asc) ST
--		FROM (
--		(SELECT DISTINCT a.CUSTOMER_CODE ,a.CUSTOMER_NM,'Rule 1' RULE_MAP
--		FROM cus a
--		JOIN hrm b ON a.ID_NUM = b.ID_NO AND a.BIRTH_DAY =b.DATEOFBIRTH AND a.PHONE_NUM =b.PHONE AND b.EMPLOYEE_NAME = a.CUSTOMER_NM
--		)
--		UNION ALL
```

### `F88DWH.PKG_KEY_DRIVER_TEST_HIEUMX2` (PACKAGE BODY) — 1 lines reference search term

```
PACKAGE BODY        PKG_KEY_DRIVER_TEST_HIEUMX2
AS

PROCEDURE PROC_PROCESS_TMP (P_DATE NUMBER)
IS

BEGIN
/*
 * asignee: hieumx2
 */


EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_ONLINE_PROCESS_TMP';

EXECUTE IMMEDIATE 'DROP INDEX IDX_OLINE_PROCESS_TMP_ID_ROW';

INSERT /*+ append parallel(6) */  INTO F88DWH.W_ONLINE_PROCESS_TMP


WITH cal AS (
SELECT YEAR_NUM,
                MONTH_NUM,
                DATE_WID
FROM F88DWH.W_CALENDAR_D wcd
WHERE  DATE_WID <= P_DATE
        AND DATE_WID >TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD')  - 30, 'YYYYMMDD')
)
,
abc AS (
SELECT INT_POL_PAWN_ID,
                CREATED_DT,
                REASON_WID
FROM F88DWH.W_ONLINE_PROCESS_F a
WHERE EXISTS (
        SELECT 1
        FROM cal
        WHERE cal.YEAR_NUM = a.YEAR_NUM
        AND cal.MONTH_NUM = a.MONTH_NUM
        AND cal.DATE_WID = a.DATE_WID
        )
)
SELECT  /*parallel(6)*/
                abc.* ,
                ROW_NUMBER () OVER(PARTITION BY INT_POL_PAWN_ID ORDER BY CREATED_DT DESC) ROW_DESC
FROM abc ;


dbms_output.put_line('----> DONE INSERT SUCCESS DATA_POL_ONLINE_PROCESS AT: '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

UPDATE F88DWH.W_DAILY_ETL_LOG
SET END_DT = SYSDATE
WHERE TRUNC(LOG_DT) = TRUNC(SYSDATE)
        AND JOB_NM = 'PROC_PROCESS_TMP';


EXECUTE IMMEDIATE 'CREATE INDEX IDX_OLINE_PROCESS_TMP_ID_ROW ON F88DWH.W_ONLINE_PROCESS_TMP(INT_POL_PAWN_ID, ROW_DESC)
PARALLEL 6 NOLOGGING';

COMMIT;

END;



PROCEDURE PROC_DATA_POL(P_DATE NUMBER)
IS

BEGIN
/*
 * asignee: hieumx2
 */


EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_DATA_POL';
INSERT /*+ append parallel(F88DWH.W_DATA_POL, 10) */ INTO F88DWH.W_DATA_POL  -----




WITH cal AS (
SELECT  *
FROM F88DWH.W_CALENDAR_D wcd
WHERE  DATE_WID <= P_DATE
        AND DATE_WID >TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD')  - 30, 'YYYYMMDD')
)
,
source_pol AS (
SELECT KENH SOURCE_LEVEL_1_NAME,
	   NHOM_NGUON SOURCE_LEVEL_2_NAME,
	   NGUON_PHU SOURCE_LEVEL_3_NAME,
	   CAMPAIGN,
	   ROW_NUMBER() OVER(PARTITION BY KENH, NHOM_NGUON, NGUON_PHU, CAMPAIGN ORDER BY KENH) RN
FROM F88DWH.W_BDM_LIST_KENH_NGUON_CAMPAIGN
WHERE STR_TYPE != 'KHONG_PHAN_LOAI'
)
,
data_pol AS (
SELECT   /*+ parallel (6) */
                op.INT_POL_PAWN_ID AS POL_ID,
                wpdf.STATUS_NM AS STATUS_STR,
                wpdf.GROUP_ID AS SHOP_CODE,
                wpdf.SOURCE_LEVEL_1_NAME AS KENH,
                wpdf.SOURCE_LEVEL_2_NAME AS NHOM_NGUON,
                wpdf.SOURCE_LEVEL_3_NAME AS NGUON_PHU,
                wpdf.CAMPAIGN_NM AS CAMPAIGN,
                worfd.INTEGRATION_ID AS REASON_ID,
                worfd.TYPE_NM AS ACTION_NM,
                worfd.CANCELED_REASON_NM AS REASON_NM,
                op.CREATED_DT ,
                wpdf.DATE_WID AS CREATED_TIME_POL,
                COALESCE(wpdf.TRANS_TO_SHOP_DT, wpdf.FORM_CREATED_DT ) AS TO_SHOP_DT,
                op.ROW_DESC
FROM F88DWH.W_POL_DTL_F wpdf
INNER JOIN cal
        ON  wpdf.YEAR_NUM = cal.YEAR_NUM
        AND wpdf.MONTH_NUM = cal.MONTH_NUM
        AND wpdf.DATE_WID = cal.DATE_WID
INNER JOIN source_pol sp
		ON wpdf.SOURCE_LEVEL_1_NAME = sp.SOURCE_LEVEL_1_NAME
		AND wpdf.SOURCE_LEVEL_2_NAME = sp.SOURCE_LEVEL_2_NAME
		AND wpdf.SOURCE_LEVEL_3_NAME = sp.SOURCE_LEVEL_3_NAME
		AND wpdf.CAMPAIGN_NM = sp.CAMPAIGN
LEFT JOIN F88DWH.W_ONLINE_PROCESS_TMP op
        ON  wpdf.POL_WID = op.INT_POL_PAWN_ID
LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
        ON op.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
WHERE sp.rn = 1
)
,
data_all AS (
SELECT /*+ parallel(6) */ dp.*,
       cf.FIRST_CALL,
       cl.LAST_CALL,
       tsa.TO_SHOP_ADJ,
       cfa.FIRST_CALL_ADJ
FROM data_pol dp
LEFT JOIN (
    SELECT /*+ parallel(6) */ POL_ID, MIN(CREATED_DT) AS FIRST_CALL
    FROM data_pol
    WHERE REASON_ID NOT IN (43,151,155,70,21,90,149,137,80,130,127,156, 168) AND REASON_ID IS NOT NULL
    GROUP BY POL_ID
) cf ON dp.POL_ID = cf.POL_ID
LEFT JOIN (
    SELECT /*+ parallel(6) */ POL_ID, MAX(CREATED_DT) AS TO_SHOP_ADJ
    FROM data_pol
    WHERE REASON_ID IN (21, 80, 127)
    GROUP BY POL_ID
) tsa ON dp.POL_ID = tsa.POL_ID
LEFT JOIN (
    SELECT /*+ parallel(6) */ a.POL_ID, MIN(a.CREATED_DT) AS FIRST_CALL_ADJ
    FROM data_pol a
    JOIN (
        SELECT POL_ID, MAX(CREATED_DT) AS TO_SHOP_ADJ
        FROM data_pol
        WHERE REASON_ID IN (21, 80, 127)
        GROUP BY POL_ID
    ) b ON a.POL_ID = b.POL_ID
    WHERE a.CREATED_DT > b.TO_SHOP_ADJ
      AND a.REASON_ID NOT IN (43,151,155,70,21,90,149,137,80,130,127,156, 168)
    GROUP BY a.POL_ID
) cfa ON dp.POL_ID = cfa.POL_ID
LEFT JOIN (
    SELECT /*+ parallel(6) */ POL_ID, MAX(CREATED_DT) AS LAST_CALL
    FROM data_pol
    WHERE REASON_ID NOT IN (43,151,155,70,21,90,149,137,80,130,127,156, 168)
    GROUP BY POL_ID
) cl ON dp.POL_ID = cl.POL_ID
)
-----------------------------------------
--,
--call_first AS (
--SELECT   /*+ parallel (6) */
--                POL_ID,
--                MIN(CREATED_DT) AS FIRST_CALL
--FROM data_pol
--WHERE 1= 1
--AND  REASON_ID NOT IN (43,151,155,70,21,90,149,137,80,130,127,156, 168)
--GROUP BY POL_ID
--)
--,
--to_shop_adj AS (
--SELECT   /*+ parallel (6) */
--                POL_ID,
--                MAX(CREATED_DT) AS TO_SHOP_ADJ
--FROM data_pol
--WHERE 1 = 1
--        AND REASON_ID IN (21, 80, 127)
--GROUP BY POL_ID
--)
--,
--call_first_adj AS (
--SELECT   /*+ parallel (6) */
--                a.POL_ID,
--                MIN(a.CREATED_DT) AS FIRST_CALL_ADJ
--FROM data_pol a
--LEFT JOIN to_shop_adj b
--        ON a.POL_ID = b.POL_ID
--WHERE 1 = 1
--        AND a.CREATED_DT > b.TO_SHOP_ADJ
--        AND a.REASON_ID NOT IN (43,151,155,70,21,90,149,137,80,130,127,156, 168)
--GROUP BY a.POL_ID
--)
--,
--call_last AS (
--SELECT   /*+ parallel (6) */
--                POL_ID,
--                MAX(CREATED_DT) AS LAST_CALL
--FROM data_pol
--WHERE CREATED_DT > TO_CHAR(TO_SHOP_DT, 'YYYYMMDDHH24MISS')
--        AND REASON_ID NOT IN (43,151,155,70,21,90,149,137,80,130,127,156, 168)
--GROUP BY POL_ID
--)
--,
--data_all AS (
--SELECT   /*+ parallel (6) */ dp.*,
--                cf.FIRST_CALL,
--                cl.LAST_CALL,
--                tsa.TO_SHOP_ADJ,
--                cfa.FIRST_CALL_ADJ
--FROM data_pol dp
--LEFT JOIN call_first cf
--        ON dp.POL_ID = cf.POL_ID
--LEFT JOIN to_shop_adj tsa
--        ON dp.POL_ID = tsa.POL_ID
--LEFT JOIN call_first_adj cfa
--        ON dp.POL_ID = cfa.POL_ID
--LEFT JOIN call_last cl
--        ON dp.POL_ID = cl.POL_ID
--)
,
lst_cmt AS (
SELECT  POL_ID,
                TO_DATE(CREATED_DT,'YYYYMMDDHH24MISS') AS CREATED_DT
FROM data_all mdp
WHERE ROW_DESC = 1
        AND STATUS_STR = 'Đang chăm sóc'
        )
,
prior_lst_cmt AS (
SELECT  POL_ID,
                TO_DATE(CREATED_DT,'YYYYMMDDHH24MISS') AS CREATED_DT
FROM data_all mdp
WHERE ROW_DESC = 2
        AND STATUS_STR = 'Đang chăm sóc'
        )
,
cham_don_3d_stt AS ( ------------------
SELECT  a.POL_ID,
                a.CREATED_DT AS LAST_CALL,
                b.CREATED_DT AS PRIOR_LAST_CALL,
                TO_DATE(TO_CHAR(a.CREATED_DT, 'YYYYMMDD'), 'YYYYMMDD') -  TO_DATE(TO_CHAR(b.CREATED_DT, 'YYYYMMDD'), 'YYYYMMDD') AS TIME_,
                CASE WHEN a.CREATED_DT - b.CREATED_DT BETWEEN 0 AND 3 THEN 'Đạt SLA'
                ELSE 'Không đạt SLA' END AS CHAM_3D_STT ------hiện tại không dùng
FROM lst_cmt a
JOIN prior_lst_cmt b
ON a.POL_ID = b.POL_ID
        )
,
sla_time AS (
SELECT
                a.POL_ID,
                CASE
                        WHEN TO_SHOP_DT IS NULL THEN NULL
                        WHEN TO_CHAR(TO_SHOP_DT, 'HH24MISS') < 80000 THEN CONCAT(TO_CHAR(TO_SHOP_DT, 'YYYYMMDD'), '080000')
                        WHEN TO_CHAR(TO_SHOP_DT, 'HH24MISS') >= 80000 AND TO_CHAR(TO_SHOP_DT, 'HH24MISS') <= 190000 THEN TO_CHAR(TO_SHOP_DT, 'YYYYMMDDHH24MISS')
                        ELSE CONCAT(TO_CHAR(TO_SHOP_DT + 1, 'YYYYMMDD'), '080000')
                END
                AS SLA_TO_SHOP,
                CASE
                        WHEN TO_SHOP_ADJ IS NULL THEN NULL
                        WHEN SUBSTR(TO_SHOP_ADJ, 9,6) <  80000 THEN CONCAT(TO_CHAR(TO_DATE(SUBSTR(TO_SHOP_ADJ,1,8), 'YYYYMMDD'), 'YYYYMMDD'), '080000')
                        WHEN SUBSTR(TO_SHOP_ADJ, 9,6) >= 80000 AND  SUBSTR(TO_SHOP_ADJ, 9,6) <= 190000 THEN TO_CHAR(TO_SHOP_ADJ)
                        ELSE CONCAT(TO_CHAR(TO_DATE(SUBSTR(TO_SHOP_ADJ,1,8), 'YYYYMMDD') + 1, 'YYYYMMDD'), '080000')
                END
                AS SLA_TO_SHOP_ADJ
FROM data_all a
WHERE a.ROW_DESC = 1
)
,
tiep_can_don AS (
SELECT
                a.POL_ID,
                a.SLA_TO_SHOP,
                a.SLA_TO_SHOP_ADJ
FROM sla_time a
)
,
final_ AS (
SELECT  /*+ parallel (6) */ a.*,
                b.SLA_TO_SHOP,
                b.SLA_TO_SHOP_ADJ,
                TO_DATE(a.FIRST_CALL, 'YYYYMMDDHH24MISS') - TO_DATE(b.SLA_TO_SHOP, 'YYYYMMDDHH24MISS') AS TIME_TIEP_CAN,
        TO_DATE(a.FIRST_CALL_ADJ, 'YYYYMMDDHH24MISS') - TO_DATE(b.SLA_TO_SHOP_ADJ, 'YYYYMMDDHH24MISS') AS TIME_TIEP_CAN_ADJ,
                c.TIME_ AS TIME_CHAM_DON,
                c.CHAM_3D_STT AS CHAM_DON_3D_STT
FROM data_all a
LEFT JOIN tiep_can_don b
        ON a.POL_ID = b.POL_ID
LEFT JOIN cham_don_3d_stt c
        ON a.POL_ID = c.POL_ID
)
SELECT * FROM FINAL_;

DBMS_OUTPUT.PUT_LINE ('----> DONE INSERT DATA_POL '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));


COMMIT;
END ;


-----------------------------------------------------------------------------------------------------
PROCEDURE PROC_STT_POL(P_DATE NUMBER)
IS

BEGIN
/*
 * asignee: hieumx2
 */


DELETE /*+ append parallel(6) */ FROM F88DWH.W_CHAM_DON_STT_TEST WHERE SUBSTR(CREATED_TIME_POL,1,6)  = SUBSTR(P_DATE, 1,6);
INSERT /*+ append parallel(6) */ INTO F88DWH.W_CHAM_DON_STT_TEST

WITH
tong_hop AS (
SELECT  mdp.CREATED_TIME_POL,
        mdp.SHOP_CODE,
        mdp.POL_ID,
        mdp.STATUS_STR,
        mdp.ACTION_NM,
        mdp.KENH,
        mdp.NHOM_NGUON,
        mdp.NGUON_PHU,
        mdp.TIME_TIEP_CAN,
        mdp.TIME_TIEP_CAN_ADJ,
        mdp.TIME_CHAM_DON ,
        CASE
                WHEN a.STR_TYPE = 'TRONG_NGAY' THEN 'Đơn tiếp cận trong ngày'
                WHEN  a.STR_TYPE = '15_PHUT' THEN 'Đơn tiếp cận 15 phút'
                WHEN  a.STR_TYPE = '60_PHUT' THEN 'Đơn tiếp cận 1 tiếng'
                ELSE 'Không tính SLA'
        END AS POL_TYPE
FROM F88DWH.W_DATA_POL mdp
LEFT JOIN F88DWH.W_BDM_LIST_KENH_NGUON_CAMPAIGN a
        ON a.KENH = mdp.KENH
        AND  a.NHOM_NGUON = mdp.NHOM_NGUON
        AND  a.NGUON_PHU = mdp.NGUON_PHU
        AND  a.CAMPAIGN = mdp.CAMPAIGN
WHERE mdp.ROW_DESC = 1
AND SUBSTR(CREATED_TIME_POL,1,6) = SUBSTR(P_DATE,1,6)
)
,
chi_tiet AS (
SELECT a.*,
    CASE WHEN a.POL_TYPE = 'Đơn tiếp cận 15 phút' AND TIME_TIEP_CAN*24*60 <= 15 AND NVL(TIME_TIEP_CAN_ADJ,1E-20)*24*60 <= 15 THEN 'Đạt SLA'
         WHEN a.POL_TYPE = 'Đơn tiếp cận 1 tiếng' AND TIME_TIEP_CAN*24 <= 1 AND  NVL(TIME_TIEP_CAN_ADJ,1E-20)*24 <= 1 THEN 'Đạt SLA'
         WHEN a.POL_TYPE = 'Đơn tiếp cận trong ngày' AND TIME_TIEP_CAN*24 <=  11 AND  NVL(TIME_TIEP_CAN_ADJ,1E-20)*24 <= 11 THEN 'Đạt SLA'
         WHEN a.POL_TYPE = 'Không tính SLA' THEN 'Không tính SLA'
    ELSE 'Không đạt SLA'
    END TRANG_THAI_TIEP_CAN,
    CASE
	    WHEN STATUS_STR != 'Đang chăm sóc' THEN 'Không tính SLA'
    	WHEN STATUS_STR = 'Đang chăm sóc' AND LOWER(ACTION_NM ) IN ('không nghe máy', 'thuê bao') AND NVL(TIME_CHAM_DON,1E2) <= 1 THEN 'Đạt SLA'
    	WHEN STATUS_STR = 'Đang chăm sóc' AND LOWER(ACTION_NM ) NOT IN ('không nghe máy', 'thuê bao') AND NVL(TIME_CHAM_DON,1E2) <= 2 THEN 'Đạt SLA'
    	ELSE 'Không đạt SLA'
    END
    AS CHAM_DON_3D_STT
FROM tong_hop a
)
,
FINAL_ AS (
SELECT  TO_NUMBER(SUBSTR(CREATED_TIME_POL,1,4)) YEAR_NUM,
        TO_NUMBER(SUBSTR(CREATED_TIME_POL,5,2)) MONTH_NUM,
        CREATED_TIME_POL,
        SHOP_CODE,
        POL_ID,
        STATUS_STR,
        KENH,
        NHOM_NGUON,
        NGUON_PHU,
        TRANG_THAI_TIEP_CAN,
        CHAM_DON_3D_STT ,
        POL_TYPE
FROM chi_tiet a
)
SELECT * FROM final_;

DBMS_OUTPUT.PUT_LINE ('----> DONE INSERT CHAM_DON_STT_TEST '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));


COMMIT;
END ;

-------------------------------------------------------------------------------------------------
--
--PROCEDURE CHAM_DON (P_DATE NUMBER)
--IS
--
--BEGIN
--/*
-- * asignee: hieumx2
-- */
--
--DELETE FROM F88DWH.W_DAILY_ETL_LOG
--WHERE TRUNC(LOG_DT) = TRUNC(SYSDATE)
--        AND JOB_NM = 'CHAM_DON';
--COMMIT;
--
--INSERT INTO F88DWH.W_DAILY_ETL_LOG (LOG_DT, JOB_NM, START_DT)
--VALUES
--(SYSDATE, 'CHAM_DON', SYSDATE);
--
--DELETE /*+ append parallel(6) */ FROM F88DWH.W_KPI_KEY_DRIVER_BY_SHOP_F WHERE  KPI_TYPE = 'VH LV2' AND KPI IN ('QC KHM','QC KHQL','Tiếp cận đơn KHM','Chăm đơn 3 ngày KHM','Tiếp cận đơn KHQL','Chăm đơn 3 ngày KHQL') AND YEAR_NUM = SUBSTR(P_DATE, 1,4) AND MONTH_NUM = SUBSTR(P_DATE,5,2) AND DATE_WID = P_DATE;
--COMMIT;
--INSERT /*+ append parallel(8) */ INTO F88DWH.W_KPI_KEY_DRIVER_BY_SHOP_F(YEAR_NUM, MONTH_NUM, DATE_WID, SHOP_WID , SHOP_CODE ,SHOP_NM, KPI_CODE, KPI, VALUE_, tu_so, mau_so,KPI_TYPE)
--
--
--WITH
--qc AS
--(SELECT
--        SHOP_NM ,
--        COUNT(1) MAU_SO,
--        SUM (CASE WHEN QC_RESULT = 'Đạt' THEN 1 ELSE 0 END)     TU_SO,
--        sum(QC_SCORE)/100 / COUNT(1) VALUE_,
--        CASE WHEN TYPE_ = 'Digital' THEN 'KHM' ELSE 'KHQL' END CUS_TYPE
--FROM F88DWH.W_TNKH_CALL_QC_F
--WHERE MONTH_NUM like '%9/2023'
--GROUP BY
--        SHOP_NM ,
--        CASE WHEN TYPE_ = 'Digital' THEN 'KHM' ELSE 'KHQL' END
--),
--TCD_KHM AS
--(SELECT wsd.SHOP_WID,
--                mcds.SHOP_CODE,
--                wsd.SHOP_NM ,
--                'Tiếp cận đơn KHM' AS KPI,
--                count(CASE WHEN TRANG_THAI_TIEP_CAN = 'Đạt SLA' THEN POL_ID END )/NULLIF(count(CASE WHEN TRANG_THAI_TIEP_CAN IN('Đạt SLA', 'Không đạt SLA')  THEN POL_ID END ),0) AS VALUE_,
--                count(CASE WHEN TRANG_THAI_TIEP_CAN = 'Đạt SLA' THEN POL_ID END ) AS TU_SO,
--                count(CASE WHEN TRANG_THAI_TIEP_CAN IN('Đạt SLA', 'Không đạt SLA')  THEN POL_ID END ) AS MAU_SO
--FROM F88DWH.W_CHAM_DON_STT mcds
--LEFT JOIN F88DWH.W_SHOP_D wsd
--        ON wsd.shop_code = TO_CHAR(mcds.SHOP_CODE) AND wsd.SHOP_TYPE = 'F88'
--        AND wsd.VALID_FM_DT <= to_date(P_DATE,'yyyymmdd')
--        AND wsd.VALID_TO_DT >= to_date(P_DATE,'yyyymmdd')
--WHERE KENH IN('Marketing PGD','TLS E2E','Digital HO')
--AND mcds.SHOP_CODE IS NOT NULL
--AND mcds.YEAR_NUM = substr(P_DATE,1,4)
--AND mcds.MONTH_NUM = substr(P_DATE,5,2)
--GROUP BY wsd.SHOP_WID,
--                mcds.SHOP_CODE,
--                wsd.SHOP_NM
--),
--TCD_KHQL AS (
--SELECT wsd.SHOP_WID,
--                mcds.SHOP_CODE,
--                wsd.SHOP_NM ,
--                'Tiếp cận đơn KHQL' AS KPI,
--                count(CASE WHEN TRANG_THAI_TIEP_CAN = 'Đạt SLA' THEN POL_ID END )/NULLIF(count(CASE WHEN TRANG_THAI_TIEP_CAN IN('Đạt SLA', 'Không đạt SLA')  THEN POL_ID END ),0) AS VALUE_,
--                count(CASE WHEN TRANG_THAI_TIEP_CAN = 'Đạt SLA' THEN POL_ID END ) AS TU_SO,
--                count(CASE WHEN TRANG_THAI_TIEP_CAN IN('Đạt SLA', 'Không đạt SLA')  THEN POL_ID END ) AS MAU_SO
--FROM F88DWH.W_CHAM_DON_STT mcds
--LEFT JOIN F88DWH.W_SHOP_D wsd
--        ON wsd.shop_code = TO_CHAR(mcds.SHOP_CODE)
--        AND wsd.SHOP_TYPE = 'F88'
--        AND wsd.VALID_FM_DT <= to_date(P_DATE,'yyyymmdd')
--        AND wsd.VALID_TO_DT >= to_date(P_DATE,'yyyymmdd')
--WHERE KENH = 'Recall KHQL'
--AND mcds.SHOP_CODE IS NOT NULL
--AND mcds.YEAR_NUM = substr(P_DATE,1,4)
--AND mcds.MONTH_NUM = substr(P_DATE,5,2)
--GROUP BY wsd.SHOP_WID,
--                mcds.SHOP_CODE,
--                wsd.SHOP_NM
--)
--,CD_KHM AS (
--SELECT wsd.SHOP_WID,
--                mcds.SHOP_CODE,
--                wsd.SHOP_NM ,
--                'Chăm đơn 3 ngày KHM' AS KPI,
--                count(CASE WHEN CHAM_DON_3D_STT = 'Đạt SLA' THEN POL_ID END )/NULLIF(count(1),0) AS VALUE_,
--                count(CASE WHEN CHAM_DON_3D_STT = 'Đạt SLA' THEN POL_ID END ) AS TU_SO,
--                count(1) AS MAU_SO
--FROM F88DWH.W_CHAM_DON_STT mcds
--LEFT JOIN F88DWH.W_SHOP_D wsd
--        ON wsd.shop_code = TO_CHAR(mcds.SHOP_CODE)  AND wsd.SHOP_TYPE = 'F88'
--        AND wsd.VALID_FM_DT <= to_date(P_DATE,'yyyymmdd')
--        AND wsd.VALID_TO_DT >= to_date(P_DATE,'yyyymmdd')
--WHERE KENH IN('Marketing PGD','TLS E2E','Digital HO')
--AND mcds.SHOP_CODE IS NOT NULL
--AND STATUS_STR = 'Đang chăm sóc'
--AND mcds.YEAR_NUM = substr(P_DATE,1,4)
--AND mcds.MONTH_NUM = substr(P_DATE,5,2)
--GROUP BY wsd.SHOP_WID,
--                mcds.SHOP_CODE,
--                wsd.SHOP_NM
--)
--,CD_KHQL AS (
--SELECT wsd.SHOP_WID,
--                mcds.SHOP_CODE,
--                wsd.SHOP_NM ,
```

### `F88DWH.PKG_KPI_KEY_DRIVER_BY_SHOP` (PACKAGE BODY) — 23 lines reference search term

```
PACKAGE BODY        PKG_KPI_KEY_DRIVER_BY_SHOP
AS
/*
* -- Author: F88DWH
* -- Created: 2024-01-18
* -- Update : 2025-09-29 by hungnm6
* -- Ticket: #F88_17OU7FT34
* -- Purpose: Phục vụ BDM theo dõi các chỉ số kinh doanh
*/

--------------------------------------------------
-- PROC INSERT DATA VÀO BẢNG W_RPT_ONLINE_TMP
PROCEDURE SALE_LEAD (P_DATE NUMBER) IS BEGIN
        --DOCSTRING
                /**
                * PROCEDURE SALE_LEAD
                *
                * Mô tả: Procedure thực hiện ETL dữ liệu báo cáo Sale Lead từ các nguồn khác nhau
                * và tổng hợp vào bảng W_RPT_ONLINE_TMP để phục vụ báo cáo KPI
                *
                * INPUT PARAMETERS:
                * - P_DATE (NUMBER): Ngày chạy báo cáo theo format YYYYMMDD
                *
                * TABLES USED:
                * - F88DWH.W_DAILY_ETL_LOG: Bảng log theo dõi quá trình ETL
                * - F88DWH.W_RPT_ONLINE_TMP: Bảng tạm chứa dữ liệu báo cáo (target table)
                * - F88DWH.VW_W_POL_DTL_F: View chứa thông tin chi tiết về đơn POL
                * - F88DWH.W_AREA_MANAGER_D: Bảng thông tin quản lý khu vực
                * - F88DWH.VW_W_EMPLOYEE_D: View thông tin nhân viên
                * - F88DWH.W_LOAN_DTL_F: Bảng chi tiết khoản vay
                * - F88DWH.W_ASSET_TP_D: Bảng loại tài sản
                * - F88DWH.VW_W_LOAN_CUSTOMER_F: View thông tin khách hàng theo khoản vay
                * - F88DWH.W_RESOURCES_D: Bảng nguồn khách hàng
                * - F88DWH.W_SHOP_D: Bảng thông tin cửa hàng
                *
                * OUTPUT:
                * - Cập nhật bảng F88DWH.W_RPT_ONLINE_TMP với dữ liệu tổng hợp từ 3 nguồn:
                *   1. Lead PGD từ VW_W_POL_DTL_F (khách hàng chuyển đến cửa hàng)
                *   2. Sale và Giai ngân TT từ VW_W_POL_DTL_F (giao dịch thành công)
                *   3. HDMM nhập thẳng trên LOS từ W_LOAN_DTL_F (không qua PAWN_ONLINE_WID)
                *
                * CẤU TRÚC DỮ LIỆU OUTPUT:
                * - YEAR_NUM, MONTH_NUM, REPORT_DT: Thông tin thời gian
                * - SHOP_CODE, CALLER_CODE, SALER_CODE: Thông tin cửa hàng và nhân viên
                * - CHANNEL_CODE, FORM_ASSET, ASSET: Thông tin kênh và loại tài sản
                * - CAMPAIGN, NHOM_NGUON, NGUON_PHU: Thông tin chiến dịch và nguồn
                * - Form_TT, Form_TLS, Lead_PGD, Sale, Giai_ngan: Các chỉ số KPI chính
                * - Lead_TLS, Sale_TLS, Giai_ngan_TLS: Chỉ số TLS
                * - F_cancel_in_month, S_in_month, F_cancel: Chỉ số hủy và thành công trong tháng
                *
                * LOGIC XỬ LÝ:
                * 1. Xóa log cũ và tạo log mới cho job
                * 2. Truncate bảng target W_RPT_ONLINE_TMP
                * 3. Insert dữ liệu từ 3 nguồn khác nhau với UNION ALL
                * 4. Group by các trường chiều để tổng hợp dữ liệu
                * 5. Cập nhật log hoàn thành
                */

        dbms_output.put_line('----> START TIME:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

        -- Xóa dữ liệu trong bảng log ETL Daily của ngày Chạy
        DELETE FROM F88DWH.W_DAILY_ETL_LOG WHERE TRUNC(LOG_DT) = TRUNC(SYSDATE) AND JOB_NM = 'SALE_LEAD';
                COMMIT;

        -- Insert Log thời gian bắt đầu chạy job vào bảng Log
        INSERT INTO F88DWH.W_DAILY_ETL_LOG (LOG_DT, JOB_NM, START_DT) VALUES (SYSDATE, 'SALE_LEAD', SYSDATE);

        -- Truncate bảng W_RPT_ONLINE_TMP
        EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_ONLINE_TMP';
                COMMIT;

        -- ========================================
        -- INSERT DỮ LIỆU VÀO BẢNG TARGET W_RPT_ONLINE_TMP
        -- ========================================
        -- Sử dụng hint append và parallel(6) để tối ưu hiệu suất insert
        -- Dữ liệu được tổng hợp từ 3 nguồn chính với UNION ALL
        INSERT /*+ append parallel(6) */ INTO F88DWH.W_RPT_ONLINE_TMP
                SELECT
                        YEAR_NUM,
                        MONTH_NUM,
                        date1 REPORT_DT,
                        SHOP_CODE,
                        CALLER_CODE,
                        SALER_CODE,
                        CHANNEL_CODE,
                        FORM_ASSET,
                        ASSET,
                        CAMPAIGN,
                        NHOM_NGUON,
                        NGUON_PHU,
                        PHAN_LOAI_NGUON_PHU,
                        URL,
                        ctr_type,
                        SUM(Form_TT) Form_TT,
                        SUM(Form_TLS) Form_TLS,
                        SUM(Lead_PGD) Lead_PGD,
                        SUM(Sale) Sale,
                        SUM(Giai_ngan) Giai_ngan,
                        SUM(Lead_TLS) Lead_TLS,
                        SUM(Sale_TLS) Sale_TLS,
                        SUM(Giai_ngan_TLS) Giai_ngan_TLS,
                        CHANNEL_STR,
                        sum(F_cancel_in_month) F_cancel_in_month,
                        sum(S_in_month) S_in_month,
                        ASSET_TYPE_NAME ,
                        sum(F_cancel) F_cancel
                FROM (
                -- ========================================
                -- NGUỒN 1: LEAD PGD - Khách hàng chuyển đến cửa hàng
                -- ========================================
                -- Lấy dữ liệu từ VW_W_POL_DTL_F với điều kiện FIRST_SHOP_TRANS_DT không null
                -- Đây là các lead đã được chuyển từ online xuống cửa hàng để xử lý
                        (   SELECT
                                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) YEAR_NUM,
                                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) MONTH_NUM,
                                TRUNC(PO.FIRST_SHOP_TRANS_DT ) AS date1,
                                po.GROUP_id shop_code,
                                WED.EMPLOYEE_CODE CALLER_CODE,
                                NULL SALER_CODE,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END Channel_code,
                                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                                po.LOAN_ASSET_TP_NM ASSET,
                                CAMPAIGN_NM CAMPAIGN,
                                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END url,
                                po.ctr_type,
                                -- Các chỉ số KPI cho nguồn Lead PGD:
                                0 AS Form_TT,                    -- Không có Form TT trong nguồn này
                                0 AS Form_TLS,                   -- Không có Form TLS trong nguồn này
                                SUM(CASE WHEN PO.FIRST_SHOP_TRANS_DT  IS NOT NULL THEN 1 ELSE 0 END) AS Lead_PGD,  -- Đếm số lead chuyển đến cửa hàng
                                0 AS Sale,                       -- Không có Sale trong nguồn này
                                0 AS Giai_ngan,                  -- Không có Giai ngân trong nguồn này
                                0 AS Lead_TLS,                   -- Không có Lead TLS trong nguồn này
                                0 AS Sale_TLS,                   -- Không có Sale TLS trong nguồn này
                                0 AS Giai_ngan_TLS,              -- Không có Giai ngân TLS trong nguồn này
                                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                                0 F_cancel_in_month,
                                0 S_in_month,
                                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                                0 F_cancel
                        FROM F88DWH.VW_W_POL_DTL_F po
                        -- Join với bảng quản lý khu vực để lấy thông tin SHOP_CODE
                        LEFT JOIN F88DWH.W_AREA_MANAGER_D m ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
                        -- Join với bảng nhân viên (chỉ lấy nhân viên đang hoạt động và current row)
                        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
                        WHERE 1=1
                                -- Điều kiện lọc dữ liệu từ tháng trước đến hiện tại
                                AND PO.FIRST_SHOP_TRANS_DT > ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1
                        GROUP BY
                                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) ,
                                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) ,
                                TRUNC(PO.FIRST_SHOP_TRANS_DT ),
                                po.GROUP_id ,
                                WED.EMPLOYEE_CODE ,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END ,
                                po.FORM_ASSET_TP_NM  ,
                                po.LOAN_ASSET_TP_NM ,
                                CAMPAIGN_NM ,
                                po.SOURCE_LEVEL_2_NAME ,
                                po.SOURCE_LEVEL_3_NAME ,
                                po.SOURCE_LEVEL_4_NAME ,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END ,
                                po.ctr_type,
                                po.SOURCE_LEVEL_1_NAME,
                                po.FORM_ASSET_TP_NM
                        )
                UNION  ALL
                -- ========================================
                -- NGUỒN 2: SALE TT VÀ GIẢI NGÂN TT - Giao dịch thành công
                -- ========================================
                -- Lấy dữ liệu từ VW_W_POL_DTL_F với điều kiện DISBURSE_DT và STATUS_NM = 'Nhận cầm cố'
                -- Đây là các giao dịch đã được giải ngân thành công
                        (
                        SELECT
                                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                                                po.GROUP_id shop_code,
                                WED.EMPLOYEE_CODE CALLER_CODE,
                                NULL SALER_CODE,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END Channel_code,
                                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                                po.LOAN_ASSET_TP_NM ASSET,
                                CAMPAIGN_NM CAMPAIGN,
                                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END url,
                                po.ctr_type,
                                -- Các chỉ số KPI cho nguồn Sale TT và Giai ngân:
                                0 AS Form_TT,                    -- Không có Form TT trong nguồn này
                                0 AS Form_TLS,                   -- Không có Form TLS trong nguồn này
                                0 AS Lead_PGD,                   -- Không có Lead PGD trong nguồn này
                                COUNT(po.LOAN_CODE)  AS Sale,    -- Đếm số giao dịch thành công
                                SUM(po.DISBURSE_AMT) AS Giai_ngan,  -- Tổng số tiền giải ngân
                                0 AS Lead_TLS,                   -- Không có Lead TLS trong nguồn này
                                0 AS Sale_TLS,                   -- Không có Sale TLS trong nguồn này
                                0 AS Giai_ngan_TLS,              -- Không có Giai ngân TLS trong nguồn này
                                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                                0 F_cancel_in_month,  -- Không có hủy trong tháng cho nguồn này
                                -- Đếm số giao dịch thành công trong tháng (form tạo và giải ngân cùng ngày)
                                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND trunc(po.FORM_CREATED_DT) = TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  THEN 1 ELSE 0 END ) S_in_month,
                                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                                0 F_cancel  -- Không có hủy cho nguồn này
                        FROM F88DWH.VW_W_POL_DTL_F po
                        LEFT JOIN F88DWH.W_AREA_MANAGER_D m ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
                        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
                        WHERE 1=1
                                -- Điều kiện lọc dữ liệu từ tháng trước đến hiện tại (format YYYYMMDD)
                                AND PO.DISBURSE_DT  > TO_CHAR(ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1, 'YYYYMMDD')
                                -- Chỉ lấy các giao dịch có trạng thái 'Nhận cầm cố' (đã giải ngân thành công)
                                AND po.STATUS_NM ='Nhận cầm cố'
                        GROUP BY
                                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                                po.GROUP_id ,
                                WED.EMPLOYEE_CODE ,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END ,
                                po.FORM_ASSET_TP_NM ,
                                po.LOAN_ASSET_TP_NM,
                                CAMPAIGN_NM ,
                                po.SOURCE_LEVEL_2_NAME ,
                                po.SOURCE_LEVEL_3_NAME ,
                                po.SOURCE_LEVEL_4_NAME ,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END ,
                                po.ctr_type,
                                po.SOURCE_LEVEL_1_NAME,
                                po.FORM_ASSET_TP_NM
                        )
                UNION  ALL
                -- ========================================
                -- NGUỒN 3: HDMM NHẬP THẲNG TRÊN LOS - Không qua PAWN_ONLINE_WID
                -- ========================================
                -- Lấy dữ liệu từ W_LOAN_DTL_F với điều kiện LOAN_CODE không tồn tại trong VW_W_POL_DTL_F
                -- Đây là các giao dịch được nhập trực tiếp trên hệ thống LOS mà không qua quy trình online
                        (
                        SELECT
                                to_number(substr(a.DISBURSE_DATE_WID, 1, 4)) year_num,
                                to_number(substr(a.DISBURSE_DATE_WID, 5, 2)) month_num,
                                to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') date1,
                                -- Chuyển đổi SHOP_CODE sang số nếu là chuỗi số, ngược lại NULL
                                CASE WHEN REGEXP_LIKE(sh.SHOP_CODE, '^[[:digit:]]+$') THEN to_number(sh.SHOP_CODE) ELSE NULL END shop_code ,
                                NULL caller_name,  -- Không có thông tin caller cho nguồn này
                                NULL caller_code,  -- Không có thông tin caller cho nguồn này
                                a.CHANNEL_CODE ,   -- Lấy CHANNEL_CODE trực tiếp từ W_LOAN_DTL_F
                                c.ASSET_TP_NM form_asset,  -- Loại tài sản từ bảng W_ASSET_TP_D
                                c.ASSET_TP_NM asset,       -- Loại tài sản (giống form_asset)
                                r.RESOURCES_NM campaign,   -- Tên chiến dịch từ bảng W_RESOURCES_D
                                -- Logic phân loại nhóm nguồn dựa trên RESOURCES_CODE:
                                -- Các code '016','015','017','023','024','025','014','029','021' thuộc 'Digital Mạng Lưới'
                                -- Các code khác thuộc 'Trade MKT'
                                CASE
                                        WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                                ELSE 'Trade MKT' END NHOM_NGUON,
                                'LOS' nguon_phu,              -- Nguồn phụ luôn là 'LOS' cho nguồn này
                                NULL phan_loai_nguon_phu,     -- Không có phân loại nguồn phụ
                                NULL url,                     -- Không có URL cho nguồn này
                                a.CTR_TYPE,                   -- Loại CTR từ W_LOAN_DTL_F
                                -- Các chỉ số KPI cho nguồn HDMM nhập thẳng LOS:
                                count(a.LOAN_WID) form_tt,     -- Đếm số form TT (bằng số loan)
                                0 form_tls,                    -- Không có Form TLS cho nguồn này
                                count(a.LOAN_WID) lead_pgd,    -- Đếm số lead PGD (bằng số loan)
                                count(a.LOAN_WID) sale,        -- Đếm số sale (bằng số loan)
                                sum(a.DISBURSE_AMT) giai_ngan, -- Tổng số tiền giải ngân
                                0 Lead_TLS,                    -- Không có Lead TLS cho nguồn này
                                0 Sale_TLS,                    -- Không có Sale TLS cho nguồn này
                                0 Giai_ngan_TLS,               -- Không có Giai ngân TLS cho nguồn này
                                'Marketing PGD' SOURCE,       -- Nguồn luôn là 'Marketing PGD' cho nguồn này
                                0 F_cancel_in_month,           -- Không có hủy trong tháng cho nguồn này
                                0 S_in_month,                  -- Không có thành công trong tháng cho nguồn này
                                c.ASSET_TP_NM ASSET_TYPE_NAME, -- Tên loại tài sản
                                0 F_cancel                     -- Không có hủy cho nguồn này
                        FROM F88DWH.W_LOAN_DTL_F a
                        -- Join với VW_W_POL_DTL_F để kiểm tra LOAN_CODE có tồn tại không
                        LEFT JOIN F88DWH.VW_W_POL_DTL_F b ON a.LOAN_WID =b.LOAN_WID
                        -- Join với bảng loại tài sản để lấy thông tin ASSET_TP_NM
                        LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID =a.ASSET_TYPE_WID
                        -- Join với bảng khách hàng vay để lấy thông tin nguồn
                        LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =A.LOAN_WID
                        -- Join với bảng nguồn để lấy thông tin chiến dịch
                        LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
                        -- Join với bảng cửa hàng để lấy thông tin SHOP_CODE
                        LEFT JOIN F88DWH.W_SHOP_D sh ON sh.SHOP_WID = a.SHOP_WID
                        WHERE 1 = 1
                        -- Điều kiện chính: LOAN_CODE phải NULL (không tồn tại trong VW_W_POL_DTL_F)
                        -- Điều này đảm bảo chỉ lấy các giao dịch nhập thẳng trên LOS
                        AND b.LOAN_CODE  IS NULL
                        -- Điều kiện lọc dữ liệu từ tháng trước đến hiện tại (format YYYYMMDD)
                        AND a.DISBURSE_DATE_WID > TO_CHAR(ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1, 'YYYYMMDD')
                        GROUP BY
                                to_number(substr(a.DISBURSE_DATE_WID, 1, 4)),
                                to_number(substr(a.DISBURSE_DATE_WID, 5, 2)),
                                to_date(a.DISBURSE_DATE_WID, 'yyyymmdd'),
                                sh.SHOP_CODE ,
                                a.CHANNEL_CODE ,
                                c.ASSET_TP_NM,
                                r.RESOURCES_NM,
                                a.CTR_TYPE,
                                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                                ELSE 'Trade MKT' END
                        )
                )
                -- ========================================
                -- GROUP BY ĐỂ TỔNG HỢP DỮ LIỆU
                -- ========================================
                -- Group by tất cả các trường chiều để tổng hợp các chỉ số KPI
                -- Điều này đảm bảo dữ liệu được tổng hợp theo từng chiều phân tích
                GROUP BY
                        YEAR_NUM,                    -- Năm
                        MONTH_NUM,                   -- Tháng
                        date1,                       -- Ngày báo cáo
                        shop_code,                   -- Mã cửa hàng
                        CALLER_CODE,                 -- Mã nhân viên caller
                        SALER_CODE,                  -- Mã nhân viên saler
                        Channel_code,                -- Mã kênh
                        FORM_ASSET,                  -- Loại tài sản form
                        ASSET,                       -- Loại tài sản
                        CAMPAIGN,                    -- Chiến dịch
                        NHOM_NGUON,                  -- Nhóm nguồn
                        NGUON_PHU,                   -- Nguồn phụ
                        PHAN_LOAI_NGUON_PHU,         -- Phân loại nguồn phụ
                        URL,                         -- URL
                        ctr_type,                    -- Loại CTR
                        CHANNEL_STR,                 -- Chuỗi kênh
                        ASSET_TYPE_NAME ;            -- Tên loại tài sản
                COMMIT;

                dbms_output.put_line('----> DONE INSERT SUCCESS SALE_LEAD AT: '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

        -- ========================================
        -- CẬP NHẬT LOG HOÀN THÀNH JOB
        -- ========================================
        -- Cập nhật thời gian kết thúc job vào bảng log để theo dõi thời gian thực thi
        UPDATE F88DWH.W_DAILY_ETL_LOG
                SET END_DT = SYSDATE
                WHERE TRUNC(LOG_DT) = TRUNC(SYSDATE)
                        AND JOB_NM = 'SALE_LEAD';

        END;

--------------------------------------------------
-- PROC TÍNH TOÁN NHÓM CHỈ SỐ LIÊN QUAN ĐẾN DƯ NỢ VÀ GIẢI NGÂN
PROCEDURE DUNO (P_DATE NUMBER)  IS BEGIN
        -- DOCSTRING
                /**
                * PROCEDURE DUNO
                *
                * Mô tả: Procedure thực hiện tính toán và cập nhật các KPI dư nợ vào bảng W_KPI_KEY_DRIVER_BY_SHOP_F
                * Bao gồm các chỉ số về dư nợ, roll forward/back, rút gốc, giải ngân, khách hàng active, etc.
                *
                * INPUT PARAMETERS:
                * - P_DATE (NUMBER): Ngày chạy báo cáo theo format YYYYMMDD
                *
                * TABLES USED:
                * - F88DWH.W_KPI_KEY_DRIVER_BY_SHOP_F: Bảng target chứa KPI theo cửa hàng
                * - F88DWH.W_DAILY_ETL_LOG: Bảng log theo dõi quá trình ETL
                * - F88DWH.W_LOAN_DTL_F: Bảng chi tiết khoản vay
                * - F88DWH.W_SHOP_D: Bảng thông tin cửa hàng
                * - F88DWH.W_ASSET_TP_D: Bảng loại tài sản
                * - F88DWH.W_LOAN_DAILY_F: Bảng dữ liệu khoản vay theo ngày
                * - F88DWH.W_RPT_LOAN_TRAFFIC_F: Bảng báo cáo traffic khoản vay
                * - F88DWH.VW_W_CUSTOMER_D: View thông tin khách hàng
                * - F88DWH.W_CTR_TYPE_KHQL: Bảng loại hợp đồng khách hàng quản lý
                *
                * OUTPUT:
                * - Cập nhật bảng F88DWH.W_KPI_KEY_DRIVER_BY_SHOP_F với các KPI dư nợ:
                *   + Dư nợ DPD0 (tổng, theo sản phẩm 2W/4W, theo loại khách hàng)
                *   + Dư nợ BQ (bình quân)
                *   + Roll Forward/Roll Back (tổng, theo sản phẩm, theo tháng)
                *   + Rút gốc (tổng, theo sản phẩm, tỷ lệ)
                *   + Giải ngân (tổng, theo loại khách hàng, net)
                *   + Khách hàng active và lũy kế
                *   + Các chỉ số dư nợ theo bucket (B1A, B1B, B2, B3, B3+)
                *   + Same Month Closed, DNQH, WO
                *
                * CẤU TRÚC DỮ LIỆU OUTPUT:
                * - YEAR_NUM, MONTH_NUM, DATE_WID: Thông tin thời gian
                * - SHOP_WID, SHOP_CODE, SHOP_NM: Thông tin cửa hàng
                * - KPI_CODE: Mã KPI (ví dụ: '10.1.1', '9.1', etc.)
                * - KPI: Tên KPI (ví dụ: 'Dư nợ DPD0', '%RFW B0-B1 monthly 2W')
                * - VALUE_: Giá trị KPI
                * - TU_SO, MAU_SO: Tử số và mẫu số cho các KPI tỷ lệ
                * - KPI_TYPE: Loại KPI ('KPI' hoặc 'Key-driver')
                *
                * LOGIC XỬ LÝ:
                * 1. Xóa dữ liệu KPI dư nợ cũ trong bảng target
                * 2. Tính toán các CTE (Common Table Expression) để chuẩn bị dữ liệu
                * 3. Insert dữ liệu KPI mới với các chỉ số đã tính toán
                * 4. Cập nhật log hoàn thành
                *
                * CÁC CTE CHÍNH:
                * - smc: Same Month Closed - giao dịch đóng trong cùng tháng
                * - WO: Write Off - dư nợ xóa nợ
                * - EOP: End of Period - dư nợ cuối kỳ
                * - EOP_BF: End of Period Before - dư nợ đầu kỳ
                * - RF01, RG, NET, cuml, active, TONG_GN, PAID: Các CTE hỗ trợ tính toán
                */

        -- Xóa dữ liệu của các KPI dư nợ trong bảng W_KPI_KEY_DRIVER_BY_SHOP_F tại ngày chạy P_DATE
        DELETE /*+ append parallel(6) */ FROM F88DWH.W_KPI_KEY_DRIVER_BY_SHOP_F
                WHERE YEAR_NUM = SUBSTR(P_DATE, 1,4)
                        AND MONTH_NUM = SUBSTR(P_DATE,5,2)
                        AND DATE_WID = P_DATE
                        AND KPI IN (
                                '%RFW B0-B1 monthly 2W','%RFW B0-B1 monthly 4W','%RFW B0-B1 monthly total',
                                '%Rút gốc','%Rút gốc 2W','%Rút gốc 4W','DNQH',
                                'KH active 4W','KH active 2W','KH lũy kế 4W', 'Same Month Closed','KH lũy kế 2W','DNQH',
                                'Dư nợ B1A','Dư nợ B1B','Dư nợ B2','Dư nợ B3','Dư nợ B3+','Dư nợ BQ','Dư nợ BQ DPD0','Dư nợ DPD 1-90',
                                'Dư nợ DPD0','Dư nợ DPD0 KHM 2W','Dư nợ DPD0 KHM 4W','Dư nợ DPD0 KHQL 2W','Dư nợ DPD0 KHQL 4W','Dư nợ DPD0 đầu kỳ','Dư nợ WO',
                                'Tổng giải ngân','Tổng giải ngân KHM','Tổng giải ngân KHM 2W','Tổng giải ngân KHM 4W','Tổng giải ngân KHQL',
                                'Giải ngân Net','Giải ngân Net 2W','Giải ngân Net 4W',
                                'HĐMM 2W','HĐMM 4W','Lãi phí thực thu',
                                'Roll Back','Roll Back monthly 2W','Roll Back monthly 4W','Roll Forward','Roll Forward monthly 2W','Roll Forward monthly 4W',
                                'Rút gốc','Rút gốc 2W','Rút gốc 4W','Tăng Net', 'Dư nợ DPD0 đầu kỳ 2W','Dư nợ DPD0 đầu kỳ 4W','Dư nợ DPD0 2W','Dư nợ DPD0 4W',
                                'Roll Forward monthly B0-B1', 'Roll Forward monthly B0-B1 2W', 'Roll Forward monthly B0-B1 4W', 'Roll Back monthly',
                                '%Paid monthly 2W','%Paid monthly 4W','%Paid monthly'
                        );
                COMMIT;

        -- INSERT DỮ LIỆU KPI MỚI
        INSERT /*+ append parallel(8) */ INTO F88DWH.W_KPI_KEY_DRIVER_BY_SHOP_F(YEAR_NUM, MONTH_NUM, DATE_WID, SHOP_WID , SHOP_CODE ,SHOP_NM, KPI_CODE, KPI, VALUE_, tu_so, mau_so,KPI_TYPE)

                -- ========================================
                -- CÁC CTE (COMMON TABLE EXPRESSION) ĐỂ CHUẨN BỊ DỮ LIỆU
                -- ========================================

                -- CTE 1: SMC (Same Month Closed) - Giao dịch đóng trong cùng tháng
                WITH smc AS (
                        SELECT
                                a.SHOP_WID ,
                                b.SHOP_CODE ,
                                b.SHOP_NM ,
                                sum(a.DISBURSE_AMT)/1e6 samemonth_closed
                        FROM F88DWH.W_LOAN_DTL_F a
                        -- Join với bảng cửa hàng để lấy thông tin SHOP_CODE, SHOP_NM
                        LEFT JOIN F88DWH.W_SHOP_D b ON b.SHOP_WID = a.SHOP_WID
                        -- Join với bảng loại tài sản để lấy thông tin ASSET_TP_NM
                        LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
                        WHERE 1=1
                                -- Điều kiện lọc dữ liệu từ đầu tháng đến ngày P_DATE
                                AND DISBURSE_DATE_WID >= to_char(trunc(to_date(P_DATE,'yyyymmdd'),'mm'),'yyyymmdd')
                                AND DISBURSE_DATE_WID <= P_DATE
                                -- Điều kiện lọc kênh: KDML hoặc ONLINE
                                -- Logic chuyển đổi kênh: E2E và PTDT3P từ ngày cụ thể sẽ được chuyển thành KDML
                                AND (
                                        (CASE
                                                WHEN (a.DISBURSE_DATE_WID >=20240515 AND a.CHANNEL_CODE ='E2E')
                                                        OR (a.DISBURSE_DATE_WID >=20240919 AND a.CHANNEL_CODE ='PTDT3P')  THEN 'KDML'
                                                ELSE a.CHANNEL_CODE END
                                        ) = 'KDML'
                                        OR (a.DISBURSE_DATE_WID >=20241107 AND a.SALE_CHANNEL ='ONLINE')
                                )
                        -- Điều kiện Same Month Closed: tháng giải ngân = tháng đóng
                        AND substr(a.DISBURSE_DATE_WID,1,6)=substr(nvl(a.CLOSED_DATE_WID,0),1,6)
                        GROUP BY
                                a.SHOP_WID ,
                                b.SHOP_CODE ,
                                b.SHOP_NM                ),

                -- CTE 2: WO (Write Off) - Dư nợ xóa nợ
                WO AS (
                        SELECT
                                a.SHOP_WID,
                                b.SHOP_CODE,
                                b.SHOP_NM,
                                -- Logic phân loại sản phẩm:
                                -- '00000015','00000007' -> 'DKOT' (Ô tô)
                                -- '00000017','00000013' -> 'DKXM' (Xe máy)
                                -- Các loại khác -> 'Khác'
                                CASE WHEN c.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN c.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END SP,
                                -- Tính dư nợ xóa nợ: chỉ tính các khoản có IS_BAD_DEBT=1 và STATUS != 603
                                sum(CASE WHEN a.DATE_WID = P_DATE AND a.IS_BAD_DEBT=1 AND a.STATUS !=603 THEN a.PRINCIPAL_REMAIN ELSE 0 END)/1e6 WO
                        FROM F88DWH.W_LOAN_DAILY_F a
                        -- Join với bảng cửa hàng để lấy thông tin SHOP_CODE, SHOP_NM
                        LEFT JOIN F88DWH.W_SHOP_D b ON b.SHOP_WID = a.SHOP_WID
                        -- Join với bảng loại tài sản để lấy thông tin ASSET_TP_CODE
                        LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
```

### `F88DWH.PKG_KPI_KEY_DRIVER_TEST` (PACKAGE BODY) — 23 lines reference search term

```
PACKAGE BODY        PKG_KPI_KEY_DRIVER_TEST
AS
/*
* -- Author: F88DWH
* -- Created: 2024-01-18
* -- Update : 2025-09-11 by hungnm6
* -- Ticket: #F88_17OU7FT34
* -- Purpose: Phục vụ BDM theo dõi các chỉ số kinh doanh
*/

--------------------------------------------------
-- PROC INSERT DATA VÀO BẢNG W_RPT_ONLINE_TEST
PROCEDURE SALE_LEAD (P_DATE NUMBER) IS BEGIN
        --DOCSTRING
                /**
                * PROCEDURE SALE_LEAD
                *
                * Mô tả: Procedure thực hiện ETL dữ liệu báo cáo Sale Lead từ các nguồn khác nhau
                * và tổng hợp vào bảng W_RPT_ONLINE_TEST để phục vụ báo cáo KPI
                *
                * INPUT PARAMETERS:
                * - P_DATE (NUMBER): Ngày chạy báo cáo theo format YYYYMMDD
                *
                * TABLES USED:
                * - F88DWH.W_DAILY_ETL_LOG: Bảng log theo dõi quá trình ETL
                * - F88DWH.W_RPT_ONLINE_TEST: Bảng tạm chứa dữ liệu báo cáo (target table)
                * - F88DWH.VW_W_POL_DTL_F: View chứa thông tin chi tiết về đơn POL
                * - F88DWH.W_AREA_MANAGER_D: Bảng thông tin quản lý khu vực
                * - F88DWH.VW_W_EMPLOYEE_D: View thông tin nhân viên
                * - F88DWH.W_LOAN_DTL_F: Bảng chi tiết khoản vay
                * - F88DWH.W_ASSET_TP_D: Bảng loại tài sản
                * - F88DWH.VW_W_LOAN_CUSTOMER_F: View thông tin khách hàng theo khoản vay
                * - F88DWH.W_RESOURCES_D: Bảng nguồn khách hàng
                * - F88DWH.W_SHOP_D: Bảng thông tin cửa hàng
                *
                * OUTPUT:
                * - Cập nhật bảng F88DWH.W_RPT_ONLINE_TEST với dữ liệu tổng hợp từ 3 nguồn:
                *   1. Lead PGD từ VW_W_POL_DTL_F (khách hàng chuyển đến cửa hàng)
                *   2. Sale và Giai ngân TT từ VW_W_POL_DTL_F (giao dịch thành công)
                *   3. HDMM nhập thẳng trên LOS từ W_LOAN_DTL_F (không qua PAWN_ONLINE_WID)
                *
                * CẤU TRÚC DỮ LIỆU OUTPUT:
                * - YEAR_NUM, MONTH_NUM, REPORT_DT: Thông tin thời gian
                * - SHOP_CODE, CALLER_CODE, SALER_CODE: Thông tin cửa hàng và nhân viên
                * - CHANNEL_CODE, FORM_ASSET, ASSET: Thông tin kênh và loại tài sản
                * - CAMPAIGN, NHOM_NGUON, NGUON_PHU: Thông tin chiến dịch và nguồn
                * - Form_TT, Form_TLS, Lead_PGD, Sale, Giai_ngan: Các chỉ số KPI chính
                * - Lead_TLS, Sale_TLS, Giai_ngan_TLS: Chỉ số TLS
                * - F_cancel_in_month, S_in_month, F_cancel: Chỉ số hủy và thành công trong tháng
                *
                * LOGIC XỬ LÝ:
                * 1. Xóa log cũ và tạo log mới cho job
                * 2. Truncate bảng target W_RPT_ONLINE_TEST
                * 3. Insert dữ liệu từ 3 nguồn khác nhau với UNION ALL
                * 4. Group by các trường chiều để tổng hợp dữ liệu
                * 5. Cập nhật log hoàn thành
                */

        dbms_output.put_line('----> START TIME:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

        -- Xóa dữ liệu trong bảng log ETL Daily của ngày Chạy
        DELETE FROM F88DWH.W_DAILY_ETL_LOG WHERE TRUNC(LOG_DT) = TRUNC(SYSDATE) AND JOB_NM = 'SALE_LEAD';
                COMMIT;

        -- Insert Log thời gian bắt đầu chạy job vào bảng Log
        INSERT INTO F88DWH.W_DAILY_ETL_LOG (LOG_DT, JOB_NM, START_DT) VALUES (SYSDATE, 'SALE_LEAD', SYSDATE);

        -- Truncate bảng W_RPT_ONLINE_TEST
        EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_ONLINE_TEST';
                COMMIT;

        -- ========================================
        -- INSERT DỮ LIỆU VÀO BẢNG TARGET W_RPT_ONLINE_TEST
        -- ========================================
        -- Sử dụng hint append và parallel(6) để tối ưu hiệu suất insert
        -- Dữ liệu được tổng hợp từ 3 nguồn chính với UNION ALL
        INSERT /*+ append parallel(6) */ INTO F88DWH.W_RPT_ONLINE_TEST
                SELECT
                        YEAR_NUM,
                        MONTH_NUM,
                        date1 REPORT_DT,
                        SHOP_CODE,
                        CALLER_CODE,
                        SALER_CODE,
                        CHANNEL_CODE,
                        FORM_ASSET,
                        ASSET,
                        CAMPAIGN,
                        NHOM_NGUON,
                        NGUON_PHU,
                        PHAN_LOAI_NGUON_PHU,
                        URL,
                        ctr_type,
                        SUM(Form_TT) Form_TT,
                        SUM(Form_TLS) Form_TLS,
                        SUM(Lead_PGD) Lead_PGD,
                        SUM(Sale) Sale,
                        SUM(Giai_ngan) Giai_ngan,
                        SUM(Lead_TLS) Lead_TLS,
                        SUM(Sale_TLS) Sale_TLS,
                        SUM(Giai_ngan_TLS) Giai_ngan_TLS,
                        CHANNEL_STR,
                        sum(F_cancel_in_month) F_cancel_in_month,
                        sum(S_in_month) S_in_month,
                        ASSET_TYPE_NAME ,
                        sum(F_cancel) F_cancel
                FROM (
                -- ========================================
                -- NGUỒN 1: LEAD PGD - Khách hàng chuyển đến cửa hàng
                -- ========================================
                -- Lấy dữ liệu từ VW_W_POL_DTL_F với điều kiện FIRST_SHOP_TRANS_DT không null
                -- Đây là các lead đã được chuyển từ online xuống cửa hàng để xử lý
                        (   SELECT
                                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) YEAR_NUM,
                                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) MONTH_NUM,
                                TRUNC(PO.FIRST_SHOP_TRANS_DT ) AS date1,
                                po.GROUP_id shop_code,
                                WED.EMPLOYEE_CODE CALLER_CODE,
                                NULL SALER_CODE,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END Channel_code,
                                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                                po.LOAN_ASSET_TP_NM ASSET,
                                CAMPAIGN_NM CAMPAIGN,
                                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END url,
                                po.ctr_type,
                                -- Các chỉ số KPI cho nguồn Lead PGD:
                                0 AS Form_TT,                    -- Không có Form TT trong nguồn này
                                0 AS Form_TLS,                   -- Không có Form TLS trong nguồn này
                                SUM(CASE WHEN PO.FIRST_SHOP_TRANS_DT  IS NOT NULL THEN 1 ELSE 0 END) AS Lead_PGD,  -- Đếm số lead chuyển đến cửa hàng
                                0 AS Sale,                       -- Không có Sale trong nguồn này
                                0 AS Giai_ngan,                  -- Không có Giai ngân trong nguồn này
                                0 AS Lead_TLS,                   -- Không có Lead TLS trong nguồn này
                                0 AS Sale_TLS,                   -- Không có Sale TLS trong nguồn này
                                0 AS Giai_ngan_TLS,              -- Không có Giai ngân TLS trong nguồn này
                                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                                0 F_cancel_in_month,
                                0 S_in_month,
                                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                                0 F_cancel
                        FROM F88DWH.VW_W_POL_DTL_F po
                        -- Join với bảng quản lý khu vực để lấy thông tin SHOP_CODE
                        LEFT JOIN F88DWH.W_AREA_MANAGER_D m ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
                        -- Join với bảng nhân viên (chỉ lấy nhân viên đang hoạt động và current row)
                        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
                        WHERE 1=1
                                -- Điều kiện lọc dữ liệu từ tháng trước đến hiện tại
                                AND PO.FIRST_SHOP_TRANS_DT > ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1
                        GROUP BY
                                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) ,
                                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) ,
                                TRUNC(PO.FIRST_SHOP_TRANS_DT ),
                                po.GROUP_id ,
                                WED.EMPLOYEE_CODE ,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END ,
                                po.FORM_ASSET_TP_NM  ,
                                po.LOAN_ASSET_TP_NM ,
                                CAMPAIGN_NM ,
                                po.SOURCE_LEVEL_2_NAME ,
                                po.SOURCE_LEVEL_3_NAME ,
                                po.SOURCE_LEVEL_4_NAME ,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END ,
                                po.ctr_type,
                                po.SOURCE_LEVEL_1_NAME,
                                po.FORM_ASSET_TP_NM
                        )
                UNION  ALL
                -- ========================================
                -- NGUỒN 2: SALE TT VÀ GIẢI NGÂN TT - Giao dịch thành công
                -- ========================================
                -- Lấy dữ liệu từ VW_W_POL_DTL_F với điều kiện DISBURSE_DT và STATUS_NM = 'Nhận cầm cố'
                -- Đây là các giao dịch đã được giải ngân thành công
                        (
                        SELECT
                                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                                                po.GROUP_id shop_code,
                                WED.EMPLOYEE_CODE CALLER_CODE,
                                NULL SALER_CODE,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END Channel_code,
                                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                                po.LOAN_ASSET_TP_NM ASSET,
                                CAMPAIGN_NM CAMPAIGN,
                                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END url,
                                po.ctr_type,
                                -- Các chỉ số KPI cho nguồn Sale TT và Giai ngân:
                                0 AS Form_TT,                    -- Không có Form TT trong nguồn này
                                0 AS Form_TLS,                   -- Không có Form TLS trong nguồn này
                                0 AS Lead_PGD,                   -- Không có Lead PGD trong nguồn này
                                COUNT(po.LOAN_CODE)  AS Sale,    -- Đếm số giao dịch thành công
                                SUM(po.DISBURSE_AMT) AS Giai_ngan,  -- Tổng số tiền giải ngân
                                0 AS Lead_TLS,                   -- Không có Lead TLS trong nguồn này
                                0 AS Sale_TLS,                   -- Không có Sale TLS trong nguồn này
                                0 AS Giai_ngan_TLS,              -- Không có Giai ngân TLS trong nguồn này
                                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                                0 F_cancel_in_month,  -- Không có hủy trong tháng cho nguồn này
                                -- Đếm số giao dịch thành công trong tháng (form tạo và giải ngân cùng ngày)
                                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND trunc(po.FORM_CREATED_DT) = TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  THEN 1 ELSE 0 END ) S_in_month,
                                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                                0 F_cancel  -- Không có hủy cho nguồn này
                        FROM F88DWH.VW_W_POL_DTL_F po
                        LEFT JOIN F88DWH.W_AREA_MANAGER_D m ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
                        LEFT JOIN (SELECT * FROM F88DWH.VW_W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
                        WHERE 1=1
                                -- Điều kiện lọc dữ liệu từ tháng trước đến hiện tại (format YYYYMMDD)
                                AND PO.DISBURSE_DT  > TO_CHAR(ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1, 'YYYYMMDD')
                                -- Chỉ lấy các giao dịch có trạng thái 'Nhận cầm cố' (đã giải ngân thành công)
                                AND po.STATUS_NM ='Nhận cầm cố'
                        GROUP BY
                                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                                po.GROUP_id ,
                                WED.EMPLOYEE_CODE ,
                                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                                        ELSE 'Khác' END ,
                                po.FORM_ASSET_TP_NM ,
                                po.LOAN_ASSET_TP_NM,
                                CAMPAIGN_NM ,
                                po.SOURCE_LEVEL_2_NAME ,
                                po.SOURCE_LEVEL_3_NAME ,
                                po.SOURCE_LEVEL_4_NAME ,
                                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                                        ELSE 'Khác' END ,
                                po.ctr_type,
                                po.SOURCE_LEVEL_1_NAME,
                                po.FORM_ASSET_TP_NM
                        )
                UNION  ALL
                -- ========================================
                -- NGUỒN 3: HDMM NHẬP THẲNG TRÊN LOS - Không qua PAWN_ONLINE_WID
                -- ========================================
                -- Lấy dữ liệu từ W_LOAN_DTL_F với điều kiện LOAN_CODE không tồn tại trong VW_W_POL_DTL_F
                -- Đây là các giao dịch được nhập trực tiếp trên hệ thống LOS mà không qua quy trình online
                        (
                        SELECT
                                to_number(substr(a.DISBURSE_DATE_WID, 1, 4)) year_num,
                                to_number(substr(a.DISBURSE_DATE_WID, 5, 2)) month_num,
                                to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') date1,
                                -- Chuyển đổi SHOP_CODE sang số nếu là chuỗi số, ngược lại NULL
                                CASE WHEN REGEXP_LIKE(sh.SHOP_CODE, '^[[:digit:]]+$') THEN to_number(sh.SHOP_CODE) ELSE NULL END shop_code ,
                                NULL caller_name,  -- Không có thông tin caller cho nguồn này
                                NULL caller_code,  -- Không có thông tin caller cho nguồn này
                                a.CHANNEL_CODE ,   -- Lấy CHANNEL_CODE trực tiếp từ W_LOAN_DTL_F
                                c.ASSET_TP_NM form_asset,  -- Loại tài sản từ bảng W_ASSET_TP_D
                                c.ASSET_TP_NM asset,       -- Loại tài sản (giống form_asset)
                                r.RESOURCES_NM campaign,   -- Tên chiến dịch từ bảng W_RESOURCES_D
                                -- Logic phân loại nhóm nguồn dựa trên RESOURCES_CODE:
                                -- Các code '016','015','017','023','024','025','014','029','021' thuộc 'Digital Mạng Lưới'
                                -- Các code khác thuộc 'Trade MKT'
                                CASE
                                        WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                                ELSE 'Trade MKT' END NHOM_NGUON,
                                'LOS' nguon_phu,              -- Nguồn phụ luôn là 'LOS' cho nguồn này
                                NULL phan_loai_nguon_phu,     -- Không có phân loại nguồn phụ
                                NULL url,                     -- Không có URL cho nguồn này
                                a.CTR_TYPE,                   -- Loại CTR từ W_LOAN_DTL_F
                                -- Các chỉ số KPI cho nguồn HDMM nhập thẳng LOS:
                                count(a.LOAN_WID) form_tt,     -- Đếm số form TT (bằng số loan)
                                0 form_tls,                    -- Không có Form TLS cho nguồn này
                                count(a.LOAN_WID) lead_pgd,    -- Đếm số lead PGD (bằng số loan)
                                count(a.LOAN_WID) sale,        -- Đếm số sale (bằng số loan)
                                sum(a.DISBURSE_AMT) giai_ngan, -- Tổng số tiền giải ngân
                                0 Lead_TLS,                    -- Không có Lead TLS cho nguồn này
                                0 Sale_TLS,                    -- Không có Sale TLS cho nguồn này
                                0 Giai_ngan_TLS,               -- Không có Giai ngân TLS cho nguồn này
                                'Marketing PGD' SOURCE,       -- Nguồn luôn là 'Marketing PGD' cho nguồn này
                                0 F_cancel_in_month,           -- Không có hủy trong tháng cho nguồn này
                                0 S_in_month,                  -- Không có thành công trong tháng cho nguồn này
                                c.ASSET_TP_NM ASSET_TYPE_NAME, -- Tên loại tài sản
                                0 F_cancel                     -- Không có hủy cho nguồn này
                        FROM F88DWH.W_LOAN_DTL_F a
                        -- Join với VW_W_POL_DTL_F để kiểm tra LOAN_CODE có tồn tại không
                        LEFT JOIN F88DWH.VW_W_POL_DTL_F b ON a.LOAN_WID =b.LOAN_WID
                        -- Join với bảng loại tài sản để lấy thông tin ASSET_TP_NM
                        LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID =a.ASSET_TYPE_WID
                        -- Join với bảng khách hàng vay để lấy thông tin nguồn
                        LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =A.LOAN_WID
                        -- Join với bảng nguồn để lấy thông tin chiến dịch
                        LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
                        -- Join với bảng cửa hàng để lấy thông tin SHOP_CODE
                        LEFT JOIN F88DWH.W_SHOP_D sh ON sh.SHOP_WID = a.SHOP_WID
                        WHERE 1 = 1
                        -- Điều kiện chính: LOAN_CODE phải NULL (không tồn tại trong VW_W_POL_DTL_F)
                        -- Điều này đảm bảo chỉ lấy các giao dịch nhập thẳng trên LOS
                        AND b.LOAN_CODE  IS NULL
                        -- Điều kiện lọc dữ liệu từ tháng trước đến hiện tại (format YYYYMMDD)
                        AND a.DISBURSE_DATE_WID > TO_CHAR(ADD_MONTHS(TRUNC(to_date(P_DATE,'yyyymmdd'), 'mm'), -1) -1, 'YYYYMMDD')
                        GROUP BY
                                to_number(substr(a.DISBURSE_DATE_WID, 1, 4)),
                                to_number(substr(a.DISBURSE_DATE_WID, 5, 2)),
                                to_date(a.DISBURSE_DATE_WID, 'yyyymmdd'),
                                sh.SHOP_CODE ,
                                a.CHANNEL_CODE ,
                                c.ASSET_TP_NM,
                                r.RESOURCES_NM,
                                a.CTR_TYPE,
                                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                                ELSE 'Trade MKT' END
                        )
                )
                -- ========================================
                -- GROUP BY ĐỂ TỔNG HỢP DỮ LIỆU
                -- ========================================
                -- Group by tất cả các trường chiều để tổng hợp các chỉ số KPI
                -- Điều này đảm bảo dữ liệu được tổng hợp theo từng chiều phân tích
                GROUP BY
                        YEAR_NUM,                    -- Năm
                        MONTH_NUM,                   -- Tháng
                        date1,                       -- Ngày báo cáo
                        shop_code,                   -- Mã cửa hàng
                        CALLER_CODE,                 -- Mã nhân viên caller
                        SALER_CODE,                  -- Mã nhân viên saler
                        Channel_code,                -- Mã kênh
                        FORM_ASSET,                  -- Loại tài sản form
                        ASSET,                       -- Loại tài sản
                        CAMPAIGN,                    -- Chiến dịch
                        NHOM_NGUON,                  -- Nhóm nguồn
                        NGUON_PHU,                   -- Nguồn phụ
                        PHAN_LOAI_NGUON_PHU,         -- Phân loại nguồn phụ
                        URL,                         -- URL
                        ctr_type,                    -- Loại CTR
                        CHANNEL_STR,                 -- Chuỗi kênh
                        ASSET_TYPE_NAME ;            -- Tên loại tài sản
                COMMIT;

                dbms_output.put_line('----> DONE INSERT SUCCESS SALE_LEAD AT: '||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

        -- ========================================
        -- CẬP NHẬT LOG HOÀN THÀNH JOB
        -- ========================================
        -- Cập nhật thời gian kết thúc job vào bảng log để theo dõi thời gian thực thi
        UPDATE F88DWH.W_DAILY_ETL_LOG
                SET END_DT = SYSDATE
                WHERE TRUNC(LOG_DT) = TRUNC(SYSDATE)
                        AND JOB_NM = 'SALE_LEAD';

        END;

--------------------------------------------------
-- PROC TÍNH TOÁN NHÓM CHỈ SỐ LIÊN QUAN ĐẾN DƯ NỢ VÀ GIẢI NGÂN
PROCEDURE DUNO (P_DATE NUMBER)  IS BEGIN
        -- DOCSTRING
                /**
                * PROCEDURE DUNO
                *
                * Mô tả: Procedure thực hiện tính toán và cập nhật các KPI dư nợ vào bảng W_KPI_KEY_DRIVER_TEST_F
                * Bao gồm các chỉ số về dư nợ, roll forward/back, rút gốc, giải ngân, khách hàng active, etc.
                *
                * INPUT PARAMETERS:
                * - P_DATE (NUMBER): Ngày chạy báo cáo theo format YYYYMMDD
                *
                * TABLES USED:
                * - F88DWH.W_KPI_KEY_DRIVER_TEST_F: Bảng target chứa KPI theo cửa hàng
                * - F88DWH.W_DAILY_ETL_LOG: Bảng log theo dõi quá trình ETL
                * - F88DWH.W_LOAN_DTL_F: Bảng chi tiết khoản vay
                * - F88DWH.W_SHOP_D: Bảng thông tin cửa hàng
                * - F88DWH.W_ASSET_TP_D: Bảng loại tài sản
                * - F88DWH.W_LOAN_DAILY_F: Bảng dữ liệu khoản vay theo ngày
                * - F88DWH.W_RPT_LOAN_TRAFFIC_F: Bảng báo cáo traffic khoản vay
                * - F88DWH.VW_W_CUSTOMER_D: View thông tin khách hàng
                * - F88DWH.W_CTR_TYPE_KHQL: Bảng loại hợp đồng khách hàng quản lý
                *
                * OUTPUT:
                * - Cập nhật bảng F88DWH.W_KPI_KEY_DRIVER_TEST_F với các KPI dư nợ:
                *   + Dư nợ DPD0 (tổng, theo sản phẩm 2W/4W, theo loại khách hàng)
                *   + Dư nợ BQ (bình quân)
                *   + Roll Forward/Roll Back (tổng, theo sản phẩm, theo tháng)
                *   + Rút gốc (tổng, theo sản phẩm, tỷ lệ)
                *   + Giải ngân (tổng, theo loại khách hàng, net)
                *   + Khách hàng active và lũy kế
                *   + Các chỉ số dư nợ theo bucket (B1A, B1B, B2, B3, B3+)
                *   + Same Month Closed, DNQH, WO
                *
                * CẤU TRÚC DỮ LIỆU OUTPUT:
                * - YEAR_NUM, MONTH_NUM, DATE_WID: Thông tin thời gian
                * - SHOP_WID, SHOP_CODE, SHOP_NM: Thông tin cửa hàng
                * - KPI_CODE: Mã KPI (ví dụ: '10.1.1', '9.1', etc.)
                * - KPI: Tên KPI (ví dụ: 'Dư nợ DPD0', '%RFW B0-B1 monthly 2W')
                * - VALUE_: Giá trị KPI
                * - TU_SO, MAU_SO: Tử số và mẫu số cho các KPI tỷ lệ
                * - KPI_TYPE: Loại KPI ('KPI' hoặc 'Key-driver')
                *
                * LOGIC XỬ LÝ:
                * 1. Xóa dữ liệu KPI dư nợ cũ trong bảng target
                * 2. Tính toán các CTE (Common Table Expression) để chuẩn bị dữ liệu
                * 3. Insert dữ liệu KPI mới với các chỉ số đã tính toán
                * 4. Cập nhật log hoàn thành
                *
                * CÁC CTE CHÍNH:
                * - smc: Same Month Closed - giao dịch đóng trong cùng tháng
                * - WO: Write Off - dư nợ xóa nợ
                * - EOP: End of Period - dư nợ cuối kỳ
                * - EOP_BF: End of Period Before - dư nợ đầu kỳ
                * - RF01, RG, NET, cuml, active, TONG_GN, PAID: Các CTE hỗ trợ tính toán
                */

        -- Xóa dữ liệu của các KPI dư nợ trong bảng W_KPI_KEY_DRIVER_TEST_F tại ngày chạy P_DATE
        DELETE /*+ append parallel(6) */ FROM F88DWH.W_KPI_KEY_DRIVER_TEST_F
                WHERE YEAR_NUM = SUBSTR(P_DATE, 1,4)
                        AND MONTH_NUM = SUBSTR(P_DATE,5,2)
                        AND DATE_WID = P_DATE
                        AND KPI IN (
                                '%RFW B0-B1 monthly 2W','%RFW B0-B1 monthly 4W','%RFW B0-B1 monthly total',
                                '%Rút gốc','%Rút gốc 2W','%Rút gốc 4W','DNQH',
                                'KH active 4W','KH active 2W','KH lũy kế 4W', 'Same Month Closed','KH lũy kế 2W','DNQH',
                                'Dư nợ B1A','Dư nợ B1B','Dư nợ B2','Dư nợ B3','Dư nợ B3+','Dư nợ BQ','Dư nợ BQ DPD0','Dư nợ DPD 1-90',
                                'Dư nợ DPD0','Dư nợ DPD0 KHM 2W','Dư nợ DPD0 KHM 4W','Dư nợ DPD0 KHQL 2W','Dư nợ DPD0 KHQL 4W','Dư nợ DPD0 đầu kỳ','Dư nợ WO',
                                'Tổng giải ngân','Tổng giải ngân KHM','Tổng giải ngân KHM 2W','Tổng giải ngân KHM 4W','Tổng giải ngân KHQL',
                                'Giải ngân Net','Giải ngân Net 2W','Giải ngân Net 4W',
                                'HĐMM 2W','HĐMM 4W','Lãi phí thực thu',
                                'Roll Back','Roll Back monthly 2W','Roll Back monthly 4W','Roll Forward','Roll Forward monthly 2W','Roll Forward monthly 4W',
                                'Rút gốc','Rút gốc 2W','Rút gốc 4W','Tăng Net', 'Dư nợ DPD0 đầu kỳ 2W','Dư nợ DPD0 đầu kỳ 4W','Dư nợ DPD0 2W','Dư nợ DPD0 4W',
                                'Roll Forward monthly B0-B1', 'Roll Forward monthly B0-B1 2W', 'Roll Forward monthly B0-B1 4W', 'Roll Back monthly',
                                '%Paid monthly 2W','%Paid monthly 4W','%Paid monthly'
                        );
                COMMIT;

        -- INSERT DỮ LIỆU KPI MỚI
        INSERT /*+ append parallel(8) */ INTO F88DWH.W_KPI_KEY_DRIVER_TEST_F(YEAR_NUM, MONTH_NUM, DATE_WID, SHOP_WID , SHOP_CODE ,SHOP_NM, KPI_CODE, KPI, VALUE_, tu_so, mau_so,KPI_TYPE)

                -- ========================================
                -- CÁC CTE (COMMON TABLE EXPRESSION) ĐỂ CHUẨN BỊ DỮ LIỆU
                -- ========================================

                -- CTE 1: SMC (Same Month Closed) - Giao dịch đóng trong cùng tháng
                WITH smc AS (
                        SELECT
                                a.SHOP_WID ,
                                b.SHOP_CODE ,
                                b.SHOP_NM ,
                                sum(a.DISBURSE_AMT)/1e6 samemonth_closed
                        FROM F88DWH.W_LOAN_DTL_F a
                        -- Join với bảng cửa hàng để lấy thông tin SHOP_CODE, SHOP_NM
                        LEFT JOIN F88DWH.W_SHOP_D b ON b.SHOP_WID = a.SHOP_WID
                        -- Join với bảng loại tài sản để lấy thông tin ASSET_TP_NM
                        LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
                        WHERE 1=1
                                -- Điều kiện lọc dữ liệu từ đầu tháng đến ngày P_DATE
                                AND DISBURSE_DATE_WID >= to_char(trunc(to_date(P_DATE,'yyyymmdd'),'mm'),'yyyymmdd')
                                AND DISBURSE_DATE_WID <= P_DATE
                                -- Điều kiện lọc kênh: KDML hoặc ONLINE
                                -- Logic chuyển đổi kênh: E2E và PTDT3P từ ngày cụ thể sẽ được chuyển thành KDML
                                AND (
                                        (CASE
                                                WHEN (a.DISBURSE_DATE_WID >=20240515 AND a.CHANNEL_CODE ='E2E')
                                                        OR (a.DISBURSE_DATE_WID >=20240919 AND a.CHANNEL_CODE ='PTDT3P')  THEN 'KDML'
                                                ELSE a.CHANNEL_CODE END
                                        ) = 'KDML'
                                        OR (a.DISBURSE_DATE_WID >=20241107 AND a.SALE_CHANNEL ='ONLINE')
                                )
                        -- Điều kiện Same Month Closed: tháng giải ngân = tháng đóng
                        AND substr(a.DISBURSE_DATE_WID,1,6)=substr(nvl(a.CLOSED_DATE_WID,0),1,6)
                        GROUP BY
                                a.SHOP_WID ,
                                b.SHOP_CODE ,
                                b.SHOP_NM                ),

                -- CTE 2: WO (Write Off) - Dư nợ xóa nợ
                WO AS (
                        SELECT
                                a.SHOP_WID,
                                b.SHOP_CODE,
                                b.SHOP_NM,
                                -- Logic phân loại sản phẩm:
                                -- '00000015','00000007' -> 'DKOT' (Ô tô)
                                -- '00000017','00000013' -> 'DKXM' (Xe máy)
                                -- Các loại khác -> 'Khác'
                                CASE WHEN c.ASSET_TP_CODE IN ('00000015','00000007') THEN 'DKOT' WHEN c.ASSET_TP_CODE IN ('00000017','00000013') THEN 'DKXM' ELSE 'Khác' END SP,
                                -- Tính dư nợ xóa nợ: chỉ tính các khoản có IS_BAD_DEBT=1 và STATUS != 603
                                sum(CASE WHEN a.DATE_WID = P_DATE AND a.IS_BAD_DEBT=1 AND a.STATUS !=603 THEN a.PRINCIPAL_REMAIN ELSE 0 END)/1e6 WO
                        FROM F88DWH.W_LOAN_DAILY_F a
                        -- Join với bảng cửa hàng để lấy thông tin SHOP_CODE, SHOP_NM
                        LEFT JOIN F88DWH.W_SHOP_D b ON b.SHOP_WID = a.SHOP_WID
                        -- Join với bảng loại tài sản để lấy thông tin ASSET_TP_CODE
                        LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
```

### `F88DWH.PKG_METRICS_KHQL` (PACKAGE BODY) — 2 lines reference search term

```
PACKAGE BODY        PKG_METRICS_KHQL
AS

PROCEDURE W_METRIC_THM_MODEL_F(p_date number) IS
BEGIN
	EXECUTE IMMEDIATE 'DELETE FROM F88DWH.W_METRICS_THM_F where MONTH_ =to_number(to_char(LAST_DAY(to_date(:P_DATE,''yyyymmdd'') - 1),''yyyymmdd''))' USING  p_date;
INSERT INTO F88DWH.W_METRICS_THM_F
		WITH pre as
		(
                SELECT *
                FROM (
                        SELECT REGEXP_SUBSTR(wopf.DESCRIPTION , 'Mã KH:(\d+)', 1, 1, 'i', 1) AS CUSTOMER_WID, -- Trường này tương đương customer_wid trên W_CUSTOMER_D
                                wopf.FIRST_CALL_DT,
                                wpdf.STATUS_NM
                        FROM F88DWH.W_POL_DTL_F wpdf
                        JOIN F88DWH.W_ONLINE_PAWN_F wopf
                                ON wpdf.POL_WID = wopf.INTEGRATION_ID
                        WHERE wpdf.CAMPAIGN_NM = 'Da tat toan'
                        )
                WHERE CUSTOMER_WID IS NOT NULL
                        AND REGEXP_LIKE(CUSTOMER_WID, '^[[:digit:]]+$')
		)
SELECT thm.MONTH_,
		wamnd.tpk AS TPK,
		thm.CUSTOMER_CODE, to_date(wldf2.DISBURSE_DATE_WID, 'yyyymmdd') AS DISBURSE_DATE,
		wcd.GENDER_NM, wamnd.region, wamnd.province , thm.kenh_ban,
		CASE WHEN STATUS_NM IN ('Đang chăm sóc', 'Hủy đăng ký', 'Nhận cầm cố') THEN 'Đã liên hệ' ELSE 'Chưa liên hệ' END AS call_status,
		--'Da do don' AS dodon_status,
		CASE WHEN t1.STATUS_NM IS NOT NULL THEN 'Da do don' ELSE 'Chua do don' END AS dodon_status,
		t1.FIRST_CALL_DT,
		--count(DISTINCT ctp.CUSTOMER_CODE) AS slkh,
		thm.category AS asset_type,
		thm.level_group,
		--count(1) AS NUM_CALL,
		Sum(CASE WHEN wldf2.DISBURSE_DATE_WID BETWEEN to_number(to_char(trunc(to_date(p_date,'yyyymmdd') - 1,'mm'),'yyyymmdd')) AND to_number(to_char(LAST_DAY(to_date(p_date,'yyyymmdd') - 1),'yyyymmdd'))  THEN 1 ELSE 0 end) slhd,
		nvl(sum(CASE WHEN wldf2.DISBURSE_DATE_WID BETWEEN to_number(to_char(trunc(to_date(p_date,'yyyymmdd') - 1,'mm'),'yyyymmdd')) AND to_number(to_char(LAST_DAY(to_date(p_date,'yyyymmdd') - 1),'yyyymmdd'))  THEN disburse_amt ELSE 0 END ),0) AS disburse_amt
		FROM  F88DWH.W_CUSTOMER_THM_F thm
			LEFT JOIN (SELECT CUSTOMER_WID, CUSTOMER_CODE, GENDER_NM FROM F88DWH.VW_W_CUSTOMER_D WHERE CRN_ROW_IND = 1) wcd
			ON to_char(thm.CUSTOMER_CODE) = wcd.CUSTOMER_CODE
			lEFT JOIN F88DWH.W_LOAN_DTL_F wldf2
			ON wldf2.CUSTOMER_CODE  = thm.CUSTOMER_CODE		--LEFT JOIN F88DWH.W_LOAN_DTL_F wldf2 ON wldf.REFINANCED_FROM = wldf2.INTEGRATION_ID
			LEFT JOIN pre t1
			ON t1.CUSTOMER_WID = thm.CUSTOMER_WID
			LEFT JOIN (SELECT shop_id, region, province, tpk FROM  F88DWH.W_AREA_MANAGER_D) wamnd
			ON to_char(thm.SHOP_CODE) = to_char(wamnd.SHOP_ID)
		WHERE thm.MONTH_  =  to_number(to_char(last_day(to_date(p_date,'yyyymmdd') - 1),'yyyymmdd'))
		--AND  t1.STATUS_STR IS NOT NULL
		GROUP BY CASE WHEN STATUS_NM IN ('Đang chăm sóc', 'Hủy đăng ký', 'Nhận cầm cố') THEN 'Đã liên hệ' ELSE 'Chưa liên hệ' END,
		--'Da do don',
		CASE WHEN t1.STATUS_NM IS NOT NULL THEN 'Da do don' ELSE 'Chua do don' END,
		thm.category,
		thm.LEVEL_group,
		wcd.GENDER_NM, thm.kenh_ban,
		thm.CUSTOMER_CODE,
		wamnd.region,
		wamnd.province,
		wldf2.DISBURSE_DATE_WID,
		wamnd.TPK,
		thm.MONTH_,
		t1.FIRST_CALL_DT;
COMMIT;
END;

PROCEDURE W_METRIC_TT_MODEL_F(p_date number) IS
BEGIN
    EXECUTE IMMEDIATE 'DELETE FROM F88DWH.W_METRICS_TT_F where MONTH_ =to_number(to_char(LAST_DAY(to_date(:P_DATE,''yyyymmdd'') - 1),''yyyymmdd''))' USING  p_date;
INSERT  INTO F88DWH.W_METRICS_TT_F
		WITH pre as
		(
                SELECT *
                FROM (
                        SELECT REGEXP_SUBSTR(wopf.DESCRIPTION , 'Mã KH:(\d+)', 1, 1, 'i', 1) AS CUSTOMER_WID, -- Trường này tương đương customer_wid trên W_CUSTOMER_D
                                wopf.FIRST_CALL_DT,
                                wpdf.STATUS_NM
                        FROM F88DWH.W_POL_DTL_F wpdf
                        JOIN F88DWH.W_ONLINE_PAWN_F wopf
                                ON wpdf.POL_WID = wopf.INTEGRATION_ID
                        WHERE wpdf.CAMPAIGN_NM = 'Da tat toan'
                        )
                WHERE CUSTOMER_WID IS NOT NULL
                        AND REGEXP_LIKE(CUSTOMER_WID, '^[[:digit:]]+$')
		)
SELECT thm.MONTH_,
		wamnd.tpk AS TPK,
		thm.CUSTOMER_CODE, to_date(wldf2.DISBURSE_DATE_WID, 'yyyymmdd') AS DISBURSE_DATE,
		wcd.GENDER_NM, wamnd.region, wamnd.province , thm.kenh_ban,
		CASE WHEN status_nm IN ('Đang chăm sóc', 'Hủy đăng ký', 'Nhận cầm cố') THEN 'Đã liên hệ' ELSE 'Chưa liên hệ' END AS call_status,
		--'Da do don' AS dodon_status,
		CASE WHEN t1.STATUS_NM IS NOT NULL THEN 'Da do don' ELSE 'Chua do don' END AS dodon_status,
		t1.FIRST_CALL_DT,
		--count(DISTINCT ctp.CUSTOMER_CODE) AS slkh,
		thm.category AS asset_type,
		thm.level_group,
		--count(1) AS NUM_CALL,
		Sum(CASE WHEN wldf2.DISBURSE_DATE_WID BETWEEN to_number(to_char(trunc(to_date(p_date,'yyyymmdd') - 1,'mm'),'yyyymmdd')) AND to_number(to_char(LAST_DAY(to_date(p_date,'yyyymmdd') - 1),'yyyymmdd'))  THEN 1 ELSE 0 end) slhd,
		nvl(sum(CASE WHEN wldf2.DISBURSE_DATE_WID BETWEEN to_number(to_char(trunc(to_date(p_date,'yyyymmdd') - 1,'mm'),'yyyymmdd')) AND to_number(to_char(LAST_DAY(to_date(p_date,'yyyymmdd') - 1),'yyyymmdd'))  THEN disburse_amt ELSE 0 END ),0) AS disburse_amt
		FROM  F88DWH.W_CUSTOMER_TT_F thm
			LEFT JOIN (SELECT CUSTOMER_WID, CUSTOMER_CODE, GENDER_NM FROM F88DWH.VW_W_CUSTOMER_D WHERE CRN_ROW_IND = 1) wcd
			ON to_char(thm.CUSTOMER_CODE) = wcd.CUSTOMER_CODE
			lEFT JOIN F88DWH.W_LOAN_DTL_F wldf2
			ON wldf2.CUSTOMER_CODE  = thm.CUSTOMER_CODE		--LEFT JOIN F88DWH.W_LOAN_DTL_F wldf2 ON wldf.REFINANCED_FROM = wldf2.INTEGRATION_ID
			LEFT JOIN pre t1
			ON t1.CUSTOMER_WID = thm.CUSTOMER_WID
			LEFT JOIN (SELECT shop_id, region, province, tpk FROM  F88DWH.W_AREA_MANAGER_D) wamnd
			ON to_char(thm.SHOP_CODE) = to_char(wamnd.SHOP_ID)
		WHERE thm.MONTH_  =  to_number(to_char(last_day(to_date(p_date,'yyyymmdd') - 1),'yyyymmdd'))
		--AND  t1.STATUS_STR IS NOT NULL
		GROUP BY CASE WHEN STATUS_NM IN ('Đang chăm sóc', 'Hủy đăng ký', 'Nhận cầm cố') THEN 'Đã liên hệ' ELSE 'Chưa liên hệ' END,
		--'Da do don',
		CASE WHEN t1.status_nm IS NOT NULL THEN 'Da do don' ELSE 'Chua do don' END,
		thm.category,
		thm.LEVEL_group,
		wcd.GENDER_NM, thm.kenh_ban,
		thm.CUSTOMER_CODE,
		wamnd.region,
		wamnd.province,
		wldf2.DISBURSE_DATE_WID,
		wamnd.TPK,
		thm.MONTH_,
		t1.FIRST_CALL_DT;
COMMIT;
END;

procedure main( p_date Number) is
  begin
    -- Tong hop Loan
  dbms_output.put_line('Begin package');
     W_METRIC_THM_MODEL_F(p_date => p_date);
     W_METRIC_TT_MODEL_F(p_date => p_date);
  dbms_output.put_line('End package');
  end;

END PKG_METRICS_KHQL;
```

### `F88DWH.PROC_BDM_DISBURSE_MONTHLY` (PROCEDURE) — 2 lines reference search term

```
PROCEDURE        PROC_BDM_Disburse_Monthly (REPORTDATE NUMBER)
IS
BEGIN
	/*
	 * File Disburse_Monthly.sql do BDM cung cấp để xây Data mart
	 * Tạo bởi: hieumx2
	 * Ngày tạo: 2025-02-27
	 * Ngày chỉnh sửa: 2025-02-27
	 */

---------------------

--- 0. Delete old data
--DELETE /*+ PARALLEL(4) */
--FROM F88DWH.W_BDM_F_DISBURSE
--WHERE DISBURSE_YEAR = SUBSTR(REPORTDATE, 1, 4)
--	AND DISBURSE_MONTH = SUBSTR(REPORTDATE, 5, 2)
--	AND DISBURSE_DATE = REPORTDATE;\

	EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_BDM_F_DISBURSE';

--- 1. Insert data
INSERT /*+ append parallel(4) */  INTO F88DWH.W_BDM_F_DISBURSE (DISBURSE_YEAR,
	DISBURSE_MONTH,
	DISBURSE_DATE,
	MATURITY_DATE,
	CLOSED_DATE,
	SHORT_NM,
	CREATED_USER,
	CREATER_NM,
	CREATED_POSITION_NM,
	CHANNEL_CODE,
	FUND_NAME,
	LOAN_CODE,
	OLD_LOAN_CODE,
	PACKAGE_NM,
	TERM_FREQUENCY,
	TERM_FREQUENCY_UNIT,
	CUSTOMER_CODE,
	CREDIT_SCORE,
	ASSET_TYPE_WID,
	CTR_TYPE_SYSTEM,
	CTR_TYPE,
	KENH,
	SOURCE_LEVEL_2_NAME,
	SAMEDAY_CLOSED,
	SAMEMONTH_CLOSED,
	COLLATERAL_AMT,
	MAX_LENDABLE_AMT,
	DISBURSE_AMT,
	INSURANCE_AMT,
	LOAN_AMT,
	LTV,
	SUPPORT_ORG_CODE,
	OLD_LOAN_PRINCIPAL,
	NET_DISBURSE,
	SOURCE_LVL_3,
	CAMPAIGN_NM,
	CONTRACT_CODE
)


--Thang Hien tai
SELECT SUBSTR(TO_CHAR(ldt.DISBURSE_DATE_WID),1,4) DISBURSE_YEAR
	,SUBSTR(TO_CHAR(ldt.DISBURSE_DATE_WID),1,6) DISBURSE_MONTH
	,TO_CHAR(ldt.DISBURSE_DATE_WID) DISBURSE_DATE
	,TO_CHAR(ldt."TO_DATE",'YYYYMMDD') MATURITY_DATE
	,CASE
		WHEN SUBSTR(TO_CHAR(ldt.DISBURSE_DATE_WID),1,6) =  SUBSTR(TO_CHAR(ldt.CLOSED_DATE_WID),1,6)  THEN  TO_CHAR(ldt.CLOSED_DATE_WID)
		ELSE NULL
	 END CLOSED_DATE
	,CASE
		WHEN s.SHORT_NM  IS NULL THEN s1.SHORT_NM
		ELSE s.SHORT_NM
	END SHORT_NM
	,ec.EMPLOYEE_CODE CREATED_USER
	,ec.EMPLOYEE_NM CREATED_NM
	,ec.POSITION_NM CREATED_POSITION_NM
	,ldt.CHANNEL_CODE
    ,ldt.FUND_NAME
	,ldt.loan_code
	,KHQL.LOAN_CODE OLD_LOAN_CODE
	,CASE
		WHEN v.PACKAGE_NM IS NULL THEN ldt.LOAN_PKG_NM
		ELSE v.PACKAGE_NM
	END PACKAGE_NM
	,ldt.TERM_FREQUENCY
	,LDT.TERM_FREQUENCY_UNIT
	,ldt.CUSTOMER_CODE
	,LS."RANK" CREDIT_SCORE
	,LDT.ASSET_TYPE_WID
    ,ldt.CTR_TYPE CTR_TYPE_SYSTEM
    ,CASE
	    WHEN ldt.ctr_type = 'Mới' THEN ldt.ctr_type
	    ELSE khql.ctr_type
	   END CTR_TYPE
	,CASE
		WHEN POL.SOURCE_LEVEL_1_NAME  IN ('Digital HO','TLS E2E') THEN 'Digital HO'
		WHEN POL.SOURCE_LEVEL_1_NAME = 'Marketing PGD' OR POL.LOAN_CODE IS NULL THEN 'Marketing PGD'
		WHEN POL.SOURCE_LEVEL_1_NAME IS NOT NULL THEN POL.SOURCE_LEVEL_1_NAME
		ELSE 'Khác'
	END KENH
	,POL.SOURCE_LEVEL_2_NAME
	,CASE WHEN ldt.DISBURSE_DATE_WID  =  ldt.CLOSED_DATE_WID  THEN 1
	ELSE 0
	END SAMEDAY_CLOSED
	,CASE WHEN SUBSTR(TO_CHAR(ldt.DISBURSE_DATE_WID),1,6) =  SUBSTR(TO_CHAR(ldt.CLOSED_DATE_WID),1,6)  THEN 1
	ELSE 0
	END SAMEMONTH_CLOSED
	, ldt.COLLATERAL_AMT
	, ldt.MAX_LENDABLE_AMT
	, NVL(ldt.DISBURSE_AMT,0) DISBURSE_AMT
 	, NVL(ldt.INSURANCE_AMT,0) INSURANCE_AMT
 	, (NVL(ldt.DISBURSE_AMT,0) - NVL(ldt.INSURANCE_AMT,0)) LOAN_AMT
 	, CASE
 		WHEN NVL(ldt.COLLATERAL_AMT,0) = 0 THEN NULL
 		ELSE ROUND((NVL(ldt.DISBURSE_AMT,0) - NVL(ldt.INSURANCE_AMT,0))/NVL(ldt.COLLATERAL_AMT,0),2)
 	END LTV
 	, SP.EMPLOYEE_CODE SUPPORT_ORG_CODE
 	, CASE
 		WHEN khql.ctr_type = 'Topup' THEN khql.PRINCIPAL_REMAIN
 		ELSE CASE
 			WHEN khql.ctr_type = 'Tái tục' THEN ldt.DISBURSE_AMT
 			ELSE 0
 			END
 	END AS OLD_LOAN_PRINCIPAL
 	, CASE
	 	WHEN ldt.CHANNEL_CODE = 'Online' THEN ldt.DISBURSE_AMT
 		WHEN khql.ctr_type = 'Topup' OR khql.ctr_type = 'Tái tục' THEN khql.NET_DISBURSE
 		ELSE ldt.DISBURSE_AMT
 	END AS NET_DISBURSE
	, POL.SOURCE_LEVEL_3_NAME SOURCE_LVL_3
	, POL.CAMPAIGN_NM CAMPAIGN_NM
	, ldt.CONTRACT_CODE
FROM F88DWH.W_LOAN_DTL_F ldt
LEFT JOIN F88DWH.W_LOAN_DAILY_F DAILY ON LDT.LOAN_WID  = DAILY.LOAN_WID AND LDT.DISBURSE_DATE_WID = DAILY.DATE_WID AND DAILY.YEAR_NUM = SUBSTR(REPORTDATE,1,4) AND DAILY.MONTH_NUM = SUBSTR(REPORTDATE,5,2)
LEFT JOIN F88DWH.W_SHOP_D s ON DAILY.SHOP_WID  = s.SHOP_WID
LEFT JOIN F88DWH.W_SHOP_D s1 ON ldt.SHOP_WID = s1.SHOP_WID
LEFT JOIN F88DWH.W_AREA_MANAGER_D a ON s.SHOP_CODE = a.SHOP_ID
LEFT JOIN F88DWH.W_CTR_TYPE_KHQL KHQL ON ldt.LOAN_WID = KHQL.loan_wid_new
LEFT JOIN F88DWH.W_ASSET_TP_D e ON ldt.ASSET_TYPE_WID = e.ASSET_TP_WID
LEFT JOIN F88DWH.W_PACKAGE_D v ON ldt.PACKAGE_WID  = v.PACKAGE_WID
LEFT JOIN F88DWH.VW_W_EMPLOYEE_D EC ON ldt.CREATED_USER_WID = EC.EMPLOYEE_WID
LEFT JOIN F88DWH.W_LOAN_SCORE_F LS ON ldt.LOAN_WID = LS.LOAN_WID
LEFT JOIN F88DWH.W_POL_DTL_F POL
--	(SELECT DISTINCT LOAN_CODE
--	, STATUS_NM
--	, SOURCE_LEVEL_1_NAME
--	, SOURCE_LEVEL_2_NAME
--	, SOURCE_LEVEL_3_NAME
--	, SOURCE_LEVEL_4_NAME
--	, CAMPAIGN_NM
--	FROM F88DWH.W_POL_DTL_F POL
--	WHERE SUBSTR(TO_CHAR(DATE_WID),1,6) = REPORTDATE
--	) POL
	ON LDT.LOAN_CODE = POL.LOAN_CODE AND POL.STATUS_NM = 'Nhận cầm cố'
LEFT JOIN F88DWH.VW_W_EMPLOYEE_D SP ON DAILY.SUPPORTER_WID = SP.EMPLOYEE_WID
WHERE SUBSTR(ldt.DISBURSE_DATE_WID,1,6) = SUBSTR(REPORTDATE,1,6)
AND DAILY.REVERSED_DATE IS NULL;

COMMIT;

END PROC_BDM_Disburse_Monthly;
```

### `F88DWH.PROC_BDM_LOAN_INFO` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE        PROC_BDM_LOAN_INFO (REPORTDATE NUMBER)
IS
BEGIN
	/*
	 * File LOAN.sql do BDM cung cấp để xây Data mart
	 * Tạo bởi: hieumx2
	 * Ngày tạo: 2025-03-27
	 * Ngày chỉnh sửa:
	 */

---------------------

--- 0. Delete old data
DELETE /*+ PARALLEL(4) */
FROM F88DWH.W_BDM_LOAN_INFO_F
WHERE YEAR_NUM = SUBSTR(REPORTDATE, 1, 4)
	AND MONTH_NUM = SUBSTR(REPORTDATE, 5, 2);
--	AND DISBURSE_DATE = REPORTDATE;\

--	EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_BDM_F_DISBURSE';

--- 1. Insert data
INSERT /*+ append parallel(4) */  INTO F88DWH.W_BDM_LOAN_INFO_F (
	"YEAR_NUM"  ,
	"MONTH_NUM"  ,
	"DATE_WID"  ,
	"KHOI"  ,
	"MA_PGD"  ,
	"PGD_MO"  ,
	"MA_HD" ,
	"MA_KH" ,
	"TEN_KH" ,
	"LOAI_KH"  ,
	"LOAI_HD" ,
	"ASSET_TP" ,
	"GOI_VAY" ,
	"GIA_THAM_DINH"  ,
	"GIA_CHO_VAY"  ,
	"GIAI_NGAN"  ,
	"NET_DISBURSE"  ,
	"KY_HAN"  ,
	"LTV"  ,
	"NGAY_TAO_HD" ,
	"NGAY_VAY"  ,
	"NGAY_HET_HAN"  ,
	"NGAY_DONG_HD"  ,
	"EMPLOYEE_CODE" ,
	"GIOI_TINH" ,
	"NGANH_NGHE"  ,
	"XEP_LOAI_TIN_DUNG"  ,
	"NHOM_TUOI",
	"TRANG_THAI_HON_NHAN"  ,
	"SL_CON_CAI"  ,
	"TINH_THANH_HIEN_TAI" ,
	"LOAI_HINH_CU_TRU" ,
	"THOI_GIAN_CU_TRU"  ,
	"NGHE_NGHIEP"  ,
	"THU_NHAP"  ,
	"MUC_DICH_VAY"  ,
	"CAMPAIGN" ,
	"NHOM_NGUON",
	"NGUON_PHU" ,
	"KENH" ,
	"NGUON",
	"PAYMENT_METHOD",
	"CONTRACT_CODE")

SELECT
	TO_NUMBER(SUBSTR(LDT.DISBURSE_DATE_WID,1,4)) YEAR_NUM,
	TO_NUMBER(SUBSTR(LDT.DISBURSE_DATE_WID,5,2)) MONTH_NUM,
	LDT.DISBURSE_DATE_WID DATE_WID,
	LDT.CHANNEL_CODE KHOI,
	S1.SHORT_NM MA_PGD,
	S1.SHOP_NM PGD_MO,
	LDT.LOAN_CODE MA_HD,
	C.CUSTOMER_CODE MA_KH,
	INITCAP(LOWER(C.CUSTOMER_NM)) TEN_KH,
	CASE
	    WHEN LDT.CTR_TYPE = 'Mới' THEN LDT.CTR_TYPE
	    ELSE ql.CTR_TYPE
	END LOAI_KH,
	CASE
		WHEN LDT.DISBURSE_DATE_WID = LDT.CLOSED_DATE_WID THEN 'Mở-đóng trong ngày'
		WHEN ql.CTR_TYPE = 'Topup' AND ql.NET_DISBURSE > 0 THEN 'Topup'
		WHEN ql.CTR_TYPE = 'Vay lại' AND ql.NET_DISBURSE > 0 THEN 'Vay lại'
		WHEN ql.CTR_TYPE = 'Tái tục' THEN 'Tái tục'
		WHEN ql.CTR_TYPE IS NULL THEN 'Mới'
	END AS LOAI_HD,
	ATP.ASSET_TP_NM AS ASSET_TP,
	NVL(P.PACKAGE_NM, LDT.LOAN_PKG_NM) AS GOI_VAY,
	LDT.COLLATERAL_AMT AS GIA_THAM_DINH,
	LDT.DISBURSE_AMT - LDT.INSURANCE_AMT AS GIA_CHO_VAY,
	LDT.DISBURSE_AMT AS GIAI_NGAN,
	NVL(ql.NET_DISBURSE , LDT.DISBURSE_AMT ) AS NET_DISBURSE,
	LDT.TERM_FREQUENCY AS KY_HAN,
	CASE
		WHEN ldt.COLLATERAL_AMT IS NULL OR ldt.COLLATERAL_AMT = 0 THEN 0
		ELSE ROUND((LDT.DISBURSE_AMT - LDT.INSURANCE_AMT)/ LDT.COLLATERAL_AMT, 4)
	END AS LTV,
	POL.FORM_CREATED_DT NGAY_TAO_HD,
	TO_DATE(LDT.DISBURSE_DATE_WID, 'YYYY-MM-DD') NGAY_VAY,
	LDT.TO_DATE NGAY_HET_HAN,
	TO_DATE(LDT.CLOSED_DATE_WID, 'YYYY-MM-DD') NGAY_DONG_HD,
	ec.EMPLOYEE_CODE EMPLOYEE_CODE,
	INITCAP(c.GENDER_NM) AS GIOI_TINH,
	vwlcf.INDUSTRY_NM NGANH_NGHE,
	CASE
		WHEN ql.CTR_TYPE IS NULL
		THEN wlsf."RANK"
		ELSE CASE
			WHEN wlsf.SCORE <= 399 THEN 'Xấu'
			WHEN wlsf.SCORE <= 500 THEN 'Trung bình'
			WHEN wlsf.SCORE <= 600 THEN 'Khá'
			WHEN wlsf.SCORE > 600 THEN 'Tốt'
			ELSE 'Không xác định'
			END
	END
	AS XEP_LOAI_TIN_DUNG,
	CASE WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 18 THEN '<18'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 21 THEN '18-20'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 26 THEN '21-25'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 31 THEN '26-30'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 36 THEN '31-35'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 41 THEN '36-40'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 46 THEN '41-45'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 51 THEN '46-50'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 56 THEN '51-55'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) < 61 THEN '56-60'
        	 WHEN (SUBSTR(LDT.DISBURSE_DATE_WID,1,4) -  vwlcf.BIRTH_YEAR) >=61 THEN '>60'
        ELSE 'Không xác định'
    END NHOM_TUOI,
	NVL(grp1.GRP_NM, 'Không xác định') TRANG_THAI_HON_NHAN,
	vwlcf.NUMBER_OF_CHILD SL_CON_CAI,
	vwlcf.PROVINCE_NM TINH_THANH_HIEN_TAI,
--	vwlcf.DISTRICT_NM QUAN_HUYEN_HIEN_TAI,
	vwlcf.LOAI_HINH_CU_TRU,
	vwlcf.RESIDENCE_TIME THOI_GIAN_CU_TRU,
--	NULL TINH_THANH_DINH_DANH,
	vwlcf.JOB_NM NGHE_NGHIEP,
	grp3.GRP_NM THU_NHAP,
	vwlcf.LOAN_PURPOSE_NAME MUC_DICH_VAY,
	POL.CAMPAIGN_NM CAMPAIGN,
	POL.SOURCE_LEVEL_2_NAME NHOM_NGUON,
	POL.SOURCE_LEVEL_3_NAME NGUON_PHU,
	CASE
		WHEN POL.SOURCE_LEVEL_1_NAME  IN ('Digital HO','TLS E2E') THEN 'Digital HO'
		ELSE POL.SOURCE_LEVEL_1_NAME
	END KENH,
	CASE
		WHEN vwlcf.CUSTOMER_SOURCE_WID IN (33, 124, 184, 186, 189, 192, 221, 222) THEN 'Online'
		WHEN POL.POL_WID IS NULL THEN 'Offline'
	ELSE 'Online'
	END NGUON,
	grp2.GRP_NM PAYMENT_METHOD,
	LDT.CONTRACT_CODE
FROM F88DWH.W_LOAN_DTL_F LDT
LEFT JOIN F88DWH.W_CTR_TYPE_KHQL ql
	ON ql.LOAN_WID_NEW = LDT.LOAN_WID
LEFT JOIN f88dwh.W_LOAN_SCORE_F wlsf
	ON wlsf.LOAN_WID = LDT.LOAN_WID
LEFT JOIN F88DWH.W_SHOP_D S1
	ON LDT.SHOP_WID = S1.SHOP_WID
LEFT JOIN F88DWH.vw_W_CUSTOMER_D c
	ON LDT.CUSTOMER_WID = C.CUSTOMER_WID
LEFT JOIN F88DWH.W_PACKAGE_D P
	ON LDT.PACKAGE_WID = P.PACKAGE_WID
LEFT JOIN f88dwh.W_AREA_MANAGER_D a
	ON s1.shop_code = trim(a.SHOP_ID)
LEFT JOIN F88DWH.W_ASSET_TP_D ATP
	ON LDT.ASSET_TYPE_WID  = ATP.ASSET_TP_WID
LEFT JOIN F88DWH.GRP grp3
	ON grp3.GRP_CODE = c.CUSTOMER_INCOME AND grp3.GRP_TP = 'AVERAGE_INCOME'
LEFT JOIN F88DWH.VW_W_EMPLOYEE_D EC
	ON LDT.CREATED_USER_WID = EC.EMPLOYEE_WID
LEFT JOIN F88DWH.W_POL_DTL_F POL
	ON LDT.LOAN_CODE = POL.LOAN_CODE
	AND POL.STATUS_NM = 'Nhận cầm cố'
LEFT JOIN F88dwh.VW_W_LOAN_CUSTOMER_F vwlcf
	ON vwlcf.LOAN_WID  = LDT.LOAN_WID
LEFT JOIN  f88dwh.GRP grp1
    ON grp1.GRP_ID = vwlcf.MARITAL_ID AND grp1.GRP_TP = 'MARITAL_STATUS'
LEFT JOIN  f88dwh.GRP grp2
    ON grp2.GRP_ID = LDT.ORIGIN_PAYMENT_METHOD_WID AND grp2.GRP_TP = 'ORIGIN_PAYMENT_METHOD'
LEFT JOIN F88DWH.W_LOAN_DAILY_F DAILY
	ON LDT.LOAN_CODE = DAILY.LOAN_CODE
	AND LDT.DISBURSE_DATE_WID = DAILY.DATE_WID
	AND DAILY.YEAR_NUM = SUBSTR(REPORTDATE,1,4)
	AND DAILY.MONTH_NUM = SUBSTR(REPORTDATE,5,2)
WHERE 1 = 1
	AND DAILY.REVERSED_DATE IS NULL
	AND lower(S1.SHOP_NM ) NOT LIKE '%test%'
	AND SUBSTR(LDT.DISBURSE_DATE_WID,1,6) = SUBSTR(REPORTDATE,1,6)
	AND LDT.DISBURSE_DATE_WID <= REPORTDATE;


COMMIT;

END PROC_BDM_LOAN_INFO;
```

### `F88DWH.PROC_CRM_SURVEY_INFO` (PROCEDURE) — 2 lines reference search term

```
PROCEDURE PROC_CRM_SURVEY_INFO (P_DATE NUMBER)
/*
  -- Author  : hungnm6
  -- Updated : 21/08/2025
  -- Purpose : Khao sat ZNS
  -- Ticket: #F88_1797D2WW0
  -- Mô tả: Procedure này thực hiện khảo sát khách hàng qua ZNS (Zalo Notification Service)
  -- Input: P_DATE - Ngày chạy dữ liệu (format: YYYYMMDD)
*/
IS
--	P_DATE NUMBER: Luồng tự động sẽ truyền Yesterday;
BEGIN
--	P_DATE := TO_CHAR(TO_DATE(C_DATE,'yyyymmdd')-1,'yyyymmdd');


--================================================================================================================--
-- ZNS DAILY NPS
-----------------------------------------------------------------------------------------------
---- PHẦN 1: XÂY DỰNG DANH SÁCH SỐ ĐIỆN THOẠI LOẠI TRỪ ----------------------------------------
---- Loại bỏ các số điện thoại đã được gửi ZNS trong thời gian gần đây ------------------------
-----------------------------------------------------------------------------------------------
-- Xóa dữ liệu cũ trong bảng trước khi chèn dữ liệu mới
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_ZNS_EXCLUDE_TMP';
-- Chèn dữ liệu vào bảng F88DWH.W_ZNS_EXCLUDE_TMP - danh sách số điện thoại cần loại trừ
-- Mục đích: Loại bỏ các số điện thoại đã được gửi ZNS thành công trong thời gian gần đây
INSERT INTO F88DWH.W_ZNS_EXCLUDE_TMP(PHONE_NO)

	-- Lấy danh sách ngày từ tháng trước đến ngày hiện tại
	-- Mục đích: Xác định khoảng thời gian để lọc số điện thoại đã được gửi ZNS
	WITH cld AS (
		SELECT wcd.*, 'Success' AS RESPONSE_CODE
		FROM F88DWH.W_CALENDAR_D wcd
		WHERE DATE_WID > TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE, 'yyyymmdd'), -1), 'YYYYMMDD'))
		AND DATE_WID <= TO_NUMBER(P_DATE)
	)
	-- Lấy danh sách số điện thoại đã được gửi ZNS thành công trong thời gian gần đây
	-- Mục đích: Loại bỏ các số điện thoại đã được gửi ZNS để tránh spam khách hàng
	, zns_exclude AS (
		SELECT PHONE_NO
		FROM F88DWH.W_NOTIFY_LOG_DTL_F h
		JOIN F88DWH.W_NOTIFY_TEMPLATE_D wntd
			ON h.TEMPLATE_ID = wntd.INTEGRATION_ID
		WHERE EXISTS (
			SELECT 1
			FROM cld
			WHERE cld.YEAR_NUM = h.YEAR_NUM
			AND cld.MONTH_NUM = h.MONTH_NUM
			AND cld.DATE_WID = h.DATE_WID
			AND cld.RESPONSE_CODE = h.RESPONSE_CODE
		)
		AND h.PROJECT_ID IN ('6704a31b83d391104b91005c', '66671b31577b427363a3b84f')  -- Project ID của ZNS
		AND wntd.CODE IN (
			'TEMPLATE_POL_ZNS_02',
			'TEMPLATE_POL_ZNS_07',
			'TEMPLATE_POL_ZNS_11'
		)
	)
	SELECT PHONE_NO
	FROM zns_exclude;
	COMMIT;


---------------------------------------------------------------------------------------------
---- PHẦN 2: CẬP NHẬT DỮ LIỆU KHÁCH HÀNG ƯU ĐÃI PTSP ----------------------------------------
---- Lấy data từ HANHDTM.KH_UUDAI_PTSP để làm nguồn dữ liệu cho F88DWH.W_KH_UUDAI_PTSP-------
---- Logic này thay đổi hàng tháng và chạy tay-----------------------------------------------
---------------------------------------------------------------------------------------------

-- Xóa dữ liệu cũ của tháng hiện tại
DELETE FROM  F88DWH.W_KH_UUDAI_PTSP WHERE YEAR_NUM = SUBSTR(P_DATE,1,4) AND MONTH_NUM = SUBSTR(P_DATE,5,2);

-- Chèn dữ liệu mới từ bảng nguồn
INSERT INTO F88DWH.W_KH_UUDAI_PTSP (YEAR_NUM, MONTH_NUM, THANG_CHOT,
									CUSTOMER, CUSTOMER_NM, ID_TYPE_NAME, ID_TYPE,
									LOAN_CODE, SHOP_CODE, TEN_PGD, TRADE_LEAD,
									PROVINCE, LOAN_PKG_NM, LOAI_TS, KY_HAN,
									SO_THANG_DUY_TRI, CLOSED_DATE_WID, DISBURSE_DATE_WID,
									DISBURSE_AMT, COLLATERAL_AMT, MAX_LENDABLE_AMT,
									MAX_DPD, PHAN_HANG, XEP_HANG_KH, GOI_VAY_DE_XUAT,
									MAX_LTV, MAX_LA, CPV, PRICE, PRICE_PREV, JOB_NM,
									STATUS, ST, RN
									)
	SELECT
			YEAR_NUM, MONTH_NUM, THANG_CHOT,
			CUSTOMER, CUSTOMER_NM, ID_TYPE_NAME, ID_TYPE,
			LOAN_CODE, SHOP_CODE, TEN_PGD, TRADE_LEAD,
			PROVINCE, LOAN_PKG_NM, LOAI_TS, KY_HAN,
			SO_THANG_DUY_TRI, CLOSED_DATE_WID, DISBURSE_DATE_WID,
			DISBURSE_AMT, COLLATERAL_AMT, MAX_LENDABLE_AMT,
			MAX_DPD, PHAN_HANG, XEP_HANG_KH, GOI_VAY_DE_XUAT,
			MAX_LTV, MAX_LA, CPV, PRICE, PRICE_PREV, JOB_NM,
			STATUS, ST, RN
	FROM HANHDTM.KH_UUDAI_PTSP
	WHERE YEAR_NUM = SUBSTR(P_DATE,1,4) AND MONTH_NUM = SUBSTR(P_DATE,5,2);

-----------------------------------------------------------------------------------------------
---- PHẦN 3: XÂY DỰNG DANH SÁCH KHÁCH HÀNG KHẢO SÁT -------------------------------------------
---- Tạo danh sách khách hàng đáp ứng các điều kiện khảo sát khác nhau ------------------------
-----------------------------------------------------------------------------------------------

-- Xóa dữ liệu tạm thời cũ
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_TNKH_SURVEY_TMP';
-- Chèn dữ liệu khách hàng khảo sát với các template khác nhau
INSERT INTO F88DWH.W_TNKH_SURVEY_TMP(CREATED_DT, TRANS_DT, CUSTOMER_CODE, CUSTOMER_NM, LOAN_CODE, LOAN_WID, TEMPLATE_CODE, NHOM_KH)
	--TEMPLATE_POL_ZNS_01
	-- ĐIỀU KIỆN TẤT TOÁN TRƯỚC HẠN:
	-- 	Có GNN đóng tại ngày P_DATE nhưng Giải ngân KHÁC ngày P_DATE
	-- 	Ngày Đóng GNN <= TO_DATE
	-- 	GNN đóng có OVERDUE_DAYS_ADJUST (DPD) <= 0
	-- 	Không có GNN nào khác mở trong ngày P_DATE
	WITH cal AS (
	-- Lấy thông tin ngày hôm qua để tính DPD
		SELECT YEAR_NUM,
				MONTH_NUM,
				DATE_WID
		FROM F88DWH.W_CALENDAR_D
		WHERE DATE_WID =  TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'yyyymmdd') - 1, 'yyyymmdd'))
		)
	, tt_th AS (--TEMPLATE_POL_ZNS_05
	-- Lấy danh sách khoản vay tất toán trước hạn
		SELECT  LDT.LOAN_WID,
				LDT.CUSTOMER_CODE,
				LDT.CUSTOMER_WID,
				LDT.LOAN_CODE,
				TO_DATE(LDT.CLOSED_DATE_WID , 'yyyymmdd') trans_dt  -- Ngày tất toán trước hạn
		FROM F88DWH.W_LOAN_DTL_F LDT
		WHERE 1=1
		AND LDT.CLOSED_DATE_WID = P_DATE  -- Tất toán trong ngày P_DATE
		AND P_DATE != LDT.DISBURSE_DATE_WID  -- Không phải ngày giải ngân
		AND TO_DATE(P_DATE , 'yyyymmdd') <= LDT.TO_DATE  -- Trước hạn
		)
	, dpd AS (
		-- Lấy thông tin DPD (Days Past Due) của khoản vay
		SELECT  LOAN_CODE,
				OVERDUE_DAYS_ADJUST
		FROM F88DWH.W_LOAN_DAILY_F LD
		WHERE 1=1
		AND EXISTS (
		SELECT 1
		FROM cal
			WHERE ld.YEAR_NUM = cal.YEAR_NUM
			AND ld.MONTH_NUM = cal.MONTH_NUM
			AND ld.DATE_WID =  cal.DATE_WID
			)
	)
	,hdmm AS (
		-- Lấy danh sách khách hàng mở hợp đồng mới trong ngày P_DATE
		-- Mục đích: Loại bỏ khách hàng đóng hợp đồng cũ rồi mở hợp đồng mới trong cùng ngày
		SELECT  c.CUSTOMER_CODE
		FROM F88DWH.W_LOAN_DTL_F LDT
		LEFT JOIN F88DWH.W_CUSTOMER_D c ON LDT.CUSTOMER_WID = c.CUSTOMER_WID
		WHERE LDT.DISBURSE_DATE_WID = P_DATE
		)
	-- ĐIỀU KIỆN Ký hợp đồng Điện tử đã hoàn thành:
	-- 	Có GNN Giải ngân trong ngày P_DATE
	-- 	Loại đóng mở trong ngày
	-- 	CHANNEL_CODE IN ('KDML','Online','PTDT3P','E2E')
	, latest_econtract AS (
		-- Lấy trạng thái hợp đồng điện tử mới nhất cho mỗi khoản vay
		-- Mục đích: Xác định khách hàng đã hoàn thành ký hợp đồng điện tử hay chưa
		-- Lấy trạng thái hợp đồng điện tử mới nhất cho mỗi khoản vay
		SELECT loan_master_wid, loan_econtract_status_wid
		FROM (
			SELECT
				a.loan_master_wid,
				a.loan_econtract_status_wid,
				ROW_NUMBER() OVER (
					PARTITION BY a.loan_master_wid
					ORDER BY a.integration_id DESC
				) AS rn
			FROM F88DWH.VW_W_LOAN_ECONTRACT_F a
			WHERE a.SIGN_TP = 'app'
		)
		WHERE rn = 1
	)
	, base AS (
		-- Dữ liệu cơ sở cho khách hàng mở hợp đồng mới
		-- Mục đích: Tạo danh sách khách hàng mở hợp đồng mới với thông tin hợp đồng điện tử
		SELECT
			SYSDATE AS created_dt,
			a.created_dt AS trans_dt,
			cd.customer_code,
			cd.customer_nm,
			a.loan_code,
			a.loan_wid,
			mt.loan_master_wid,
			ap.loan_econtract_status_wid,
			b.loan_econtract_status_code
		FROM F88DWH.W_LOAN_DTL_F a
		LEFT JOIN F88DWH.W_CUSTOMER_D cd
			ON a.customer_wid = cd.customer_wid
		LEFT JOIN F88DWH.VW_W_LOAN_MASTER_F mt
			ON a.loan_code = mt.codeno
		LEFT JOIN latest_econtract ap
			ON mt.loan_master_wid = ap.loan_master_wid
		LEFT JOIN F88DWH.W_LOAN_ECONTRACT_STATUS_D b
			ON ap.loan_econtract_status_wid = b.loan_econtract_status_wid
		WHERE a.ctr_type = 'Mới' -- HDMM lần đầu tiên
		AND a.disburse_date_wid = P_DATE
		AND (a.closed_date_wid IS NULL OR a.closed_date_wid <> P_DATE)
		AND a.channel_code IN ('KDML','Online','PTDT3P','E2E')
	)
	-- UNION 1: Khách hàng tất toán trước hạn (TT)
	-- Điều kiện: Tất toán trong ngày P_DATE, không quá hạn, không mở hợp đồng mới trong cùng ngày
	SELECT
			SYSDATE CREATED_DT,
			TRANS_DT,
			tt_th.CUSTOMER_CODE,
			c.CUSTOMER_NM ,
			tt_th.LOAN_CODE,
			tt_th.LOAN_WID,
			'TEMPLATE_POL_ZNS_07' TEMPLATE_CODE,
			'TT' NHOM_KH
		FROM tt_th
		LEFT JOIN dpd ON tt_th.LOAN_CODE = dpd.LOAN_CODE
		LEFT JOIN F88DWH.W_CUSTOMER_D c ON tt_th.CUSTOMER_WID = c.CUSTOMER_WID
		WHERE NVL(dpd.OVERDUE_DAYS_ADJUST,0) <=0 --Không quá hạn
		AND NOT EXISTS (
			SELECT 1
			FROM hdmm
			WHERE hdmm.CUSTOMER_CODE = tt_th.CUSTOMER_CODE
		)   --Loại KH đóng cũ rồi mở HĐ mới trong ngày P_DATE
	UNION ALL
	-- UNION 2: Khách hàng mở hợp đồng mới chưa hoàn thành hợp đồng điện tử (MMPGD)
	-- Điều kiện: Mở hợp đồng mới trong ngày P_DATE, chưa hoàn thành ký hợp đồng điện tử
		SELECT
			created_dt,
			trans_dt,
			customer_code,
			customer_nm,
			loan_code,
			loan_wid,
			'TEMPLATE_POL_ZNS_07' AS template_code,
			'MMPGD' AS nhom_kh
		FROM base
		WHERE (loan_econtract_status_code <> 'complete' OR loan_econtract_status_code IS NULL)
	UNION ALL
	-- UNION 3: Khách hàng mở hợp đồng mới đã hoàn thành hợp đồng điện tử (MMAPP1)
	-- Điều kiện: Mở hợp đồng mới trong ngày P_DATE, đã hoàn thành ký hợp đồng điện tử
		SELECT
			created_dt,
			trans_dt,
			customer_code,
			customer_nm,
			loan_code,
			loan_wid,
			'TEMPLATE_POL_ZNS_07' AS template_code,
			'MMAPP1' AS nhom_kh
		FROM base
		WHERE loan_econtract_status_code = 'complete'
	UNION ALL
	-- UNION 4: Khách hàng mở hợp đồng mới đã hoàn thành hợp đồng điện tử (MMAPP2) - duplicate để tăng số lượng
	-- Điều kiện: Giống MMAPP1 nhưng tạo thêm một nhóm riêng để tăng số lượng mẫu khảo sát
		SELECT
			created_dt,
			trans_dt,
			customer_code,
			customer_nm,
			loan_code,
			loan_wid,
			'TEMPLATE_POL_ZNS_07' AS template_code,
			'MMAPP2' AS nhom_kh
		FROM base
		WHERE loan_econtract_status_code = 'complete'
	UNION ALL
	-- UNION 5: Khách hàng bị nhắc nợ (NNTH/NNQH)
	-- ĐIỀU KIỆN KH Bị nhắc nợ:
	-- NNTH: Khách hàng được nhắc nợ trước hạn (DPD <= 0)
	-- NNQH: Khách hàng được nhắc nợ quá hạn (DPD >= 1)
		SELECT DISTINCT
			SYSDATE CREATE_DT,
			COMPLETED_PAID_DATE TRANS_DT,
			c.CUSTOMER_CODE,
			c.CUSTOMER_NM,
			LDT.LOAN_CODE,
			LDT.LOAN_WID,
			'TEMPLATE_POL_ZNS_07' TEMPLATE_CODE,
			CASE
				WHEN CMT.DPD <= 0 AND LS.OVERDUE_DAYS <= 0 THEN 'NNTH' -- KH được nhắc nợ trước hạn: KH được nhắc nợ vào thời điểm DPD<=0 và tại ngày đóng CPV, KH không quá hạn
				WHEN CMT.DPD >= 1 THEN 'NNQH' -- KH được nhắc nợ quá hạn: KH được nhắc nợ vào thời điểm DPD>=1
				END NHOM_KH
		FROM F88DWH.W_LOAN_SCH_DTL_F LS
		LEFT JOIN F88DWH.W_LOAN_DTL_F LDT
			ON LS.LOAN_WID = LDT.LOAN_WID
		LEFT JOIN F88DWH.W_CUSTOMER_D c
			ON LDT.CUSTOMER_WID = c.CUSTOMER_WID
		LEFT JOIN (SELECT DPD, LOAN_WID FROM F88DWH.vw_W_CMT_CONTRACT_F WHERE SUBSTR(DATE_WID,1,6) = SUBSTR(P_DATE,1,6)) CMT
			ON LS.LOAN_WID = CMT.LOAN_WID --Tương tác nhắc nợ của tháng trả CPV
		WHERE 1=1
			AND EXTRACT(YEAR FROM  LS.TO_DATE) = SUBSTR(P_DATE,1,4)
			AND EXTRACT(MONTH FROM LS.TO_DATE) = SUBSTR(P_DATE,5,2) --Trả CPV của tháng này
			AND CMT.DPD IS NOT NULL --Phân loại nhắc nợ
			AND LS.COMPLETED_PAID_DATE = TO_DATE(P_DATE,'yyyymmdd')
	UNION ALL
	-- UNION 6: Khách hàng quay lại (KHQL)
	-- Phân loại khách hàng quay lại dựa trên loại hợp đồng và lịch sử ưu đãi PTSP
		SELECT
			SYSDATE CREATED_DT,
			A.CREATED_DT TRANS_DT,
			c.CUSTOMER_CODE,
			c.CUSTOMER_NM  ,
			A.LOAN_CODE, A.LOAN_WID,
			'TEMPLATE_POL_ZNS_07' TEMPLATE_CODE,
			CASE
				WHEN UD.CUSTOMER IS NOT NULL AND KHQL.CTR_TYPE = 'Vay lại' THEN 'KHQLCUD'  -- KH quay lại cũ
				WHEN UD.CUSTOMER IS NULL THEN
					CASE
						WHEN KHQL.CTR_TYPE = 'Vay lại' THEN 'KHQLVL'  -- KH quay lại vay lại
						WHEN KHQL.CTR_TYPE = 'Topup' THEN 'KHQLTU'    -- KH quay lại topup
						WHEN KHQL.CTR_TYPE = 'Tái tục' THEN 'KHQLTT'  -- KH quay lại tái tục
					END
			END AS NHOM_KH
		FROM F88DWH.W_LOAN_DTL_F A
		LEFT JOIN F88DWH.W_NET_DISBURSE_F KHQL
			ON A.LOAN_CODE = KHQL.LOAN_CODE
		LEFT JOIN F88DWH.W_CUSTOMER_D c
			ON A.CUSTOMER_WID = c.CUSTOMER_WID
		LEFT JOIN F88DWH.W_KH_UUDAI_PTSP ud
			ON c.CUSTOMER_CODE = ud.CUSTOMER
			AND UD.YEAR_NUM  = TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE, 'YYYYMMDD'), -1), 'YYYY')
			AND UD.MONTH_NUM = TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE, 'YYYYMMDD'), -1), 'MM') --- LẤY DATA PTSP CHỐT Ở THÁNG TRƯỚC: CHẠY DỮ LIỆU THÁNG 4 THÌ DATA PTSP LÀ THÁNG 3
		WHERE 1=1
			AND KHQL.CTR_TYPE IN ('Vay lại', 'Topup', 'Tái tục') --KHQL
			AND a.DISBURSE_DATE_WID = P_DATE
	UNION ALL
	-- UNION 7: Khách hàng quay lại topup đã hoàn thành hợp đồng điện tử (KHQLTUAPP)
	-- Điều kiện: Khách hàng quay lại với loại hợp đồng Topup và đã hoàn thành ký hợp đồng điện tử
		SELECT
			SYSDATE CREATED_DT,
			A.CREATED_DT TRANS_DT,
			c.CUSTOMER_CODE,
			c.CUSTOMER_NM  ,
			A.LOAN_CODE, A.LOAN_WID,
			'TEMPLATE_POL_ZNS_07' TEMPLATE_CODE,
			'KHQLTUAPP' AS NHOM_KH
		FROM F88DWH.W_LOAN_DTL_F A
		LEFT JOIN F88DWH.W_NET_DISBURSE_F KHQL
			ON A.LOAN_CODE = KHQL.LOAN_CODE
		LEFT JOIN F88DWH.W_CUSTOMER_D c
			ON A.CUSTOMER_WID = c.CUSTOMER_WID
		LEFT JOIN f88dwh.vw_w_loan_master_f mt
			ON a.LOAN_CODE = mt.CODENO
		LEFT JOIN latest_econtract ap ON mt.LOAN_MASTER_WID = ap.LOAN_MASTER_WID
		LEFT JOIN F88DWH.W_LOAN_ECONTRACT_STATUS_D b
			ON ap.LOAN_ECONTRACT_STATUS_WID = b.LOAN_ECONTRACT_STATUS_WID
		WHERE 1=1
			AND KHQL.CTR_TYPE ='Topup'
			AND a.DISBURSE_DATE_WID = P_DATE
			AND b.LOAN_ECONTRACT_STATUS_CODE = 'complete'
	UNION ALL
	-- UNION 8: Khách hàng cũ vay lại cũ (KHCVLCUD)
	-- Điều kiện: Khách hàng từ danh sách ưu đãi PTSP tháng trước, không phát sinh hợp đồng mới
		SELECT
			SYSDATE CREATED_DT,
			trunc(SYSDATE -1)  TRANS_DT,
			UD.CUSTOMER CUSTOMER_CODE,
			UD.CUSTOMER_NM  ,
		UD.LOAN_CODE, WLDF.LOAN_WID,
			'TEMPLATE_POL_ZNS_07' TEMPLATE_CODE,
			'KHCVLCUD' NHOM_KH
		FROM  F88DWH.W_KH_UUDAI_PTSP ud
		JOIN F88DWH.W_LOAN_DTL_F wldf
			ON UD.LOAN_CODE = WLDF.LOAN_CODE
		WHERE 1=1
			AND UD.YEAR_NUM  = TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE, 'YYYYMMDD'), -1), 'YYYY')
			AND UD.MONTH_NUM = TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE, 'YYYYMMDD'), -1), 'MM') --- LẤY DATA PTSP CHỐT Ở THÁNG TRƯỚC: CHẠY DỮ LIỆU THÁNG 4 THÌ DATA PTSP LÀ THÁNG 3
			AND ud.CUSTOMER NOT IN
			(SELECT DISTINCT VWCD.CUSTOMER_CODE
			FROM F88DWH.W_LOAN_DTL_F wldf
			LEFT JOIN F88DWH.W_CUSTOMER_D vwcd
				ON WLDF.CUSTOMER_WID =VWCD.CUSTOMER_WID
			WHERE wldf.DISBURSE_DATE_WID BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE, 'YYYYMMDD'), -1), 'YYYYMM') || '28' AND P_DATE )
		;
	--		(--LOẠI BỎ KH PHÁT SINH TẠI THỜI ĐIỂM CHỐT CỦA PTSP ngày 28 tháng trước ĐẾN THỜI GIAN CHẠY DỮ LIỆU)
	-- Mục đích: Tránh trùng lặp với khách hàng đã được khảo sát từ tháng trước
	dbms_output.put_line('----> DONE INSERT SUCCESS W_TNKH_SURVEY_TMP AT:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));


-- Xóa dữ liệu cũ của ngày chạy dữ liệu
DELETE FROM  F88DWH.W_CRM_SURVEY_INFO WHERE TO_CHAR(TRANS_DT, 'yyyymmdd') = P_DATE;

--================================================================================================================--
-- Mã Ticket: #F88_1D7383LKW
-- 1/ Nhóm 1 (BHĐLMM): KH mua bảo hiểm độc lập (bảo hiểm không đính kèm khoản vay) vào ngày T-1 (trừ KH mua BH trách nhiệm dân sự xe máy)
-- Param CTA khảo sát: r/BH20251?MMBH=LOAN_CODE
-- 2/ Nhóm 2 (BHĐLĐH): KH có gói bảo hiểm độc lập (loại trừ KH mua BH trách nhiệm dân sự xe máy) sắp đến hạn, cách ngày đến hạn 10 ngày (T-10, T là ngày đến hạn bảo hiểm)
-- Param CTA khảo sát: r/BH20252?DHBH=LOAN_CODE
-- Trong trường hợp 1 khách hàng trùng giữa nhóm Bảo hiểm với các nhóm vay khác (MM,TT, ...) thì ưu tiên giữ ở nhóm Bảo hiểm. Lọc trùng CIF trong cùng 1 nhóm (nếu có)
INSERT INTO F88DWH.W_CRM_SURVEY_INFO (CREATED_DT,TRANS_DT,CUSTOMER_CODE,CUSTOMER_NM,GENDER_NM,INS_CONTRACT_NO,TEMPLATE_CODE,PHONE,URL,NHOM_KH,CODE)
	WITH CUS_INS AS (
		SELECT
			c.*
			, ROW_NUMBER() OVER(PARTITION BY CUSTOMER_CODE ORDER BY INTEGRATION_ID DESC) RN
		FROM F88DWH.W_INS_CUSTOMER_D c
	) ,
	INSUARANCE_BASE AS (
		SELECT
			SYSDATE AS CREATED_DT
			, TO_DATE(P_DATE,'YYYYMMDD') AS TRANS_DT
			, wir.CONTRACT_NO
			, NVL(wir.CUSTOMER_CODE, wir.BUYER_CODE) CUSTOMER_CODE
			, NVL(wir.CUSTOMER_NM, wir.BUYER_NM) customer_nm
			, CASE
				WHEN ci.GENDER_CODE = 1 THEN 'NAM'
				WHEN ci.GENDER_CODE = 0 THEN 'NỮ'
			END GENDER_NM
			, wir.LOAN_CODE_CHECK
			, CASE
				WHEN ci.PHONE_NUM IS NOT NULL THEN ci.PHONE_NUM
				ELSE cp.PHONE_NUM
			END PHONE_NUM
			, CASE
				WHEN TO_CHAR(wir.CHARGE_DT,'YYYYMMDD') = P_DATE THEN 'BHĐLMM'
				WHEN TO_CHAR(wir.EXP_DT-11, 'YYYYMMDD') = P_DATE THEN 'BHĐLĐH'
			END	NHOM_KH
			, ROW_NUMBER() OVER(PARTITION BY wir.CUSTOMER_CODE ORDER BY CONTRACT_NO DESC) AS RN
		FROM F88DWH.W_INSURANCE_RPT wir
		LEFT JOIN CUS_INS ci ON ci.CUSTOMER_CODE = NVL(wir.CUSTOMER_CODE, wir.BUYER_CODE)
		LEFT JOIN F88DWH.W_CUSTOMER_PHONE_F cp ON cp.CUSTOMER_CODE = NVL(wir.CUSTOMER_CODE, wir.BUYER_CODE) AND cp.STATUS = 1 AND cp.IS_PRIMARY  = 1
		LEFT JOIN F88DWH.W_INS_PRODUCT_MAP_D p ON wir.PRODUCT_MAP_CODE = p.PRODUCT_MAP_CODE
		WHERE 1=1
			AND wir.TYPE_ = 'Độc lập'
			AND UPPER(wir.PRODUCT_MAP_CODE) NOT LIKE '%TNDSXM%'
			AND (TO_CHAR(wir.CHARGE_DT,'YYYYMMDD') = P_DATE OR TO_CHAR(wir.EXP_DT-11, 'YYYYMMDD') = P_DATE)
			AND CASE
				WHEN ci.PHONE_NUM IS NOT NULL THEN ci.PHONE_NUM
				ELSE cp.PHONE_NUM
			END IS NOT NULL
	)
	, FINAL_TBL AS (
		SELECT
			CREATED_DT,
			TRANS_DT,
			customer_code,
			customer_nm,
			GENDER_NM,
			CONTRACT_NO AS INS_CONTRACT_NO,
			'TEMPLATE_POL_ZNS_07' AS template_code,
			PHONE_NUM,
			'r/BH20251?MMBH=' || CONTRACT_NO AS URL,
			NHOM_KH,
			SUBSTR(PHONE_NUM, -6) AS CODE
		FROM INSUARANCE_BASE i
		WHERE NHOM_KH = 'BHĐLMM' AND RN = 1 AND PHONE_NUM IS NOT NULL
			AND NOT EXISTS (
				SELECT 1
				FROM F88DWH.W_ZNS_EXCLUDE_TMP z
				WHERE z.PHONE_NO = i.PHONE_NUM
			)
			AND ROWNUM <= (SELECT SAMPLE_LIMIT FROM PT_HUNGNM6.W_ZNS_DAILY_RULE_LIMIT WHERE NHOM_KH = 'BHĐLMM')
		UNION ALL
		SELECT
			CREATED_DT,
			TRANS_DT,
			customer_code,
			customer_nm,
			GENDER_NM,
			CONTRACT_NO AS INS_CONTRACT_NO,
			'TEMPLATE_POL_ZNS_07' AS template_code,
			PHONE_NUM,
			'r/BH20252?DHBH=' || CONTRACT_NO AS URL,
			NHOM_KH,
			SUBSTR(PHONE_NUM, -6) AS CODE
		FROM INSUARANCE_BASE i
		WHERE NHOM_KH = 'BHĐLĐH' AND RN = 1 AND PHONE_NUM IS NOT NULL
			AND NOT EXISTS (
				SELECT 1
				FROM F88DWH.W_ZNS_EXCLUDE_TMP z
				WHERE z.PHONE_NO = i.PHONE_NUM
			)
			AND ROWNUM <= (SELECT SAMPLE_LIMIT FROM PT_HUNGNM6.W_ZNS_DAILY_RULE_LIMIT WHERE NHOM_KH = 'BHĐLĐH')
	)
	SELECT * FROM FINAL_TBL;
	COMMIT;


-- Chèn dữ liệu vào bảng W_TNKH_PHONE_SURVEY_TMP - danh sách số điện thoại khảo sát
-- Mục đích: Tạo danh sách số điện thoại hợp lệ cho khảo sát, loại bỏ các số đã được gửi ZNS
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_TNKH_PHONE_SURVEY_TMP';
INSERT INTO F88DWH.W_TNKH_PHONE_SURVEY_TMP(PHONE, LOAN_WID, CODE_RNK)

	-- Lấy thông tin khách hàng mới nhất cho mỗi khoản vay
	-- Mục đích: Đảm bảo lấy thông tin khách hàng cập nhật nhất
	WITH cus AS (
		SELECT
			LC.LOAN_WID,
			LC.LOAN_CODE,
			LC.CUSTOMER_CODE,
			LC.INTEGRATION_ID,
			ROW_NUMBER() OVER (
				PARTITION BY LC.LOAN_WID, LC.LOAN_CODE, LC.CUSTOMER_CODE
				ORDER BY LC.CREATED_DT DESC
			) AS rnk
		FROM F88DWH.VW_W_LOAN_CUSTOMER_F LC
		WHERE EXISTS (
			SELECT 1
			FROM F88DWH.W_TNKH_SURVEY_TMP survey
			WHERE survey.LOAN_WID = LC.LOAN_WID
		)
	),
```

### `F88DWH.PROC_CRM_SURVEY_INFO_TEST` (PROCEDURE) — 4 lines reference search term

```
PROCEDURE        PROC_CRM_SURVEY_INFO_TEST (P_DATE NUMBER)
/*
  -- Author  : TRANH2
  -- Updated : 03/01/2025
  -- Purpose : Khao sat ZNS
*/
IS
--	P_DATE NUMBER;
BEGIN
--	P_DATE := TO_CHAR(TO_DATE(C_DATE,'yyyymmdd')-1,'yyyymmdd');

	EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_TNKH_SURVEY_TMP_TEST';

	INSERT INTO F88DWH.W_TNKH_SURVEY_TMP_TEST(CREATED_DT, TRANS_DT, CUSTOMER_CODE, CUSTOMER_NM, LOAN_CODE, LOAN_WID, TEMPLATE_CODE, NHOM_KH)
	--TEMPLATE_POL_ZNS_01
	WITH cld AS (
	SELECT YEAR_NUM,
		MONTH_NUM,
		DATE_WID
	FROM F88DWH.W_CALENDAR_D
	WHERE DATE_WID < P_DATE
	)
	,
	cal AS (
	SELECT YEAR_NUM,
			MONTH_NUM,
			DATE_WID
	FROM F88DWH.W_CALENDAR_D
	WHERE DATE_WID =  TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'yyyymmdd') - 1, 'yyyymmdd'))
	)
	,
	pre AS (
	SELECT
		dtl.CUSTOMER_CODE ,
		CASE
			WHEN pdtl.SOURCE_LEVEL_1_ID = 1 THEN 'Pre_onl'
			WHEN pdtl.SOURCE_LEVEL_2_ID = 8 THEN 'Pre_onl'
			WHEN pdtl.LOAN_CODE IS NULL AND dtl.CHANNEL_CODE = 'KDML' AND REGEXP_LIKE(wrd.RESOURCES_NM, 'OFFLINE|TRADE','i') THEN 'Pre_off'
			WHEN pdtl.SOURCE_LEVEL_1_ID =2 AND  pdtl.SOURCE_LEVEL_2_ID = 9 THEN 'Pre_off'
			ELSE 'Khác'
		END
		AS GRP_NM
	FROM F88DWH.W_LOAN_DTL_F dtl
	JOIN cld
		ON cld.DATE_WID = dtl.DISBURSE_DATE_WID
	LEFT JOIN F88DWH.W_POL_DTL_F pdtl
		ON pdtl.LOAN_WID  = dtl.LOAN_WID
	LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F lc
		ON lc.LOAN_WID = dtl.LOAN_WID
	LEFT JOIN F88DWH.W_RESOURCES_D wrd
		ON wrd.RESOURCES_WID = lc.CUSTOMER_RESOURCES_WID
	WHERE 1=1
		AND (CASE
				WHEN pdtl.SOURCE_LEVEL_1_ID = 1 THEN 1
				WHEN pdtl.SOURCE_LEVEL_2_ID = 8 THEN 1
				WHEN pdtl.LOAN_CODE IS NULL AND dtl.CHANNEL_CODE = 'KDML' AND REGEXP_LIKE(wrd.RESOURCES_NM, 'OFFLINE|TRADE','i') THEN 1
				WHEN pdtl.SOURCE_LEVEL_1_ID =2 AND  pdtl.SOURCE_LEVEL_2_ID = 9 THEN 1
				ELSE 0
			 END
			) = 1
	)
	, tt_th AS (--TEMPLATE_POL_ZNS_05
	SELECT  LDT.LOAN_WID,
			LDT.CUSTOMER_CODE,
			LDT.CUSTOMER_WID,
			LDT.LOAN_CODE,
			TO_DATE(LDT.CLOSED_DATE_WID , 'yyyymmdd') trans_dt  --tất toán trước hạn
	FROM F88DWH.W_LOAN_DTL_F LDT
	WHERE 1=1
		AND LDT.CLOSED_DATE_WID = P_DATE
		AND P_DATE != LDT.DISBURSE_DATE_WID
		AND TO_DATE(P_DATE , 'yyyymmdd') <= LDT.TO_DATE
	)
	, dpd AS (
		SELECT  LOAN_CODE,
				OVERDUE_DAYS_ADJUST
		FROM F88DWH.W_LOAN_DAILY_F LD
		WHERE 1=1
		AND EXISTS (
		SELECT 1
		FROM cal
			WHERE ld.YEAR_NUM = cal.YEAR_NUM
			AND ld.MONTH_NUM = cal.MONTH_NUM
			AND ld.DATE_WID =  cal.DATE_WID
			)
	)
	,hdmm AS (
		SELECT  c.CUSTOMER_CODE,
				c.CUSTOMER_WID
		FROM F88DWH.W_LOAN_DTL_F LDT
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D c
			ON LDT.CUSTOMER_WID = c.CUSTOMER_WID
		WHERE 1=1
		AND LDT.DISBURSE_DATE_WID = P_DATE
		)
	SELECT
			SYSDATE CREATED_DT,
			TRANS_DT,
			tt_th.CUSTOMER_CODE,
			c.CUSTOMER_NM ,
			tt_th.LOAN_CODE,
			tt_th.LOAN_WID,
			'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE,
			'TT' NHOM_KH
		FROM tt_th
		LEFT JOIN dpd
			ON tt_th.LOAN_CODE = dpd.LOAN_CODE
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D c
			ON tt_th.CUSTOMER_WID = c.CUSTOMER_WID
		LEFT JOIN hdmm
			ON tt_th.CUSTOMER_CODE = hdmm.CUSTOMER_CODE
		WHERE 1=1
		AND NVL(dpd.OVERDUE_DAYS_ADJUST,0) <=0 --Không quá hạn
		AND hdmm.CUSTOMER_CODE IS NULL  --Loại KH đóng mở trong ngày
	UNION ALL
		SELECT
			SYSDATE CREATED_DT,
			A.CREATED_DT TRANS_DT,
		    CD.CUSTOMER_CODE,
		    CD.CUSTOMER_NM,
		    A.LOAN_CODE , A.LOAN_WID ,
		    'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE,
		    'MM' NHOM_KH
		FROM F88DWH.W_LOAN_DTL_F A
		LEFT JOIN F88DWH.W_POL_DTL_F C
			ON A.LOAN_WID = C.LOAN_WID
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D CD
			ON A.CUSTOMER_WID = CD.CUSTOMER_WID
		WHERE 1 = 1
			AND A.CTR_TYPE = 'Mới'--HDMM lần đầu tiên
			AND DISBURSE_DATE_WID = P_DATE
			AND NVL(CLOSED_DATE_WID,0) != P_DATE
			AND (C.SOURCE_LEVEL_1_ID = 1 OR SOURCE_LEVEL_2_ID = 8)
			AND A.CHANNEL_CODE = 'KDML'
			AND C.STATUS_NM = 'Nhận cầm cố'
			AND NOT EXISTS (
				SELECT 1
				FROM Pre
				WHERE GRP_NM = 'Pre_onl'
					AND CD.CUSTOMER_CODE = pre.CUSTOMER_CODE
			)
--	UNION ALL
--		--TEMPLATE_POL_ZNS_02
--		SELECT
--			SYSDATE CREATED_DT,
--			DTL.CREATED_DT TRANS_DT ,
--		    LC.CUSTOMER_CODE,
--		    LC.CUSTOMER_NM,
--		    DTL.LOAN_CODE , dtl.LOAN_WID ,
--		    'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE,
--		    'MM' NHOM_KH
--		FROM F88DWH.W_LOAN_DTL_F DTL
--		LEFT JOIN F88DWH.W_POL_DTL_F b ON b.LOAN_WID  = dtl.LOAN_WID
--		LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =DTL.LOAN_WID
--		LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
--		WHERE 1=1
--		AND DTL.CTR_TYPE = 'Mới'
--		AND DISBURSE_DATE_WID = P_DATE
--		AND b.LOAN_CODE IS NULL
--		AND dtl.CHANNEL_CODE = 'KDML'
--		AND REGEXP_LIKE(R.RESOURCES_NM, 'OFFLINE|TRADE','i')
--		AND NOT EXISTS (
--				SELECT 1
--				FROM Pre
--				WHERE GRP_NM = 'Pre_off'
--					AND lc.CUSTOMER_CODE = pre.CUSTOMER_CODE
--			)
	UNION ALL
		SELECT
			SYSDATE CREATED_DT,
			l.CREATED_DT TRANS_DT ,
		    c.CUSTOMER_CODE ,
		    c.CUSTOMER_NM,
		    l.LOAN_CODE , l.LOAN_WID,
		    'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE,
		    'MM' NHOM_KH
		FROM F88DWH.W_POL_DTL_F d
		INNER JOIN F88DWH.W_LOAN_DTL_F l  ON d.LOAN_WID = l.LOAN_WID
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D c ON l.CUSTOMER_WID = c.CUSTOMER_WID
		WHERE 1=1
		AND l.CTR_TYPE = 'Mới'
		AND SOURCE_LEVEL_1_ID =2
		AND SOURCE_LEVEL_2_ID =9
		AND DISBURSE_DATE_WID = P_DATE
		AND NOT EXISTS (
				SELECT 1
				FROM Pre
				WHERE GRP_NM = 'Pre_off'
					AND C.CUSTOMER_CODE = pre.CUSTOMER_CODE
			)
		;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	INSERT INTO F88DWH.W_TNKH_SURVEY_TMP_TEST(CREATED_DT, TRANS_DT, CUSTOMER_CODE, CUSTOMER_NM, LOAN_CODE, LOAN_WID, TEMPLATE_CODE, NHOM_KH)
		--TEMPLATE_POL_ZNS_03, TEMPLATE_POL_ZNS_04
		SELECT
			SYSDATE CREATE_DT,
			COMPLETED_PAID_DATE TRANS_DT,
			c.CUSTOMER_CODE,
			c.CUSTOMER_NM,
			LDT.LOAN_CODE,
			LDT.LOAN_WID,
			'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE,
			CASE
				WHEN CMT.DPD <= 0 AND LS.OVERDUE_DAYS <= 0 THEN 'NNTH' -- KH được nhắc nợ trước hạn: KH được nhắc nợ vào thời điểm DPD<=0 và tại ngày đóng CPV, KH không quá hạn
				WHEN CMT.DPD >= 1 THEN 'NNQH' -- KH được nhắc nợ quá hạn: KH được nhắc nợ vào thời điểm DPD>=1
			    END NHOM_KH
		FROM F88DWH.W_LOAN_SCH_DTL_F LS
		LEFT JOIN F88DWH.W_LOAN_DTL_F LDT
			ON LS.LOAN_WID = LDT.LOAN_WID
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D c
			ON LDT.CUSTOMER_WID = c.CUSTOMER_WID
		LEFT JOIN (SELECT DPD, LOAN_WID FROM F88DWH.VW_W_CMT_CONTRACT_F WHERE SUBSTR(DATE_WID,1,6) = SUBSTR(P_DATE,1,6)) CMT
			ON LS.LOAN_WID = CMT.LOAN_WID --Tương tác nhắc nợ của tháng trả CPV
		WHERE 1=1
			AND CMT.DPD IS NOT NULL --Phân loại nhắc nợ
			AND LS.COMPLETED_PAID_DATE = TO_DATE(P_DATE,'yyyymmdd')
			AND EXTRACT(MONTH FROM LS.TO_DATE) = SUBSTR(P_DATE,5,2) --Trả CPV của tháng này
			AND EXTRACT(YEAR FROM  LS.TO_DATE) = SUBSTR(P_DATE,1,4)
	UNION ALL
		SELECT
			SYSDATE CREATED_DT,
			A.CREATED_DT TRANS_DT,
			c.CUSTOMER_CODE,
			c.CUSTOMER_NM  ,
			A.LOAN_CODE, A.LOAN_WID,
			'TEMPLATE_POL_ZNS_02' TEMPLATE_CODE,
			CASE
				WHEN KHQL.CTR_TYPE = 'Vay lại' THEN 'QLNQ'
				WHEN KHQL.CTR_TYPE = 'Topup' THEN 'QLTU'
				WHEN KHQL.CTR_TYPE = 'Tái tục' THEN 'QLTT'
			END NHOM_KH
		FROM F88DWH.W_LOAN_DTL_F A
		LEFT JOIN F88DWH.W_CTR_TYPE_KHQL KHQL
			ON A.LOAN_WID = KHQL.LOAN_WID_NEW
		LEFT JOIN F88DWH.VW_W_CUSTOMER_D c
			ON A.CUSTOMER_WID = c.CUSTOMER_WID
		WHERE 1=1
			AND A.CTR_TYPE = 'Quay lại' --KHQL
			AND DISBURSE_DATE_WID = P_DATE;
----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

	EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_TNKH_PHONE_SURVEY_TMP_TEST';

	INSERT INTO F88DWH.W_TNKH_PHONE_SURVEY_TMP_TEST(PHONE, LOAN_WID, CODE_RNK)
WITH cus AS (
    SELECT LC.LOAN_WID, LC.LOAN_CODE, LC.CUSTOMER_CODE, LC.INTEGRATION_ID,
           ROW_NUMBER() OVER(PARTITION BY LC.LOAN_WID, LC.LOAN_CODE, LC.CUSTOMER_CODE ORDER BY LC.CREATED_DT DESC) rnk
    FROM F88DWH.VW_W_LOAN_CUSTOMER_F LC
    INNER JOIN F88DWH.W_TNKH_SURVEY_TMP_TEST survey ON survey.LOAN_WID = LC.LOAN_WID
	)
	SELECT CP.PHONE, cus.LOAN_WID
	, ROW_NUMBER() OVER(PARTITION BY SUBSTR(CP.PHONE, -6) ORDER BY cus.LOAN_WID DESC) code_rnk --lọc trùng 6 chữ số cuối trong SĐT của KS ngày hôm nay
	FROM F88DWH.W_LOAN_CUSTOMER_PHONE_F CP
	INNER JOIN cus ON CP.LOAN_CUSTOMER_ID = cus.INTEGRATION_ID
	LEFT JOIN (-- Lọc trùng các KH có 6 số cuối số điện thoại giống nhau trong vòng 3 tháng liên tiếp
	SELECT CODE
	FROM F88DWH.W_CRM_SURVEY_INFO
	WHERE CREATED_DT > ADD_MONTHS(TO_DATE(P_DATE,'yyyymmdd'),-3)
	) CRM ON CRM.CODE =  SUBSTR(CP.PHONE, -6)
	WHERE 1=1
--	AND CP.PHONE NOT IN ( --lọc trùng IVR
--	SELECT PHONE_NUM
--	FROM F88DWH.VW_W_AUTO_CALL_DTL_F
--	WHERE DTMF IN ('0','1')--ANSWERED_TIME > 0
--	  AND DIALED_NUM = 89999999
--	  AND TO_DATE(DATE_WID, 'yyyymmdd') > ADD_MONTHS(TO_DATE(C_DATE, 'yyyymmdd'), -3)
--	)
	AND CP.PHONE NOT IN (--lọc trùng ZNS
	SELECT PHONE_NO
	FROM F88DWH.W_NOTIFY_LOG_DTL_F
	WHERE 1=1
	AND PROJECT_ID IN ('6704a31b83d391104b91005c','66671b31577b427363a3b84f') -- ZNS POL và ZLBH
	AND RESPONSE_CODE = 'Success' --gửi thành công
	AND TO_DATE(DATE_WID,'yyyymmdd') > ADD_MONTHS(TO_DATE(P_DATE,'yyyymmdd'),-3)
	)
--	AND SUBSTR(CP.PHONE, -6) NOT IN (
--	SELECT CODE
--	FROM F88DWH.W_CRM_SURVEY_INFO
--	WHERE CREATED_DT > ADD_MONTHS(TO_DATE(:C_DATE,'yyyymmdd'),-3))
	AND CRM.CODE IS NULL -- Lọc trùng các KH có 6 số cuối số điện thoại giống nhau trong vòng 3 tháng liên tiếp
	AND CP.IS_PRIMARY = 1
	AND CP.STATUS = 1
	AND CP.TYPE = 1
	AND cus.rnk = 1;

----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------

	DELETE FROM  F88DWH.W_CRM_SURVEY_INFO_TEST WHERE TO_CHAR(TRANS_DT, 'yyyymmdd') = P_DATE;

	INSERT INTO F88DWH.W_CRM_SURVEY_INFO_TEST (CREATED_DT,TRANS_DT,CUSTOMER_CODE,CUSTOMER_NM,LOAN_CODE,TEMPLATE_CODE,PHONE,URL,"TIME"
	,NHOM_KH,GENDER_NM,LOAN_PKG_NM,ASSET_TP_NM,TRADE_LEAD,CODE)
	WITH
	dup_temp AS
	(
	SELECT  survey.CREATED_DT, survey.TRANS_DT, survey.CUSTOMER_CODE, survey.CUSTOMER_NM,
	        survey.LOAN_CODE, survey.LOAN_WID, survey.TEMPLATE_CODE,survey.NHOM_KH, CP.PHONE,
	        ROW_NUMBER() OVER(PARTITION BY survey.CUSTOMER_CODE ORDER BY survey.NHOM_KH) AS temp_
	FROM F88DWH.W_TNKH_SURVEY_TMP_TEST survey
	INNER JOIN F88DWH.W_TNKH_PHONE_SURVEY_TMP_TEST CP
		ON SURVEY.LOAN_WID = CP.LOAN_WID
	WHERE CP.CODE_RNK = 1 --CODE duy nhất của khảo sát hôm nay
	)
	, population AS
	(
	SELECT
	dup_temp.CREATED_DT,
	dup_temp.TRANS_DT,
	dup_temp.CUSTOMER_CODE,
	dup_temp.CUSTOMER_NM,
	dup_temp.LOAN_CODE,
	dup_temp.TEMPLATE_CODE
	, dup_temp.PHONE
	,CASE
		WHEN dup_temp.NHOM_KH = 'MM' THEN 'r/KMM2024?KHMM='||dup_temp.LOAN_CODE
		WHEN dup_temp.NHOM_KH = 'NNTH' THEN 'r/NNTH2024?NNTH='||dup_temp.LOAN_CODE
		WHEN dup_temp.NHOM_KH = 'NNQH' THEN 'r/NNQH2024?NNQH='||dup_temp.LOAN_CODE
		WHEN dup_temp.NHOM_KH = 'TT' THEN 'r/KTT2024?KHTT='||dup_temp.LOAN_CODE
		WHEN dup_temp.NHOM_KH IN ('QLNQ','QLTU','QLTT') THEN 'r/QL2024?KHQL='||dup_temp.LOAN_CODE
	END URL
	,'5' AS "TIME"
	,dup_temp.NHOM_KH
	,CD.GENDER_NM
	,LDT.LOAN_PKG_NM
	,AD.ASSET_TP_NM
	,AM.TRADE_LEAD
	,SUBSTR(dup_temp.PHONE, -6) CODE
	,ROW_NUMBER() OVER(PARTITION BY dup_temp.NHOM_KH,AM.TRADE_LEAD  ORDER BY dup_temp.LOAN_CODE) AS sample
	FROM dup_temp
	LEFT JOIN F88DWH.W_LOAN_DTL_F LDT ON LDT.LOAN_WID = dup_temp.LOAN_WID
	LEFT JOIN F88DWH.VW_W_CUSTOMER_D CD ON LDT.CUSTOMER_WID = CD.CUSTOMER_WID
	LEFT JOIN F88DWH.W_ASSET_TP_D AD ON LDT.ASSET_TYPE_WID = AD.ASSET_TP_WID
	LEFT JOIN F88DWH.W_SHOP_D SD ON LDT.SHOP_WID = SD.SHOP_WID
	LEFT JOIN F88DWH.W_AREA_MANAGER_D AM ON SD.SHOP_CODE = AM.SHOP_ID
	WHERE 1=1
	AND dup_temp.NHOM_KH IS NOT NULL
	AND AM.TRADE_LEAD IS NOT NULL
--	AND SD.SHOP_TYPE = 'F88'
--	AND TO_DATE(C_DATE, 'YYYYMMDD') BETWEEN SD.VALID_FM_DT AND SD.VALID_TO_DT
--	AND AM.TRADE_LEAD IN ('Hồ Chí Minh 2')
--	AND AM.FLAG = 'Active'
	AND temp_ = 1
	)
	SELECT CREATED_DT,TRANS_DT,CUSTOMER_CODE,CUSTOMER_NM,LOAN_CODE,TEMPLATE_CODE,PHONE,URL,"TIME"
	,NHOM_KH,GENDER_NM,LOAN_PKG_NM,ASSET_TP_NM,TRADE_LEAD,CODE
 	FROM population WHERE sample < 31; --lấy 20 mẫu cho 1 nhóm trong 1 ngày


---------------------------------------------------------------------------------------------------------------------------------
--EXECUTE IMMEDIATE 'TRUNCATE TABLE TRANH2.W_TNKH_PHONE_SURVEY_TMP';
--EXECUTE IMMEDIATE 'TRUNCATE TABLE TRANH2.W_TNKH_SURVEY_TMP';

	dbms_output.put_line('----> DONE INSERT SUCCESS W_CRM_SURVEY_INFO_TEST AT:'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

	COMMIT;

END PROC_CRM_SURVEY_INFO_TEST;
```

### `F88DWH.PROC_LOAN_COLLECTION_RISK_T` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE proc_loan_collection_risk_t (P_DATE IN NUMBER)
IS
/*
  -- Author  : NAMDH4
  -- Created : 08/01/2026
  -- Purpose : check data collection
*/
    v_max_yymm NUMBER;
BEGIN
    -- Get current max yymm
    SELECT MAX(YYMM)
    INTO v_max_yymm
    FROM F88DWH.W_QTRR_RISK_LOAN_COLLECTION_T;

    -- If P_DATE >= current max YYMM, delete existing data for that YYMM and YYMM_DISBUR, else delete only for YYMM = P_DATE
    DELETE FROM F88DWH.W_QTRR_RISK_LOAN_COLLECTION_T
    WHERE YYMM = SUBSTR(P_DATE,1,6)
       OR (
        (v_max_yymm IS NULL OR SUBSTR(P_DATE,1,6) >= v_max_yymm)
        AND YYMM_DISBUR = SUBSTR(P_DATE,1,6)
      );


    INSERT INTO F88DWH.W_QTRR_RISK_LOAN_COLLECTION_T
    WITH d AS
    (
                select
                    CAL.YEAR_NUM,
                    CAL.MONTH_NUM,
                    D.DATE_WID,
                    cal.date_tm,
                    d.status loan_status,
                    CASE
                        WHEN IS_BAD_DEBT = 1 AND d.STATUS = 300 THEN 'WO'
                        WHEN d.STATUS IN (77,88,99) THEN 'WO'
                        WHEN d.STATUS = 603 THEN 'Liquidation'
                        ELSE 'A' END AS STATUS_SOM,
                    Substr(TO_NUMBER(TO_CHAR(DATE_TM +1,'YYYYMMDD')),1,6) as YYMM,
                    --SUBSTR(CAL.DATE_WID,1,6) YYMM ,
                    EXTRACT( YEAR FROM DATE_TM +1) YEAR_NUM_N ,
                    EXTRACT( MONTH FROM DATE_TM +1) MONTH_NUM_N,
                    CAL.DATE_TM - D.OVERDUE_DAYS SCH_DT,
                    to_number(to_char(d.dpd_from_date,'yyyymm')) dpd_from_date,
                    LOAN_WID,
                    LOAN_CODE,
                    OVERDUE_DAYS DPD_SOM,
                    IS_BAD_DEBT,
                    term_frequency ,
                    --LAG(OVERDUE_DAYS) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) DPD_SOM,
                    LEAD(OVERDUE_DAYS) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) DPD_EOM,
                    principal_remain BAL_SOM,
                    --LAG(principal_remain) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) BAL_SOM
                    LEAD(principal_remain) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) BAL_EOM
                FROM
                    F88DWH.W_LOAN_DAILY_F d
                INNER JOIN F88DWH.W_CALENDAR_D CAL
                    ON CAL.DATE_WID = D.DATE_WID
                    AND CAL.YEAR_NUM = D.YEAR_NUM
                    AND CAL.MONTH_NUM = D.MONTH_NUM
                INNER JOIN F88DWH.W_ASSET_TP_D ATP
                    ON ATP.ASSET_TP_WID = D.ASSET_TYPE_WID
                WHERE 1=1
                    AND CAL.LAST_DOM_FLAG = 1
                    AND ATP.CATEGORY_CODE  IN ('15','17','02')
                    AND CAL.YEAR_NUM >= 2022
                    AND
                        (
                        (cal.year_num = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE ,'YYYYMMDD'),-1),'YYYY'))
                        AND cal.date_wid = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE,'YYYYMMDD'),-1),'YYYYMMDD')))
                        OR
                        (cal.year_num = TO_NUMBER(SUBSTR(P_DATE,1,4))
                        AND cal.date_wid = P_DATE
                        )
                        )
                    AND cal.date_wid >= 20221231
                    AND d.reversed_date IS NULL
    --				AND d.loan_wid = 17602419 --- ndh
    )
    ,  mgl AS (
            select
                loan_code,
                to_number(SUBSTR(trans.trans_date_wid,1,4)) trans_yyyy,
                to_number(SUBSTR(trans.trans_date_wid,5,2)) trans_mm,
                SUM(abs(trans.trans_amt)) mgl_amt
            from f88dwh.w_loan_trans_dtl_f trans
            where
            trans.action_code in ('133','134','213','227','210','226','135','212','228'
                                    ,'MIEN_GIAM_PHI','MIEN_GIAM_GOC','MIEN_GIAM_PHAT','MIEN_GIAM_CPV'
                                    ,'MIEN_GIAM_CPV_THU_THEM','MIEN_GIAM_DONG_HD','MIEN_GIAM','322','321','323', 'UNDO_MIEN_GIAM' )
            and trans.deactive_flag != 1
            and trans.trans_date_wid >= 20240101 --between 20240901 and 20240930
    --		AND LOAN_CODE = '20640411515'  --ndh
            group by loan_code, to_number(SUBSTR(trans.trans_date_wid,1,4)), to_number(SUBSTR(trans.trans_date_wid,5,2))
    )
    , emi_hdcc AS (
                    SELECT
                    l.contract_code,
                    l.loan_wid,
                    SUM	(
                    round(
                    CASE WHEN l.ORIGIN_PAYMENT_METHOD_WID = 100000
                    THEN
                        (l.disburse_amt * (l.interest_rate/100) * POWER(1 + l.interest_rate/100,l.TERM_FREQUENCY)) /
                        (POWER(1 + l.interest_rate/100, l.TERM_FREQUENCY) - 1) +
                         nvl(l.CIMB_FEE_A_N_INTEREST_RATE,0)/100/12 * l.disburse_amt
                    ELSE (l.disburse_amt * (l.interest_rate/100) + nvl(l.CIMB_FEE_A_N_INTEREST_RATE,0)/100/12 * l.disburse_amt) end
                    ,0 )) AS emi_hdcc
                FROM F88DWH.W_LOAN_DTL_F l
                LEFT JOIN F88DWH.W_LOAN_DTL_F prev ON prev.contract_code = l.contract_code
                AND nvl(prev.closed_date_wid,100000000) > l.disburse_date_wid  -- các dòng trước đó,  1tr de treatment nhung hd chua closed
                AND prev.disburse_date_wid <= l.disburse_date_wid
                WHERE l.contract_code IN
                (SELECT DISTINCT contract_code FROM F88DWH.W_LOAN_DTL_F
                WHERE Channel_code= 'Online') -- gnn co hdcc topup
                     AND l.disburse_date_wid >= 20240402
                GROUP BY  l.contract_code,l.loan_wid
    )
    , recovery AS (
                    SELECT
                        YEAR_NUM
                        , MONTH_NUM
                        , SUBSTR(DATE_WID,1,6) RECOVERY_YYMM
                        , CODE_NO
                        , SUM (AMOUNT) AS RECOVERY
                from f88dwh.w_document_transaction
                where 1=1
            AND	(TRANSACTION_TYPE_ENUM in
            ('REPAYMENT', 'RECOVERY_LIQUIDATION', 'REVERT_LIQUIDATION')  and (CODE_MASTER_DATA like '%NX%' or CODE_MASTER_DATA like '%WO%')
                    or (TRANSACTION_TYPE_ENUM is null and CODE_MASTER_DATA in ('133', '134', '136', '140', '210','211','227', '228')
                and nvl(is_bad_debt,0) = 1))
                and CODE_MASTER_DATA not in ('BAN_THANH_LY_HDNX_CIMB_F88', 'TRA_HANG_THANH_LY_HDNX_CIMB_F88')
                AND year_num >= 2022
                AND DATE_WID >= 20220601
                AND REVERSED_DATE IS NULL
               GROUP BY
                        YEAR_NUM
                        , MONTH_NUM
                        , SUBSTR(DATE_WID,1,6)
                        , CODE_NO
    )
    , TEMP_DATA AS (
    select
            l.loan_wid,
            L.LOAN_CODE,
            l.contract_code HDCC,
            l.customer_code,
            substr(l.disburse_date_wid,1,6) as YYMM_Disbur,
            to_date(l.disburse_date_wid,'YYYYMMDD') disburse_date,
            to_date(l.closed_date_wid,'YYYYMMDD') closed_date_log,
            MONTHS_BETWEEN(to_date(l.closed_date_wid,'YYYYMMDD'),to_date(l.disburse_date_wid,'YYYYMMDD')) mth_log, --thangtattoan
    --		CASE WHEN d.YYMM IS NULL THEN substr(l.disburse_date_wid,1,6) ELSE d.yymm END yymm,
            NVL(d.YYMM, SUBSTR(l.disburse_date_wid,1,6)) yymm,
            SUBSTR(l.WRITEOFF_DATE_WID,1,6) WO_YYMM_log,
            r.RECOVERY_YYMM,
            r.RECOVERY RECOVERY_AMT,
            CASE WHEN YYMM = SUBSTR(l.WRITEOFF_DATE_WID,1,6) THEN BAL_SOM ELSE 0 END WO_AMT,
            d.is_bad_debt,
            l.disburse_amt,
            l.COLLATERAL_AMT,
            L.INSURANCE_AMT baohiem,
            l.MAX_LENDABLE_AMT,
            mt.pricemax,
            round((L.DISBURSE_AMT - L.INSURANCE_AMT) / L.COLLATERAL_AMT,3) LTV,
            l.NUMBER_of_extend,
            a.ASSET_TP_NM AS asset_type,
            UPPER(ass.LOAN_ASSET_NM) TEN_TS,
            ass.REGISTRATION_DT NGAY_DKX,
            d.loan_status,
            STATUS_SOM,
            f.LOAN_FUND_NAME AS FUND_NAME,
            l.channel_code,
            l.term_frequency tenor_hd,
            l.LOAN_PKG_NM,
            CASE WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100000 THEN 'GocHangKy'
                WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100001 THEN 'GocGocKy' ELSE 'other' end PAYMENT_METHOD,
            CASE WHEN wndf.CTR_TYPE = 'Mới' THEN wndf.CTR_TYPE ELSE 'Cũ' END KH_MOICU,
            wndf.CTR_TYPE AS CTR_TYPE,
            l.ctr_type ctr_type_dtl,
            l.shop_wid ,
            SHOP.shop_nm ,
            manager.province,
            manager.Trade_lead as Area,
            --score
             CASE WHEN wndf.ctr_type = 'Mới' THEN  sco.RANK  ELSE NULL END as a_score,
             sco.SCORE_INTERNAL AS INTERNAL_SCORE,
             final_cus_rank as b_score_gn,
            D.BAL_SOM,
            D.BAL_EOM,
            DPD_EOM,
            DPD_SOM,
            case
                 when DPD_EOM IS null then NULL
                 when DPD_EOM < 1 then 0
                 when DPD_EOM < 31 then 1
                 when DPD_EOM < 61 then 2
                 when DPD_EOM < 91 then 3
                 else 4 end dpd_EOM_grp ,
            case
                 when DPD_SOM IS null then null
                 when DPD_SOM < 1 then 0
                 when DPD_SOM < 31 then 1
                 when DPD_SOM < 61 then 2
                 when DPD_SOM < 91 then 3
                 else 4 --B4+
                 end  DPD_SOM_GRP,
            ls.schedule_num,
            to_number(to_char(d.SCH_DT,'yyyymmdd')) sch_dt,
            CASE WHEN LS.COMPLETED_PAID_DATE <= d.sch_dt THEN to_number(TO_CHAR(d.sch_dt,'yyyymmdd'))
            WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') THEN to_number(to_char(LS.COMPLETED_PAID_DATE,'yyyymmdd'))
            ELSE NULL END PAID_DATE,
            ----
            CASE WHEN d.dpd_from_date = d.yymm THEN 1 ELSE 0 END FLAG_DENHAN_B0,
            CASE
                 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS < 0 THEN 'TẤT TOÁN HĐ TRƯỚC HẠN'
                 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 AND D.SCH_DT > TO_DATE(P_DATE,'YYYYMMDD') THEN 'CHƯA CẦN THU'  --CURRENT_DATE  --P_DATE ndh
                 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 THEN 'THU ĐÚNG HẠN'
                 WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') AND LS.OVERDUE_DAYS > 0 THEN 'THU QUÁ HẠN'
                 WHEN D.SCH_DT > TO_DATE(P_DATE,'YYYYMMDD') THEN 'CHƯA CẦN THU'  --P_DATE ndh 20251130
                 WHEN LS.LOAN_WID IS NULL THEN NULL
                 ELSE 'CHƯA THU ĐƯỢC'
            END COLLECTION_STATUS ,
            ---khach hang
            CUS.GENDER_NM GIOI_TINH,
            CASE
                WHEN cus.birth_day IS NULL THEN NULL
                ELSE TO_NUMBER(SUBSTR(TO_CHAR(l.disburse_date_wid),1,4)) - TO_NUMBER(cus.birth_day)
            END AS CUSTOMER_AGE,
            lc.LOAI_HINH_CU_TRU ,
            lc.DISTANCE AS DISTANCE,
            lc.RESIDENCE_TIME,
            house.HOUSE_STATUS_NM TINHTRANG_NOIO,
            LC.INDUSTRY_NM,
            lc.JOB_NM,
            lc.JOB_DETAIL,
            lc.NUMBER_OF_CHILD NgPhuThuoc,
            g.GRP_NM Marital_status,
            LC.MONTHLY_INCOME_VALUE INCOME,
            customer_income,
            INCOME_FINAL,
            CASE when cus.customer_income = '01' then '1.<5tr'
                when cus.customer_income = '02' then '2.5->8tr'
                when cus.customer_income = '03' then '3.8->10tr'
                when cus.customer_income = '04' THEN '4.10->15tr'
                when cus.customer_income = '05' THEN '5.15->25tr'
                when cus.customer_income = '06' then '6.25->45tr'
                when cus.customer_income = '07' then '7.>45tr'
                ELSE cus.customer_income END INCOME_GRP,
            round(
            CASE WHEN l.ORIGIN_PAYMENT_METHOD_WID = 100000
            THEN
                (l.disburse_amt * (l.interest_rate / 100) * POWER(1 + l.interest_rate / 100, l.TERM_FREQUENCY)) /
                    (POWER(1 + l.interest_rate / 100, l.TERM_FREQUENCY) - 1) + nvl(l.CIMB_FEE_A_N_INTEREST_RATE, 0)/ 100 / 12 * l.disburse_amt
                ELSE
                    (l.disburse_amt * (l.interest_rate / 100) + nvl(l.CIMB_FEE_A_N_INTEREST_RATE, 0)/ 100 / 12 * l.disburse_amt) END, 0 ) AS emi,
            --emi_hdcc
            emi_hdcc.emi_hdcc,
            ---NGUON DON
            pol.channel_code POL_CHANNEL_CODE,
            POL.SOURCE_LEVEL_1_NAME ,
            POL.SOURCE_LEVEL_2_NAME ,
            POL.SOURCE_LEVEL_3_NAME ,
            POL.SOURCE_LEVEL_4_NAME ,
            --mgl
            mgl.mgl_amt,
            ----segment
            CASE
            WHEN upper(l.LOAN_PKG_NM) LIKE '%LAODONG%'
            OR lc.JOB_NM = 'Lao động tự do' THEN
            CASE
            WHEN (UPPER(CUS.GENDER_NM) = 'NỮ'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 42)
            OR (UPPER(CUS.GENDER_NM) = 'NỮ'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 30
            AND UPPER(g.GRP_NM) = 'ĐÃ KẾT HÔN')
            OR (UPPER(CUS.GENDER_NM) = 'NAM'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 42
            AND UPPER(g.GRP_NM) = 'ĐÃ KẾT HÔN') THEN 'GOOD'
            ELSE 'BAD'
        END
        WHEN upper(l.LOAN_PKG_NM) LIKE '%CONGNHAN%'
        OR lc.JOB_NM = 'Công nhân'
        OR lc.JOB_NM LIKE '%Công nhân%' THEN
        CASE
            WHEN (UPPER(CUS.GENDER_NM) = 'NỮ'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 23)
            OR (UPPER(CUS.GENDER_NM) = 'NAM'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 38
            AND UPPER(g.GRP_NM) = 'ĐÃ KẾT HÔN') THEN 'GOOD'
            ELSE 'BAD'
            END
            WHEN upper(l.LOAN_PKG_NM) LIKE '%VP%'
            OR lc.JOB_NM = 'Viên chức văn phòng'
            OR lc.JOB_NM = 'Nhân viên văn phòng' THEN
        CASE
                WHEN (UPPER(CUS.GENDER_NM) = 'NỮ')
                OR (UPPER(CUS.GENDER_NM) = 'NAM'
                AND substr(L.DISBURSE_DATE_WID,
                1,
                4) - CUS.BIRTH_DAY >= 33) THEN 'GOOD'
                ELSE 'BAD'
            END
        END AS REPAYMENT_STATUS,
        CASE
            WHEN a.CATEGORY_CODE = '17' THEN
        CASE
            WHEN upper(l.LOAN_PKG_NM) LIKE '%LAODONG%'
            OR lc.JOB_NM = 'Lao động tự do' THEN
        CASE
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%KINH DOANH%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%DỊCH VỤ%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NHÀ HÀNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%THƯƠNG MẠI%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%GIẢI TRÍ%' THEN 'LDTD-KD'
                ELSE 'LDTD-CVN'
            END
            WHEN upper(l.LOAN_PKG_NM) LIKE '%CONGNHAN%'
            OR lc.JOB_NM = 'Công nhân'
            OR lc.JOB_NM LIKE '%Công nhân%' THEN
        CASE
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%ĐÀO TẠO%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NGHỆ THUẬT%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NHÀ HÀNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%Y TẾ%' THEN 'CN-YT'
                ELSE 'CN'
            END
            WHEN upper(l.LOAN_PKG_NM) LIKE '%VP%'
            OR lc.JOB_NM = 'Viên chức văn phòng'
            OR lc.JOB_NM = 'Nhân viên văn phòng' THEN
        CASE
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%Y TẾ%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%VIỄN THÔNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NHÀ NƯỚC%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%ĐIỆN NƯỚC%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%CÔNG CỘNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%ĐÀO TẠO%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NGHỆ THUẬT%' THEN 'VP-ASXH'
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%XÂY DỰNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%TÀI CHÍNH%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%DU LỊCH%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%KHOA HỌC%' THEN 'VP-TDC'
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%VẬN TẢI%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%SỬA CHỮA%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%THỦY SẢN%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%CÔNG NGHIỆP%' THEN 'VP-PT'
            END
        END
        END AS SEGMENT
    FROM F88DWH.w_loan_dtl_f l
        LEFT JOIN F88DWH.W_POL_DTL_F POL ON POL.LOAN_WID = L.LOAN_WID AND pol.STATUS_NM= 'Nhận cầm cố' and  pol.year_num >= 2024 --and pol.date_wid >= 20231001 --nguon don
        LEFT JOIN F88DWH.W_NET_DISBURSE_F wndf ON l.LOAN_WID = wndf.LOAN_WID
        LEFT JOIN F88DWH.W_LOAN_FUND_D f ON l.FUND_ID = f.INTEGRATION_ID AND f.CRN_ROW_IND = 1
        LEFT join d on d.loan_wid = l.loan_wid
        LEFT JOIN F88DWH.W_LOAN_SCH_DTL_F LS ON d.LOAN_WID = LS.LOAN_WID  AND D.SCH_DT = LS.TO_DATE
        LEFT JOIN f88dwh.VW_W_LOAN_MASTER_F mt ON mt.loan_wid = l.loan_wid
        left join F88DWH.VW_W_CUSTOMER_D cus on cus.customer_wid = l.customer_wid AND cus."SOURCE" = 'CIF'
        LEFT JOIN
            ( --loai duplicate
            SELECT b.*,
            ROW_NUMBER() OVER(PARTITION BY LOAN_WID ORDER BY SOURCE, INTEGRATION_ID DESC ) rn
            FROM  F88DWH.VW_W_LOAN_CUSTOMER_F b
            ) lc ON l.LOAN_WID = lc.LOAN_WID AND RN=1
        LEFT JOIN F88DWH.W_HOUSE_STATUS_D house ON house.HOUSE_STATUS_WID = lc.HOUSE_STATUS_WID
        LEFT JOIN F88DWH.GRP g ON G.GRP_ID = lc.MARITAL_ID
        LEFT JOIN f88dwh.W_ASSET_TP_D a ON a.ASSET_TP_WID = l.ASSET_TYPE_WID
        LEFT JOIN F88DWH.W_LOAN_ASSET_F ass ON ass.LOAN_WID = l.LOAN_WID
        left join f88dwh.w_shop_d shop on shop.shop_wid = l.shop_wid
        left join f88dwh.w_area_manager_d manager on shop.shop_code = trim(manager.shop_id)
        left join f88dwh.w_loan_score_f sco on sco.loan_wid = l.loan_wid
        LEFT JOIN recovery r ON r.code_no = l.loan_code
                            AND r.YEAR_NUM = d.YEAR_NUM_n
                            AND r.MONTH_NUM = d.MONTH_NUM_n
                            AND r.RECOVERY > 0
    --	LEFT JOIN SCH ON SCH.LOAN_WID = L.LOAN_WID -- tạm thời bỏ
        LEFT JOIN mgl ON mgl.loan_code = d.loan_code
                      AND MGL.trans_yyyy = d.YEAR_NUM_N
                      AND MGL.trans_mm = d.MONTH_NUM_N
                      AND NVL(d.dpd_eom,0) < 91
                      AND d.year_num_n >= 2023
        LEFT JOIN emi_hdcc ON emi_hdcc.loan_wid = l.loan_wid
    WHERE
            a.CATEGORY_CODE in ('15','17','02')
            and l.disburse_date_wid >  20220531
            AND l.disburse_date_wid <=  P_DATE
            AND l.CREATED_USER NOT LIKE '%test%'
            AND NVL(L.COLLATERAL_AMT,0) > 0
    --		AND l.loan_code = '20640411515' --ndh
    )
    SELECT
        a.*
        , CASE
            WHEN A.SEGMENT = 'VP-ASXH' THEN
                CASE WHEN (A.REPAYMENT_STATUS = 'GOOD' OR (A.REPAYMENT_STATUS = 'BAD' AND A.INCOME >= 10000000)) THEN 'VP-ASXH-1' ELSE 'VP-ASXH-2' END
            WHEN A.SEGMENT = 'VP-TDC' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' AND A.INCOME >= 5000000 THEN 'VP-TDC-1' ELSE 'VP-TDC-2' END
            WHEN A.SEGMENT = 'VP-PT' THEN
                CASE WHEN A.REPAYMENT_STATUS ='GOOD' AND A.INCOME >= 10000000 THEN 'VP-PT-1' ELSE 'VP-PT-2' END
            WHEN A.SEGMENT = 'CN-YT' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' OR (A.REPAYMENT_STATUS = 'BAD' AND A.INCOME >= 15000000) THEN 'CN-YT-1' ELSE 'CN-YT-2' END
            WHEN A.SEGMENT = 'CN' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' THEN 'CN-1' ELSE 'CN-2' END
            WHEN A.SEGMENT = 'LDTD-KD' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' OR (A.REPAYMENT_STATUS = 'BAD' AND A.INCOME >= 15000000) THEN 'LDTD-KD-1' ELSE 'LDTD-KD-2' END
            WHEN A.SEGMENT = 'LDTD-CVN' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' THEN 'LDTD-CVN-1' ELSE 'LDTD-CVN-2' END
        END AS SEGMENT_PROFILE
    FROM TEMP_DATA A
    WHERE yymm = SUBSTR(P_DATE,1,6)
       OR (
        (v_max_yymm IS NULL OR SUBSTR(P_DATE,1,6) >= v_max_yymm)
        AND YYMM_DISBUR = SUBSTR(P_DATE,1,6)
      );


    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END proc_loan_collection_risk_t;
```

### `F88DWH.PROC_QTRR_LOAN_COLLECTION_RISK` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE proc_qtrr_loan_collection_risk (P_DATE IN NUMBER)
IS
/*
  -- Author  : NAMDH4
  -- Created : 08/01/2026
  -- Purpose : check data collection
*/
    v_max_yymm NUMBER;
    v_last_month_date DATE;
BEGIN
--     Auto get last month yymm from P_DATE
    v_last_month_date := LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD'));
    -- Get current max yymm
    SELECT MAX(YYMM)
    INTO v_max_yymm
    FROM F88DWH.W_QTRR_RISK_LOAN_COLLECTION;

    -- If v_last_month_date >= current max YYMM, delete existing data for that YYMM and YYMM_DISBUR, else delete only for YYMM = v_last_month_date
    DELETE FROM F88DWH.W_QTRR_RISK_LOAN_COLLECTION
    WHERE YYMM = TO_NUMBER(TO_CHAR(v_last_month_date, 'YYYYMM'))
       OR (
        (v_max_yymm IS NULL OR TO_NUMBER(TO_CHAR(v_last_month_date, 'YYYYMM')) >= v_max_yymm)
        AND YYMM_DISBUR = TO_NUMBER(TO_CHAR(v_last_month_date, 'YYYYMM'))
      );


    INSERT INTO F88DWH.W_QTRR_RISK_LOAN_COLLECTION
    WITH d AS
    (
                select
                    CAL.YEAR_NUM,
                    CAL.MONTH_NUM,
                    D.DATE_WID,
                    cal.date_tm,
                    d.status loan_status,
                    CASE
                        WHEN IS_BAD_DEBT = 1 AND d.STATUS = 300 THEN 'WO'
                        WHEN d.STATUS IN (77,88,99) THEN 'WO'
                        WHEN d.STATUS = 603 THEN 'Liquidation'
                        ELSE 'A' END AS STATUS_SOM,
                    Substr(TO_NUMBER(TO_CHAR(DATE_TM +1,'YYYYMMDD')),1,6) as YYMM,
                    --SUBSTR(CAL.DATE_WID,1,6) YYMM ,
                    EXTRACT( YEAR FROM DATE_TM +1) YEAR_NUM_N ,
                    EXTRACT( MONTH FROM DATE_TM +1) MONTH_NUM_N,
                    CAL.DATE_TM - D.OVERDUE_DAYS SCH_DT,
                    to_number(to_char(d.dpd_from_date,'yyyymm')) dpd_from_date,
                    LOAN_WID,
                    LOAN_CODE,
                    OVERDUE_DAYS DPD_SOM,
                    IS_BAD_DEBT,
                    term_frequency ,
                    --LAG(OVERDUE_DAYS) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) DPD_SOM,
                    LEAD(OVERDUE_DAYS) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) DPD_EOM,
                    principal_remain BAL_SOM,
                    --LAG(principal_remain) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) BAL_SOM
                    LEAD(principal_remain) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) BAL_EOM
                FROM
                    F88DWH.W_LOAN_DAILY_F d
                INNER JOIN F88DWH.W_CALENDAR_D CAL
                    ON CAL.DATE_WID = D.DATE_WID
                    AND CAL.YEAR_NUM = D.YEAR_NUM
                    AND CAL.MONTH_NUM = D.MONTH_NUM
                INNER JOIN F88DWH.W_ASSET_TP_D ATP
                    ON ATP.ASSET_TP_WID = D.ASSET_TYPE_WID
                WHERE 1=1
                    AND CAL.LAST_DOM_FLAG = 1
                    AND ATP.CATEGORY_CODE  IN ('15','17','02')
                    AND CAL.YEAR_NUM >= 2022
                    AND
                        (
                        (cal.year_num = EXTRACT(YEAR FROM ADD_MONTHS(v_last_month_date,-1))
                        AND cal.date_wid = TO_NUMBER(TO_CHAR(ADD_MONTHS(v_last_month_date,-1),'YYYYMMDD')))
                        OR
                        (cal.year_num = EXTRACT(YEAR FROM v_last_month_date)
                        AND cal.date_wid = TO_NUMBER(TO_CHAR(v_last_month_date,'YYYYMMDD'))
                        )
                        )
                    AND cal.date_wid >= 20221231
                    AND d.reversed_date IS NULL
    --				AND d.loan_wid = 17602419 --- ndh
    )
    ,  mgl AS (
            select
                loan_code,
                to_number(SUBSTR(trans.trans_date_wid,1,4)) trans_yyyy,
                to_number(SUBSTR(trans.trans_date_wid,5,2)) trans_mm,
                SUM(abs(trans.trans_amt)) mgl_amt
            from f88dwh.w_loan_trans_dtl_f trans
            where
            trans.action_code in ('133','134','213','227','210','226','135','212','228'
                                    ,'MIEN_GIAM_PHI','MIEN_GIAM_GOC','MIEN_GIAM_PHAT','MIEN_GIAM_CPV'
                                    ,'MIEN_GIAM_CPV_THU_THEM','MIEN_GIAM_DONG_HD','MIEN_GIAM','322','321','323', 'UNDO_MIEN_GIAM' )
            and trans.deactive_flag != 1
            and trans.trans_date_wid >= 20240101 --between 20240901 and 20240930
    --		AND LOAN_CODE = '20640411515'  --ndh
            group by loan_code, to_number(SUBSTR(trans.trans_date_wid,1,4)), to_number(SUBSTR(trans.trans_date_wid,5,2))
    )
    , emi_hdcc AS (
                    SELECT
                    l.contract_code,
                    l.loan_wid,
                    SUM	(
                    round(
                    CASE WHEN l.ORIGIN_PAYMENT_METHOD_WID = 100000
                    THEN
                        (l.disburse_amt * (l.interest_rate/100) * POWER(1 + l.interest_rate/100,l.TERM_FREQUENCY)) /
                        (POWER(1 + l.interest_rate/100, l.TERM_FREQUENCY) - 1) +
                         nvl(l.CIMB_FEE_A_N_INTEREST_RATE,0)/100/12 * l.disburse_amt
                    ELSE (l.disburse_amt * (l.interest_rate/100) + nvl(l.CIMB_FEE_A_N_INTEREST_RATE,0)/100/12 * l.disburse_amt) end
                    ,0 )) AS emi_hdcc
                FROM F88DWH.W_LOAN_DTL_F l
                LEFT JOIN F88DWH.W_LOAN_DTL_F prev ON prev.contract_code = l.contract_code
                AND nvl(prev.closed_date_wid,100000000) > l.disburse_date_wid  -- các dòng trước đó,  1tr de treatment nhung hd chua closed
                AND prev.disburse_date_wid <= l.disburse_date_wid
                WHERE l.contract_code IN
                (SELECT DISTINCT contract_code FROM F88DWH.W_LOAN_DTL_F
                WHERE Channel_code= 'Online') -- gnn co hdcc topup
                     AND l.disburse_date_wid >= 20240402
                GROUP BY  l.contract_code,l.loan_wid
    )
    , recovery AS (
                    SELECT
                        YEAR_NUM
                        , MONTH_NUM
                        , SUBSTR(DATE_WID,1,6) RECOVERY_YYMM
                        , CODE_NO
                        , SUM (AMOUNT) AS RECOVERY
                from f88dwh.w_document_transaction
                where 1=1
            AND	(TRANSACTION_TYPE_ENUM in
            ('REPAYMENT', 'RECOVERY_LIQUIDATION', 'REVERT_LIQUIDATION')  and (CODE_MASTER_DATA like '%NX%' or CODE_MASTER_DATA like '%WO%')
                    or (TRANSACTION_TYPE_ENUM is null and CODE_MASTER_DATA in ('133', '134', '136', '140', '210','211','227', '228')
                and nvl(is_bad_debt,0) = 1))
                and CODE_MASTER_DATA not in ('BAN_THANH_LY_HDNX_CIMB_F88', 'TRA_HANG_THANH_LY_HDNX_CIMB_F88')
                AND year_num >= 2022
                AND DATE_WID >= 20220601
                AND REVERSED_DATE IS NULL
               GROUP BY
                        YEAR_NUM
                        , MONTH_NUM
                        , SUBSTR(DATE_WID,1,6)
                        , CODE_NO
    )
    , TEMP_DATA AS (
    select
            l.loan_wid,
            L.LOAN_CODE,
            l.contract_code HDCC,
            l.customer_code,
            substr(l.disburse_date_wid,1,6) as YYMM_Disbur,
            to_date(l.disburse_date_wid,'YYYYMMDD') disburse_date,
            to_date(l.closed_date_wid,'YYYYMMDD') closed_date_log,
            MONTHS_BETWEEN(to_date(l.closed_date_wid,'YYYYMMDD'),to_date(l.disburse_date_wid,'YYYYMMDD')) mth_log, --thangtattoan
    --		CASE WHEN d.YYMM IS NULL THEN substr(l.disburse_date_wid,1,6) ELSE d.yymm END yymm,
            NVL(d.YYMM, SUBSTR(l.disburse_date_wid,1,6)) yymm,
            SUBSTR(l.WRITEOFF_DATE_WID,1,6) WO_YYMM_log,
            r.RECOVERY_YYMM,
            r.RECOVERY RECOVERY_AMT,
            CASE WHEN YYMM = SUBSTR(l.WRITEOFF_DATE_WID,1,6) THEN BAL_SOM ELSE 0 END WO_AMT,
            d.is_bad_debt,
            l.disburse_amt,
            l.COLLATERAL_AMT,
            L.INSURANCE_AMT baohiem,
            l.MAX_LENDABLE_AMT,
            mt.pricemax,
            round((L.DISBURSE_AMT - L.INSURANCE_AMT) / L.COLLATERAL_AMT,3) LTV,
            l.NUMBER_of_extend,
            a.ASSET_TP_NM AS asset_type,
            UPPER(ass.LOAN_ASSET_NM) TEN_TS,
            ass.REGISTRATION_DT NGAY_DKX,
            d.loan_status,
            STATUS_SOM,
            f.LOAN_FUND_NAME AS FUND_NAME,
            l.channel_code,
            l.term_frequency tenor_hd,
            l.LOAN_PKG_NM,
            CASE WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100000 THEN 'GocHangKy'
                WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100001 THEN 'GocGocKy' ELSE 'other' end PAYMENT_METHOD,
            CASE WHEN wndf.CTR_TYPE = 'Mới' THEN wndf.CTR_TYPE ELSE 'Cũ' END KH_MOICU,
            wndf.CTR_TYPE AS CTR_TYPE,
            l.ctr_type ctr_type_dtl,
            l.shop_wid ,
            SHOP.shop_nm ,
            manager.province,
            manager.Trade_lead as Area,
            --score
             CASE WHEN wndf.ctr_type = 'Mới' THEN  sco.RANK  ELSE NULL END as a_score,
             sco.SCORE_INTERNAL AS INTERNAL_SCORE,
             final_cus_rank as b_score_gn,
            D.BAL_SOM,
            D.BAL_EOM,
            DPD_EOM,
            DPD_SOM,
            case
                 when DPD_EOM IS null then NULL
                 when DPD_EOM < 1 then 0
                 when DPD_EOM < 31 then 1
                 when DPD_EOM < 61 then 2
                 when DPD_EOM < 91 then 3
                 else 4 end dpd_EOM_grp ,
            case
                 when DPD_SOM IS null then null
                 when DPD_SOM < 1 then 0
                 when DPD_SOM < 31 then 1
                 when DPD_SOM < 61 then 2
                 when DPD_SOM < 91 then 3
                 else 4 --B4+
                 end  DPD_SOM_GRP,
            ls.schedule_num,
            to_number(to_char(d.SCH_DT,'yyyymmdd')) sch_dt,
            CASE WHEN LS.COMPLETED_PAID_DATE <= d.sch_dt THEN to_number(TO_CHAR(d.sch_dt,'yyyymmdd'))
            WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') THEN to_number(to_char(LS.COMPLETED_PAID_DATE,'yyyymmdd'))
            ELSE NULL END PAID_DATE,
            ----
            CASE WHEN d.dpd_from_date = d.yymm THEN 1 ELSE 0 END FLAG_DENHAN_B0,
            CASE
                 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS < 0 THEN 'TẤT TOÁN HĐ TRƯỚC HẠN'
                 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 AND D.SCH_DT > v_last_month_date THEN 'CHƯA CẦN THU'  --CURRENT_DATE  --P_DATE ndh
                 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 THEN 'THU ĐÚNG HẠN'
                 WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') AND LS.OVERDUE_DAYS > 0 THEN 'THU QUÁ HẠN'
                 WHEN D.SCH_DT > v_last_month_date THEN 'CHƯA CẦN THU'  --P_DATE ndh 20251130
                 WHEN LS.LOAN_WID IS NULL THEN NULL
                 ELSE 'CHƯA THU ĐƯỢC'
            END COLLECTION_STATUS ,
            ---khach hang
            CUS.GENDER_NM GIOI_TINH,
            CASE
                WHEN cus.birth_day IS NULL THEN NULL
                ELSE TO_NUMBER(SUBSTR(TO_CHAR(l.disburse_date_wid),1,4)) - TO_NUMBER(cus.birth_day)
            END AS CUSTOMER_AGE,
            lc.LOAI_HINH_CU_TRU ,
            lc.DISTANCE AS DISTANCE,
            lc.RESIDENCE_TIME,
            house.HOUSE_STATUS_NM TINHTRANG_NOIO,
            LC.INDUSTRY_NM,
            lc.JOB_NM,
            lc.JOB_DETAIL,
            lc.NUMBER_OF_CHILD NgPhuThuoc,
            g.GRP_NM Marital_status,
            LC.MONTHLY_INCOME_VALUE INCOME,
            customer_income,
            INCOME_FINAL,
            CASE when cus.customer_income = '01' then '1.<5tr'
                when cus.customer_income = '02' then '2.5->8tr'
                when cus.customer_income = '03' then '3.8->10tr'
                when cus.customer_income = '04' THEN '4.10->15tr'
                when cus.customer_income = '05' THEN '5.15->25tr'
                when cus.customer_income = '06' then '6.25->45tr'
                when cus.customer_income = '07' then '7.>45tr'
                ELSE cus.customer_income END INCOME_GRP,
            round(
            CASE WHEN l.ORIGIN_PAYMENT_METHOD_WID = 100000
            THEN
                (l.disburse_amt * (l.interest_rate / 100) * POWER(1 + l.interest_rate / 100, l.TERM_FREQUENCY)) /
                    (POWER(1 + l.interest_rate / 100, l.TERM_FREQUENCY) - 1) + nvl(l.CIMB_FEE_A_N_INTEREST_RATE, 0)/ 100 / 12 * l.disburse_amt
                ELSE
                    (l.disburse_amt * (l.interest_rate / 100) + nvl(l.CIMB_FEE_A_N_INTEREST_RATE, 0)/ 100 / 12 * l.disburse_amt) END, 0 ) AS emi,
            --emi_hdcc
            emi_hdcc.emi_hdcc,
            ---NGUON DON
            pol.channel_code POL_CHANNEL_CODE,
            POL.SOURCE_LEVEL_1_NAME ,
            POL.SOURCE_LEVEL_2_NAME ,
            POL.SOURCE_LEVEL_3_NAME ,
            POL.SOURCE_LEVEL_4_NAME ,
            --mgl
            mgl.mgl_amt,
            ----segment
            CASE
            WHEN upper(l.LOAN_PKG_NM) LIKE '%LAODONG%'
            OR lc.JOB_NM = 'Lao động tự do' THEN
            CASE
            WHEN (UPPER(CUS.GENDER_NM) = 'NỮ'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 42)
            OR (UPPER(CUS.GENDER_NM) = 'NỮ'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 30
            AND UPPER(g.GRP_NM) = 'ĐÃ KẾT HÔN')
            OR (UPPER(CUS.GENDER_NM) = 'NAM'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 42
            AND UPPER(g.GRP_NM) = 'ĐÃ KẾT HÔN') THEN 'GOOD'
            ELSE 'BAD'
        END
        WHEN upper(l.LOAN_PKG_NM) LIKE '%CONGNHAN%'
        OR lc.JOB_NM = 'Công nhân'
        OR lc.JOB_NM LIKE '%Công nhân%' THEN
        CASE
            WHEN (UPPER(CUS.GENDER_NM) = 'NỮ'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 23)
            OR (UPPER(CUS.GENDER_NM) = 'NAM'
            AND substr(L.DISBURSE_DATE_WID,
            1,
            4) - CUS.BIRTH_DAY >= 38
            AND UPPER(g.GRP_NM) = 'ĐÃ KẾT HÔN') THEN 'GOOD'
            ELSE 'BAD'
            END
            WHEN upper(l.LOAN_PKG_NM) LIKE '%VP%'
            OR lc.JOB_NM = 'Viên chức văn phòng'
            OR lc.JOB_NM = 'Nhân viên văn phòng' THEN
        CASE
                WHEN (UPPER(CUS.GENDER_NM) = 'NỮ')
                OR (UPPER(CUS.GENDER_NM) = 'NAM'
                AND substr(L.DISBURSE_DATE_WID,
                1,
                4) - CUS.BIRTH_DAY >= 33) THEN 'GOOD'
                ELSE 'BAD'
            END
        END AS REPAYMENT_STATUS,
        CASE
            WHEN a.CATEGORY_CODE = '17' THEN
        CASE
            WHEN upper(l.LOAN_PKG_NM) LIKE '%LAODONG%'
            OR lc.JOB_NM = 'Lao động tự do' THEN
        CASE
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%KINH DOANH%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%DỊCH VỤ%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NHÀ HÀNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%THƯƠNG MẠI%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%GIẢI TRÍ%' THEN 'LDTD-KD'
                ELSE 'LDTD-CVN'
            END
            WHEN upper(l.LOAN_PKG_NM) LIKE '%CONGNHAN%'
            OR lc.JOB_NM = 'Công nhân'
            OR lc.JOB_NM LIKE '%Công nhân%' THEN
        CASE
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%ĐÀO TẠO%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NGHỆ THUẬT%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NHÀ HÀNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%Y TẾ%' THEN 'CN-YT'
                ELSE 'CN'
            END
            WHEN upper(l.LOAN_PKG_NM) LIKE '%VP%'
            OR lc.JOB_NM = 'Viên chức văn phòng'
            OR lc.JOB_NM = 'Nhân viên văn phòng' THEN
        CASE
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%Y TẾ%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%VIỄN THÔNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NHÀ NƯỚC%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%ĐIỆN NƯỚC%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%CÔNG CỘNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%ĐÀO TẠO%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%NGHỆ THUẬT%' THEN 'VP-ASXH'
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%XÂY DỰNG%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%TÀI CHÍNH%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%DU LỊCH%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%KHOA HỌC%' THEN 'VP-TDC'
                WHEN UPPER(LC.INDUSTRY_NM) LIKE '%VẬN TẢI%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%SỬA CHỮA%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%THỦY SẢN%'
                OR UPPER(LC.INDUSTRY_NM) LIKE '%CÔNG NGHIỆP%' THEN 'VP-PT'
            END
        END
        END AS SEGMENT
    FROM F88DWH.w_loan_dtl_f l
        LEFT JOIN F88DWH.W_POL_DTL_F POL ON POL.LOAN_WID = L.LOAN_WID AND pol.STATUS_NM= 'Nhận cầm cố' and  pol.year_num >= 2024 --and pol.date_wid >= 20231001 --nguon don
        LEFT JOIN F88DWH.W_NET_DISBURSE_F wndf ON l.LOAN_WID = wndf.LOAN_WID
        LEFT JOIN F88DWH.W_LOAN_FUND_D f ON l.FUND_ID = f.INTEGRATION_ID AND f.CRN_ROW_IND = 1
        LEFT join d on d.loan_wid = l.loan_wid
        LEFT JOIN F88DWH.W_LOAN_SCH_DTL_F LS ON d.LOAN_WID = LS.LOAN_WID  AND D.SCH_DT = LS.TO_DATE
        LEFT JOIN f88dwh.VW_W_LOAN_MASTER_F mt ON mt.loan_wid = l.loan_wid
        left join F88DWH.VW_W_CUSTOMER_D cus on cus.customer_wid = l.customer_wid AND cus."SOURCE" = 'CIF'
        LEFT JOIN
            ( --loai duplicate
            SELECT b.*,
            ROW_NUMBER() OVER(PARTITION BY LOAN_WID ORDER BY SOURCE, INTEGRATION_ID DESC ) rn
            FROM  F88DWH.VW_W_LOAN_CUSTOMER_F b
            ) lc ON l.LOAN_WID = lc.LOAN_WID AND RN=1
        LEFT JOIN F88DWH.W_HOUSE_STATUS_D house ON house.HOUSE_STATUS_WID = lc.HOUSE_STATUS_WID
        LEFT JOIN F88DWH.GRP g ON G.GRP_ID = lc.MARITAL_ID
        LEFT JOIN f88dwh.W_ASSET_TP_D a ON a.ASSET_TP_WID = l.ASSET_TYPE_WID
        LEFT JOIN F88DWH.W_LOAN_ASSET_F ass ON ass.LOAN_WID = l.LOAN_WID
        left join f88dwh.w_shop_d shop on shop.shop_wid = l.shop_wid
        left join f88dwh.w_area_manager_d manager on shop.shop_code = trim(manager.shop_id)
        left join f88dwh.w_loan_score_f sco on sco.loan_wid = l.loan_wid
        LEFT JOIN recovery r ON r.code_no = l.loan_code
                            AND r.YEAR_NUM = d.YEAR_NUM_n
                            AND r.MONTH_NUM = d.MONTH_NUM_n
                            AND r.RECOVERY > 0
    --	LEFT JOIN SCH ON SCH.LOAN_WID = L.LOAN_WID -- tạm thời bỏ
        LEFT JOIN mgl ON mgl.loan_code = d.loan_code
                      AND MGL.trans_yyyy = d.YEAR_NUM_N
                      AND MGL.trans_mm = d.MONTH_NUM_N
                      AND NVL(d.dpd_eom,0) < 91
                      AND d.year_num_n >= 2023
        LEFT JOIN emi_hdcc ON emi_hdcc.loan_wid = l.loan_wid
    WHERE
            a.CATEGORY_CODE in ('15','17','02')
            and l.disburse_date_wid >  20220531
            AND l.disburse_date_wid <=  TO_NUMBER(TO_CHAR(v_last_month_date, 'YYYYMMDD'))
            AND l.CREATED_USER NOT LIKE '%test%'
            AND NVL(L.COLLATERAL_AMT,0) > 0
    --		AND l.loan_code = '20640411515' --ndh
    )
    SELECT
        a.*
        , CASE
            WHEN A.SEGMENT = 'VP-ASXH' THEN
                CASE WHEN (A.REPAYMENT_STATUS = 'GOOD' OR (A.REPAYMENT_STATUS = 'BAD' AND A.INCOME >= 10000000)) THEN 'VP-ASXH-1' ELSE 'VP-ASXH-2' END
            WHEN A.SEGMENT = 'VP-TDC' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' AND A.INCOME >= 5000000 THEN 'VP-TDC-1' ELSE 'VP-TDC-2' END
            WHEN A.SEGMENT = 'VP-PT' THEN
                CASE WHEN A.REPAYMENT_STATUS ='GOOD' AND A.INCOME >= 10000000 THEN 'VP-PT-1' ELSE 'VP-PT-2' END
            WHEN A.SEGMENT = 'CN-YT' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' OR (A.REPAYMENT_STATUS = 'BAD' AND A.INCOME >= 15000000) THEN 'CN-YT-1' ELSE 'CN-YT-2' END
            WHEN A.SEGMENT = 'CN' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' THEN 'CN-1' ELSE 'CN-2' END
            WHEN A.SEGMENT = 'LDTD-KD' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' OR (A.REPAYMENT_STATUS = 'BAD' AND A.INCOME >= 15000000) THEN 'LDTD-KD-1' ELSE 'LDTD-KD-2' END
            WHEN A.SEGMENT = 'LDTD-CVN' THEN
                CASE WHEN A.REPAYMENT_STATUS = 'GOOD' THEN 'LDTD-CVN-1' ELSE 'LDTD-CVN-2' END
        END AS SEGMENT_PROFILE
    FROM TEMP_DATA A
    WHERE yymm = TO_NUMBER(TO_CHAR(v_last_month_date, 'YYYYMM'))
       OR (
        (v_max_yymm IS NULL OR TO_NUMBER(TO_CHAR(v_last_month_date, 'YYYYMM')) >= v_max_yymm)
        AND YYMM_DISBUR = TO_NUMBER(TO_CHAR(v_last_month_date, 'YYYYMM'))
      );


    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END proc_qtrr_loan_collection_risk;
```

### `F88DWH.PROC_RPT_ONLINE_DAILY` (PROCEDURE) — 6 lines reference search term

```
PROCEDURE        PROC_RPT_ONLINE_DAILY
AS
BEGIN

/*
Procedure to generate data for Online datamart
Daily procedure re-generate the data for the current month and the previous month

update by: hanhdtm
update dt: 20250411
ticket: #F88_M9CB10YS
*/

-- 1.2. Delete old data
DELETE FROM F88DWH.W_RPT_ONLINE
WHERE REPORT_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1;

-- 2.2. Insert new data
INSERT INTO F88DWH.W_RPT_ONLINE
(YEAR_NUM, MONTH_NUM, REPORT_DT, SHOP_CODE, CALLER_CODE, SALER_CODE, CHANNEL_CODE, FORM_ASSET, ASSET, CAMPAIGN, NHOM_NGUON, NGUON_PHU, PHAN_LOAI_NGUON_PHU, URL, CTR_TYPE, FLAG_SAMEDAY, FORM_TT, FORM_TLS, LEAD_PGD, SALE, GIAI_NGAN, LEAD_TLS, SALE_TLS, GIAI_NGAN_TLS, CHANNEL_STR, F_CANCEL_IN_MONTH, S_IN_MONTH, ASSET_TYPE_NAME, F_CANCEL)
SELECT
        YEAR_NUM,
        MONTH_NUM,
        date1 REPORT_DT,
        SHOP_CODE,
        CALLER_CODE,
        SALER_CODE,
        CHANNEL_CODE,
        FORM_ASSET,
        ASSET,
        CAMPAIGN,
        NHOM_NGUON,
        NGUON_PHU,
        PHAN_LOAI_NGUON_PHU,
        URL,
        ctr_type,
        FLAG_SAMEDAY,
        SUM(Form_TT) Form_TT,
        SUM(Form_TLS) Form_TLS,
        SUM(Lead_PGD) Lead_PGD,
        SUM(Sale) Sale,
        SUM(Giai_ngan) Giai_ngan,
        SUM(Lead_TLS) Lead_TLS,
        SUM(Sale_TLS) Sale_TLS,
        SUM(Giai_ngan_TLS) Giai_ngan_TLS,
        CHANNEL_STR,
        sum(F_cancel_in_month) F_cancel_in_month,
        sum(S_in_month) S_in_month,
        ASSET_TYPE_NAME ,
        sum(F_cancel) F_cancel
--1.sum Form TT
FROM (
        (
        SELECT
                po.YEAR_NUM,
                po.MONTH_NUM,
                TRUNC(po.FORM_CREATED_DT) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                SUM(CASE WHEN FORM_CREATED_DT IS NOT NULL THEN 1 ELSE 0 END) AS Form_TT,
                0 AS Form_TLS,
                0 AS Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                sum(CASE WHEN lower(po.STATUS_NM)='hủy đăng ký' THEN 1 ELSE 0 END) F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TRUNC(FORM_CREATED_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND FORM_CREATED_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
                AND po.SOURCE_LEVEL_2_NAME <>'LOS'
        GROUP BY
                po.YEAR_NUM,
                po.MONTH_NUM,
                TRUNC(po.FORM_CREATED_DT),
                po.group_id,
                WED.EMPLOYEE_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM,
                CAMPAIGN_NM,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END,
                po.SOURCE_LEVEL_1_NAME
       )
--2. sum Lead PGD
UNION ALL
        (   SELECT
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) YEAR_NUM,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) MONTH_NUM,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                SUM(CASE WHEN PO.FIRST_SHOP_TRANS_DT  IS NOT NULL THEN 1 ELSE 0 END) AS Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
    FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
  WHERE 1=1
--       AND TRUNC(PO.FIRST_SHOP_TRANS_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
		AND PO.FIRST_SHOP_TRANS_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
       AND po.SOURCE_LEVEL_2_NAME <>'LOS'
  GROUP BY
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) ,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) ,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ),
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE  WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM ,
                po.LOAN_ASSET_TP_NM ,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
               CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END,
                po.SOURCE_LEVEL_1_NAME   )
-- 3. sum sale TT và Giải ngân TT
UNION  ALL
        (
        SELECT
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                0 AS Lead_PGD,
                COUNT(po.LOAN_CODE)  AS Sale,
                SUM(po.DISBURSE_AMT) AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND to_char(po.FORM_CREATED_DT,'yyyymm') = substr(PO.DISBURSE_DT,1,6)  THEN 1 ELSE 0 END ) S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND PO.DISBURSE_DT > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
                AND po.STATUS_NM ='Nhận cầm cố'
                AND po.SOURCE_LEVEL_2_NAME <>'LOS'
        GROUP BY
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM ,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END  ,
                po.SOURCE_LEVEL_1_NAME
       )
--4. HDMM nhập thẳng trên LOS không qua PAWN_ONLINE_WID
UNION  ALL
        (
SELECT
        to_number(substr(a.DISBURSE_DATE_WID, 1, 4)) year_num,
        to_number(substr(a.DISBURSE_DATE_WID, 5, 2)) month_num,
        to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') date1,
        CASE WHEN REGEXP_LIKE(sh.SHOP_CODE, '^[[:digit:]]+$') THEN to_number(sh.SHOP_CODE) ELSE NULL END shop_code ,
        NULL caller_name,
        NULL caller_code,
        a.CHANNEL_CODE ,
        c.ASSET_TP_NM  AS FORM_ASSET,
        c.ASSET_TP_NM ASSET,
        r.RESOURCES_NM campaign,
        CASE
                WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END NHOM_NGUON,
        'LOS' nguon_phu,
        NULL phan_loai_nguon_phu,
        NULL url,
        a.CTR_TYPE,
        CASE WHEN NVL(A.CLOSED_DATE_WID,0) != A.DISBURSE_DATE_WID THEN 1 ELSE 0 END FLAG_SAMEDAY,
        count(a.LOAN_WID) form_tt,
        0 form_tls,
        count(a.LOAN_WID) lead_pgd,
        count(a.LOAN_WID) sale,
        sum(a.DISBURSE_AMT) giai_ngan,
        0 Lead_TLS,
        0 Sale_TLS,
        0 Giai_ngan_TLS,
        'Marketing PGD' SOURCE,
        0 F_cancel_in_month,
        0 S_in_month,
        c.ASSET_TP_NM  ASSET_TYPE_NAME,
        0 F_cancel
FROM
    F88DWH.W_LOAN_DTL_F a
LEFT JOIN F88DWH.VW_W_POL_DTL_F b ON a.LOAN_WID =b.LOAN_WID
LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
LEFT JOIN F88DWH.W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =A.LOAN_WID
LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
LEFT JOIN F88DWH.W_SHOP_D sh ON sh.SHOP_WID = a.SHOP_WID
WHERE
    1 = 1
    AND b.LOAN_CODE  IS NULL
--    AND to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
    AND a.DISBURSE_DATE_WID > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
GROUP BY
        to_number(substr(a.DISBURSE_DATE_WID, 1, 4)),
        to_number(substr(a.DISBURSE_DATE_WID, 5, 2)),
        to_date(a.DISBURSE_DATE_WID, 'yyyymmdd'),
        sh.SHOP_CODE ,
        a.CHANNEL_CODE ,
        b.FORM_ASSET_TP_NM  ,
        b.LOAN_ASSET_TP_NM,
        r.RESOURCES_NM,
        a.CTR_TYPE,
        CASE WHEN NVL(A.CLOSED_DATE_WID,0) != A.DISBURSE_DATE_WID THEN 1 ELSE 0 END ,
        CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END,
        c.ASSET_TP_NM
        )
---4.* HỢP ĐỒNG TỪ GOLIVE NHÓM NGUỒN LOS NHẬP LÊN POL TỪ 19/04/2024
UNION  ALL
        (
        SELECT
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                po.GROUP_id shop_code,
                NULL CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                r.RESOURCES_NM  CAMPAIGN,
                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                        ELSE 'Trade MKT' END NHOM_NGUON,
                'LOS' nguon_phu,
                NULL PHAN_LOAI_NGUON_PHU,
                NULL url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                count(po.LOAN_WID) form_tt,
                        0 form_tls,
                        count(po.LOAN_WID) lead_pgd,
                        count(po.LOAN_WID) sale,
                SUM(po.DISBURSE_AMT) AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                'Marketing PGD'  CHANNEL_STR,
                0 F_cancel_in_month,
                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND to_char(po.FORM_CREATED_DT,'yyyymm') = substr(PO.DISBURSE_DT,1,6)  THEN 1 ELSE 0 END ) S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN F88DWH.W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =PO.LOAN_WID
                LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND PO.DISBURSE_DT > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
                AND po.STATUS_NM ='Nhận cầm cố'
                AND po.SOURCE_LEVEL_2_NAME ='LOS'
        GROUP BY
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                po.GROUP_id ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM ,
                RESOURCES_NM ,
                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                        ELSE 'Trade MKT' END,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END
       )
 -- 5.Traffic NKTB nhập thẳng trên LOS
UNION ALL
(
SELECT
        TO_NUMBER(SUBSTR(LLF.DATE_WID,1,4)) YEAR_NUM,
        TO_NUMBER(SUBSTR(LLF.DATE_WID,5,2)) MONTH_NUM,
        TO_DATE(LLF.DATE_WID,'YYYYMMDD') DATE1,
        TO_NUMBER(LLF.SHOP_CODE) SHOP_CODE,
        NULL CALLER_NAME,
        NULL CALLER_CODE,
        'KDML' CHANNEL_CODE,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END FORM_ASSET,
        NULL ASSET,
        WRD.RESOURCES_NM CAMPAIGN,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'Digital Mạng Lưới'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'Trade MKT'
    END NHOM_NGUON,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'WALKIN ONLINE'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'WALKIN OFFLINE'
    END NGUON_PHU,
    NULL PHAN_LOAI_NGUON_PHU,
    NULL URL,
    NULL CTR_TYPE,
    NULL FLAG_SAMEDAY,
    COUNT(1) FORM_TT,
    0 FORM_TLS,
    COUNT(1) LEAD_PGD,
    0 SALE,
    0 GIAI_NGAN,
    0 LEAD_TLS,
    0 SALE_TLS,
    0 GIAI_NGAN_TLS,
    'Marketing PGD' SOURCE,
    0 F_CANCEL_IN_MONTH,
    0 S_IN_MONTH,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END ASSET_TYPE_NAME,
        0 F_CANCEL
FROM F88DWH.VW_W_LOAN_LOG_FAILURE_F LLF
LEFT JOIN (SELECT * FROM F88DWH.W_RESOURCES_D WHERE status = 1 )  wrd on LLF.ORG_CUSTOMER = wrd.RESOURCES_CODE
WHERE 1=1
--AND TO_DATE(LLF.DATE_WID, 'yyyymmdd') > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
AND LLF.DATE_WID > TO_CHAR(ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1, 'YYYYMMDD')
GROUP BY
        TO_NUMBER(SUBSTR(LLF.DATE_WID,1,4)),
        TO_NUMBER(SUBSTR(LLF.DATE_WID,5,2)),
        TO_DATE(LLF.DATE_WID,'YYYYMMDD'),
        TO_NUMBER(LLF.SHOP_CODE),
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END,
        WRD.RESOURCES_NM,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'Digital Mạng Lưới'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'Trade MKT'
    END,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'WALKIN ONLINE'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'WALKIN OFFLINE'
    END,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END
        )
UNION ALL --đơn hủy theo tháng hủy đơn
(
        SELECT
                EXTRACT (YEAR FROM CANCEL_DT) YEAR_NUM,
                EXTRACT (MONTH FROM CANCEL_DT) MONTH_NUM,
                TRUNC(CANCEL_DT) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                0 Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                count(po.POL_WID) F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TO_NUMBER(TRIM(m.SHOP_ID))= po.group_id
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
--                AND TRUNC(CANCEL_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
        		AND CANCEL_DT > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
```

### `F88DWH.PROC_RPT_ONLINE_WEEKLY` (PROCEDURE) — 6 lines reference search term

```
PROCEDURE        PROC_RPT_ONLINE_WEEKLY
AS
BEGIN

/*
Procedure to generate data for Online datamart
Weekly procedure re-generate the data for the whole history

update by: hanhdtm
update dt: 20250411
ticket: #F88_M9CB10YS

*/

-- 1.1. Delete old data
EXECUTE IMMEDIATE 'TRUNCATE TABLE F88DWH.W_RPT_ONLINE';

-- 2.1. Re-run data
INSERT INTO F88DWH.W_RPT_ONLINE
(YEAR_NUM, MONTH_NUM, REPORT_DT, SHOP_CODE, CALLER_CODE, SALER_CODE, CHANNEL_CODE, FORM_ASSET, ASSET, CAMPAIGN, NHOM_NGUON, NGUON_PHU, PHAN_LOAI_NGUON_PHU, URL, CTR_TYPE, FLAG_SAMEDAY, FORM_TT, FORM_TLS, LEAD_PGD, SALE, GIAI_NGAN, LEAD_TLS, SALE_TLS, GIAI_NGAN_TLS, CHANNEL_STR, F_CANCEL_IN_MONTH, S_IN_MONTH, ASSET_TYPE_NAME, F_CANCEL)
SELECT
        YEAR_NUM,
        MONTH_NUM,
        date1 REPORT_DT,
        SHOP_CODE,
        CALLER_CODE,
        SALER_CODE,
        CHANNEL_CODE,
        FORM_ASSET,
        ASSET,
        CAMPAIGN,
        NHOM_NGUON,
        NGUON_PHU,
        PHAN_LOAI_NGUON_PHU,
        URL,
        ctr_type,
        FLAG_SAMEDAY,
        SUM(Form_TT) Form_TT,
        SUM(Form_TLS) Form_TLS,
        SUM(Lead_PGD) Lead_PGD,
        SUM(Sale) Sale,
        SUM(Giai_ngan) Giai_ngan,
        SUM(Lead_TLS) Lead_TLS,
        SUM(Sale_TLS) Sale_TLS,
        SUM(Giai_ngan_TLS) Giai_ngan_TLS,
        CHANNEL_STR,
        sum(F_cancel_in_month) F_cancel_in_month,
        sum(S_in_month) S_in_month,
        ASSET_TYPE_NAME ,
        sum(F_cancel) F_cancel
--1.sum Form TT
FROM (
        (
        SELECT
                po.YEAR_NUM,
                po.MONTH_NUM,
                TRUNC(po.FORM_CREATED_DT) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                SUM(CASE WHEN FORM_CREATED_DT IS NOT NULL THEN 1 ELSE 0 END) AS Form_TT,
                0 AS Form_TLS,
                0 AS Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                sum(CASE WHEN lower(po.STATUS_NM)='hủy đăng ký' THEN 1 ELSE 0 END) F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TRIM(m.SHOP_ID)= TO_CHAR(po.group_id)
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
                --AND TRUNC(FORM_CREATED_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
                AND po.SOURCE_LEVEL_2_NAME <>'LOS'
        GROUP BY
                po.YEAR_NUM,
                po.MONTH_NUM,
                TRUNC(po.FORM_CREATED_DT),
                po.group_id,
                WED.EMPLOYEE_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM,
                CAMPAIGN_NM,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END,
                po.SOURCE_LEVEL_1_NAME
       )
--2. sum Lead PGD
UNION ALL
        (   SELECT
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) YEAR_NUM,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) MONTH_NUM,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                SUM(CASE WHEN PO.FIRST_SHOP_TRANS_DT  IS NOT NULL THEN 1 ELSE 0 END) AS Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
    FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TRIM(m.SHOP_ID)= TO_CHAR(po.group_id)
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
  WHERE 1=1
       --AND TRUNC(PO.FIRST_SHOP_TRANS_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
       AND po.SOURCE_LEVEL_2_NAME <>'LOS'
  GROUP BY
                EXTRACT (YEAR FROM PO.FIRST_SHOP_TRANS_DT ) ,
                EXTRACT (MONTH FROM PO.FIRST_SHOP_TRANS_DT ) ,
                TRUNC(PO.FIRST_SHOP_TRANS_DT ),
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE  WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM ,
                po.LOAN_ASSET_TP_NM ,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
               CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END,
                po.SOURCE_LEVEL_1_NAME   )
-- 3. sum sale TT và Giải ngân TT
UNION  ALL
        (
        SELECT
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                0 AS Lead_PGD,
                COUNT(po.LOAN_CODE)  AS Sale,
                SUM(po.DISBURSE_AMT) AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND to_char(po.FORM_CREATED_DT,'yyyymm') = substr(PO.DISBURSE_DT,1,6)  THEN 1 ELSE 0 END ) S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TRIM(m.SHOP_ID)= TO_CHAR(po.group_id)
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
                --AND TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
                AND po.STATUS_NM ='Nhận cầm cố'
                AND po.SOURCE_LEVEL_2_NAME <>'LOS'
        GROUP BY
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM ,
                CAMPAIGN_NM ,
                po.SOURCE_LEVEL_2_NAME ,
                po.SOURCE_LEVEL_3_NAME ,
                po.SOURCE_LEVEL_4_NAME ,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END ,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END  ,
                po.SOURCE_LEVEL_1_NAME
       )
--4. HDMM nhập thẳng trên LOS không qua PAWN_ONLINE_WID
UNION  ALL
        (
SELECT
        to_number(substr(a.DISBURSE_DATE_WID, 1, 4)) year_num,
        to_number(substr(a.DISBURSE_DATE_WID, 5, 2)) month_num,
        to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') date1,
        CASE WHEN REGEXP_LIKE(sh.SHOP_CODE, '^[[:digit:]]+$') THEN to_number(sh.SHOP_CODE) ELSE NULL END shop_code ,
        NULL caller_name,
        NULL caller_code,
        a.CHANNEL_CODE ,
        c.ASSET_TP_NM  AS FORM_ASSET,
        c.ASSET_TP_NM ASSET,
        r.RESOURCES_NM campaign,
        CASE
                WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END NHOM_NGUON,
        'LOS' nguon_phu,
        NULL phan_loai_nguon_phu,
        NULL url,
        a.CTR_TYPE,
        CASE WHEN NVL(A.CLOSED_DATE_WID,0) != A.DISBURSE_DATE_WID THEN 1 ELSE 0 END FLAG_SAMEDAY,
        count(a.LOAN_WID) form_tt,
        0 form_tls,
        count(a.LOAN_WID) lead_pgd,
        count(a.LOAN_WID) sale,
        sum(a.DISBURSE_AMT) giai_ngan,
        0 Lead_TLS,
        0 Sale_TLS,
        0 Giai_ngan_TLS,
        'Marketing PGD' SOURCE,
        0 F_cancel_in_month,
        0 S_in_month,
        c.ASSET_TP_NM  ASSET_TYPE_NAME,
        0 F_cancel
FROM
    F88DWH.W_LOAN_DTL_F a
LEFT JOIN F88DWH.VW_W_POL_DTL_F b ON a.LOAN_WID =b.LOAN_WID
LEFT JOIN F88DWH.W_ASSET_TP_D c ON c.ASSET_TP_WID = a.ASSET_TYPE_WID
LEFT JOIN F88DWH.W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =A.LOAN_WID
LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
LEFT JOIN F88DWH.W_SHOP_D sh ON sh.SHOP_WID = a.SHOP_WID
WHERE
    1 = 1
    AND b.LOAN_CODE  IS NULL
    --AND to_date(a.DISBURSE_DATE_WID, 'yyyymmdd') > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
GROUP BY
        to_number(substr(a.DISBURSE_DATE_WID, 1, 4)),
        to_number(substr(a.DISBURSE_DATE_WID, 5, 2)),
        to_date(a.DISBURSE_DATE_WID, 'yyyymmdd'),
        sh.SHOP_CODE ,
        a.CHANNEL_CODE ,
        b.FORM_ASSET_TP_NM  ,
        b.LOAN_ASSET_TP_NM,
        r.RESOURCES_NM,
        a.CTR_TYPE,
        CASE WHEN NVL(A.CLOSED_DATE_WID,0) != A.DISBURSE_DATE_WID THEN 1 ELSE 0 END ,
        CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
        ELSE 'Trade MKT' END,
        c.ASSET_TP_NM
        )
---4.* HỢP ĐỒNG TỪ GOLIVE NHÓM NGUỒN LOS NHẬP LÊN POL TỪ 19/04/2024
UNION  ALL
        (
        SELECT
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) YEAR_NUM,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) MONTH_NUM,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') AS date1,
                po.GROUP_id shop_code,
                NULL CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                r.RESOURCES_NM  CAMPAIGN,
                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                        ELSE 'Trade MKT' END NHOM_NGUON,
                'LOS' nguon_phu,
                NULL PHAN_LOAI_NGUON_PHU,
                NULL url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                count(po.LOAN_WID) form_tt,
                        0 form_tls,
                        count(po.LOAN_WID) lead_pgd,
                        count(po.LOAN_WID) sale,
                SUM(po.DISBURSE_AMT) AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                'Marketing PGD'  CHANNEL_STR,
                0 F_cancel_in_month,
                sum(CASE WHEN lower(po.STATUS_NM) = 'nhận cầm cố' AND to_char(po.FORM_CREATED_DT,'yyyymm') = substr(PO.DISBURSE_DT,1,6)  THEN 1 ELSE 0 END ) S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                0 F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TRIM(m.SHOP_ID)= TO_CHAR(po.group_id)
        LEFT JOIN F88DWH.W_LOAN_CUSTOMER_F LC ON LC.LOAN_WID =PO.LOAN_WID
                LEFT JOIN F88DWH.W_RESOURCES_D R ON R.RESOURCES_WID=LC.CUSTOMER_RESOURCES_WID
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
                --AND TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')  > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
                AND po.STATUS_NM ='Nhận cầm cố'
                AND po.SOURCE_LEVEL_2_NAME ='LOS'
        GROUP BY
                EXTRACT (YEAR FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                EXTRACT (MONTH FROM TO_DATE(PO.DISBURSE_DT,'YYYYMMDD')) ,
                TO_DATE(PO.DISBURSE_DT,'YYYYMMDD') ,
                po.GROUP_id ,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END ,
                po.FORM_ASSET_TP_NM  ,
                po.LOAN_ASSET_TP_NM ,
                RESOURCES_NM ,
                CASE WHEN R.RESOURCES_CODE IN ('016','015','017','023','024','025','014','029','021') THEN 'Digital Mạng Lưới'
                        ELSE 'Trade MKT' END,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END
       )
 -- 5.Traffic NKTB nhập thẳng trên LOS
UNION ALL
(
SELECT
        TO_NUMBER(SUBSTR(LLF.DATE_WID,1,4)) YEAR_NUM,
        TO_NUMBER(SUBSTR(LLF.DATE_WID,5,2)) MONTH_NUM,
        TO_DATE(LLF.DATE_WID,'YYYYMMDD') DATE1,
        TO_NUMBER(LLF.SHOP_CODE) SHOP_CODE,
        NULL CALLER_NAME,
        NULL CALLER_CODE,
        'KDML' CHANNEL_CODE,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END FORM_ASSET,
        NULL ASSET,
        WRD.RESOURCES_NM CAMPAIGN,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'Digital Mạng Lưới'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'Trade MKT'
    END NHOM_NGUON,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'WALKIN ONLINE'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'WALKIN OFFLINE'
    END NGUON_PHU,
    NULL PHAN_LOAI_NGUON_PHU,
    NULL URL,
    NULL CTR_TYPE,
    NULL FLAG_SAMEDAY,
    COUNT(1) FORM_TT,
    0 FORM_TLS,
    COUNT(1) LEAD_PGD,
    0 SALE,
    0 GIAI_NGAN,
    0 LEAD_TLS,
    0 SALE_TLS,
    0 GIAI_NGAN_TLS,
    'Marketing PGD' SOURCE,
    0 F_CANCEL_IN_MONTH,
    0 S_IN_MONTH,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END ASSET_TYPE_NAME,
        0 F_CANCEL
FROM F88DWH.VW_W_LOAN_LOG_FAILURE_F LLF
LEFT JOIN (SELECT * FROM F88DWH.W_RESOURCES_D WHERE status = 1 )  wrd on LLF.ORG_CUSTOMER = wrd.RESOURCES_CODE
WHERE 1=1
--AND TO_DATE(LLF.DATE_WID, 'yyyymmdd') > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
GROUP BY
        TO_NUMBER(SUBSTR(LLF.DATE_WID,1,4)),
        TO_NUMBER(SUBSTR(LLF.DATE_WID,5,2)),
        TO_DATE(LLF.DATE_WID,'YYYYMMDD'),
        TO_NUMBER(LLF.SHOP_CODE),
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END,
        WRD.RESOURCES_NM,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'Digital Mạng Lưới'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'Trade MKT'
    END,
    CASE
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%ONLINE%' THEN 'WALKIN ONLINE'
        WHEN UPPER(WRD.RESOURCES_NM) LIKE '%OFFLINE%' OR UPPER(WRD.RESOURCES_NM) LIKE '%TRADE%' THEN 'WALKIN OFFLINE'
    END,
        CASE
                WHEN LLF.CATEGORY_NAME NOT IN ('Đăng ký xe máy','Đăng ký Ô tô') THEN 'Khác'
                ELSE LLF.CATEGORY_NAME
        END
        )
UNION ALL --đơn hủy theo tháng hủy đơn
(
        SELECT
                EXTRACT (YEAR FROM CANCEL_DT) YEAR_NUM,
                EXTRACT (MONTH FROM CANCEL_DT) MONTH_NUM,
                TRUNC(CANCEL_DT) AS date1,
                po.GROUP_id shop_code,
                WED.EMPLOYEE_CODE CALLER_CODE,
                NULL SALER_CODE,
                CASE WHEN po.LOAN_CODE IS NOT NULL THEN po.CHANNEL_CODE
                        WHEN m.SHOP_CODE IS NOT NULL THEN m.SHOP_CODE
                        WHEN po.GROUP_NM LIKE '%TNKH%' THEN 'TNKH'
                        ELSE 'Khác' END Channel_code,
                po.FORM_ASSET_TP_NM  AS FORM_ASSET,
                po.LOAN_ASSET_TP_NM ASSET,
                CAMPAIGN_NM CAMPAIGN,
                po.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                po.SOURCE_LEVEL_3_NAME NGUON_PHU,
                po.SOURCE_LEVEL_4_NAME PHAN_LOAI_NGUON_PHU,
                CASE WHEN url LIKE '%utm_source=ktl%' THEN 'utm_source=ktl'
                        WHEN url LIKE '%online.f88.vn%' THEN 'online.f88.vn'
                        ELSE 'Khác' END url,
                po.ctr_type,
                CASE WHEN NVL(po.CLOSED_DT,0) != po.DISBURSE_DT THEN 1 ELSE 0 END FLAG_SAMEDAY,
                0 AS Form_TT,
                0 AS Form_TLS,
                0 Lead_PGD,
                0 AS Sale,
                0 AS Giai_ngan,
                0 AS Lead_TLS,
                0 AS Sale_TLS,
                0 AS Giai_ngan_TLS,
                po.SOURCE_LEVEL_1_NAME  CHANNEL_STR,
                0 F_cancel_in_month,
                0 S_in_month,
                po.FORM_ASSET_TP_NM ASSET_TYPE_NAME ,
                count(po.POL_WID) F_cancel
        FROM F88DWH.VW_W_POL_DTL_F po
        LEFT JOIN F88DWH.W_AREA_MANAGER_D m
                ON TRIM(m.SHOP_ID)= TO_CHAR(po.group_id)
        LEFT JOIN (SELECT * FROM F88DWH.W_EMPLOYEE_D WHERE  ISACTIVATED =1 AND CRN_ROW_IND =1) wed ON PO.EMPLOYEE_WID=WED.EMPLOYEE_WID
        WHERE 1=1
                --AND TRUNC(CANCEL_DT) > ADD_MONTHS(TRUNC(SYSDATE, 'mm'), -1) -1
                AND status_NM='Hủy đăng ký'
        GROUP BY
                EXTRACT (YEAR FROM CANCEL_DT) ,
                EXTRACT (MONTH FROM CANCEL_DT) ,
                TRUNC(CANCEL_DT) ,
                po.GROUP_id ,
                WED.EMPLOYEE_CODE ,
```

### `F88DWH.PROC_W_COHORT_QTRR` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE        PROC_W_COHORT_QTRR(P_DATE NUMBER)
IS
BEGIN

DELETE
FROM F88DWH.W_COHORT_QTRR
WHERE YYMM = SUBSTR(P_DATE,1,6);

COMMIT;

INSERT INTO F88DWH.W_COHORT_QTRR
(LOAN_WID, LOAN_CODE, HDCC, CUSTOMER_CODE, YYMM_DISBUR, CREATEDDATE, DISBURSE_DATE, CLOSED_DATE, MTH, YYMM,
WO_YYMM, WO_AMT, IS_BAD_DEBT, DISBURSE_AMT, COLLATERAL_AMT, BAOHIEM, MAX_LENDABLE_AMT, LTV, BAL_SOM, BAL_EOM,
DPD_EOM, DPD_SOM, DPD_EOM_GRP, DPD_SOM_GRP, ASSET_TYPE, TEN_TS, NGAY_DKX, LOAN_STATUS, FUND_NAME, CHANNEL_CODE,
TENOR_HD, SCHEDULE_NUM, SCH_DT, TO_DATE, PAID_DATE, LOAN_PKG_NM, PAYMENT_METHOD, CTR_TYPE, SHOP_WID, SHOP_NM,
PROVINCE, AREA, A_SCORE, INTERNAL_SCORE, BSCORE_MONTHLY, BSCORE_GN, CUSTOMERSCORE, FLAG_DENHAN_B0,
COLLECTION_STATUS, GIOI_TINH, CUSTOMER_AGE, LOAI_HINH_CU_TRU, DISTANCE, RESIDENCE_TIME, TINHTRANG_NOIO,
JOB_NM, NGPEHUTHUOC, MARITAL_STATUS, INCOME, CUSTOMER_INCOME, INCOME_FINAL, INCOME_GRP, POL_CHANNEL_CODE, SOURCE_LEVEL_1_NAME,
SOURCE_LEVEL_2_NAME, SOURCE_LEVEL_3_NAME, SOURCE_LEVEL_4_NAME, TONG_NGHIAVU, NGHIAVU_GOC, NGHIAVU_LAI_PHAT, TONG_PAID, GOC_PAID, LAI_PHI_PAID, TONG_WAIVED)

WITH cal AS (
SELECT YEAR_NUM,
		MONTH_NUM,
		DATE_WID ,
		DATE_TM,
		TO_CHAR(TRUNC(DATE_TM, 'MM'), 'YYYYMMDD') DATE_WID_SOM
FROM f88dwh.W_CALENDAR_D cal
WHERE 1 = 1
	AND CAL.LAST_DOM_FLAG = 1
	AND DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE,'YYYYMMDD'), 'MM')-1, 'YYYYMMDD')
	AND DATE_WID <= P_DATE
)
,
d AS (
select
	CAL.YEAR_NUM,
	CAL.MONTH_NUM,
	cal.date_tm,
	d.status loan_status,
    Substr(TO_NUMBER(TO_CHAR(DATE_TM +1,'YYYYMMDD')),1,6) as YYMM,
   	EXTRACT( YEAR FROM DATE_TM +1) YEAR_NUM_N ,
	EXTRACT( MONTH FROM DATE_TM +1) MONTH_NUM_N,
	CAL.DATE_TM - D.OVERDUE_DAYS SCH_DT,
	to_number(to_char(d.dpd_from_date,'yyyymm')) dpd_from_date,
	LOAN_WID,
	LOAN_CODE,
    OVERDUE_DAYS DPD_SOM,
    IS_BAD_DEBT,
    term_frequency ,
    LEAD(OVERDUE_DAYS) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) DPD_EOM,
    principal_remain BAL_SOM,
    LEAD(principal_remain) OVER (PARTITION BY LOAN_WID ORDER BY DATE_TM) BAL_EOM
FROM
	F88DWH.W_LOAN_DAILY_F d
	,cal
	, F88DWH.W_ASSET_TP_D ATP
where
	1 =1
 	and CAL.YEAR_NUM = d.YEAR_NUM
  	AND CAL.MONTH_NUM = d.MONTH_NUM
  	AND CAL.DATE_WID = d.DATE_WID
	AND ATP.ASSET_TP_WID = D.ASSET_TYPE_WID
	AND ATP.CATEGORY_CODE  IN ('15','17','02')
	AND d.reversed_date IS NULL
)
, bscore AS
(
SELECT * FROM (
		SELECT
		b.*,
		SUBSTR(b.date_wid,1,6) YYMM,
		ROW_NUMBER() OVER (PARTITION BY CUSTOMER_CODE, DATE_WID ORDER BY DATE_CREATED) rn
		FROM F88DWH.W_B_SCORE_MONTHLY_F b
		WHERE 1=1
		AND
		(date_wid = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE ,'YYYYMMDD'),-1)+1,'YYYYMMDD'))
		OR
		date_wid = TO_NUMBER(TO_CHAR(ADD_MONTHS(TO_DATE(P_DATE ,'YYYYMMDD'),-2)+1,'YYYYMMDD'))
		)
		) WHERE rn =1
)
SELECT
*
FROM
(
SELECT
l.loan_wid,
		L.LOAN_CODE,
		l.contract_code HDCC,
		l.customer_code,
		substr(l.disburse_date_wid,1,6) as YYMM_Disbur,
		mt.CREATEDDATE,
		to_date(l.disburse_date_wid,'yyyy-mm_dd') disburse_date,
		to_date(l.closed_date_wid,'yyyy-mm_dd') closed_date,
	    MONTHS_BETWEEN(to_date(l.closed_date_wid,'yyyy-mm_dd'),to_date(l.disburse_date_wid,'yyyy-mm_dd')) mth, --thangtattoan
		d.YYMM,
		SUBSTR(l.WRITEOFF_DATE_WID,1,6) WO_YYMM,
		CASE WHEN d.YYMM = SUBSTR(l.WRITEOFF_DATE_WID,1,6) THEN BAL_SOM ELSE 0 END WO_AMT,
		d.is_bad_debt,
		l.disburse_amt,
		l.COLLATERAL_AMT,
		L.INSURANCE_AMT baohiem,
		l.MAX_LENDABLE_AMT,
		round((L.DISBURSE_AMT - L.INSURANCE_AMT) / L.COLLATERAL_AMT,3) LTV,
		D.BAL_SOM,
		D.BAL_EOM,
		DPD_EOM,
		DPD_SOM,
		case when DPD_EOM < 1 then 0
			 when DPD_EOM < 31 then 1
			 when DPD_EOM < 61 then 2
			 when DPD_EOM < 91 then 3
			 when DPD_EOM IS null then null
			 else 4 end dpd_EOM_grp ,
		case
			when DPD_SOM < 1 then 0
			 when DPD_SOM < 31 then 1
			 when DPD_SOM < 61 then 2
			 when DPD_SOM < 91 then 3
			 when DPD_SOM IS null then null
			 else 4 --B4+
			 end  DPD_SOM_GRP,
		a.ASSET_TP_NM  asset_type,
		UPPER(ass.LOAN_ASSET_NM) TEN_TS,
		ass.REGISTRATION_DT NGAY_DKX,
		d.loan_status,
		l.fund_name,
		l.channel_code,
		l.term_frequency tenor_hd,
		ls.schedule_num,
		to_number(to_char(SCH_DT,'yyyymmdd')) sch_dt,
		ls.to_date,
		CASE WHEN LS.COMPLETED_PAID_DATE <= sch_dt THEN sch_dt
		WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') THEN LS.COMPLETED_PAID_DATE
		END PAID_DATE,
		l.LOAN_PKG_NM,
	 	---
	 	CASE WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100000 THEN 'GocHangKy'
	 		WHEN L.ORIGIN_PAYMENT_METHOD_WID = 100001 THEN 'GocGocKy' ELSE 'other' end PAYMENT_METHOD,
		CASE WHEN l.ctr_type = 'Mới' THEN l.ctr_type
				else COALESCE(ql.CTR_TYPE, l.ctr_type) END ctr_type ,
			l.shop_wid , SHOP.shop_nm , manager.province, manager.Trade_lead as Area,
		 	CASE WHEN l.ctr_type = 'Mới' THEN  sco.RANK  ELSE NULL END  a_score,
		 	sco.SCORE_INTERNAL AS INTERNAL_SCORE,
		 	b.RANK bscore_monthly,
		 	CASE
		 		WHEN mt.CUSTOMERSCORE >600 THEN '1. Tốt'
		 		WHEN mt.CUSTOMERSCORE >500 THEN '2. Khá'
		 		WHEN mt.CUSTOMERSCORE >399 THEN '3. Trung Bình'
		 		WHEN mt.CUSTOMERSCORE <400 THEN '4. Xấu'
		 		ELSE '5. Khác'
		 	END Bscore_gn,
		 	customerscore,
			----
		CASE WHEN d.dpd_from_date = d.yymm THEN 1 ELSE 0 END FLAG_DENHAN_B0,
		CASE
			 WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS < 0 THEN 'TẤT TOÁN HĐ TRƯỚC HẠN'
		     WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 AND D.SCH_DT > TO_DATE(P_DATE ,'YYYYMMDD') THEN 'CHƯA CẦN THU'
		     WHEN LS.COMPLETED_PAID_DATE IS NOT NULL AND LS.OVERDUE_DAYS = 0 THEN 'THU ĐÚNG HẠN'
			 WHEN TO_CHAR(LS.COMPLETED_PAID_DATE,'YYYYMM') = TO_CHAR(D.DATE_TM+1,'YYYYMM') AND LS.OVERDUE_DAYS > 0 THEN 'THU QUÁ HẠN'
			 WHEN D.SCH_DT > TO_DATE(P_DATE ,'YYYYMMDD') THEN 'CHƯA CẦN THU'
			 WHEN LS.LOAN_WID IS NULL THEN NULL
			 ELSE 'CHƯA THU ĐƯỢC'
		END COLLECTION_STATUS,
		CUS.GENDER_NM GIOI_TINH,
		substr(L.DISBURSE_DATE_WID,1,4) - TO_CHAR(CUS.BIRTH_DAY, 'YYYY')  CUSTOMER_AGE,
		lc.LOAI_HINH_CU_TRU ,
		lc.DISTANCE ,
		lc.RESIDENCE_TIME,
		house.HOUSE_STATUS_NM TINHTRANG_NOIO ,
		lc.JOB_NM,
		lc.NUMBER_OF_CHILD NgPehuThuoc,
		g.GRP_NM Marital_status,
		LC.MONTHLY_INCOME_VALUE INCOME,
		customer_income,
		INCOME_FINAL,
		CASE when cus.customer_income = '01' then '1.<5tr'
			when cus.customer_income = '02' then '2.5->8tr'
			when cus.customer_income = '03' then '3.8->10tr'
			when cus.customer_income = '04' THEN '4.10->15tr'
			when cus.customer_income = '05' THEN '5.15->25tr'
			when cus.customer_income = '06' then '6.25->45tr'
			when cus.customer_income = '07' then '7.>45tr'
			ELSE cus.customer_income END INCOME_GRP,
		pol.channel_code POL_CHANNEL_CODE,
		POL.SOURCE_LEVEL_1_NAME ,
		POL.SOURCE_LEVEL_2_NAME ,
		POL.SOURCE_LEVEL_3_NAME ,
		POL.SOURCE_LEVEL_4_NAME ,
       PRINCIPAL_AMT + ROUND(INTEREST_AMT *1.1,0) + NVL(PENALTY_AMT,0)+ NVL(FEE_CHARGES_AMOUNT,0) TONG_NGHIAVU,
		PRINCIPAL_AMT NGHIAVU_GOC,
		ROUND(INTEREST_AMT *1.1,0)  + NVL(PENALTY_AMT,0)+ NVL(FEE_CHARGES_AMOUNT,0) NGHIAVU_LAI_PHAT,
		nvl(principal_paid_amt,0) + nvl(interest_paid_amt,0) + nvl(PENALTY_CHARGES_PAID_AMT ,0) + nvl(FEE_CHARGES_PAID_AMT,0) TONG_PAID,
		nvl(principal_paid_amt,0)  GOC_PAID,
		nvl(interest_paid_amt,0) + nvl(PENALTY_CHARGES_PAID_AMT,0) + nvl(FEE_CHARGES_PAID_AMT,0)  LAI_Phi_PAID,
		nvl(INTEREST_WAIVED_DERIVED,0) + nvl(FEE_CHARGES_WAIVED_DERIVED,0) + nvl(PENALTY_CHARGES_WAIVED_DERIVED,0) TONG_waived
FROM F88DWH.W_LOAN_DTL_F l
	LEFT JOIN F88DWH.W_POL_DTL_F POL
		ON POL.LOAN_WID = L.LOAN_WID
		AND pol.STATUS_NM= 'Nhận cầm cố'
		and  pol.year_num > 2022 --and pol.date_wid >= 20231001 --nguon don
	LEFT JOIN f88dwh.W_CTR_TYPE_KHQL ql
		ON ql.LOAN_WID_NEW = l.loan_wid
	left join d
		on d.loan_wid = l.loan_wid
	LEFT JOIN F88DWH.W_LOAN_SCH_DTL_F LS
		ON d.LOAN_WID = LS.LOAN_WID
		AND D.SCH_DT = LS.TO_DATE
	LEFT JOIN f88dwh.W_LOAN_MASTER_F mt
		ON mt.loan_wid = l.loan_wid
	left join F88DWH.W_CUSTOMER_D cus
		on cus.customer_wid = l.customer_wid
		AND cus."SOURCE" = 'CIF'
	LEFT JOIN F88DWH.VW_W_LOAN_CUSTOMER_F lc
		ON lc.LOAN_WID = L.LOAN_WID
	LEFT JOIN F88DWH.W_HOUSE_STATUS_D house
		ON house.HOUSE_STATUS_WID = lc.HOUSE_STATUS_WID
	LEFT JOIN F88DWH.GRP g
		ON G.GRP_ID = lc.MARITAL_ID
	LEFT JOIN f88dwh.W_ASSET_TP_D a
		ON a.ASSET_TP_WID = l.ASSET_TYPE_WID
	LEFT JOIN F88DWH.W_LOAN_ASSET_F ass
		ON ass.LOAN_WID = l.LOAN_WID
	left join f88dwh.w_shop_d shop
		on shop.shop_wid = l.shop_wid
	left join f88dwh.w_area_manager_d manager
		on shop.shop_code = trim(manager.shop_id)
	left join f88dwh.w_loan_score_f sco
		on sco.loan_wid = l.loan_wid
	LEFT JOIN bscore b
		ON  d.YYMM = b.YYMM
		AND b.customer_code = l.customer_code
	WHERE
		a.CATEGORY_CODE in ('15','17','02')
		and l.disburse_date_wid > 20220531
		AND l.CREATED_USER NOT LIKE '%test%'
		AND L.COLLATERAL_AMT > 0
		)
		WHERE yymm = SUBSTR(P_DATE,1,6)
;

COMMIT;

END PROC_W_COHORT_QTRR;
```

### `F88DWH.PROC_W_POL_DTL_F` (PROCEDURE) — 7 lines reference search term

```
PROCEDURE        PROC_W_POL_DTL_F (P_DATE NUMBER)
IS
BEGIN

---------------------

--- 0. Delete old data
DELETE /*+ PARALLEL(10) */
FROM F88DWH.W_POL_DTL_F
WHERE POL_WID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);

COMMIT;

---------------------

--- 1. Insert data from ONLINE_PAWN
INSERT /*+PARALLEL(6) */ INTO F88DWH.W_POL_DTL_F (
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        POL_WID,
        STATUS,
        STATUS_NM,
        FORM_ASSET_TP_NM,
        LOAN_ASSET_TP_NM,
        AREA_WID,
        PROVINCE_WID,
        DISTRICT_WID,
        AREA,
        PROVINCE,
        DISTRICT,
        EMPLOYEE_WID,
        EMPLOYEE_NM,
        SHOP_WID,
        SHOP_NM,
        GROUP_ID,
        GROUP_NM,
        GROUP_ID_HIST,
        POL_CUS_WID,
        CALLER_SHOP_WID,
        CALLER_ONLINE_WID,
        PAWN_ID,
        REASON_WID,
        REASON_NM,
        CAMPAIGN_WID,
        CAMPAIGN_NM,
        SOURCE_LEVEL_1_ID,
        SOURCE_LEVEL_2_ID,
        SOURCE_LEVEL_3_ID,
        SOURCE_LEVEL_4_ID,
        SOURCE_LEVEL_1_NAME,
        SOURCE_LEVEL_2_NAME,
        SOURCE_LEVEL_3_NAME,
        SOURCE_LEVEL_4_NAME,
        FORM_CREATED_DT,
        TRANS_TO_SHOP_DT,
        CANCEL_DT,
        FIRST_CALL_DT,
        LAST_CALL_DT,
        LNG_CALL_BACK,
        IS_NOT_CONTROL,
        URL,
        REFERENCE_ID,
        FIRST_SHOP_TRANS_DT,
        LOAN_CODE,
        LOAN_WID,
        DISBURSE_DT,
        DISBURSE_AMT,
        CLOSED_DT,
        LAST_PROCESS_DT,
        LAST_PROCESS_REASON_NM,
        LAST_PROCESS_REASON_TYPE,
        CTR_TYPE,
        CHANNEL_CODE,
        FIRST_OP_DT,
        OLD_SOURCE,
        BRAND_IDENTITY_NM,
        FIRST_FORWARD_DT,
        FIRST_REEXPLOIT_DT,
        LAST_PROCESS_NOTE,
        FIRST_APPROVE_DT,
        FIRST_TLS_GROUP_NM,
        LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD_EMPLOYEE_NM,
        FIRST_GROUP_NM,
        PAWN_WID
        )
SELECT /*+PARALLEL(6) */TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'YYYY')) YEAR_NUM,
        TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'MM')) MONTH_NUM,
        wopf.CREATED_DT,
        wopf.INTEGRATION_ID POL_WID,
        wopf.STATUS,
        CASE wopf.STATUS WHEN 1 THEN 'Chưa chia'
                WHEN 2 THEN 'Chưa tư vấn'
                WHEN 3 THEN 'Đang chăm sóc'
                WHEN 4 THEN 'Hủy đăng ký'
                WHEN 5 THEN 'Nhận cầm cố'
                WHEN 13 THEN 'Chưa chia TNKH'
                ELSE 'Không xác định' END STATUS_NM,
        --wopf.ASSET_TP_WID,
        watd.ASSET_TP_NM FORM_ASSET_TP_NM,
        watd2.ASSET_TP_NM LOAN_ASSET_TP_NM,
        --wopf.CHANNEL_WID,
        wopf.AREA_WID,
        wopf.PROVINCE_WID,
        wopf.DISTRICT_WID,
        wad.AREA_NM AREA,
        wpd.POL_REGION_NM PROVINCE,
        wdd.POL_REGION_NM DISTRICT,
        wopf.EMPLOYEE_WID,
        wed.EMPLOYEE_NM,
        wopf.SHOP_WID,
        wsd.SHOP_NM,
        wogd.ID GROUP_ID,
        wogd.GROUP_NM,
        SUBSTR(wopf.GROUP_IDS_REVEICED,1,1000),
        wopf.POL_CUS_WID,
        wopf.CALLER_SHOP_WID,
        wopf.CALLER_ONLINE_WID,
        wopf.PAWN_ID,
        wopf.REASON_WID,
--        NULL REASON_NM, --Namdhh hotfix tạm thời 20240803
        worfd.CANCELED_REASON_NM,
        wopf.CAMPAIN_EXCEL_WID CAMPAIN_WID,
        wocd.CAMPAIGN_NM,
        wosd1.INTEGRATION_ID SOURCE_LEVEL_1_ID,
        wopf.GROUP_SOURCE_ID SOURCE_LEVEL_2_ID,
        wopf.SOURCE_ID SOURCE_LEVEL_3_ID,
        wopf.SEC_SOURCE_ID SOURCE_LEVEL_4_ID,
        wosd1.STR_NAME SOURCE_LEVEL_1_NAME,
        wosd2.STR_NAME SOURCE_LEVEL_2_NAME,
        wosd3.STR_NAME SOURCE_LEVEL_3_NAME,
        wosd4.STR_NAME SOURCE_LEVEL_4_NAME,
        TO_DATE(wopf.CREATED_DT || LPAD(wopf.CREATED_TIME, 6, 0), 'YYYYMMDDHH24MISS') FORM_CREATED_DT,
        TO_DATE(DECODE(wopf.TRANS_TO_SHOP_DT, -1, NULL, wopf.TRANS_TO_SHOP_DT || DECODE(wopf.TRANS_TO_SHOP_TIME, -1, '000000', LPAD(wopf.TRANS_TO_SHOP_TIME, 6, 0))), 'YYYYMMDDHH24MISS') TRANS_TO_SHOP_DT,
        CASE WHEN LENGTH(wopf.CANCEL_DT) = 10 THEN TO_DATE(wopf.CANCEL_DT || '0000', 'YYYYMMDDHH24MISS')
                ELSE NULL END CANCEL_DT,
        TO_DATE(DECODE(wopf.FIRST_CALL_DT, -1, NULL, wopf.FIRST_CALL_DT), 'YYYYMMDDHH24MISS') FIRST_CALL_DT,
        TO_DATE(DECODE(wopf.LAST_CALL_DT, -1, NULL, wopf.LAST_CALL_DT), 'YYYYMMDDHH24MISS') LAST_CALL_DT,
        CASE WHEN LENGTH(wopf.LNG_CALL_BACK) = 14 THEN TO_DATE(wopf.LNG_CALL_BACK, 'YYYYMMDDHH24MISS')
                ELSE NULL END LNG_CALL_BACK,
        wopf.ISNOTCONTROL IS_NOT_CONTROL,
        wopf.URL,
        wopf.REFERENCE_AFFILATE_ID REFERENCE_ID,
        TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS') FIRST_SHOP_TRANS_DT,
        --NULL FIRST_SHOP_TRANS_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_CODE ELSE wldf2.LOAN_CODE END LOAN_CODE,
        wopf.LOAN_CODE,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_WID ELSE wldf2.LOAN_WID END LOAN_WID,
        wldf.LOAN_WID,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_DATE_WID ELSE wldf2.DISBURSE_DATE_WID END DISBURSE_DT,
        wldf.DISBURSE_DATE_WID DISBURSE_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_AMT ELSE wldf2.DISBURSE_AMT END DISBURSE_AMT,
        wldf.DISBURSE_AMT,
        wldf.CLOSED_DATE_WID CLOSED_DT,
        last_op.LAST_OP_DT LAST_PROCESS_DT,
        last_op.LAST_OP_REASON_NM LAST_PROCESS_REASON_NM,
        last_op.LAST_OP_REASON_TYPE LAST_PROCESS_REASON_TYPE,
        wldf.CTR_TYPE,
        wldf.CHANNEL_CODE,
        TO_DATE(first_op.FIRST_OP_DT, 'YYYYMMDDHH24MISS') FIRST_OP_DT,
        old_source.OLD_SOURCE,
        wpbid.POL_BRAND_IDENTITY_NAME BRAND_IDENTITY_NM,
        FIRST_FORWARD.PROCESS_DT FIRST_FORWARD_DT,
        FIRST_REEXPLOIT.PROCESS_DT FIRST_REEXPLOIT_DT,
        last_op.LAST_OP_NOTE LAST_PROCESS_NOTE,
        first_approve.PROCESS_DT FIRST_APPROVE_DT,
        first_tls_process.GROUP_NM FIRST_TLS_GROUP_NM,
        LAST_FORWARD.EMPLOYEE_CODE LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD.EMPLOYEE_NM LAST_FORWARD_EMPLOYEE_NM,
        wogd2.GROUP_NM FIRST_GROUP_NM,
        p.PAWN_WID
FROM F88DWH.W_ONLINE_PAWN_F wopf
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wopf.LOAN_CODE = wldf.LOAN_CODE
LEFT JOIN F88DWH.W_PAWN_F p
        ON wopf.LOAN_CODE = p.CODE_NO
                AND p.LEGACY_SYSTEM_FLAG = 0
/*
LEFT JOIN F88DWH.W_LOAN_MASTER_F wlmf
        ON wopf.PAWN_ID = wlmf.INTEGRATION_ID
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wlmf.LOAN_WID = wldf.LOAN_WID
                AND wldf.SOURCE = 'MIFOS'
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf2
        ON wopf.PAWN_ID = wldf2.INTEGRATION_ID
                AND wldf2.SOURCE = 'POS'
*/
LEFT JOIN F88DWH.W_ASSET_TP_D watd
        ON wopf.ASSET_TP_WID = watd.ASSET_TP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D watd2
        ON wldf.ASSET_TYPE_WID = watd2.ASSET_TP_WID
LEFT JOIN F88DWH.W_AREA_D wad
        ON wopf.AREA_WID = wad.AREA_WID
LEFT JOIN F88DWH.W_POL_REGION_D wpd
        ON wopf.PROVINCE_WID = wpd.POL_REGION_WID
LEFT JOIN F88DWH.W_POL_REGION_D wdd
        ON wopf.DISTRICT_WID = wdd.POL_REGION_WID
LEFT JOIN F88DWH.W_EMPLOYEE_D wed
        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
LEFT JOIN F88DWH.W_SHOP_D wsd
        ON wopf.SHOP_WID = wsd.SHOP_WID
LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE id <> 'TLS') wogd
        ON wopf.ONLINE_GRP_WID = wogd.ONLINE_GRP_WID
LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
LEFT JOIN F88DWH.W_ONLINE_CAMPAIGN_D wocd
        ON wopf.CAMPAIN_EXCEL_WID = wocd.CAMPAIGN_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd1
        ON wopf.CHANNEL_WID = wosd1.ONLINE_SOURCE_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd2
        ON wopf.GROUP_SOURCE_ID = wosd2.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd3
        ON wopf.SOURCE_ID = wosd3.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd4
        ON wopf.SEC_SOURCE_ID = wosd4.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_GRP_D wogd2
        ON wopf.FIRST_GROUP_WID = wogd2.ONLINE_GRP_WID
--/*
LEFT JOIN
        (
        SELECT /*+PARALLEL(4) */ INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE upper(trim(id)) <> 'TLS') g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and to_number(NULLIF(g1.id, 'TLS')) >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                AND t.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON wopf.INTEGRATION_ID = shop_trans.INT_POL_PAWN_ID
--*/
LEFT JOIN (
        SELECT /*+PARALLEL(4) */ INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_OP_DT
        FROM F88DWH.W_ONLINE_PROCESS_F op
        LEFT JOIN F88DWH.w_online_grp_d wogd
                ON op.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
        WHERE 1=1
                AND op.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND wogd.ID <> '44'
        GROUP BY INT_POL_PAWN_ID
        ) first_op
        ON wopf.INTEGRATION_ID = first_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT POL_WID,
                GROUP_NM
        FROM (
                SELECT /*+PARALLEL(4) */ wopf.INT_POL_PAWN_ID POL_WID,
                        wogd.GROUP_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_tls_process
        ON wopf.INTEGRATION_ID = first_tls_process.POL_WID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE,
                OP_NOTE LAST_OP_NOTE
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd.CANCELED_REASON_NM OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        wopf.NOTE OP_NOTE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) last_op
        ON wopf.INTEGRATION_ID = last_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OLD_SOURCE
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID,
                        wopf.NOTE OLD_SOURCE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 158
                        AND wopf.NOTE LIKE 'Nguồn cũ%'
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) old_source
        ON wopf.INTEGRATION_ID = old_source.INT_POL_PAWN_ID
LEFT JOIN F88DWH.W_POL_BRAND_IDENTITY_D wpbid
        ON wopf.BRAND_IDENTITY_WID = wpbid.POL_BRAND_IDENTITY_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_FORWARD
        ON wopf.INTEGRATION_ID = FIRST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT,
                EMPLOYEE_CODE,
                EMPLOYEE_NM
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        wed.EMPLOYEE_CODE,
                        wed.EMPLOYEE_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                LEFT JOIN F88DWH.W_EMPLOYEE_D wed
                        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) LAST_FORWARD
        ON wopf.INTEGRATION_ID = LAST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 137
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_REEXPLOIT
        ON wopf.INTEGRATION_ID = FIRST_REEXPLOIT.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 179
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_approve
        ON wopf.INTEGRATION_ID = first_approve.POL_WID
WHERE 1=1
        --AND wopf.STATUS IN (1, 2, 3, 4, 5, 13)
        AND wopf.INTEGRATION_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);

COMMIT;

---------------------

--- 2. Update data from ONLINE_PROCESS
-- 2.1. Update first shop trans
/*
MERGE
INTO F88DWH.W_POL_DTL_F wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN F88DWH.w_online_grp_d g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and g1.id >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                --AND t.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                --AND t.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                --AND t.DATE_WID = P_DATE
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON (wpdf.POL_WID = shop_trans.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.FIRST_SHOP_TRANS_DT = TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS')
WHERE wpdf.FIRST_SHOP_TRANS_DT IS NULL;

COMMIT;
*/

-- 2.2. Update last process info
/*
MERGE
INTO F88DWH.W_POL_DTL_F wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd. OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                        AND wopf.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                        AND wopf.DATE_WID = P_DATE
                )
        WHERE RN = 1
        ) wopf
        ON (wpdf.POL_WID = wopf.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.LAST_PROCESS_DT = wopf.LAST_OP_DT,
                wpdf.LAST_PROCESS_REASON_NM = wopf.LAST_OP_REASON_NM,
                wpdf.LAST_PROCESS_REASON_TYPE = wopf.LAST_OP_REASON_TYPE;

COMMIT;
*/

-- 2.3. Clean up data
/*
DELETE FROM F88DWH.W_POL_DTL_F
WHERE POL_WID IN (
        SELECT ID FROM STGPROD.POL_PAWN_V2_TMP
        WHERE INT_STATUS NOT IN (1, 2, 3, 4, 5, 13)
);
*/

COMMIT;

---------------------

END PROC_W_POL_DTL_F;
```

### `F88DWH.PROC_W_POL_DTL_F_LOG` (PROCEDURE) — 8 lines reference search term

```
PROCEDURE        PROC_W_POL_DTL_F_LOG (P_DATE NUMBER)
IS
BEGIN

-------------------------

--- 0. Delete old data
--DELETE /*+ PARALLEL(10) */
--FROM F88DWH.W_POL_DTL_F_LOG
--WHERE POL_WID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);
UPDATE F88DWH.W_POL_DTL_F_LOG SET active = 0,TIME_JOB = SYSDATE -1 WHERE POL_WID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP  WHERE INT_STATUS NOT IN (1, 2, 3, 4, 5, 13));

COMMIT;

---------------------

--- 1. Insert data from ONLINE_PAWN
INSERT INTO F88DWH.W_POL_DTL_F_LOG (
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        POL_WID,
        STATUS,
        STATUS_NM,
        FORM_ASSET_TP_NM,
        LOAN_ASSET_TP_NM,
        AREA_WID,
        PROVINCE_WID,
        DISTRICT_WID,
        AREA,
        PROVINCE,
        DISTRICT,
        EMPLOYEE_WID,
        EMPLOYEE_NM,
        SHOP_WID,
        SHOP_NM,
        GROUP_ID,
        GROUP_NM,
        GROUP_ID_HIST,
        POL_CUS_WID,
        CALLER_SHOP_WID,
        CALLER_ONLINE_WID,
        PAWN_ID,
        REASON_WID,
        REASON_NM,
        CAMPAIGN_WID,
        CAMPAIGN_NM,
        SOURCE_LEVEL_1_ID,
        SOURCE_LEVEL_2_ID,
        SOURCE_LEVEL_3_ID,
        SOURCE_LEVEL_4_ID,
        SOURCE_LEVEL_1_NAME,
        SOURCE_LEVEL_2_NAME,
        SOURCE_LEVEL_3_NAME,
        SOURCE_LEVEL_4_NAME,
        FORM_CREATED_DT,
        TRANS_TO_SHOP_DT,
        CANCEL_DT,
        FIRST_CALL_DT,
        LAST_CALL_DT,
        LNG_CALL_BACK,
        IS_NOT_CONTROL,
        URL,
        REFERENCE_ID,
        FIRST_SHOP_TRANS_DT,
        LOAN_CODE,
        LOAN_WID,
        DISBURSE_DT,
        DISBURSE_AMT,
        CLOSED_DT,
        LAST_PROCESS_DT,
        LAST_PROCESS_REASON_NM,
        LAST_PROCESS_REASON_TYPE,
        CTR_TYPE,
        CHANNEL_CODE,
        FIRST_OP_DT,
        OLD_SOURCE,
        BRAND_IDENTITY_NM,
        FIRST_FORWARD_DT,
        FIRST_REEXPLOIT_DT,
        LAST_PROCESS_NOTE,
        FIRST_APPROVE_DT,
        FIRST_TLS_GROUP_NM,
        LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD_EMPLOYEE_NM,
        FIRST_GROUP_NM,
        active
        )
SELECT TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'YYYY')) YEAR_NUM,
        TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'MM')) MONTH_NUM,
        wopf.CREATED_DT,
        wopf.INTEGRATION_ID POL_WID,
        wopf.STATUS,
        CASE wopf.STATUS WHEN 1 THEN 'Chưa chia'
                WHEN 2 THEN 'Chưa tư vấn'
                WHEN 3 THEN 'Đang chăm sóc'
                WHEN 4 THEN 'Hủy đăng ký'
                WHEN 5 THEN 'Nhận cầm cố'
                WHEN 13 THEN 'Chưa chia TNKH'
                ELSE 'Không xác định' END STATUS_NM,
        --wopf.ASSET_TP_WID,
        watd.ASSET_TP_NM FORM_ASSET_TP_NM,
        watd2.ASSET_TP_NM LOAN_ASSET_TP_NM,
        --wopf.CHANNEL_WID,
        wopf.AREA_WID,
        wopf.PROVINCE_WID,
        wopf.DISTRICT_WID,
        wad.AREA_NM AREA,
        wpd.POL_REGION_NM PROVINCE,
        wdd.POL_REGION_NM DISTRICT,
        wopf.EMPLOYEE_WID,
        wed.EMPLOYEE_NM,
        wopf.SHOP_WID,
        wsd.SHOP_NM,
        wogd.ID GROUP_ID,
        wogd.GROUP_NM,
        wopf.GROUP_IDS_REVEICED,
        wopf.POL_CUS_WID,
        wopf.CALLER_SHOP_WID,
        wopf.CALLER_ONLINE_WID,
        wopf.PAWN_ID,
        wopf.REASON_WID,
--        NULL REASON_NM, --Namdhh hotfix tạm thời 20240803
        worfd.CANCELED_REASON_NM,
        wopf.CAMPAIN_EXCEL_WID CAMPAIN_WID,
        wocd.CAMPAIGN_NM,
        wosd1.INTEGRATION_ID SOURCE_LEVEL_1_ID,
        wopf.GROUP_SOURCE_ID SOURCE_LEVEL_2_ID,
        wopf.SOURCE_ID SOURCE_LEVEL_3_ID,
        wopf.SEC_SOURCE_ID SOURCE_LEVEL_4_ID,
        wosd1.STR_NAME SOURCE_LEVEL_1_NAME,
        wosd2.STR_NAME SOURCE_LEVEL_2_NAME,
        wosd3.STR_NAME SOURCE_LEVEL_3_NAME,
        wosd4.STR_NAME SOURCE_LEVEL_4_NAME,
        TO_DATE(wopf.CREATED_DT || LPAD(wopf.CREATED_TIME, 6, 0), 'YYYYMMDDHH24MISS') FORM_CREATED_DT,
        TO_DATE(DECODE(wopf.TRANS_TO_SHOP_DT, -1, NULL, wopf.TRANS_TO_SHOP_DT || DECODE(wopf.TRANS_TO_SHOP_TIME, -1, '000000', LPAD(wopf.TRANS_TO_SHOP_TIME, 6, 0))), 'YYYYMMDDHH24MISS') TRANS_TO_SHOP_DT,
        CASE WHEN LENGTH(wopf.CANCEL_DT) = 10 THEN TO_DATE(wopf.CANCEL_DT || '0000', 'YYYYMMDDHH24MISS')
                ELSE NULL END CANCEL_DT,
        TO_DATE(DECODE(wopf.FIRST_CALL_DT, -1, NULL, wopf.FIRST_CALL_DT), 'YYYYMMDDHH24MISS') FIRST_CALL_DT,
        TO_DATE(DECODE(wopf.LAST_CALL_DT, -1, NULL, wopf.LAST_CALL_DT), 'YYYYMMDDHH24MISS') LAST_CALL_DT,
        CASE WHEN LENGTH(wopf.LNG_CALL_BACK) = 14 THEN TO_DATE(wopf.LNG_CALL_BACK, 'YYYYMMDDHH24MISS')
                ELSE NULL END LNG_CALL_BACK,
        wopf.ISNOTCONTROL IS_NOT_CONTROL,
        wopf.URL,
        wopf.REFERENCE_AFFILATE_ID REFERENCE_ID,
        TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS') FIRST_SHOP_TRANS_DT,
        --NULL FIRST_SHOP_TRANS_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_CODE ELSE wldf2.LOAN_CODE END LOAN_CODE,
        wopf.LOAN_CODE,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_WID ELSE wldf2.LOAN_WID END LOAN_WID,
        wldf.LOAN_WID,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_DATE_WID ELSE wldf2.DISBURSE_DATE_WID END DISBURSE_DT,
        wldf.DISBURSE_DATE_WID DISBURSE_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_AMT ELSE wldf2.DISBURSE_AMT END DISBURSE_AMT,
        wldf.DISBURSE_AMT,
        wldf.CLOSED_DATE_WID CLOSED_DT,
        last_op.LAST_OP_DT LAST_PROCESS_DT,
       -- NULL LAST_PROCESS_REASON_NM, --Namdhh hotfix tạm thời 20240803
        last_op.LAST_OP_REASON_NM LAST_PROCESS_REASON_NM,
        last_op.LAST_OP_REASON_TYPE LAST_PROCESS_REASON_TYPE,
        wldf.CTR_TYPE,
        wldf.CHANNEL_CODE,
        TO_DATE(first_op.FIRST_OP_DT, 'YYYYMMDDHH24MISS') FIRST_OP_DT,
        old_source.OLD_SOURCE,
        wpbid.POL_BRAND_IDENTITY_NAME BRAND_IDENTITY_NM,
        FIRST_FORWARD.PROCESS_DT FIRST_FORWARD_DT,
        FIRST_REEXPLOIT.PROCESS_DT FIRST_REEXPLOIT_DT,
        last_op.LAST_OP_NOTE LAST_PROCESS_NOTE,
        first_approve.PROCESS_DT FIRST_APPROVE_DT,
        first_tls_process.GROUP_NM FIRST_TLS_GROUP_NM,
        LAST_FORWARD.EMPLOYEE_CODE LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD.EMPLOYEE_NM LAST_FORWARD_EMPLOYEE_NM,
        wogd2.GROUP_NM FIRST_GROUP_NM,
        1 AS ACTIVE
FROM F88DWH.W_ONLINE_PAWN_F wopf
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wopf.LOAN_CODE = wldf.LOAN_CODE
/*
LEFT JOIN F88DWH.W_LOAN_MASTER_F wlmf
        ON wopf.PAWN_ID = wlmf.INTEGRATION_ID
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wlmf.LOAN_WID = wldf.LOAN_WID
                AND wldf.SOURCE = 'MIFOS'
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf2
        ON wopf.PAWN_ID = wldf2.INTEGRATION_ID
                AND wldf2.SOURCE = 'POS'
*/
LEFT JOIN F88DWH.W_ASSET_TP_D watd
        ON wopf.ASSET_TP_WID = watd.ASSET_TP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D watd2
        ON wldf.ASSET_TYPE_WID = watd2.ASSET_TP_WID
LEFT JOIN F88DWH.W_AREA_D wad
        ON wopf.AREA_WID = wad.AREA_WID
LEFT JOIN F88DWH.W_POL_REGION_D wpd
        ON wopf.PROVINCE_WID = wpd.POL_REGION_WID
LEFT JOIN F88DWH.W_POL_REGION_D wdd
        ON wopf.DISTRICT_WID = wdd.POL_REGION_WID
LEFT JOIN F88DWH.W_EMPLOYEE_D wed
        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
LEFT JOIN F88DWH.W_SHOP_D wsd
        ON wopf.SHOP_WID = wsd.SHOP_WID
LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE id <> 'TLS') wogd
        ON wopf.ONLINE_GRP_WID = wogd.ONLINE_GRP_WID
LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
LEFT JOIN F88DWH.W_ONLINE_CAMPAIGN_D wocd
        ON wopf.CAMPAIN_EXCEL_WID = wocd.CAMPAIGN_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd1
        ON wopf.CHANNEL_WID = wosd1.ONLINE_SOURCE_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd2
        ON wopf.GROUP_SOURCE_ID = wosd2.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd3
        ON wopf.SOURCE_ID = wosd3.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd4
        ON wopf.SEC_SOURCE_ID = wosd4.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_GRP_D wogd2
        ON wopf.FIRST_GROUP_WID = wogd2.ONLINE_GRP_WID
--/*
LEFT JOIN
        (
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE upper(trim(id)) <> 'TLS') g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and to_number(NULLIF(g1.id, 'TLS')) >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                AND t.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON wopf.INTEGRATION_ID = shop_trans.INT_POL_PAWN_ID
--*/
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_OP_DT
        FROM F88DWH.W_ONLINE_PROCESS_F op
        LEFT JOIN F88DWH.w_online_grp_d wogd
                ON op.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
        WHERE 1=1
                AND op.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND wogd.ID <> '44'
        GROUP BY INT_POL_PAWN_ID
        ) first_op
        ON wopf.INTEGRATION_ID = first_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT POL_WID,
                GROUP_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        wogd.GROUP_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_tls_process
        ON wopf.INTEGRATION_ID = first_tls_process.POL_WID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE,
                OP_NOTE LAST_OP_NOTE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd.CANCELED_REASON_NM OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        wopf.NOTE OP_NOTE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) last_op
        ON wopf.INTEGRATION_ID = last_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OLD_SOURCE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        wopf.NOTE OLD_SOURCE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 158
                        AND wopf.NOTE LIKE 'Nguồn cũ%'
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) old_source
        ON wopf.INTEGRATION_ID = old_source.INT_POL_PAWN_ID
LEFT JOIN F88DWH.W_POL_BRAND_IDENTITY_D wpbid
        ON wopf.BRAND_IDENTITY_WID = wpbid.POL_BRAND_IDENTITY_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_FORWARD
        ON wopf.INTEGRATION_ID = FIRST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT,
                EMPLOYEE_CODE,
                EMPLOYEE_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        wed.EMPLOYEE_CODE,
                        wed.EMPLOYEE_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                LEFT JOIN F88DWH.W_EMPLOYEE_D wed
                        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) LAST_FORWARD
        ON wopf.INTEGRATION_ID = LAST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 137
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_REEXPLOIT
        ON wopf.INTEGRATION_ID = FIRST_REEXPLOIT.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 179
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_approve
        ON wopf.INTEGRATION_ID = first_approve.POL_WID
WHERE wopf.STATUS IN (1, 2, 3, 4, 5, 13)
        AND wopf.INTEGRATION_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);

COMMIT;

---------------------

--- 2. Update data from ONLINE_PROCESS
-- 2.1. Update first shop trans
/*
MERGE
INTO F88DWH.W_POL_DTL_F_LOG wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN F88DWH.w_online_grp_d g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and g1.id >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                --AND t.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                --AND t.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                --AND t.DATE_WID = P_DATE
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON (wpdf.POL_WID = shop_trans.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.FIRST_SHOP_TRANS_DT = TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS')
WHERE wpdf.FIRST_SHOP_TRANS_DT IS NULL;

COMMIT;
*/

-- 2.2. Update last process info
/*
MERGE
INTO F88DWH.W_POL_DTL_F_LOG wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd. OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                        AND wopf.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                        AND wopf.DATE_WID = P_DATE
                )
        WHERE RN = 1
        ) wopf
        ON (wpdf.POL_WID = wopf.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.LAST_PROCESS_DT = wopf.LAST_OP_DT,
                wpdf.LAST_PROCESS_REASON_NM = wopf.LAST_OP_REASON_NM,
                wpdf.LAST_PROCESS_REASON_TYPE = wopf.LAST_OP_REASON_TYPE;

COMMIT;
*/

-- 2.3. ghi logs
UPDATE F88DWH.W_POL_DTL_F_LOG SET active = 0,TIME_JOB = SYSDATE -1 WHERE POL_WID IN (
        SELECT ID FROM STGPROD.POL_PAWN_V2_TMP
        WHERE INT_STATUS NOT IN (1, 2, 3, 4, 5, 13)
);


COMMIT;

---------------------

END PROC_W_POL_DTL_F_LOG;
```

### `F88DWH.PROC_W_POL_FORM_F_DAILY` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE        PROC_W_POL_FORM_F_DAILY (P_DATE NUMBER)
IS
BEGIN

-- 1. Delete stale data if any
DELETE
FROM F88DWH.W_POL_FORM_F
WHERE CAMPAIGN_ID = 22306
        AND DATE_WID = P_DATE;

COMMIT;

-- 2. Insert new data
INSERT INTO F88DWH.W_POL_FORM_F (
        ID,
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        TYPE_PAWN,
        POL_TYPE,
        SYS_ID,
        CHANNEL_ID,
        GROUP_SOURCE_ID,
        SOURCE_ID,
        CAMPAIGN_ID,
        SHOP_CODE,
        DESCRIPTION,
        CUSTOMER_NM,
        PHONE_NUM,
        MAIL_ADDRESS,
        IDENTITY_NUM,
        IDENTITY_TYPE,
        GENDER,
        PROVINCE,
        REGION,
        ADDRESS,
        DISBURSE_AMT,
        TOPUP_AMT,
        CODENO,
        CUSTOMER_CODE,
        CATEGORY
        )
SELECT
        ID,
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        'Đơn hủy' TYPE_PAWN,
        POL_TYPE,
        1 SYS_ID,
        2 CHANNEL_ID,
        GROUP_SOURCE_ID,
        SOURCE_ID,
        CAMPAIGN_ID,
        SHOP_CODE,
        NULL DESCRIPTION,
        CUSTOMER_NM,
        PHONE_NUM,
        NULL MAIL_ADDRESS,
        NULL IDENTITY_NUM,
        NULL IDENTITY_TYPE,
        GENDER,
        NULL PROVINCE,
        NULL REGION,
        NULL ADDRESS,
        DISBURSE_AMT,
        NULL TOPUP_AMT,
        CODENO,
        CUSTOMER_CODE,
        NULL CATEGORY
                FROM
                        (
                        SELECT
                                NULL ID,
                            TO_NUMBER(SUBSTR(QO.DATE_WID,1,4)) YEAR_NUM,
                            TO_NUMBER(SUBSTR(QO.DATE_WID,5,2)) MONTH_NUM,
                            QO.DATE_WID,
                            TO_NUMBER(SHOPD.SHOP_CODE_NEW) SHOP_CODE,
                            QO.CUSTOMERNAME CUSTOMER_NM,
                            QO.CUSTOMERPHONE PHONE_NUM,
                            QO.GENDERNAME GENDER,
                            QO.PRICELOAN DISBURSE_AMT,
                            QO.CODENO CODENO,
                            QO.CUSTOMERCODE CUSTOMER_CODE,
                            a.status,
                            CASE WHEN TO_NUMBER(CAM.INTEGRATION_ID) IS NOT NULL THEN TO_NUMBER(CAM.INTEGRATION_ID)
                                        ELSE 22306
                                END  CAMPAIGN_ID,
                                CASE WHEN A.SOURCE_LEVEL_1_ID IS NOT NULL THEN A.SOURCE_LEVEL_3_ID
                                        WHEN A.SOURCE_LEVEL_1_ID IS NULL AND MOD(ROW_NUMBER() OVER(ORDER BY nvl(a.DATE_WID,qo.DATE_WID )),2)=0 THEN 342
                                        ELSE 347
                                END SOURCE_ID,
                                CASE WHEN A.SOURCE_LEVEL_1_ID IS NOT NULL THEN A.SOURCE_LEVEL_1_ID
                                        WHEN A.SOURCE_LEVEL_1_ID IS NULL AND MOD(ROW_NUMBER() OVER(ORDER BY nvl(a.DATE_WID,qo.DATE_WID )),2)=0 THEN 9
                                        ELSE 8
                                END GROUP_SOURCE_ID,
                                CASE WHEN A.SOURCE_LEVEL_1_ID IS NOT NULL THEN 33
                                        ELSE 7
                                END POL_TYPE,
                                row_number() OVER (PARTITION BY  QO.CUSTOMERPHONE ORDER BY nvl(A.DATE_WID,qo.DATE_WID) desc) ROW_N
                        FROM F88DWH.W_LOAN_QUICKOFFER_F QO
                        LEFT JOIN F88DWH.w_online_cus_contact_d pcd
                                ON QO.CUSTOMERPHONE=PCD.CONTACT
                                        AND pcd.contact_type =1
                        LEFT JOIN F88DWH.W_POL_DTL_F a
                                ON a.POL_CUS_WID = pcd.POL_CUS_WID
                                        AND A.DATE_WID < to_char(to_date(qo.DATE_WID,'yyyymmdd') - 30 ,'yyyymmdd')
                                        AND A.DATE_WID > to_char(to_date(qo.DATE_WID,'yyyymmdd') - 365 ,'yyyymmdd')
                        LEFT JOIN F88DWH.W_ONLINE_CAMPAIGN_D cam
                                ON a.CAMPAIGN_WID=cam.CAMPAIGN_WID
                        LEFT JOIN F88DWH.W_SHOP_D s
                                ON QO.SHOP_WID = S.SHOP_WID
                        LEFT JOIN F88DWH.W_AREA_MANAGER_D ar
                                ON S.SHOP_CODE = ar.SHOP_ID AND S.CRN_ROW_IND = 1 AND S.SHOP_TYPE = 'F88'
                        LEFT JOIN HANHDTM.TNKH_SHOP_QO SHOPD
                                ON S.SHOP_CODE = to_char(SHOPD.SHOP_CODE)
                        WHERE 1=1
                              AND QO.PARTNERLOANSTATUS IN ('CANCELLED', 'REJECTED')
                              AND AR.FLAG = 'Active'
                              AND QO.DATE_WID = P_DATE
                              AND NOT EXISTS (SELECT 1 FROM (
                                        SELECT DISTINCT(lp.PHONE) PHONE
                                    FROM F88DWH.W_LOAN_DTL_F dtl
                                    LEFT JOIN F88DWH.W_LOAN_CUSTOMER_F lc
                                        ON dtl.LOAN_WID = lc.LOAN_WID
                                    LEFT JOIN F88dwh.W_LOAN_CUSTOMER_PHONE_F lp
                                        ON lc.INTEGRATION_ID = lp.LOAN_CUSTOMER_ID
                                    WHERE dtl.STATUS = 300
                                    ) LOS WHERE QO.CUSTOMERPHONE = LOS.PHONE)
                               AND NOT EXISTS (SELECT 1 FROM W_LOAN_LOG_FAILURE_F NKTB WHERE NKTB.DATE_WID = P_DATE AND QO.CUSTOMERPHONE = NKTB.PHONE)
                                )
WHERE ROW_N = 1
        AND shop_code IS NOT NULL
        AND (STATUS=4 OR STATUS IS NULL)  ;

COMMIT;

DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT PROC_POL_FORM'||TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

END PROC_W_POL_FORM_F_DAILY;
```

### `F88DWH.PROC_W_POL_FORM_F_MONTHLY` (PROCEDURE) — 2 lines reference search term

```
PROCEDURE        PROC_W_POL_FORM_F_MONTHLY (P_DATE NUMBER)
IS
BEGIN

--Digital HO
DELETE
FROM F88DWH.W_POL_FORM_F
WHERE CAMPAIGN_ID = 22287
        AND DATE_WID = P_DATE;

COMMIT;

INSERT INTO F88DWH.W_POL_FORM_F (
    ID,
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        TYPE_PAWN,
        POL_TYPE,
        SYS_ID,
        CHANNEL_ID,
        GROUP_SOURCE_ID,
        SOURCE_ID,
        CAMPAIGN_ID,
        SHOP_CODE,
        DESCRIPTION,
        CUSTOMER_NM,
        PHONE_NUM,
        MAIL_ADDRESS,
        IDENTITY_NUM,
        IDENTITY_TYPE,
        GENDER,
        PROVINCE,
        REGION,
        ADDRESS,
        DISBURSE_AMT,
        TOPUP_AMT,
        CODENO,
        CUSTOMER_CODE,
        CATEGORY
        )
SELECT
        NULL ID,
        SUBSTR(P_DATE, 1, 4) YEAR_NUM,
        SUBSTR(P_DATE, 5, 2) MONTH_NUM,
        P_DATE DATE_WID,
        'Đơn hủy' TYPE_PAWN,
        POL_TYPE,
        1 SYS_ID,
        NULL CHANNEL_ID,
        NULL GROUP_SOURCE_ID,
        SOURCE_ID,
        22287 CAMPAIGN_ID,
        SHOP_CODE,
        NULL DESCRIPTION,
        CUSTOMER_NM,
        PHONE_NUM,
        NULL MAIL_ADRESS,
        NULL IDENTITY_NUM,
        NULL IDENTITY_TYPE,
        NULL GENDER,
        NULL PROVINCE,
        NULL REGION,
        NULL ADDRESS,
        NULL DISBURSE_AMT,
        NULL TOPUP_AMT,
        NULL CODENO,
        NULL CUSTOMER_CODE,
        CATEGORY
FROM
        (
        SELECT
                A.POL_WID,
                to_number(TO_CHAR(A.LAST_PROCESS_DT, 'YYYYMMDD')) DATE_WID,
                A.REASON_NM,
                A.SOURCE_LEVEL_2_NAME NHOM_NGUON,
                A.GROUP_NM SHOP_NAME,
                SHOPD.SHOP_CODE_NEW SHOP_CODE,
                A.POL_CUS_WID ,
                VWCD .CUSTOMER_NM ,
                A.FORM_ASSET_TP_NM ,
                PCD.CONTACT PHONE_NUM,
                CASE
                        WHEN a.SOURCE_LEVEL_2_NAME IN ('Owned', 'Paid') THEN 10
                        WHEN a.SOURCE_LEVEL_2_NAME IN ('3P Leads', 'PartnerShip') THEN 12
                END POL_TYPE,
                CASE
                        WHEN a.SOURCE_LEVEL_2_NAME = 'Owned' THEN 328
                        WHEN a.SOURCE_LEVEL_2_NAME = 'Paid' THEN 329
                        WHEN a.SOURCE_LEVEL_2_NAME = '3P Leads' THEN 331
                        WHEN a.SOURCE_LEVEL_2_NAME = 'PartnerShip' THEN 330
                END SOURCE_ID,
                CASE
                        WHEN a.FORM_ASSET_TP_NM IN ('Ô tô', 'Đăng ký Ô tô') THEN 15
                        WHEN a.FORM_ASSET_TP_NM IN ('Xe máy', 'Đăng ký xe máy') THEN 17
                END CATEGORY,
                ROW_NUMBER() OVER(PARTITION BY PCD.CONTACT ORDER BY TO_CHAR(A.LAST_PROCESS_DT, 'YYYYMMDD') DESC) ROW_NUM
        FROM F88DWH.W_POL_DTL_F A
        LEFT JOIN F88DWH.w_online_cus_contact_d pcd
                ON      a.POL_CUS_WID = pcd.POL_CUS_WID
                        AND pcd.contact_type = 1
        LEFT JOIN F88DWH.VW_W_CUSTOMER_D vwcd
        ON a.POL_CUS_WID = VWCD.CUSTOMER_WID
        LEFT JOIN F88DWH.W_AREA_MANAGER_D AM
        ON TO_CHAR(A.GROUP_ID) = AM.SHOP_ID
        LEFT JOIN HANHDTM.TNKH_SHOP_DIGITAL_HO SHOPD
        ON a.GROUP_ID = SHOPD.SHOP_CODE
        WHERE 1 = 1
                AND NOT EXISTS (SELECT 1 FROM (
                        SELECT
                                DISTINCT(lp.PHONE) PHONE
                        FROM F88DWH.W_LOAN_DTL_F dtl
                        LEFT JOIN F88DWH.W_LOAN_CUSTOMER_F lc
                ON dtl.LOAN_WID = lc.LOAN_WID
                        LEFT JOIN F88dwh.W_LOAN_CUSTOMER_PHONE_F lp
                ON lc.INTEGRATION_ID = lp.LOAN_CUSTOMER_ID
                        WHERE dtl.STATUS = 300
            ) LOS WHERE PCD.CONTACT = LOS.PHONE)
                AND TO_CHAR(A.LAST_PROCESS_DT, 'YYYYMM') = SUBSTR(P_DATE, 1, 6)
                AND A.SOURCE_LEVEL_1_NAME = 'Digital HO'
                AND A.SOURCE_LEVEL_2_NAME IN ('3P Leads', 'Owned', 'Paid', 'PartnerShip')
                AND A.CAMPAIGN_NM NOT IN ('Khai Thác Thêm', 'Khai Thac Lai')
                AND A.REASON_NM IN ('KH chỉ có nhu cầu vay tín chấp',
                        'Khách hàng chỉ có nhu cầu vay tín chấp',
                        'Không có nhu cầu, không đăng ký vay',
                        'Định giá tài sản không đáp ứng đủ nhu cầu vay',
                        'Không nghe máy nhiều lần',
                        'KH cúp máy khi đang trao đổi',
                        'Thuê bao / Không nghe máy nhiều lần',
                        'Hết nhu cầu',
                        'KNM nhiều lần',
                        'KH không có nhu cầu/Không đăng ký',
                        'Từ chối nhiều lần',
                        'KH từ chối do lãi suất/CPV cao',
                        'KH không đủ điều kiện đáo hạn vay thêm',
                        'Nơi lưu trữ tài sản ko trùng trên CCCD hoặc cách PGD >30km',
                        'Tạm dừng do chính sách'
                        )
                AND A.status = 4
                AND AM.FLAG = 'Active'
                AND SHOPD.SHOP_CODE_NEW IS NOT NULL
        )
WHERE row_num = 1;

COMMIT;


---- NKTB
DELETE
FROM    F88DWH.W_POL_FORM_F
WHERE CAMPAIGN_ID = 22305
        AND DATE_WID = P_DATE;

COMMIT;

INSERT INTO     F88DWH.W_POL_FORM_F (
    ID,
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        TYPE_PAWN,
        POL_TYPE,
        SYS_ID,
        CHANNEL_ID,
        GROUP_SOURCE_ID,
        SOURCE_ID,
        CAMPAIGN_ID,
        SHOP_CODE,
        DESCRIPTION,
        CUSTOMER_NM,
        PHONE_NUM,
        MAIL_ADDRESS,
        IDENTITY_NUM,
        IDENTITY_TYPE,
        GENDER,
        PROVINCE,
        REGION,
        ADDRESS,
        DISBURSE_AMT,
        TOPUP_AMT,
        CODENO,
        CUSTOMER_CODE,
        CATEGORY
        )
SELECT
        NULL ID,
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        'NKTB' TYPE_PAWN,
        POL_TYPE,
        1 SYS_ID,
        2 CHANNEL_ID,
        GROUP_SOURCE_ID,
        SOURCE_ID,
        CAMPAIGN_ID,
        SHOP_CODE,
        DESCRIPTION,
        CUSTOMER_NM,
        PHONE_NUM,
        NULL MAIL_ADDRESS,
        NULL IDENTITY_NUM,
        NULL IDENTITY_TYPE,
        NULL GENDER,
        PROVINCE,
        REGION,
        NULL ADDRESS,
        NULL DISBURSE_AMT,
        NULL TOPUP_AMT,
        NULL CODENO,
        NULL CUSTOMER_CODE,
        NULL CATEGORY
FROM
        (
        SELECT
                SUBSTR(P_DATE, 1, 4) YEAR_NUM,
                SUBSTR(P_DATE, 5, 2) MONTH_NUM,
                P_DATE DATE_WID,
                TO_NUMBER(FAIL.SHOP_CODE) SHOP_CODE,
                CONCAT(CONCAT(FAIL.CATEGORY_NAME, ' - '), FAIL.REASON) DESCRIPTION,
                FAIL.CUSTOMER_NAME CUSTOMER_NM,
                FAIL.PHONE PHONE_NUM,
                AR.SHOP_NAME ,
                AR.FLAG,
                ar.PROVINCE ,
                ar.REGION ,
                A.DATE_WID ngay_tao,
                A.POL_WID,
                a.STATUS ,
                CASE WHEN TO_NUMBER(CAM.INTEGRATION_ID) IS NOT NULL THEN TO_NUMBER(CAM.INTEGRATION_ID)
                        ELSE 22305
                END CAMPAIGN_ID,
                CASE WHEN A.SOURCE_LEVEL_1_ID IS NOT NULL THEN A.SOURCE_LEVEL_3_ID
                        WHEN A.SOURCE_LEVEL_1_ID IS NULL AND res.RESOURCES_CODE IN ('016', '015', '017', '023', '024', '025', '014', '029', '021', '004') THEN 347
                        ELSE 342
                END SOURCE_ID,
                CASE WHEN A.SOURCE_LEVEL_1_ID IS NOT NULL THEN A.SOURCE_LEVEL_1_ID
                        WHEN A.SOURCE_LEVEL_1_ID IS NULL AND res.RESOURCES_CODE IN ('016', '015', '017', '023', '024', '025', '014', '029', '021', '004') THEN 8
                        ELSE 9
                END GROUP_SOURCE_ID,
                CASE WHEN A.SOURCE_LEVEL_1_ID IS NOT NULL THEN 33
                        WHEN A.SOURCE_LEVEL_1_ID IS NULL AND res.RESOURCES_CODE IN ('016', '015', '017', '023', '024', '025', '014', '029', '021', '004') THEN 6
                        ELSE 9
                END POL_TYPE,
                ROW_NUMBER() OVER (PARTITION BY fail.phone      ORDER BY nvl(A.DATE_WID, fail.DATE_WID) DESC) row_n
        FROM F88DWH.W_LOAN_LOG_FAILURE_F FAIL
        LEFT JOIN F88DWH.W_RESOURCES_D res
                        ON FAIL.ORG_CUSTOMER = res.RESOURCES_CODE
        LEFT JOIN F88DWH.W_AREA_MANAGER_D AR
                        ON trim(FAIL.SHOP_CODE) = ar.SHOP_ID
        LEFT JOIN F88DWH.w_online_cus_contact_d pcd
                        ON FAIL.PHONE = PCD.CONTACT
                                AND pcd.contact_type = 1
        LEFT JOIN F88DWH.W_POL_DTL_F a
                        ON a.POL_CUS_WID = pcd.POL_CUS_WID
                                AND A.DATE_WID < to_char(to_date(FAIL.DATE_WID, 'yyyymmdd') - 30 , 'yyyymmdd')
                                AND A.DATE_WID > to_char(to_date(FAIL.DATE_WID, 'yyyymmdd') - 365 , 'yyyymmdd')
        LEFT JOIN F88DWH.W_ONLINE_CAMPAIGN_D cam
                        ON a.CAMPAIGN_WID = cam.CAMPAIGN_WID
        WHERE SUBSTR(FAIL.DATE_WID, 1, 6) = SUBSTR(P_DATE, 1, 6)
                AND (FAIL.PHONE IS NOT NULL
                AND FAIL.CUSTOMER_NAME IS NOT NULL)
                AND AR.FLAG = 'Active'
                AND NOT EXISTS (SELECT 1 FROM (
                                SELECT
                                                DISTINCT(lp.PHONE) PHONE
                                FROM F88DWH.W_LOAN_DTL_F dtl
                                LEFT JOIN F88DWH.W_LOAN_CUSTOMER_F lc
                                        ON dtl.LOAN_WID = lc.LOAN_WID
                                LEFT JOIN F88dwh.W_LOAN_CUSTOMER_PHONE_F lp
                    ON lc.INTEGRATION_ID = lp.LOAN_CUSTOMER_ID
                                WHERE dtl.STATUS = 300
                ) LOS WHERE FAIL.PHONE = LOS.PHONE)
                AND NOT EXISTS (SELECT DISTINCT(CUSTOMERPHONE) PHONE
                                                FROM F88DWH.W_LOAN_QUICKOFFER_F QO
                                                WHERE QO.PARTNERLOANSTATUS IN ('CANCELLED', 'REJECTED')
                                                        AND SUBSTR(DATE_WID, 1, 6)= SUBSTR(P_DATE, 1, 6)
                                                        AND FAIL.PHONE = QO.CUSTOMERPHONE)
        )
WHERE row_n = 1
        --Lấy những đơn có trạng thái gần nhất là Hủy đăng ký
        AND (STATUS = 4 OR STATUS IS NULL);

COMMIT;

DBMS_OUTPUT.PUT_LINE ('--> DONE INSERT PROC_POL_FORM' || TO_CHAR(SYSDATE, 'DD-MON-YYYY HH24:MI:SS'));

END PROC_W_POL_FORM_F_MONTHLY;
```

### `F88DWH.PROC_W_POL_TLS_MONTHLY_F` (PROCEDURE) — 2 lines reference search term

```
PROCEDURE        PROC_W_POL_TLS_MONTHLY_F(P_DATE NUMBER)
IS
BEGIN

-- Delete existing data

DELETE FROM F88DWH.W_POL_TLS_MONTHLY_F
WHERE YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
        AND MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2));

COMMIT;

-- Insert new data

INSERT INTO F88DWH.W_POL_TLS_MONTHLY_F (
        YEAR_NUM,
        MONTH_NUM,
        POL_WID,
        FORM_CREATED_DT,
        DISBURSE_DT,
        DISBURSE_AMT,
        STATUS_NM,
        LOAN_ASSET_TP_NM,
        FORM_ASSET_TP_NM,
        SOURCE_LEVEL_1_NAME,
        SOURCE_LEVEL_2_NAME,
        SOURCE_LEVEL_3_NAME,
        SOURCE_LEVEL_4_NAME,
        GROUP_ID,
        GROUP_NM,
        FIRST_RECEIVE_DT,
        FIRST_RECEIVE_EMPLOYEE_CODE,
        FIRST_RECEIVE_EMPLOYEE_NM,
        FIRST_FORWARD_DT,
        FIRST_FORWARD_EMPLOYEE_CODE,
        FIRST_FORWARD_EMPLOYEE_NM,
        LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD_EMPLOYEE_NM,
        LAST_TLS_DT,
        LAST_TLS_REASON_NM,
        LAST_TLS_GROUP_REASON_NM,
        LAST_TLS_NOTE,
        FIRST_REEXPLOIT_DT,
        FIRST_REEXPLOIT_EMPLOYEE_NM,
        LAST_DT,
        LAST_REASON_NM,
        LAST_GROUP_REASON_NM
        )
SELECT TO_NUMBER(SUBSTR(P_DATE, 1, 4)) YEAR_NUM,
        TO_NUMBER(SUBSTR(P_DATE, 5, 2)) MONTH_NUM,
        wpdf.POL_WID,
        wpdf.FORM_CREATED_DT,
        TO_DATE(wpdf.DISBURSE_DT, 'YYYYMMDD') DISBURSE_DT,
        wpdf.DISBURSE_AMT,
        wpdf.STATUS_NM,
        wpdf.LOAN_ASSET_TP_NM,
        wpdf.FORM_ASSET_TP_NM,
        wpdf.SOURCE_LEVEL_1_NAME,
        wpdf.SOURCE_LEVEL_2_NAME,
        wpdf.SOURCE_LEVEL_3_NAME,
        wpdf.SOURCE_LEVEL_4_NAME,
        wpdf.GROUP_ID,
        wpdf.GROUP_NM,
        FIRST_RECEIVE.FIRST_RECEIVE_DT,
        FIRST_RECEIVE.FIRST_RECEIVE_EMPLOYEE_CODE,
        FIRST_RECEIVE.FIRST_RECEIVE_EMPLOYEE_NM,
        FIRST_FORWARD.PROCESS_DT FIRST_FORWARD_DT,
        FIRST_FORWARD.EMPLOYEE_CODE FIRST_FORWARD_EMPLOYEE_CODE,
        FIRST_FORWARD.EMPLOYEE_NM FIRST_FORWARD_EMPLOYEE_NM,
        CASE WHEN wpdf.LOAN_CODE IS NOT NULL AND wpdf.STATUS_NM = 'Nhận cầm cố' THEN LAST_FORWARD.EMPLOYEE_CODE END LAST_FORWARD_EMPLOYEE_CODE,
        CASE WHEN wpdf.LOAN_CODE IS NOT NULL AND wpdf.STATUS_NM = 'Nhận cầm cố' THEN LAST_FORWARD.EMPLOYEE_NM END LAST_FORWARD_EMPLOYEE_NM,
        LAST_TLS_PROCESS.PROCESS_DT LAST_TLS_DT,
        LAST_TLS_PROCESS.REASON_NM LAST_TLS_REASON_NM,
        LAST_TLS_PROCESS.GROUP_REASON_NM LAST_TLS_GROUP_REASON_NM,
        LAST_TLS_PROCESS.NOTE LAST_TLS_NOTE,
        FIRST_REEXPLOIT.PROCESS_DT FIRST_REEXPLOIT_DT,
        FIRST_REEXPLOIT.EMPLOYEE_NM FIRST_REEXPLOIT_EMPLOYEE_NM,
        LAST_PROCESS.PROCESS_DT LAST_DT,
        LAST_PROCESS.REASON_NM LAST_REASON_NM,
        LAST_PROCESS.GROUP_REASON_NM LAST_GROUP_REASON_NM
FROM F88DWH.W_POL_DTL_F wpdf
LEFT JOIN
        ( --- FIRST_RECEIVE
        SELECT
                po.POL_WID,
                CASE WHEN NVL(a.PROCESS_DT, TO_DATE('24000101', 'YYYYMMDDHH')) < NVL(b.Nexttime, TO_DATE('24000101', 'YYYYMMDDHH')) THEN a.PROCESS_DT ELSE b.Nexttime END FIRST_RECEIVE_DT,
                CASE WHEN NVL(a.PROCESS_DT, TO_DATE('24000101', 'YYYYMMDDHH')) < NVL(b.Nexttime, TO_DATE('24000101', 'YYYYMMDDHH')) THEN a.EMPLOYEE_CODE ELSE b.NEXTCODE END FIRST_RECEIVE_EMPLOYEE_CODE,
                CASE WHEN NVL(a.PROCESS_DT, TO_DATE('24000101', 'YYYYMMDDHH')) < NVL(b.Nexttime, TO_DATE('24000101', 'YYYYMMDDHH')) THEN a.EMPLOYEE_NM ELSE b.NEXTNM END FIRST_RECEIVE_EMPLOYEE_NM
        FROM F88DWH.W_POL_DTL_F po
        LEFT JOIN
          (      SELECT POL_WID,
                        PROCESS_DT,
                        EMPLOYEE_CODE,
                        EMPLOYEE_NM
                FROM
                (
                        SELECT wopf.INT_POL_PAWN_ID POL_WID,
                                TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                                wed.EMPLOYEE_CODE,
                                wed.EMPLOYEE_NM,
                                ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                        FROM F88DWH.W_ONLINE_PROCESS_F wopf
                        JOIN F88DWH.W_POL_TLS_GRP_D wogd --- TLS 1
                                ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                        JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                                ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                        LEFT JOIN F88DWH.W_EMPLOYEE_D wed
                                ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                        WHERE 1=1
                                AND wopf.YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
                                AND wopf.MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2))
                                AND worfd.INTEGRATION_ID IN (139, 149, 150)
                        )
                WHERE  RN = 1
                ) a ON po.POL_WID =a.pol_wid
        LEFT JOIN
        (WITH ct AS
           (
                                select t.int_pol_pawn_id id,
                                       to_date(decode(t.created_dt, -1, null, t.created_dt),'yyyymmddhh24miss') created_dt,
                                       wed.EMPLOYEE_CODE ,
                                       wed.EMPLOYEE_NM ,
                                       r.INTEGRATION_ID  status,
                                       g.GROUP_NM ,
                                       g.GROUP_CODE ,
                                       ROW_NUMBER () over(ORDER BY t.integration_id ) ROW_
                                  from F88DWH.w_online_process_f t
                                  LEFT join F88DWH.w_online_grp_d g on g.online_grp_wid = t.created_group_wid
                                  join F88DWH.w_online_reason_fail_d r
                                    on t.reason_wid = r.online_reason_fail_wid
                                  left join F88DWH.W_EMPLOYEE_D wed ON t.EMPLOYEE_WID =wed.EMPLOYEE_WID
                                  WHERE t.INT_POL_PAWN_ID IN (SELECT DISTINCT INT_POL_PAWN_ID FROM F88DWH.W_ONLINE_PROCESS_F WHERE REASON_WID = 963)
                                                AND wed.EMPLOYEE_CODE IS NOT null
                                         )
                ,cte AS (
            SELECT
                id,
                status,
                GROUP_NM,
                LEAD(status) OVER (PARTITION BY id ORDER BY ROW_) AS NextStatus,
                LEAD(created_dt) OVER (PARTITION BY id ORDER BY ROW_) AS Nexttime_,
                LEAD(EMPLOYEE_CODE) OVER (PARTITION BY id ORDER BY ROW_) AS Nextcode_,
                LEAD(EMPLOYEE_NM) OVER (PARTITION BY id ORDER BY ROW_) AS Nextnm_,
                LEAD(GROUP_NM) OVER (PARTITION BY id ORDER BY ROW_) AS Nextshop
            FROM
                ct
        )
        , cs AS
                        (
                        SELECT  cte.*,
                                        ROW_NUMBER ()OVER (PARTITION BY ID, to_char(Nexttime_,'yyyymm') ORDER BY NEXTTIME_ ) rn
                        FROM
                            cte
                        WHERE
                            Status = 151
                            AND nvl(NextStatus,0)!=151
                         )
         SELECT
                id,
                status,
                CASE WHEN Nextshop LIKE '%Telesale%' THEN Nexttime_ END Nexttime,
                CASE WHEN Nextshop LIKE '%Telesale%' THEN Nextcode_ END Nextcode,
                CASE WHEN Nextshop LIKE '%Telesale%' THEN Nextnm_ END Nextnm
         FROM cs
         WHERE rn=1
                AND to_char(Nexttime_,'yyyymm')=substr(P_DATE,1,6)) b ON PO .POL_WID =b.id
        WHERE
        (to_char(a.PROCESS_DT,'yyyymm')=substr(P_DATE,1,6)
                OR to_char(b.Nexttime,'yyyymm')=substr(P_DATE,1,6)
                )
) FIRST_RECEIVE
    ON wpdf.POL_WID = FIRST_RECEIVE.POL_WID
LEFT JOIN
        ( --- FIRST_FORWARD
        SELECT POL_WID,
                PROCESS_DT,
                EMPLOYEE_CODE,
                EMPLOYEE_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        wed.EMPLOYEE_CODE,
                        wed.EMPLOYEE_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd --- TLS 2
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                LEFT JOIN F88DWH.W_EMPLOYEE_D wed
                        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
                        AND wopf.MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2))
                        AND worfd.INTEGRATION_ID = 21
                )
        WHERE RN = 1
) FIRST_FORWARD
    ON wpdf.POL_WID = FIRST_FORWARD.POL_WID
LEFT JOIN
        ( --- LAST_FORWARD
        SELECT POL_WID,
                PROCESS_DT,
                EMPLOYEE_CODE,
                EMPLOYEE_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        wed.EMPLOYEE_CODE,
                        wed.EMPLOYEE_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd --- TLS 3
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                LEFT JOIN F88DWH.W_EMPLOYEE_D wed
                        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
                        AND wopf.MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2))
                        AND worfd.INTEGRATION_ID = 21
                )
        WHERE RN = 1
) LAST_FORWARD
    ON wpdf.POL_WID = LAST_FORWARD.POL_WID
LEFT JOIN
        ( --- LAST_TLS_PROCESS
        SELECT POL_WID,
                PROCESS_DT,
                REASON_NM,
                GROUP_REASON_NM,
                NOTE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        worfd.CANCELED_REASON_NM REASON_NM,
                        worfd.TYPE_NM GROUP_REASON_NM,
                        wopf.NOTE,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.CREATED_DT DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd --- TLS 4
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
                        AND wopf.MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2))
                )
        WHERE RN = 1
) LAST_TLS_PROCESS
    ON wpdf.POL_WID = LAST_TLS_PROCESS.POL_WID
LEFT JOIN
        ( --- FIRST_REEXPLOIT
        SELECT POL_WID,
                PROCESS_DT,
                EMPLOYEE_CODE,
                EMPLOYEE_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        wed.EMPLOYEE_CODE,
                        wed.EMPLOYEE_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd --- TLS 5
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                LEFT JOIN F88DWH.W_EMPLOYEE_D wed
                        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
                        AND wopf.MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2))
                        AND worfd.INTEGRATION_ID = 137
                )
        WHERE RN = 1
) FIRST_REEXPLOIT
    ON wpdf.POL_WID = FIRST_REEXPLOIT.POL_WID
LEFT JOIN
        ( --- LAST_PROCESS
        SELECT POL_WID,
                PROCESS_DT,
                REASON_NM,
                GROUP_REASON_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        worfd.CANCELED_REASON_NM REASON_NM,
                        worfd.TYPE_NM GROUP_REASON_NM,
                        wopf.NOTE,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.CREATED_DT DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
                        AND wopf.MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2))
                )
        WHERE RN = 1
) LAST_PROCESS
    ON wpdf.POL_WID = LAST_PROCESS.POL_WID
WHERE EXISTS (
        SELECT 1
        FROM F88DWH.W_ONLINE_PROCESS_F wopf
        WHERE 1=1
                AND wopf.YEAR_NUM = TO_NUMBER(SUBSTR(P_DATE, 1, 4))
                AND wopf.MONTH_NUM = TO_NUMBER(SUBSTR(P_DATE, 5, 2))
                AND wpdf.POL_WID = wopf.INT_POL_PAWN_ID
        );

COMMIT;

END PROC_W_POL_TLS_MONTHLY_F;
```

### `F88DWH.PROC_W_PTDT_LOAN_F` (PROCEDURE) — 1 lines reference search term

```
PROCEDURE        PROC_W_PTDT_LOAN_F (P_DATE NUMBER)
/*
---------- OVERVIEW---------------
  -- AUTHOR_CODE : GIANGNT14
  -- AUTHOR_NAME : NGUYỄN TRƯỜNG GIANG
  -- CREATED_DATE : 2025-12-22
  -- PURPOSE : TỔNG HỢP DỮ LIỆU LOAN PTDT
-----------PROCESS GOLIVE--------
CÁC BƯỚC CẦN DE CHUYỂN ĐỔI KHI GOLIVE:
	Bước 1:
	Bước 2:
	Bước 3:
*/
IS
BEGIN
--	 Delete existing data
	DELETE FROM F88DWH.W_PTDT_LOAN_F
	WHERE 1=1
	 ---- LUỒNG GIẢI NGÂN
	AND NGAY_GIAI_NGAN >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
	AND	NGAY_GIAI_NGAN <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')

;
COMMIT;

-- Insert new data

INSERT INTO F88DWH.W_PTDT_LOAN_F (

	POL_WID
	,  PHAN_LOAI_DOI_TAC
	,  KENH
	,  NHOM_NGUON
	,  NGUON
	,  SOURCE_LEVEL_4_NAME
	,  CAMPAIGN_NM
	,  POL_PGD_TLS_DAU_TIEN
	,  POL_THOI_GIAN_GIAI_NGAN
	,  MA_HO_SO
	,  NGAY_TAO_HO_SO
	,  CONTRACT_CODE
	,  LOAN_CODE
	,  LOAI_TAI_SAN
	,  HANG_SAN_XUAT
	,  NAM_SAN_XUAT
	,  TAI_SAN
	,  SAN_PHAM_VAY
	,  CPV
	,  LTV
	,  PHI_BH
	,  KI_HAN_VAY
	,  KI_TRA_NO_DAU_TIEN
	,  KENH_BAN
	,  PGD
	,  PHAN_LOAI_VUNG
	,  TINH
	,  TONG_GIAI_NGAN
	,  NGAY_GIAI_NGAN
	,  THANG_GIAI_NGAN
	,  LOAI_KH
	,  MA_SAN_PHAM
	,  FUND_NAME
	,  CHANNEL_CODE
	,  PTDT_CHANNEL_CODE
	,  GRP
	,  NGAY_WO
	,  NGAY_DONG_GNN
	,  CUSTOMER_WID
)
-------- Query ------------

---- STEP1

SELECT
MAIN.POL_WID
,  MAIN.PHAN_LOAI_DOI_TAC
,  MAIN.KENH
,  MAIN.NHOM_NGUON
,  MAIN.NGUON
,  MAIN.SOURCE_LEVEL_4_NAME
,  MAIN.CAMPAIGN_NM
,  MAIN.POL_PGD_TLS_DAU_TIEN
,  MAIN.POL_THOI_GIAN_GIAI_NGAN
,  MAIN.MA_HO_SO
,  MAIN.NGAY_TAO_HO_SO
,  MAIN.CONTRACT_CODE
,  MAIN.LOAN_CODE
,  MAIN.LOAI_TAI_SAN
,  MAIN.HANG_SAN_XUAT
,  MAIN.NAM_SAN_XUAT
,  MAIN.TAI_SAN
,  MAIN.SAN_PHAM_VAY
,  MAIN.CPV
,  MAIN.LTV
,  MAIN.PHI_BH
,  MAIN.KI_HAN_VAY
,  MAIN.KI_TRA_NO_DAU_TIEN
,  MAIN.KENH_BAN
,  MAIN.PGD
,  MAIN.PHAN_LOAI_VUNG
,  MAIN.TINH
,  MAIN.TONG_GIAI_NGAN
,  MAIN.NGAY_GIAI_NGAN
,  MAIN.THANG_GIAI_NGAN
,  MAIN.LOAI_KH
,  MAIN.MA_SAN_PHAM
,  MAIN.FUND_NAME
,  MAIN.CHANNEL_CODE
,  MAIN.PTDT_CHANNEL_CODE
,  MAIN.GRP
,  MAIN.NGAY_WO
,  MAIN.NGAY_DONG_GNN
,  MAIN.CUSTOMER_WID
FROM (
	SELECT
	POL.POL_WID
	, CASE
		WHEN ( --1. QuickOffer
					LOAN.FUND_NAME = 'MB'
				OR	QO.PARTNER_CODE IN ('MB', 'MOMO')
			)
				THEN 'PTDT_QO'
		WHEN ( -- 2. E2E
					( -- TH thường
						L_MASTER.SOURCE ='PTDT3P'
					OR	L_MASTER.SALE_CHANNEL = 'PTDT3P'
					OR  LOAN.CHANNEL_CODE = 'PTDT3P'
					)
				OR	( -- TH đặc biệt
							-- https://www.gapowork.vn/ticket/view/3746319249408
						LOAN.SALE_CHANNEL = 'CIMB'
					AND L_AGENT.MAIN_AGENT IN (SELECT TRIM(UPPER(MAIN_AGENT)) FROM F88DWH.W_CHANNEL_AGENT )
					)
			)
				THEN 'PTDT_E2E'
		WHEN ( -- 3. POL
					POL.SOURCE_LEVEL_1_ID IN ( 363 --- ID NGUỒN MỚI HIỆN DÙNG
											 , 409 --- ID CŨ ĐÃ DỪNG - SỬ DỤNG CHECK QUÁ KHỨ
											)
				OR (	-- TTKH BÀN GIAO https://www.gapowork.vn/ticket/view/1743395345933
						POL.SOURCE_LEVEL_1_ID = 1 AND POL.SOURCE_LEVEL_2_ID IN (4, 6)
					AND (
							LOAN.DISBURSE_DATE_WID >= 20250401
						OR	TO_NUMBER(TO_CHAR(POL.YEAR_NUM) || LPAD(POL.MONTH_NUM, 2, '0')) >= 202504
						)
				)
				OR POL.CAMPAIGN_NM = 'Luồng rớt MB'
				-- TLS giải ngân
				OR	TLS_LOAN.LOAN_CODE IS NOT NULL
			)
				THEN 'PTDT_LEADS'
	END PHAN_LOAI_DOI_TAC
	, CASE
		WHEN LOAN.CHANNEL_CODE = 'PTDT3P'
			THEN 'PTDT3P'
		WHEN POL.SOURCE_LEVEL_1_ID NOT IN (363, 1)
			THEN 'Kênh khác'
		ELSE POL.SOURCE_LEVEL_1_NAME
	END KENH
	, CASE
		WHEN ( --1. QuickOffer
					LOAN.FUND_NAME = 'MB'
				OR	QO.PARTNER_CODE IN ('MB', 'MOMO')
			)
			THEN 'QO_' || QO.PARTNER_CODE
		WHEN ( -- 2. E2E
					( -- TH thường
						L_MASTER.SOURCE ='PTDT3P'
					OR	L_MASTER.SALE_CHANNEL = 'PTDT3P'
					OR  LOAN.CHANNEL_CODE = 'PTDT3P'
					)
				OR	( -- TH đặc biệt
							-- https://www.gapowork.vn/ticket/view/3746319249408
						LOAN.SALE_CHANNEL = 'CIMB'
					AND L_AGENT.MAIN_AGENT IN (SELECT TRIM(UPPER(MAIN_AGENT)) FROM F88DWH.W_CHANNEL_AGENT )
					)
			)
			THEN 'PTDT3P'
		WHEN POL.SOURCE_LEVEL_1_ID = 1
			AND POL.SOURCE_LEVEL_2_ID NOT IN (4,6)
				THEN 'TLS'
		WHEN POL.SOURCE_LEVEL_1_ID NOT IN (363, 1)
			THEN 'TLS'
		ELSE SOURCE_LEVEL_2_NAME
	END NHOM_NGUON
	, CASE
		WHEN ( --1. QuickOffer
					LOAN.FUND_NAME = 'MB'
				OR	QO.PARTNER_CODE IN ('MB', 'MOMO')
			)
			THEN QO.PARTNER_CODE
		WHEN ( -- 2. E2E
					( -- TH thường
						L_MASTER.SOURCE ='PTDT3P'
					OR	L_MASTER.SALE_CHANNEL = 'PTDT3P'
					OR  LOAN.CHANNEL_CODE = 'PTDT3P'
					)
				OR	( -- TH đặc biệt
							-- https://www.gapowork.vn/ticket/view/3746319249408
						LOAN.SALE_CHANNEL = 'CIMB'
					AND L_AGENT.MAIN_AGENT IN (SELECT TRIM(UPPER(MAIN_AGENT)) FROM F88DWH.W_CHANNEL_AGENT )
					)
			)
			THEN L_AGENT.MAIN_AGENT
		WHEN POL.SOURCE_LEVEL_1_ID = 1
			AND POL.SOURCE_LEVEL_2_ID NOT IN (4,6)
				THEN 'TLS-Còn lại'
		WHEN POL.SOURCE_LEVEL_1_ID NOT IN (363, 1)
			THEN 'TLS-Còn lại'
		ELSE POL.SOURCE_LEVEL_3_NAME
	END NGUON
	, CASE
		WHEN LOAN.CHANNEL_CODE = 'PTDT3P'
			THEN L_AGENT.SUB_AGENT
		ELSE POL.SOURCE_LEVEL_4_NAME
	END SOURCE_LEVEL_4_NAME
	, POL.CAMPAIGN_NM
	, POL.FIRST_TLS_GROUP_NM POL_PGD_TLS_DAU_TIEN
	, (TO_DATE(LOAN.DISBURSE_DATE_WID, 'YYYYMMDD') - TO_DATE(POL.DATE_WID,'YYYYMMDD') ) POL_THOI_GIAN_GIAI_NGAN
	-- MASTER
	, L_MASTER.APP_FORM_ID MA_HO_SO
	, TO_CHAR(L_MASTER.CREATEDDATE  , 'YYYYMMDD') NGAY_TAO_HO_SO
	, L_MASTER.CONTRACT_CODE
	, L_MASTER.CODENO LOAN_CODE
	, L_MASTER.CATEGORYNAME LOAI_TAI_SAN
	, ASSET_CMP.NAME HANG_SAN_XUAT
	, L_ASSET.MADE_YEAR NAM_SAN_XUAT
	, L_MASTER.PAWNASSETNAME TAI_SAN
	, L_MASTER.LOANPRODUCTNAME SAN_PHAM_VAY
	, L_MASTER.PARTNERINTERESTRATE CPV
	, L_MASTER.LTV
	, L_MASTER.INSURANCEMONEY PHI_BH
	, L_MASTER.PERIODNAME KI_HAN_VAY
	, L_MASTER.REPAYMENTSSTARTINGFROMDATE KI_TRA_NO_DAU_TIEN
	, L_MASTER.SALE_CHANNEL KENH_BAN
	, SHOP.SHOP_NM PGD
	, AREA.TRADE_LEAD PHAN_LOAI_VUNG
	, AREA.PROVINCE TINH
	--- LOAN
	, LOAN.LOAN_WID
	, LOAN.DISBURSE_AMT TONG_GIAI_NGAN
	, LOAN.DISBURSE_DATE_WID NGAY_GIAI_NGAN
	, TO_CHAR(TO_DATE(LOAN.DISBURSE_DATE_WID, 'YYYYMMDD'), 'YYYY-MM') THANG_GIAI_NGAN
	, LOAN.CTR_TYPE LOAI_KH
	, LOAN.LOAN_PKG_NM MA_SAN_PHAM
	, LOAN.FUND_NAME
	, LOAN.CHANNEL_CODE
	, CASE
		WHEN TLS_LOAN.PTDT_CHANNEL_CODE IS NOT NULL
			THEN TLS_LOAN.PTDT_CHANNEL_CODE
		ELSE LOAN.CHANNEL_CODE
	END PTDT_CHANNEL_CODE
	, CASE
		WHEN POL.SOURCE_LEVEL_1_ID NOT IN (363, 1) THEN NULL
		WHEN POL.SOURCE_LEVEL_1_ID IN (363, 1)  AND REGEXP_LIKE(POL.FIRST_GROUP_NM,'hỗ trợ|tele|test','i') THEN 'TLS'
		WHEN POL.SOURCE_LEVEL_1_ID IN (363, 1)  AND POL.FIRST_GROUP_NM IS NULL AND SOURCE_LEVEL_3_ID NOT IN (442, 443) THEN 'TLS'
		ELSE 'KDML'
	END GRP
	, LOAN.WRITEOFF_DATE_WID NGAY_WO
	, LOAN.CLOSED_DATE_WID NGAY_DONG_GNN
	, L_MASTER.CUSTOMER_WID
	FROM F88DWH.W_LOAN_DTL_F LOAN
	LEFT JOIN F88DWH.VW_W_LOAN_MASTER_F L_MASTER
		ON L_MASTER.LOAN_WID = LOAN.LOAN_WID
	LEFT JOIN F88DWH.W_LOAN_AGENT_F L_AGENT
		ON L_AGENT.LOAN_CODE = LOAN.LOAN_CODE
	-- ASSET
	LEFT JOIN F88DWH.W_LOAN_ASSET_F L_ASSET
		ON L_ASSET.LOAN_CODE = L_MASTER.CODENO
	LEFT JOIN F88DWH.W_APPR_ASSET_COMPANY_D ASSET_CMP
		ON ASSET_CMP.CODE = L_ASSET.COMPANYCODE
	--- PGD
	LEFT JOIN F88DWH.W_SHOP_D SHOP
		ON SHOP.SHOP_WID = L_MASTER.SHOP_WID
	LEFT JOIN F88DWH.W_AREA_MANAGER_D AREA
		ON AREA.SHOP_ID = SHOP.SHOP_CODE
		AND SHOP.SHOP_TYPE = 'F88'
		AND SHOP.CRN_ROW_IND = 1
	--QO
	LEFT JOIN F88DWH.VW_W_LOAN_QO_PARTNER_FINAL_F QO
		ON QO.APPFORMID = L_MASTER.APP_FORM_ID
	LEFT JOIN (
		SELECT
		L_STATE.LOAN_CODE
		, 'TLS' PTDT_CHANNEL_CODE
		FROM F88DWH.W_LOAN_STATE_WORKFLOW_F L_STATE
		LEFT JOIN F88DWH.W_LOAN_DTL_F LOAN
			ON LOAN.LOAN_WID = L_STATE.LOAN_WID
		LEFT JOIN F88DWH.VW_W_LOAN_AGENT_F L_AGENT
			ON L_AGENT.LOAN_CODE = L_STATE.LOAN_CODE
			AND L_AGENT.MAIN_AGENT = 'TLS'
		LEFT JOIN F88DWH.VW_W_EMPLOYEE_D EMP ON EMP.EMPLOYEE_WID  = L_STATE.EMPLOYEE_WID_UPDATE
		LEFT JOIN F88DWH.GRP GRP
			ON GRP.GRP_ID  = L_STATE.WORK_FLOW_STATUS_WID
			AND GRP_TP = 'WORK_FLOW_STATUS'
		WHERE 1=1
		AND LOAN.DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
		AND LOAN.DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
		AND GRP.GRP_CODE  = '001'
		AND L_STATE.ROLE = 'CV_TLS'
		UNION
		SELECT
		PAWN.CODE_NO
		, 'TLS_ONLINE' PTDT_CHANNEL_CODE
		FROM F88DWH.W_MYF88_PAWN_F MY_F88
		INNER JOIN F88DWH.W_PAWN_F PAWN
			ON PAWN.PAWN_WID  = MY_F88.PAWN_WID
		LEFT JOIN F88DWH.VW_W_HRM_EMPLOYEE_INFOR_D EMP
			ON EMP.EMPLOYEE_CODE = UPPER(TRIM(TO_CHAR(MY_F88.INTRODUCER_EMPLOYEE_CODE)))
		WHERE 1=1
		AND PAWN.MIFOS_CHANNEL_CODE  = 'Online'
		AND EMP.LEVEL4_NAME = 'Phòng Bán hàng qua điện thoại'
		AND PAWN.MIFOS_DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
		AND PAWN.MIFOS_DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
	) TLS_LOAN ON TLS_LOAN.LOAN_CODE = LOAN.LOAN_CODE
	LEFT JOIN F88DWH.W_POL_DTL_F POL
		ON POL.LOAN_WID = LOAN.LOAN_WID
		AND POL.STATUS_NM = 'Nhận cầm cố'
	WHERE 1=1
	AND LOAN.DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
	AND LOAN.DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
	AND (
		( --1. QuickOffer
				LOAN.FUND_NAME = 'MB'
			OR	QO.PARTNER_CODE IN ('MB', 'MOMO')
		)
		OR ( -- 2. E2E
				( -- TH thường
					L_MASTER.SOURCE ='PTDT3P'
				OR	L_MASTER.SALE_CHANNEL = 'PTDT3P'
				OR  LOAN.CHANNEL_CODE = 'PTDT3P'
				)
			OR	( -- TH đặc biệt
						-- https://www.gapowork.vn/ticket/view/3746319249408
					LOAN.SALE_CHANNEL = 'CIMB'
				AND L_AGENT.MAIN_AGENT IN (SELECT TRIM(UPPER(MAIN_AGENT)) FROM F88DWH.W_CHANNEL_AGENT )
				)
		)
		OR ( -- 3. POL
				POL.SOURCE_LEVEL_1_ID IN ( 363 --- ID NGUỒN MỚI HIỆN DÙNG
										 , 409 --- ID CŨ ĐÃ DỪNG - SỬ DỤNG CHECK QUÁ KHỨ
										)
			OR (	-- TTKH BÀN GIAO https://www.gapowork.vn/ticket/view/1743395345933
					POL.SOURCE_LEVEL_1_ID = 1 AND POL.SOURCE_LEVEL_2_ID IN (4, 6)
				AND (
						LOAN.DISBURSE_DATE_WID >= 20250401
					OR	TO_NUMBER(TO_CHAR(POL.YEAR_NUM) || LPAD(POL.MONTH_NUM, 2, '0')) >= 202504
					)
			)
			OR POL.CAMPAIGN_NM = 'Luồng rớt MB'
			-- TLS giải ngân
			OR	TLS_LOAN.LOAN_CODE IS NOT NULL
		)
	)
) MAIN


;



COMMIT;

MERGE INTO F88DWH.W_PTDT_LOAN_F PTDT_LOAN
	USING (
	---- STEP2
	SELECT
	LOAN.LOAN_CODE
	, LOAN.WRITEOFF_DATE_WID
	, LOAN.CLOSED_DATE_WID
	FROM F88DWH.W_LOAN_DTL_F LOAN
	INNER JOIN F88DWH.W_PTDT_LOAN_F PTDT_L
		ON PTDT_L.LOAN_CODE = LOAN.LOAN_CODE
	WHERE 1=1
	AND NVL(LOAN.WRITEOFF_DATE_WID, 'IS NULL') <> NVL(PTDT_L.NGAY_WO, 'IS NULL')
	OR NVL(LOAN.CLOSED_DATE_WID, 'IS NULL') <> NVL(PTDT_L.NGAY_DONG_GNN , 'IS NULL')
) MERGE_LOAN
	ON (PTDT_LOAN.LOAN_CODE = MERGE_LOAN.LOAN_CODE )
        WHEN MATCHED THEN UPDATE SET
        PTDT_LOAN.NGAY_WO = MERGE_LOAN.WRITEOFF_DATE_WID,
        PTDT_LOAN.NGAY_DONG_GNN = MERGE_LOAN.CLOSED_DATE_WID

;


COMMIT;

END PROC_W_PTDT_LOAN_F;
```

### `F88DWH.PROC_W_PTDT_OBJECT` (PROCEDURE) — 2 lines reference search term

```
PROCEDURE        PROC_W_PTDT_OBJECT (P_DATE NUMBER)
/*
---------- OVERVIEW---------------
  -- AUTHOR_CODE : GIANGNT14
  -- AUTHOR_NAME : NGUYỄN TRƯỜNG GIANG
  -- CREATED_DATE : 2025-12-22
  -- PURPOSE : ĐINH DANH DỮ LIỆU PTĐT

---------- TABLE OF CONTENTS ---------------
	I. Nguồn
	I.1.1. Nguồn POL
	I.1.2. Nguồn E2E
	I.1.3. Nguồn QUICKOFFER
	I.1.4. PTDT NGUỒN FINAL
	II. Kênh bán
	II.1.1. PTDT KÊNH BÁN FINAL
	II.1.2. LỌC KÊNH BÁN PTDT
	III. RAW_DATA
	IV. Định danh PTĐT
	IV.1. QuickOffer
	IV.1.1. Dự án MB
	IV.1.2. Dự án MOMO
	IV.2. E2E (LOS)
	IV.3. LEADS (POL)
	IV.3.1. 2025 LEADS - MB
	IV.4. KÊNH BÁN PTDT: TLS giải ngân


-----------PROCESS GOLIVE--------
CÁC BƯỚC CẦN DE CHUYỂN ĐỔI KHI GOLIVE:
	Bước 1: CHUYỂN GIANGNT14. => F88DWH.
	Bước 2: GIỮ NGUYÊN GIANGNT14.W_TLS_EXCEPTION_F
	Bước 3: HIỆN ĐÃ CONVERT PROCEDURED LỖI IBX GIANG NHÉ.

*/
IS
BEGIN
--	 Delete existing data
	---- STEP_6
	DELETE FROM F88DWH.W_PTDT_OBJECT
	WHERE 1=1
	AND (
		( -- LOAN_WID
				DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
			AND DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
		)
		OR (	LOAN_CREATED_DATE >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
			AND LOAN_CREATED_DATE <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')

		)
		OR (	POL_YEAR_NUM = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'YYYY')
			AND POL_MONTH_NUM = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM')
		)
	)

;

-- Insert new data

INSERT INTO F88DWH.W_PTDT_OBJECT (
	POL_WID
	,  POL_YEAR_NUM
	,  POL_MONTH_NUM
	,  POL_DATE_WID
	,  POL_CAMPAIGN_NM
	,  POL_STATUS_NM
	,  POL_SOURCE_LEVEL_1_NAME
	,  POL_SOURCE_LEVEL_2_NAME
	,  POL_SOURCE_LEVEL_3_NAME
	,  E2E_SOURCE_LEVEL_1_NAME
	,  E2E_SOURCE_LEVEL_2_NAME
	,  E2E_SOURCE_LEVEL_3_NAME
	,  QO_SOURCE_LEVEL_2_NAME
	,  QO_SOURCE_LEVEL_3_NAME
	,  PARTNER_TYPE
	,  PARTNER_RANKING
	,  PTDT_SOURCE_LEVEL_1_NAME
	,  PTDT_SOURCE_LEVEL_2_NAME
	,  PTDT_SOURCE_LEVEL_3_NAME
	,  IS_PTDT_SOURCE
	,  LOAN_CODE
	,  LOAN_CREATED_DATE
	,  IS_PTDT_SALES
	,  USER_CODE_SALES
	,  LOAN_WID
	,  DISBURSE_DATE_WID
	,  PTDT_CHANNEL_CODE
	,  OBJECT_DATE
	,  CREATED_DATE

)
-------- Query ------------
SELECT
MAIN_V2.POL_WID
, MAIN_V2.POL_YEAR_NUM
, MAIN_V2.POL_MONTH_NUM
, MAIN_V2.POL_DATE_WID
, MAIN_V2.POL_CAMPAIGN_NM
, MAIN_V2.POL_STATUS_NM
, MAIN_V2.POL_SOURCE_LEVEL_1_NAME
, MAIN_V2.POL_SOURCE_LEVEL_2_NAME
, MAIN_V2.POL_SOURCE_LEVEL_3_NAME
, MAIN_V2.E2E_SOURCE_LEVEL_1_NAME
, MAIN_V2.E2E_SOURCE_LEVEL_2_NAME
, MAIN_V2.E2E_SOURCE_LEVEL_3_NAME
, MAIN_V2.QO_SOURCE_LEVEL_2_NAME
, MAIN_V2.QO_SOURCE_LEVEL_3_NAME
, MAIN_V2.PARTNER_TYPE
, MAIN_V2.PARTNER_RANKING
, MAIN_V2.PTDT_SOURCE_LEVEL_1_NAME
, MAIN_V2.PTDT_SOURCE_LEVEL_2_NAME
, MAIN_V2.PTDT_SOURCE_LEVEL_3_NAME
, CASE
	WHEN NVL(MAIN_V2.PARTNER_TYPE, 'OTHER') != 'OTHER'
		THEN 1
	ELSE 0
END IS_PTDT_SOURCE
---
, MAIN_V2.LOAN_CODE
, MAIN_V2.LOAN_CREATED_DATE
--	II.1.2. LỌC KÊNH BÁN PTDT
, CASE
	WHEN
			PTDT_CHANNEL_CODE IN ('PTDT3P')
		OR	PTDT_CHANNEL_CODE LIKE '%TLS%'
		THEN 1
	ELSE 0
END IS_PTDT_SALES
, MAIN_V2.USER_CODE_SALES
--- LOAN_WID
, MAIN_V2.LOAN_WID
, MAIN_V2.DISBURSE_DATE_WID
, MAIN_V2.PTDT_CHANNEL_CODE
, MAIN_V2.OBJECT_DATE
, SYSTIMESTAMP -1 CREATED_DATE
FROM (
	SELECT
	MAIN.*
	-- I.1.4. PTDT NGUỒN FINAL
	, CASE
		WHEN MAIN.E2E_SOURCE_LEVEL_1_NAME IS NOT NULL
			THEN 'PTDT_E2E'
		WHEN MAIN.QO_SOURCE_LEVEL_2_NAME IS NOT NULL
			THEN 'PTDT_QO'
		WHEN MAIN.PTDT_LEADS IS NOT NULL
			THEN MAIN.PTDT_LEADS
		ELSE 'OTHER'
	END PARTNER_TYPE
	, CASE
		WHEN MAIN.QO_SOURCE_LEVEL_2_NAME IS NOT NULL
			THEN MAIN.QO_SOURCE_LEVEL_2_NAME
		WHEN MAIN.E2E_SOURCE_LEVEL_1_NAME IS NOT NULL
			THEN MAIN.E2E_SOURCE_LEVEL_1_NAME
		WHEN MAIN.PTDT_LEADS IS NOT NULL
			THEN MAIN.POL_SOURCE_LEVEL_1_NAME
		ELSE 'OTHER'
	END PTDT_SOURCE_LEVEL_1_NAME
	, CASE
		WHEN MAIN.QO_SOURCE_LEVEL_2_NAME IS NOT NULL
			THEN MAIN.QO_SOURCE_LEVEL_2_NAME
		WHEN MAIN.E2E_SOURCE_LEVEL_1_NAME IS NOT NULL
			THEN MAIN.E2E_SOURCE_LEVEL_2_NAME
		WHEN MAIN.PTDT_LEADS IS NOT NULL
			THEN MAIN.POL_SOURCE_LEVEL_2_NAME
		ELSE 'OTHER'
	END PTDT_SOURCE_LEVEL_2_NAME
	, CASE
		WHEN MAIN.QO_SOURCE_LEVEL_2_NAME IS NOT NULL
			THEN MAIN.QO_SOURCE_LEVEL_3_NAME
		WHEN MAIN.E2E_SOURCE_LEVEL_1_NAME IS NOT NULL
			THEN MAIN.E2E_SOURCE_LEVEL_3_NAME
		WHEN MAIN.PTDT_LEADS IS NOT NULL
			THEN MAIN.POL_SOURCE_LEVEL_3_NAME
		ELSE 'OTHER'
	END PTDT_SOURCE_LEVEL_3_NAME
	-------
	, GREATEST(
		NVL(MAIN.POL_DATE_WID , 19000101),
	    NVL(MAIN.LOAN_CREATED_DATE  , 19000101),
	    NVL(MAIN.DISBURSE_DATE_WID , 19000101)
	) OBJECT_DATE
	, CASE
		WHEN MAIN.E2E_SOURCE_LEVEL_1_NAME IS NOT NULL
			THEN 1
		WHEN MAIN.QO_SOURCE_LEVEL_2_NAME IS NOT NULL
			THEN 2
		WHEN MAIN.PTDT_LEADS IS NOT NULL
			THEN 3
	END PARTNER_RANKING
	FROM (
		SELECT
		--	I. Nguồn
			-- I.1.1. Nguồn POL
		NVL(L_POL.POL_WID, POL.POL_WID ) POL_WID
		, NVL(L_POL.YEAR_NUM, POL.YEAR_NUM) POL_YEAR_NUM
		, NVL(L_POL.MONTH_NUM, POL.MONTH_NUM) POL_MONTH_NUM
		, NVL(L_POL.DATE_WID, POL.DATE_WID) POL_DATE_WID
		, NVL(L_POL.SOURCE_LEVEL_1_ID, POL.SOURCE_LEVEL_1_ID) POL_SOURCE_LEVEL_1_ID
		, NVL(L_POL.SOURCE_LEVEL_2_ID, POL.SOURCE_LEVEL_2_ID) POL_SOURCE_LEVEL_2_ID
		, NVL(L_POL.SOURCE_LEVEL_1_NAME, POL.SOURCE_LEVEL_1_NAME) POL_SOURCE_LEVEL_1_NAME
		, NVL(L_POL.SOURCE_LEVEL_2_NAME, POL.SOURCE_LEVEL_2_NAME) POL_SOURCE_LEVEL_2_NAME
		, NVL(L_POL.SOURCE_LEVEL_3_NAME, POL.SOURCE_LEVEL_3_NAME) POL_SOURCE_LEVEL_3_NAME
		, NVL(L_POL.CAMPAIGN_NM, POL.CAMPAIGN_NM) POL_CAMPAIGN_NM
		, NVL(L_POL.STATUS_NM, POL.STATUS_NM) POL_STATUS_NM
		, CASE -- NOTED: Nhập lại 3. LEADS (POL)
					-- LOẠI BỎ: -- 4. KÊNH BÁN PTDT: TLS giải ngân
			WHEN
				(
					( --- 1. QuickOffer
						--- 1.1 Dự án MB
						LOAN.FUND_NAME = 'MB'
						--- 1.2. Dự án MOMO
					OR	L_AGENT.MAIN_AGENT = 'MOMO'
					)
				OR ( -- 2. E2E (LOS)
						PTDT_E2E.LOAN_CODE IS NOT NULL
					)
				OR ( -- 3. LEADS (POL)
						POL.SOURCE_LEVEL_1_ID IN ( 363 --- PTĐT Leads
												 , 409 --- PTĐT E2E
												)
					OR (	-- TTKH BÀN GIAO https://www.gapowork.vn/ticket/view/1743395345933
							POL.SOURCE_LEVEL_1_ID = 1 -- Digital HO
						AND POL.SOURCE_LEVEL_2_ID IN (4 -- 3P Leads
													, 6 -- PartnerShip
													)
						AND (
								LOAN.DISBURSE_DATE_WID >= 20250401
							OR	TO_NUMBER(TO_CHAR(POL.YEAR_NUM) || LPAD(POL.MONTH_NUM, 2, '0')) >= 202504
							)
						)
					OR ( -- 2025 LEADS - MB
							POL.YEAR_NUM = 2025
						AND POL.CAMPAIGN_NM IN ('Tạo TK MBbank'
													, 'NFC'
													, 'Đơn vay MB'
													, 'Luồng rớt MB'
												)
						)
					)
			)
				THEN 'PTDT_LEADS'
		END PTDT_LEADS
			-- I.1.2. Nguồn E2E
		, PTDT_E2E.E2E_SOURCE_LEVEL_1_NAME
		, PTDT_E2E.E2E_SOURCE_LEVEL_2_NAME
		, PTDT_E2E.E2E_SOURCE_LEVEL_3_NAME
			-- I.1.3. Nguồn QUICKOFFER
		, CASE
			WHEN LOAN.FUND_NAME = 'MB'
				THEN 'QO_MB'
			WHEN L_AGENT.MAIN_AGENT = 'MOMO'
				THEN 'QO_MOMO'
		END QO_SOURCE_LEVEL_2_NAME
		, CASE
			WHEN LOAN.FUND_NAME = 'MB'
				THEN 'MB'
			WHEN L_AGENT.MAIN_AGENT = 'MOMO'
				THEN 'MOMO'
		END QO_SOURCE_LEVEL_3_NAME
		, L_MASTER.APP_FORM_ID LOS_APP_FORM_ID
		-- II. Kênh bán
			--	II.1.1. PTDT KÊNH BÁN FINAL
		, CASE
			WHEN TLS_LOAN.PTDT_CHANNEL_CODE IS NOT NULL
				THEN TLS_LOAN.PTDT_CHANNEL_CODE
			WHEN TLS_EXCEP.EXCEPTION_TYPE = 'ADD'
				THEN 'TLS_EXCEPTION'
			WHEN TLS_EXCEP.EXCEPTION_TYPE = 'REMOVE'
				THEN 'TLS_REMOVE'
			ELSE LOAN.CHANNEL_CODE
		END PTDT_CHANNEL_CODE
		, CASE
			WHEN
				 TLS_LOAN.PTDT_CHANNEL_CODE IS NOT NULL
					THEN TLS_LOAN.TLS_USERCODE
			WHEN TLS_EXCEP.LOAN_CODE IS NOT NULL
				THEN TLS_EXCEP.TLS_USERCODE
		END USER_CODE_SALES
		-- III. RAW_DATA
		, L_MASTER.CODENO LOAN_CODE
		, TO_CHAR(L_MASTER.CREATEDDATE, 'YYYYMMDD') LOAN_CREATED_DATE
		, LOAN.LOAN_WID
		, LOAN.DISBURSE_DATE_WID
		FROM F88DWH.VW_W_LOAN_MASTER_F L_MASTER
		LEFT JOIN F88DWH.VW_W_LOAN_AGENT_F L_AGENT
			ON L_AGENT.LOAN_CODE = L_MASTER.CODENO
		LEFT JOIN (
			SELECT
			L_MASTER.CODENO  LOAN_CODE
			, TO_CHAR(L_MASTER.CREATEDDATE, 'YYYYMMDD') LOAN_CREATED
			, 'PTDT3P' E2E_SOURCE_LEVEL_1_NAME
			, L_AGENT.MAIN_AGENT E2E_SOURCE_LEVEL_2_NAME
			, L_AGENT.SUB_AGENT E2E_SOURCE_LEVEL_3_NAME
			, L_AGENT.USER_AGENT_STAFF
			, L_AGENT.AGENT_STAFF_CODE
			FROM F88DWH.VW_W_LOAN_MASTER_F L_MASTER
			LEFT JOIN F88DWH.W_LOAN_AGENT_F L_AGENT
				ON L_AGENT.LOAN_CODE = L_MASTER.CODENO
			LEFT JOIN F88DWH.W_LOAN_STATE_WORKFLOW_F L_STATE
				ON L_STATE.LOAN_CODE = L_MASTER.CODENO
			LEFT JOIN F88DWH.GRP GRP
				ON GRP.GRP_ID  = L_STATE.WORK_FLOW_STATUS_WID
				AND GRP.GRP_TP = 'WORK_FLOW_STATUS'
			WHERE 1=1
			AND GRP.GRP_CODE  = '001'
			AND L_STATE.ROLE =  'CVKD_PTDT'
		) PTDT_E2E
			ON PTDT_E2E.LOAN_CODE = L_MASTER.CODENO
		LEFT JOIN F88DWH.W_LOAN_DTL_F LOAN
			ON LOAN.LOAN_WID = L_MASTER.LOAN_WID
		LEFT JOIN F88DWH.W_POL_DTL_F L_POL
			ON L_POL.LOAN_CODE = L_MASTER.CODENO
		FULL JOIN (
			SELECT
			POL.POL_WID
			, POL.YEAR_NUM
			, POL.MONTH_NUM
			, POL.DATE_WID
			, POL.SOURCE_LEVEL_1_ID
			, POL.SOURCE_LEVEL_2_ID
			, POL.SOURCE_LEVEL_1_NAME
			, POL.SOURCE_LEVEL_2_NAME
			, POL.SOURCE_LEVEL_3_NAME
			, POL.CAMPAIGN_NM
			, POL.STATUS_NM
			, LOAN.LOAN_WID
			, L_MASTER.CODENO LOAN_CODE
			, L_MASTER.CREATEDDATE
			, LOAN.DISBURSE_DATE_WID
			FROM F88DWH.W_POL_DTL_F POL
			LEFT JOIN F88DWH.VW_W_LOAN_MASTER_F L_MASTER
				ON L_MASTER.CODENO = POL.LOAN_CODE
			LEFT JOIN F88DWH.W_LOAN_DTL_F LOAN
				ON LOAN.LOAN_WID = POL.LOAN_WID
			WHERE 1=1
			AND (
					POL.YEAR_NUM = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'YYYY')
				AND POL.MONTH_NUM = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM')
			)
			OR 	(
					LOAN.DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
				AND LOAN.DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
			)
			OR (
				TO_CHAR(L_MASTER.CREATEDDATE , 'YYYYMM') = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'YYYYMM')
			)
		) POL
			ON POL.LOAN_CODE = L_MASTER.CODENO
		LEFT JOIN (
			SELECT
			L_STATE.LOAN_CODE
			, 'TLS_E2E' PTDT_CHANNEL_CODE
			, CASE
				WHEN EMP.EMPLOYEE_CODE  = 'systls'
						THEN EMP1.EMPLOYEE_CODE
				ELSE EMP.EMPLOYEE_CODE
			END TLS_USERCODE
			FROM F88DWH.W_LOAN_STATE_WORKFLOW_F L_STATE
			LEFT JOIN F88DWH.W_LOAN_DTL_F LOAN
				ON LOAN.LOAN_WID = L_STATE.LOAN_WID
			LEFT JOIN F88DWH.VW_W_LOAN_AGENT_F L_AGENT
				ON L_AGENT.LOAN_CODE = L_STATE.LOAN_CODE
				AND L_AGENT.MAIN_AGENT = 'TLS'
			LEFT JOIN F88DWH.VW_W_HRM_EMPLOYEE_INFOR_D EMP1
				ON LOWER(EMP1.EMPLOYEE_USER_NM) = LOWER(TRIM(TO_CHAR(L_AGENT.AGENT_STAFF_CODE)))
			LEFT JOIN F88DWH.VW_W_EMPLOYEE_D EMP ON EMP.EMPLOYEE_WID  = L_STATE.EMPLOYEE_WID_UPDATE
			LEFT JOIN F88DWH.GRP GRP
				ON GRP.GRP_ID  = L_STATE.WORK_FLOW_STATUS_WID
				AND GRP_TP = 'WORK_FLOW_STATUS'
			WHERE 1=1
--			AND LOAN.DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
--			AND LOAN.DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
			AND GRP.GRP_CODE  = '001'
			AND L_STATE.ROLE = 'CV_TLS'
			AND NVL(LOAN.CHANNEL_CODE, 'TLS_E2E') != 'Online'
			UNION
			SELECT
			PAWN.CODE_NO
			, 'TLS_ONLINE' PTDT_CHANNEL_CODE
			, EMP.EMPLOYEE_CODE
			FROM F88DWH.W_MYF88_PAWN_F MY_F88
			INNER JOIN F88DWH.W_PAWN_F PAWN
				ON PAWN.PAWN_WID  = MY_F88.PAWN_WID
			LEFT JOIN F88DWH.VW_W_HRM_EMPLOYEE_INFOR_D EMP
				ON EMP.EMPLOYEE_CODE = UPPER(TRIM(TO_CHAR(MY_F88.INTRODUCER_EMPLOYEE_CODE)))
			WHERE 1=1
			AND PAWN.MIFOS_CHANNEL_CODE  = 'Online'
			AND EMP.LEVEL4_NAME = 'Phòng Bán hàng qua điện thoại'
--			AND PAWN.MIFOS_DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
--			AND PAWN.MIFOS_DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
		) TLS_LOAN ON TLS_LOAN.LOAN_CODE = LOAN.LOAN_CODE
		LEFT JOIN (
			SELECT LOAN_CODE
			, 'TLS_EXCEPTION'
			, TLS.TLS_USER TLS_USERCODE
			, TLS.EXCEPTION_TYPE
			FROM GIANGNT14.W_TLS_EXCEPTION_F TLS
			WHERE 1=1
--			AND TLS.EXCEPTION_TYPE = 'ADD'
--			GROUP BY TLS.LOAN_CODE
		) TLS_EXCEP ON TLS_EXCEP.LOAN_CODE = L_MASTER.CODENO
		WHERE 1=1
		--- STEP_1
		AND ( -- TIME
			(
					LOAN.DISBURSE_DATE_WID >= TO_CHAR(TRUNC(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM'),'YYYYMMDD')
				AND LOAN.DISBURSE_DATE_WID <= TO_CHAR(LAST_DAY(TO_DATE(P_DATE, 'YYYYMMDD')) , 'YYYYMMDD')
			)
			OR (	POL.YEAR_NUM = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'YYYY')
				AND POL.MONTH_NUM = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'MM')
			)
			OR (	TO_CHAR(L_MASTER.CREATEDDATE, 'YYYYMM') = TO_CHAR(TO_DATE(P_DATE, 'YYYYMMDD'), 'YYYYMM')

			)
		)
		--- STEP_2
		---- IV. Định danh PTĐT
		AND (
				( --- IV.1. QuickOffer
					--- IV.1.1. Dự án MB
					LOAN.FUND_NAME = 'MB'
					--- IV.1.2. Dự án MOMO
				OR	L_AGENT.MAIN_AGENT = 'MOMO'
				)
			OR ( -- IV.2. E2E (LOS)
					PTDT_E2E.LOAN_CODE IS NOT NULL
				)
			OR ( -- IV.3. LEADS (POL)
					POL.SOURCE_LEVEL_1_ID IN ( 363 --- PTĐT Leads
											 , 409 --- PTĐT E2E
											)
				OR (	-- TTKH BÀN GIAO https://www.gapowork.vn/ticket/view/1743395345933
						POL.SOURCE_LEVEL_1_ID = 1 -- Digital HO
					AND POL.SOURCE_LEVEL_2_ID IN (4 -- 3P Leads
												, 6 -- PartnerShip
												)
					AND (
							LOAN.DISBURSE_DATE_WID >= 20250401
						OR	TO_NUMBER(TO_CHAR(POL.YEAR_NUM) || LPAD(POL.MONTH_NUM, 2, '0')) >= 202504
						)
					)
				OR ( -- IV.3.1. 2025 LEADS - MB
						POL.YEAR_NUM = 2025
					AND POL.CAMPAIGN_NM IN ('Tạo TK MBbank'
												, 'NFC'
												, 'Đơn vay MB'
												, 'Luồng rớt MB'
											)
					)
				)
			OR ( -- IV.4. KÊNH BÁN PTDT: TLS giải ngân
					TLS_LOAN.LOAN_CODE IS NOT NULL
				OR	TLS_EXCEP.LOAN_CODE IS NOT NULL
			    )
		)
	) MAIN
	WHERE 1=1
--	AND MAIN.LOAN_CREATED_DATE IS NOT NULL
) MAIN_V2

;

MERGE INTO F88DWH.W_PTDT_OBJECT MAIN
USING (
	SELECT
	ROWID
	, CASE
		WHEN ROW_NUMBER() OVER ( PARTITION BY POL_WID ORDER BY OBJECT_DATE DESC ) = 1
				THEN 1
		ELSE 0
	END POL_ROW_IND
	, CASE
		WHEN ROW_NUMBER() OVER ( PARTITION BY LOAN_CODE ORDER BY PARTNER_RANKING DESC ) = 1
			THEN
				CASE
					WHEN 	PARTNER_TYPE = 'PTDT_LEADS'
						AND POL_STATUS_NM = 'Không xác định'
							THEN 0
					ELSE 1
				END
		ELSE 0
	END LOAN_ROW_IND
	, SYSTIMESTAMP -1 UPDATED_DATE
	FROM F88DWH.W_PTDT_OBJECT
) PTDT_MERGE
	ON (MAIN.ROWID = PTDT_MERGE.ROWID)
        WHEN MATCHED THEN UPDATE SET
        MAIN.POL_ROW_IND = PTDT_MERGE.POL_ROW_IND,
        MAIN.LOAN_ROW_IND = PTDT_MERGE.LOAN_ROW_IND,
        MAIN.UPDATED_DATE = PTDT_MERGE.UPDATED_DATE

;

COMMIT;

END PROC_W_PTDT_OBJECT;
```


## By --name PROC_W_POL_DTL_F
Found 2 object(s).

Found **2** matching objects (full source).

### `F88DWH.PROC_W_POL_DTL_F` (PROCEDURE)

```
PROCEDURE        PROC_W_POL_DTL_F (P_DATE NUMBER)
IS
BEGIN

---------------------

--- 0. Delete old data
DELETE /*+ PARALLEL(10) */
FROM F88DWH.W_POL_DTL_F
WHERE POL_WID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);

COMMIT;

---------------------

--- 1. Insert data from ONLINE_PAWN
INSERT /*+PARALLEL(6) */ INTO F88DWH.W_POL_DTL_F (
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        POL_WID,
        STATUS,
        STATUS_NM,
        FORM_ASSET_TP_NM,
        LOAN_ASSET_TP_NM,
        AREA_WID,
        PROVINCE_WID,
        DISTRICT_WID,
        AREA,
        PROVINCE,
        DISTRICT,
        EMPLOYEE_WID,
        EMPLOYEE_NM,
        SHOP_WID,
        SHOP_NM,
        GROUP_ID,
        GROUP_NM,
        GROUP_ID_HIST,
        POL_CUS_WID,
        CALLER_SHOP_WID,
        CALLER_ONLINE_WID,
        PAWN_ID,
        REASON_WID,
        REASON_NM,
        CAMPAIGN_WID,
        CAMPAIGN_NM,
        SOURCE_LEVEL_1_ID,
        SOURCE_LEVEL_2_ID,
        SOURCE_LEVEL_3_ID,
        SOURCE_LEVEL_4_ID,
        SOURCE_LEVEL_1_NAME,
        SOURCE_LEVEL_2_NAME,
        SOURCE_LEVEL_3_NAME,
        SOURCE_LEVEL_4_NAME,
        FORM_CREATED_DT,
        TRANS_TO_SHOP_DT,
        CANCEL_DT,
        FIRST_CALL_DT,
        LAST_CALL_DT,
        LNG_CALL_BACK,
        IS_NOT_CONTROL,
        URL,
        REFERENCE_ID,
        FIRST_SHOP_TRANS_DT,
        LOAN_CODE,
        LOAN_WID,
        DISBURSE_DT,
        DISBURSE_AMT,
        CLOSED_DT,
        LAST_PROCESS_DT,
        LAST_PROCESS_REASON_NM,
        LAST_PROCESS_REASON_TYPE,
        CTR_TYPE,
        CHANNEL_CODE,
        FIRST_OP_DT,
        OLD_SOURCE,
        BRAND_IDENTITY_NM,
        FIRST_FORWARD_DT,
        FIRST_REEXPLOIT_DT,
        LAST_PROCESS_NOTE,
        FIRST_APPROVE_DT,
        FIRST_TLS_GROUP_NM,
        LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD_EMPLOYEE_NM,
        FIRST_GROUP_NM,
        PAWN_WID
        )
SELECT /*+PARALLEL(6) */TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'YYYY')) YEAR_NUM,
        TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'MM')) MONTH_NUM,
        wopf.CREATED_DT,
        wopf.INTEGRATION_ID POL_WID,
        wopf.STATUS,
        CASE wopf.STATUS WHEN 1 THEN 'Chưa chia'
                WHEN 2 THEN 'Chưa tư vấn'
                WHEN 3 THEN 'Đang chăm sóc'
                WHEN 4 THEN 'Hủy đăng ký'
                WHEN 5 THEN 'Nhận cầm cố'
                WHEN 13 THEN 'Chưa chia TNKH'
                ELSE 'Không xác định' END STATUS_NM,
        --wopf.ASSET_TP_WID,
        watd.ASSET_TP_NM FORM_ASSET_TP_NM,
        watd2.ASSET_TP_NM LOAN_ASSET_TP_NM,
        --wopf.CHANNEL_WID,
        wopf.AREA_WID,
        wopf.PROVINCE_WID,
        wopf.DISTRICT_WID,
        wad.AREA_NM AREA,
        wpd.POL_REGION_NM PROVINCE,
        wdd.POL_REGION_NM DISTRICT,
        wopf.EMPLOYEE_WID,
        wed.EMPLOYEE_NM,
        wopf.SHOP_WID,
        wsd.SHOP_NM,
        wogd.ID GROUP_ID,
        wogd.GROUP_NM,
        SUBSTR(wopf.GROUP_IDS_REVEICED,1,1000),
        wopf.POL_CUS_WID,
        wopf.CALLER_SHOP_WID,
        wopf.CALLER_ONLINE_WID,
        wopf.PAWN_ID,
        wopf.REASON_WID,
--        NULL REASON_NM, --Namdhh hotfix tạm thời 20240803
        worfd.CANCELED_REASON_NM,
        wopf.CAMPAIN_EXCEL_WID CAMPAIN_WID,
        wocd.CAMPAIGN_NM,
        wosd1.INTEGRATION_ID SOURCE_LEVEL_1_ID,
        wopf.GROUP_SOURCE_ID SOURCE_LEVEL_2_ID,
        wopf.SOURCE_ID SOURCE_LEVEL_3_ID,
        wopf.SEC_SOURCE_ID SOURCE_LEVEL_4_ID,
        wosd1.STR_NAME SOURCE_LEVEL_1_NAME,
        wosd2.STR_NAME SOURCE_LEVEL_2_NAME,
        wosd3.STR_NAME SOURCE_LEVEL_3_NAME,
        wosd4.STR_NAME SOURCE_LEVEL_4_NAME,
        TO_DATE(wopf.CREATED_DT || LPAD(wopf.CREATED_TIME, 6, 0), 'YYYYMMDDHH24MISS') FORM_CREATED_DT,
        TO_DATE(DECODE(wopf.TRANS_TO_SHOP_DT, -1, NULL, wopf.TRANS_TO_SHOP_DT || DECODE(wopf.TRANS_TO_SHOP_TIME, -1, '000000', LPAD(wopf.TRANS_TO_SHOP_TIME, 6, 0))), 'YYYYMMDDHH24MISS') TRANS_TO_SHOP_DT,
        CASE WHEN LENGTH(wopf.CANCEL_DT) = 10 THEN TO_DATE(wopf.CANCEL_DT || '0000', 'YYYYMMDDHH24MISS')
                ELSE NULL END CANCEL_DT,
        TO_DATE(DECODE(wopf.FIRST_CALL_DT, -1, NULL, wopf.FIRST_CALL_DT), 'YYYYMMDDHH24MISS') FIRST_CALL_DT,
        TO_DATE(DECODE(wopf.LAST_CALL_DT, -1, NULL, wopf.LAST_CALL_DT), 'YYYYMMDDHH24MISS') LAST_CALL_DT,
        CASE WHEN LENGTH(wopf.LNG_CALL_BACK) = 14 THEN TO_DATE(wopf.LNG_CALL_BACK, 'YYYYMMDDHH24MISS')
                ELSE NULL END LNG_CALL_BACK,
        wopf.ISNOTCONTROL IS_NOT_CONTROL,
        wopf.URL,
        wopf.REFERENCE_AFFILATE_ID REFERENCE_ID,
        TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS') FIRST_SHOP_TRANS_DT,
        --NULL FIRST_SHOP_TRANS_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_CODE ELSE wldf2.LOAN_CODE END LOAN_CODE,
        wopf.LOAN_CODE,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_WID ELSE wldf2.LOAN_WID END LOAN_WID,
        wldf.LOAN_WID,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_DATE_WID ELSE wldf2.DISBURSE_DATE_WID END DISBURSE_DT,
        wldf.DISBURSE_DATE_WID DISBURSE_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_AMT ELSE wldf2.DISBURSE_AMT END DISBURSE_AMT,
        wldf.DISBURSE_AMT,
        wldf.CLOSED_DATE_WID CLOSED_DT,
        last_op.LAST_OP_DT LAST_PROCESS_DT,
        last_op.LAST_OP_REASON_NM LAST_PROCESS_REASON_NM,
        last_op.LAST_OP_REASON_TYPE LAST_PROCESS_REASON_TYPE,
        wldf.CTR_TYPE,
        wldf.CHANNEL_CODE,
        TO_DATE(first_op.FIRST_OP_DT, 'YYYYMMDDHH24MISS') FIRST_OP_DT,
        old_source.OLD_SOURCE,
        wpbid.POL_BRAND_IDENTITY_NAME BRAND_IDENTITY_NM,
        FIRST_FORWARD.PROCESS_DT FIRST_FORWARD_DT,
        FIRST_REEXPLOIT.PROCESS_DT FIRST_REEXPLOIT_DT,
        last_op.LAST_OP_NOTE LAST_PROCESS_NOTE,
        first_approve.PROCESS_DT FIRST_APPROVE_DT,
        first_tls_process.GROUP_NM FIRST_TLS_GROUP_NM,
        LAST_FORWARD.EMPLOYEE_CODE LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD.EMPLOYEE_NM LAST_FORWARD_EMPLOYEE_NM,
        wogd2.GROUP_NM FIRST_GROUP_NM,
        p.PAWN_WID
FROM F88DWH.W_ONLINE_PAWN_F wopf
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wopf.LOAN_CODE = wldf.LOAN_CODE
LEFT JOIN F88DWH.W_PAWN_F p
        ON wopf.LOAN_CODE = p.CODE_NO
                AND p.LEGACY_SYSTEM_FLAG = 0
/*
LEFT JOIN F88DWH.W_LOAN_MASTER_F wlmf
        ON wopf.PAWN_ID = wlmf.INTEGRATION_ID
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wlmf.LOAN_WID = wldf.LOAN_WID
                AND wldf.SOURCE = 'MIFOS'
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf2
        ON wopf.PAWN_ID = wldf2.INTEGRATION_ID
                AND wldf2.SOURCE = 'POS'
*/
LEFT JOIN F88DWH.W_ASSET_TP_D watd
        ON wopf.ASSET_TP_WID = watd.ASSET_TP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D watd2
        ON wldf.ASSET_TYPE_WID = watd2.ASSET_TP_WID
LEFT JOIN F88DWH.W_AREA_D wad
        ON wopf.AREA_WID = wad.AREA_WID
LEFT JOIN F88DWH.W_POL_REGION_D wpd
        ON wopf.PROVINCE_WID = wpd.POL_REGION_WID
LEFT JOIN F88DWH.W_POL_REGION_D wdd
        ON wopf.DISTRICT_WID = wdd.POL_REGION_WID
LEFT JOIN F88DWH.W_EMPLOYEE_D wed
        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
LEFT JOIN F88DWH.W_SHOP_D wsd
        ON wopf.SHOP_WID = wsd.SHOP_WID
LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE id <> 'TLS') wogd
        ON wopf.ONLINE_GRP_WID = wogd.ONLINE_GRP_WID
LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
LEFT JOIN F88DWH.W_ONLINE_CAMPAIGN_D wocd
        ON wopf.CAMPAIN_EXCEL_WID = wocd.CAMPAIGN_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd1
        ON wopf.CHANNEL_WID = wosd1.ONLINE_SOURCE_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd2
        ON wopf.GROUP_SOURCE_ID = wosd2.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd3
        ON wopf.SOURCE_ID = wosd3.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd4
        ON wopf.SEC_SOURCE_ID = wosd4.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_GRP_D wogd2
        ON wopf.FIRST_GROUP_WID = wogd2.ONLINE_GRP_WID
--/*
LEFT JOIN
        (
        SELECT /*+PARALLEL(4) */ INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE upper(trim(id)) <> 'TLS') g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and to_number(NULLIF(g1.id, 'TLS')) >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                AND t.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON wopf.INTEGRATION_ID = shop_trans.INT_POL_PAWN_ID
--*/
LEFT JOIN (
        SELECT /*+PARALLEL(4) */ INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_OP_DT
        FROM F88DWH.W_ONLINE_PROCESS_F op
        LEFT JOIN F88DWH.w_online_grp_d wogd
                ON op.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
        WHERE 1=1
                AND op.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND wogd.ID <> '44'
        GROUP BY INT_POL_PAWN_ID
        ) first_op
        ON wopf.INTEGRATION_ID = first_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT POL_WID,
                GROUP_NM
        FROM (
                SELECT /*+PARALLEL(4) */ wopf.INT_POL_PAWN_ID POL_WID,
                        wogd.GROUP_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_tls_process
        ON wopf.INTEGRATION_ID = first_tls_process.POL_WID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE,
                OP_NOTE LAST_OP_NOTE
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd.CANCELED_REASON_NM OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        wopf.NOTE OP_NOTE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) last_op
        ON wopf.INTEGRATION_ID = last_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OLD_SOURCE
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID,
                        wopf.NOTE OLD_SOURCE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 158
                        AND wopf.NOTE LIKE 'Nguồn cũ%'
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) old_source
        ON wopf.INTEGRATION_ID = old_source.INT_POL_PAWN_ID
LEFT JOIN F88DWH.W_POL_BRAND_IDENTITY_D wpbid
        ON wopf.BRAND_IDENTITY_WID = wpbid.POL_BRAND_IDENTITY_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_FORWARD
        ON wopf.INTEGRATION_ID = FIRST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT,
                EMPLOYEE_CODE,
                EMPLOYEE_NM
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        wed.EMPLOYEE_CODE,
                        wed.EMPLOYEE_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                LEFT JOIN F88DWH.W_EMPLOYEE_D wed
                        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) LAST_FORWARD
        ON wopf.INTEGRATION_ID = LAST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 137
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_REEXPLOIT
        ON wopf.INTEGRATION_ID = FIRST_REEXPLOIT.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT /*+PARALLEL(4) */wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 179
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_approve
        ON wopf.INTEGRATION_ID = first_approve.POL_WID
WHERE 1=1
        --AND wopf.STATUS IN (1, 2, 3, 4, 5, 13)
        AND wopf.INTEGRATION_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);

COMMIT;

---------------------

--- 2. Update data from ONLINE_PROCESS
-- 2.1. Update first shop trans
/*
MERGE
INTO F88DWH.W_POL_DTL_F wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN F88DWH.w_online_grp_d g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and g1.id >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                --AND t.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                --AND t.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                --AND t.DATE_WID = P_DATE
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON (wpdf.POL_WID = shop_trans.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.FIRST_SHOP_TRANS_DT = TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS')
WHERE wpdf.FIRST_SHOP_TRANS_DT IS NULL;

COMMIT;
*/

-- 2.2. Update last process info
/*
MERGE
INTO F88DWH.W_POL_DTL_F wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd. OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                        AND wopf.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                        AND wopf.DATE_WID = P_DATE
                )
        WHERE RN = 1
        ) wopf
        ON (wpdf.POL_WID = wopf.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.LAST_PROCESS_DT = wopf.LAST_OP_DT,
                wpdf.LAST_PROCESS_REASON_NM = wopf.LAST_OP_REASON_NM,
                wpdf.LAST_PROCESS_REASON_TYPE = wopf.LAST_OP_REASON_TYPE;

COMMIT;
*/

-- 2.3. Clean up data
/*
DELETE FROM F88DWH.W_POL_DTL_F
WHERE POL_WID IN (
        SELECT ID FROM STGPROD.POL_PAWN_V2_TMP
        WHERE INT_STATUS NOT IN (1, 2, 3, 4, 5, 13)
);
*/

COMMIT;

---------------------

END PROC_W_POL_DTL_F;
```

### `HANHDTM.PROC_W_POL_DTL_F` (PROCEDURE)

```
PROCEDURE         PROC_W_POL_DTL_F (P_DATE NUMBER)
IS
BEGIN

---------------------

--- 0. Delete old data
DELETE /*+ PARALLEL(10) */
FROM HANHDTM.W_POL_DTL_F
WHERE POL_WID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);

COMMIT;

---------------------

--- 1. Insert data from ONLINE_PAWN
INSERT INTO HANHDTM.W_POL_DTL_F (
        YEAR_NUM,
        MONTH_NUM,
        DATE_WID,
        POL_WID,
        STATUS,
        STATUS_NM,
        FORM_ASSET_TP_NM,
        LOAN_ASSET_TP_NM,
        AREA_WID,
        PROVINCE_WID,
        DISTRICT_WID,
        AREA,
        PROVINCE,
        DISTRICT,
        EMPLOYEE_WID,
        EMPLOYEE_NM,
        SHOP_WID,
        SHOP_NM,
        GROUP_ID,
        GROUP_NM,
        GROUP_ID_HIST,
        POL_CUS_WID,
        CALLER_SHOP_WID,
        CALLER_ONLINE_WID,
        PAWN_ID,
        REASON_WID,
        REASON_NM,
        CAMPAIGN_WID,
        CAMPAIGN_NM,
        SOURCE_LEVEL_1_ID,
        SOURCE_LEVEL_2_ID,
        SOURCE_LEVEL_3_ID,
        SOURCE_LEVEL_4_ID,
        SOURCE_LEVEL_1_NAME,
        SOURCE_LEVEL_2_NAME,
        SOURCE_LEVEL_3_NAME,
        SOURCE_LEVEL_4_NAME,
        FORM_CREATED_DT,
        TRANS_TO_SHOP_DT,
        CANCEL_DT,
        FIRST_CALL_DT,
        LAST_CALL_DT,
        LNG_CALL_BACK,
        IS_NOT_CONTROL,
        URL,
        REFERENCE_ID,
        FIRST_SHOP_TRANS_DT,
        LOAN_CODE,
        LOAN_WID,
        DISBURSE_DT,
        DISBURSE_AMT,
        CLOSED_DT,
        LAST_PROCESS_DT,
        LAST_PROCESS_REASON_NM,
        LAST_PROCESS_REASON_TYPE,
        CTR_TYPE,
        CHANNEL_CODE,
        FIRST_OP_DT,
        OLD_SOURCE,
        BRAND_IDENTITY_NM,
        FIRST_FORWARD_DT,
        FIRST_REEXPLOIT_DT,
        LAST_PROCESS_NOTE,
        FIRST_APPROVE_DT,
        FIRST_TLS_GROUP_NM,
        LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD_EMPLOYEE_NM,
        FIRST_GROUP_NM
        )
SELECT TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'YYYY')) YEAR_NUM,
        TO_NUMBER(TO_CHAR(TO_DATE(wopf.CREATED_DT, 'YYYYMMDD'), 'MM')) MONTH_NUM,
        wopf.CREATED_DT,
        wopf.INTEGRATION_ID POL_WID,
        wopf.STATUS,
        CASE wopf.STATUS WHEN 1 THEN 'Chưa chia'
                WHEN 2 THEN 'Chưa tư vấn'
                WHEN 3 THEN 'Đang chăm sóc'
                WHEN 4 THEN 'Hủy đăng ký'
                WHEN 5 THEN 'Nhận cầm cố'
                WHEN 13 THEN 'Chưa chia TNKH'
                ELSE 'Không xác định' END STATUS_NM,
        --wopf.ASSET_TP_WID,
        watd.ASSET_TP_NM FORM_ASSET_TP_NM,
        watd2.ASSET_TP_NM LOAN_ASSET_TP_NM,
        --wopf.CHANNEL_WID,
        wopf.AREA_WID,
        wopf.PROVINCE_WID,
        wopf.DISTRICT_WID,
        wad.AREA_NM AREA,
        wpd.POL_REGION_NM PROVINCE,
        wdd.POL_REGION_NM DISTRICT,
        wopf.EMPLOYEE_WID,
        wed.EMPLOYEE_NM,
        wopf.SHOP_WID,
        wsd.SHOP_NM,
        wogd.ID GROUP_ID,
        wogd.GROUP_NM,
        wopf.GROUP_IDS_REVEICED,
        wopf.POL_CUS_WID,
        wopf.CALLER_SHOP_WID,
        wopf.CALLER_ONLINE_WID,
        wopf.PAWN_ID,
        wopf.REASON_WID,
--        NULL REASON_NM, --Namdhh hotfix tạm thời 20240803
        worfd.CANCELED_REASON_NM,
        wopf.CAMPAIN_EXCEL_WID CAMPAIN_WID,
        wocd.CAMPAIGN_NM,
        wosd1.INTEGRATION_ID SOURCE_LEVEL_1_ID,
        wopf.GROUP_SOURCE_ID SOURCE_LEVEL_2_ID,
        wopf.SOURCE_ID SOURCE_LEVEL_3_ID,
        wopf.SEC_SOURCE_ID SOURCE_LEVEL_4_ID,
        wosd1.STR_NAME SOURCE_LEVEL_1_NAME,
        wosd2.STR_NAME SOURCE_LEVEL_2_NAME,
        wosd3.STR_NAME SOURCE_LEVEL_3_NAME,
        wosd4.STR_NAME SOURCE_LEVEL_4_NAME,
        TO_DATE(wopf.CREATED_DT || LPAD(wopf.CREATED_TIME, 6, 0), 'YYYYMMDDHH24MISS') FORM_CREATED_DT,
        TO_DATE(DECODE(wopf.TRANS_TO_SHOP_DT, -1, NULL, wopf.TRANS_TO_SHOP_DT || DECODE(wopf.TRANS_TO_SHOP_TIME, -1, '000000', LPAD(wopf.TRANS_TO_SHOP_TIME, 6, 0))), 'YYYYMMDDHH24MISS') TRANS_TO_SHOP_DT,
        CASE WHEN LENGTH(wopf.CANCEL_DT) = 10 THEN TO_DATE(wopf.CANCEL_DT || '0000', 'YYYYMMDDHH24MISS')
                ELSE NULL END CANCEL_DT,
        TO_DATE(DECODE(wopf.FIRST_CALL_DT, -1, NULL, wopf.FIRST_CALL_DT), 'YYYYMMDDHH24MISS') FIRST_CALL_DT,
        TO_DATE(DECODE(wopf.LAST_CALL_DT, -1, NULL, wopf.LAST_CALL_DT), 'YYYYMMDDHH24MISS') LAST_CALL_DT,
        CASE WHEN LENGTH(wopf.LNG_CALL_BACK) = 14 THEN TO_DATE(wopf.LNG_CALL_BACK, 'YYYYMMDDHH24MISS')
                ELSE NULL END LNG_CALL_BACK,
        wopf.ISNOTCONTROL IS_NOT_CONTROL,
        wopf.URL,
        wopf.REFERENCE_AFFILATE_ID REFERENCE_ID,
        TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS') FIRST_SHOP_TRANS_DT,
        --NULL FIRST_SHOP_TRANS_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_CODE ELSE wldf2.LOAN_CODE END LOAN_CODE,
        wopf.LOAN_CODE,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.LOAN_WID ELSE wldf2.LOAN_WID END LOAN_WID,
        wldf.LOAN_WID,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_DATE_WID ELSE wldf2.DISBURSE_DATE_WID END DISBURSE_DT,
        wldf.DISBURSE_DATE_WID DISBURSE_DT,
        --CASE WHEN wopf.CREATED_DT >= 20211122 THEN wldf.DISBURSE_AMT ELSE wldf2.DISBURSE_AMT END DISBURSE_AMT,
        wldf.DISBURSE_AMT,
        wldf.CLOSED_DATE_WID CLOSED_DT,
        last_op.LAST_OP_DT LAST_PROCESS_DT,
       -- NULL LAST_PROCESS_REASON_NM, --Namdhh hotfix tạm thời 20240803
        last_op.LAST_OP_REASON_NM LAST_PROCESS_REASON_NM,
        last_op.LAST_OP_REASON_TYPE LAST_PROCESS_REASON_TYPE,
        wldf.CTR_TYPE,
        wldf.CHANNEL_CODE,
        TO_DATE(first_op.FIRST_OP_DT, 'YYYYMMDDHH24MISS') FIRST_OP_DT,
        old_source.OLD_SOURCE,
        wpbid.POL_BRAND_IDENTITY_NAME BRAND_IDENTITY_NM,
        FIRST_FORWARD.PROCESS_DT FIRST_FORWARD_DT,
        FIRST_REEXPLOIT.PROCESS_DT FIRST_REEXPLOIT_DT,
        last_op.LAST_OP_NOTE LAST_PROCESS_NOTE,
        first_approve.PROCESS_DT FIRST_APPROVE_DT,
        first_tls_process.GROUP_NM FIRST_TLS_GROUP_NM,
        LAST_FORWARD.EMPLOYEE_CODE LAST_FORWARD_EMPLOYEE_CODE,
        LAST_FORWARD.EMPLOYEE_NM LAST_FORWARD_EMPLOYEE_NM,
        wogd2.GROUP_NM FIRST_GROUP_NM
FROM F88DWH.W_ONLINE_PAWN_F wopf
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wopf.LOAN_CODE = wldf.LOAN_CODE
/*
LEFT JOIN F88DWH.W_LOAN_MASTER_F wlmf
        ON wopf.PAWN_ID = wlmf.INTEGRATION_ID
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf
        ON wlmf.LOAN_WID = wldf.LOAN_WID
                AND wldf.SOURCE = 'MIFOS'
LEFT JOIN F88DWH.W_LOAN_DTL_F wldf2
        ON wopf.PAWN_ID = wldf2.INTEGRATION_ID
                AND wldf2.SOURCE = 'POS'
*/
LEFT JOIN F88DWH.W_ASSET_TP_D watd
        ON wopf.ASSET_TP_WID = watd.ASSET_TP_WID
LEFT JOIN F88DWH.W_ASSET_TP_D watd2
        ON wldf.ASSET_TYPE_WID = watd2.ASSET_TP_WID
LEFT JOIN F88DWH.W_AREA_D wad
        ON wopf.AREA_WID = wad.AREA_WID
LEFT JOIN F88DWH.vw_W_POL_REGION_D wpd
        ON wopf.PROVINCE_WID = wpd.POL_REGION_WID
LEFT JOIN F88DWH.vw_W_POL_REGION_D wdd
        ON wopf.DISTRICT_WID = wdd.POL_REGION_WID
LEFT JOIN F88DWH.vw_W_EMPLOYEE_D wed
        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
LEFT JOIN F88DWH.W_SHOP_D wsd
        ON wopf.SHOP_WID = wsd.SHOP_WID
LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE id <> 'TLS') wogd
        ON wopf.ONLINE_GRP_WID = wogd.ONLINE_GRP_WID
LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
LEFT JOIN F88DWH.W_ONLINE_CAMPAIGN_D wocd
        ON wopf.CAMPAIN_EXCEL_WID = wocd.CAMPAIGN_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd1
        ON wopf.CHANNEL_WID = wosd1.ONLINE_SOURCE_WID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd2
        ON wopf.GROUP_SOURCE_ID = wosd2.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd3
        ON wopf.SOURCE_ID = wosd3.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_SOURCE_D wosd4
        ON wopf.SEC_SOURCE_ID = wosd4.INTEGRATION_ID
LEFT JOIN F88DWH.W_ONLINE_GRP_D wogd2
        ON wopf.FIRST_GROUP_WID = wogd2.ONLINE_GRP_WID
--/*
LEFT JOIN
	(
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN (SELECT * FROM F88DWH.w_online_grp_d WHERE upper(trim(id)) <> 'TLS') g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and to_number(NULLIF(g1.id, 'TLS')) >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                AND t.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON wopf.INTEGRATION_ID = shop_trans.INT_POL_PAWN_ID
--*/
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_OP_DT
        FROM F88DWH.W_ONLINE_PROCESS_F op
        LEFT JOIN F88DWH.w_online_grp_d wogd
                ON op.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
        WHERE 1=1
                AND op.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                AND wogd.ID <> '44'
        GROUP BY INT_POL_PAWN_ID
        ) first_op
        ON wopf.INTEGRATION_ID = first_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT POL_WID,
                GROUP_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        wogd.GROUP_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN GIANGNT14.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_tls_process
        ON wopf.INTEGRATION_ID = first_tls_process.POL_WID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE,
                OP_NOTE LAST_OP_NOTE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd.CANCELED_REASON_NM OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        wopf.NOTE OP_NOTE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) last_op
        ON wopf.INTEGRATION_ID = last_op.INT_POL_PAWN_ID
LEFT JOIN (
        SELECT INT_POL_PAWN_ID,
                OLD_SOURCE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        wopf.NOTE OLD_SOURCE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 158
                        AND wopf.NOTE LIKE 'Nguồn cũ%'
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) old_source
        ON wopf.INTEGRATION_ID = old_source.INT_POL_PAWN_ID
LEFT JOIN F88DWH.W_POL_BRAND_IDENTITY_D wpbid
        ON wopf.BRAND_IDENTITY_WID = wpbid.POL_BRAND_IDENTITY_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN GIANGNT14.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_FORWARD
        ON wopf.INTEGRATION_ID = FIRST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT,
                EMPLOYEE_CODE,
                EMPLOYEE_NM
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        wed.EMPLOYEE_CODE,
                        wed.EMPLOYEE_NM,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN GIANGNT14.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                LEFT JOIN F88DWH.vw_W_EMPLOYEE_D wed
                        ON wopf.EMPLOYEE_WID = wed.EMPLOYEE_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 21
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) LAST_FORWARD
        ON wopf.INTEGRATION_ID = LAST_FORWARD.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN GIANGNT14.W_POL_TLS_GRP_D wogd
                        ON wopf.CREATED_GROUP_WID = wogd.ONLINE_GRP_WID
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 137
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) FIRST_REEXPLOIT
        ON wopf.INTEGRATION_ID = FIRST_REEXPLOIT.POL_WID
LEFT JOIN (
        SELECT POL_WID,
                PROCESS_DT
        FROM (
                SELECT wopf.INT_POL_PAWN_ID POL_WID,
                        TO_DATE(wopf.CREATED_DT, 'YYYYMMDDHH24MISS') PROCESS_DT,
                        ROW_NUMBER () OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND worfd.INTEGRATION_ID = 179
                        AND wopf.INT_POL_PAWN_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP)
                )
        WHERE RN = 1
        ) first_approve
        ON wopf.INTEGRATION_ID = first_approve.POL_WID
WHERE wopf.STATUS IN (1, 2, 3, 4, 5, 13)
        AND wopf.INTEGRATION_ID IN (SELECT ID FROM STGPROD.POL_PAWN_V2_TMP);


COMMIT;

---------------------

--- 2. Update data from ONLINE_PROCESS
-- 2.1. Update first shop trans
/*
MERGE
INTO F88DWH.W_POL_DTL_F wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                MIN(CREATED_DT) FIRST_SHOP_TRANS_DT
        FROM F88DWH.W_ONLINE_PROCESS_F t
        LEFT JOIN F88DWH.w_online_grp_d g1
                on t.created_group_wid=g1.online_grp_wid
                        AND g1.SHOP_NM NOT LIKE '%Telesale%'
                        and g1.id >1000
        LEFT JOIN F88DWH.W_SHOP_D g2
                on to_char(t.RECEPT_GROUP_ID) =g2.SHOP_CODE
                        AND g2.shop_type='F88'
                        AND g2.SHOP_NM NOT LIKE '%Telesale%'
        WHERE 1=1
                --AND t.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                --AND t.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                --AND t.DATE_WID = P_DATE
                AND nvl(g2.SHOP_NM,g1.SHOP_Nm) IS NOT NULL
        GROUP BY INT_POL_PAWN_ID
        ) shop_trans
        ON (wpdf.POL_WID = shop_trans.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.FIRST_SHOP_TRANS_DT = TO_DATE(shop_trans.FIRST_SHOP_TRANS_DT, 'YYYYMMDDHH24MISS')
WHERE wpdf.FIRST_SHOP_TRANS_DT IS NULL;

COMMIT;
*/

-- 2.2. Update last process info
/*
MERGE
INTO F88DWH.W_POL_DTL_F wpdf
USING (
        SELECT INT_POL_PAWN_ID,
                OP_DT LAST_OP_DT,
                OP_REASON_NM LAST_OP_REASON_NM,
                OP_REASON_TYPE LAST_OP_REASON_TYPE
        FROM (
                SELECT wopf.INT_POL_PAWN_ID,
                        TO_DATE(DECODE(wopf.CREATED_DT, -1, NULL, wopf.CREATED_DT), 'YYYYMMDDHH24MISS') OP_DT,
                        worfd. OP_REASON_NM,
                        worfd.TYPE_NM OP_REASON_TYPE,
                        ROW_NUMBER() OVER (PARTITION BY wopf.INT_POL_PAWN_ID ORDER BY wopf.INTEGRATION_ID DESC) RN
                FROM F88DWH.W_ONLINE_PROCESS_F wopf
                LEFT JOIN F88DWH.W_ONLINE_REASON_FAIL_D worfd
                        ON wopf.REASON_WID = worfd.ONLINE_REASON_FAIL_WID
                WHERE 1=1
                        AND wopf.YEAR_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'YYYY'))
                        AND wopf.MONTH_NUM = TO_NUMBER(TO_CHAR(TO_DATE(P_DATE, 'RRRR/MM/DD'), 'MM'))
                        AND wopf.DATE_WID = P_DATE
                )
        WHERE RN = 1
        ) wopf
        ON (wpdf.POL_WID = wopf.INT_POL_PAWN_ID)
WHEN MATCHED THEN UPDATE
        SET wpdf.LAST_PROCESS_DT = wopf.LAST_OP_DT,
                wpdf.LAST_PROCESS_REASON_NM = wopf.LAST_OP_REASON_NM,
                wpdf.LAST_PROCESS_REASON_TYPE = wopf.LAST_OP_REASON_TYPE;

COMMIT;
*/

-- 2.3. Clean up data
DELETE FROM HANHDTM.W_POL_DTL_F
WHERE POL_WID IN (
        SELECT ID FROM STGPROD.POL_PAWN_V2_TMP
        WHERE INT_STATUS NOT IN (1, 2, 3, 4, 5, 13)
);

COMMIT;

---------------------

END PROC_W_POL_DTL_F;
```
